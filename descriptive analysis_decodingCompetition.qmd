---
title: "descriptive analysis_decodingCompetition"
author: Kunya Zhan 
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  html:
   toc: true
   toc-depth: 3
   number-sections: true
   code-fold: true
   code-summary: "Show/Hide Code"
   smooth-scroll: true
   df-print: paged
   code-tools: true
   highlight-style: atom-one
   toc-location: left
editor: visual
---

# Descriptive Analysis 

This quarto document aims at reorganizing the codes at 'descriptive analysis 1021.Rmd'. It has two major parts:

1\. overall descriptive analysis of original decodeCompetition data;

2\. key characteristics identification through regression model and logistic model.

# Set up

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = TRUE)
```

### Packages Installing if not already installed

```{r}
#| label: install_libraries
#| echo: false
# è®¾ç½®é»˜è®¤ CRAN æºï¼Œé˜²æ­¢æœªæŒ‡å®šé•œåƒå¯¼è‡´ install.packages æŠ¥é”™
options(repos = c(CRAN = "https://cloud.r-project.org"))

# æ‰€éœ€åŒ…åˆ—è¡¨
packages <- c(
  "Rcpp", "dplyr", "stringr", "readr", "ggplot2", "tidyr", "readxl", "scales", 
  "showtext", "sysfonts", "skimr", "plm", "car", "glmnet", 
  "Rtsne", "networkD3", "cluster", "factoextra", "pROC", "lme4", 
  "MuMIn", "nnet", "DHARMa", "tigris", "ggeffects", "stargazer",
  "htmltools", "tidyverse", "ggcorrplot", "purrr", "broom.mixed", 
  "performance", "lattice", "fmsb", "kableExtra", "broom", 
  "knitr", "ggnewscale", "modelsummary", "pscl", "ggfortify", 
  "rlang", "patchwork", "segmented", "tidytext", "mgcv", "splines", 
  "interactions", "RColorBrewer", "cowplot", "ggbreak", "randomcoloR",
  "marginaleffects"
)

# Install only if missing
for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
  }
}

# Load all packages
lapply(packages, library, character.only = TRUE)
```

# Data cleansing

## data acquisition

```{r}
#| label: load_data
#| echo: false

# ----- main databases -----
adver_sum_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/1022data/adver_analysis_sum.xlsx"
legis_sum_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/1022data/legis_analysis_sum.xlsx"

adver_sum <- read_excel(adver_sum_path)
legis_sum <- read_excel(legis_sum_path)

adver_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/1022data/adver_analysis_all.xlsx"
legis_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/1022data/legis_analysis_all.xlsx"

adver_all <- read_excel(adver_path)
legis_all <- read_excel(legis_path)

adver_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/1022data/adver_train_data.csv")
legis_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/1022data/legis_train_data.csv")


# ----- supplementary databases -----
bioguide <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/congress_2025-10-23.csv")

# ideology
ideology_115_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2018-senate-ideology.csv")
ideology_115_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2018-house-ideology.csv")
ideology_116_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2020-senate-ideology.csv")
ideology_116_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2020-house-ideology.csv")
ideology_117_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2022-senate-ideology.csv")
ideology_117_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2022-house-ideology.csv")
ideology_118_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2024-senate-ideology.csv")
ideology_118_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/new ideology/govtrack-stats-2024-house-ideology.csv")

# original news data
news_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/115_118_news_data_new1.csv"
news_data <- read_csv(news_data_path)

# original legislative data
bills_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/115-118_congress_data_new.csv"
bills_data <- read_csv(bills_data_path)
```

## matching variables and special patch

```{r}
#| label: matching variables 
#| echo: false

# ------ matching variables map ------
match_vars <- c(
  "leverage_pl", "leverage_ne", "committee_pl", "committee_ne",
  "employ_industry_pl", "employ_industry_ne",
  "payroll_industry_pl", "payroll_industry_ne",
  "ethnicity_pl", "ethnicity_ne",
  "party_value_pl", "party_value_ne",
  "party_score_pl", "party_score_ne"
)

# ------ Add raw columns ------
adver_data_raw <- adver_data %>%
  rename_with(.cols = all_of(match_vars), .fn = ~ paste0(.x, "_raw"))
adver_all <- adver_all %>%
  left_join(
    adver_data_raw %>% dplyr::select(full_name, issue, congress, ends_with("_raw")),
    by = c("full_name", "issue", "congress")
  )

legis_data_raw <- legis_data %>%
  rename_with(.cols = all_of(match_vars), .fn = ~ paste0(.x, "_raw"))
legis_all <- legis_all %>%
  left_join(
    legis_data_raw %>% dplyr::select(full_name, issue, congress, ends_with("_raw")),
    by = c("full_name", "issue", "congress")
  )


# ------ Sanity check ------
stopifnot(all(paste0(match_vars, "_raw") %in% names(adver_all)))
stopifnot(all(paste0(match_vars, "_raw") %in% names(legis_all)))
```

#### special clean for legis_sum and legis data

```{r}
#| label: special clean for legis
#| echo: false

legis_data <- legis_data %>%
  mutate(issue = str_to_title(issue))

legis_sum <- legis_sum %>%
  mutate(issue = str_to_title(issue))
```

## name cleansing

### preparing bioguide as matching map

name cleansing: addressing issues that some full_name are missing

```{r}
#| label: name missing check in congress_basic
#| echo: false
congress_basic <- bioguide %>%
  dplyr::select(
    bioguide_id, full_name, direct_order_name, chamber, member_type,
    party, state_name, state_code, district, gender,
    birth_year, death_year, age_at_death, district_congress
  ) %>%
  distinct() 

# ---- check missing full_name inside bioguide ----
missing_name_df <- congress_basic %>%
  filter(is.na(full_name) | full_name == "") %>%
  dplyr::select(bioguide_id, direct_order_name, chamber, state_code, district, party, district_congress) %>%
  arrange(chamber, state_code, district)
```

```{r}
#| label: clean_name
#| echo: false

# ------ Step 0: Create direct_order_name -> full_name mapping ------
name_map <- tibble::tibble(
  direct_order_name = c(
    "Mike Rogers", "J. French Hill", "Dave Min", "Cory Mills",
    "Marjorie Taylor Greene", "David P. Joyce", "Michael Baumgartner",
    "Mark  Begich", "Richard C. Shelby", "Mark Udall", "Chuck Grassley",
    "Daniel Coats", "Joe Donnelly", "Pat Roberts", "Rand Paul", "David Vitter",
    "Carl Levin", "Al  Franken", "Claire McCaskill", "Richard Burr",
    "John Hoeven", "Heidi  Heitkamp", "Kelly Ayotte", "Dean Heller",
    "Rob Portman", "Ron Wyden", "Jack Reed", "Sheldon Whitehouse",
    "Lindsey Graham", "Tim Johnson", "Bob Corker"
  ),
  full_name = c(
    "Rep. Rogers, Mike [R-AL-3]", "Rep. Hill, J. French [R-AR-2]",
    "Rep. Min, Dave [D-CA-47]", "Rep. Mills, Cory [R-FL-7]",
    "Rep. Greene, Marjorie Taylor [R-GA-14]", "Rep. Joyce, David P. [R-OH-14]",
    "Rep. Baumgartner, Michael [R-WA-5]", "Sen. Begich, Mark [D-AK]",
    "Sen. Shelby, Richard C. [R-AL]", "Sen. Udall, Mark [D-CO]",
    "Sen. Grassley, Charles E. [R-IA]", "Sen. Coats, Daniel R. [R-IN]",
    "Sen. Donnelly, Joe [D-IN]", "Sen. Roberts, Patrick J. [R-KS]",
    "Sen. Paul, Randal H. [R-KY]", "Sen. Vitter, David [R-LA]",
    "Sen. Levin, Carl [D-MI]", "Sen. Franken, Al [D-MN]",
    "Sen. McCaskill, Claire [D-MO]", "Sen. Burr, Richard [R-NC]",
    "Sen. Hoeven, John [R-ND]", "Sen. Heitkamp, Heidi [D-ND]",
    "Sen. Ayotte, Kelly [R-NH]", "Sen. Heller, Dean [R-NV]",
    "Sen. Portman, Robert J. [R-OH]", "Sen. Wyden, Ronald [D-OR]",
    "Sen. Reed, Jack [D-RI]", "Sen. Whitehouse, Sheldon [D-RI]",
    "Sen. Graham, Lindsey [R-SC]", "Sen. Johnson, Timothy M. [D-SD]",
    "Sen. Corker, Robert P. [R-TN]"
  )
)
missing_name_df <- missing_name_df %>%
  left_join(name_map, by = "direct_order_name")

# ------ Step 1: Define helper to clean names ------
clean_names <- function(x) {
  x %>%
    stringr::str_replace_all("\\p{Zs}+", " ") %>%
    stringr::str_squish() %>%
    stringr::str_trim() %>%
    stringr::str_to_lower()
}

congress_basic <- congress_basic %>%
  mutate(direct_order_name_clean = clean_names(direct_order_name))
missing_name_df <- missing_name_df %>%
  mutate(direct_order_name_clean = clean_names(direct_order_name))

# ------ Step 2: Fill missing full_name using mapping ------
congress_basic <- congress_basic %>%
  left_join(
    missing_name_df %>% dplyr::select(direct_order_name_clean, full_name) %>% distinct(),
    by = "direct_order_name_clean"
  ) %>%
  mutate(full_name = ifelse(is.na(full_name.x), full_name.y, full_name.x)) %>%
  dplyr::select(-ends_with(".x"), -ends_with(".y"), -direct_order_name_clean)

# Verify no missing names remain
cat("Number of remaining missing full_name:", sum(is.na(congress_basic$full_name)), "\n")
```

district cleansing: matching district code in main databases

```{r}
#| label: clean district
#| echo: false
congress_basic <- congress_basic %>%
  mutate(
    district = as.character(district),
    district = case_when(
      is.na(district) & chamber == "Senate" ~ "99",
      is.na(district) & chamber == "House of Representatives" ~ "At Large",
      TRUE ~ district
    )
  )
```

age cleansing: create age_to_date to match ages in main database and prepare age_to_congress to replace ages in main databases

```{r}
#| label: clean age
#| echo: false
# ------ Define congress start years ------
congress_year_map <- tibble(
  district_congress = c(115, 116, 117, 118),
  congress_start_year = c(2019, 2021, 2023, 2025)
)

# ------ Compute ages ------
congress_basic <- congress_basic %>%
  # Join start year info
  left_join(congress_year_map, by = "district_congress") %>%
  
  # Compute age
  mutate(
    age_to_date = 2025 - birth_year,
    age_to_congress = congress_start_year - birth_year,
    
    # Handle missing birth_year
    age_to_date = if_else(!is.na(birth_year), age_to_date, NA_real_),
    age_to_congress = if_else(!is.na(birth_year) & !is.na(congress_start_year),
                              age_to_congress, NA_real_)
  )
cat("âœ… Age calculation completed.\n")
```

### name cleansing adver_sum & legis_sum and special patches

main database name extracting

```{r}
#| label: name extracting
#| echo: false

adver_sum0 <- adver_sum %>%
  mutate(
    name_no_title = str_remove(full_name, "^\\s*(Sen\\.|Rep\\.|Del\\.)\\s*"),
    name_clean = str_remove(name_no_title, "\\s*\\[.*\\]") %>% str_squish(),
    eng_name = str_replace(name_clean, "^([^,]+),\\s*(.+)$", "\\2 \\1")
  ) %>%
  dplyr::select(-name_no_title, -name_clean)
adver_sum0$congress <- as.character(adver_sum0$congress)

legis_sum0 <- legis_sum %>%
  mutate(
    name_no_title = str_remove(full_name, "^\\s*(Sen\\.|Rep\\.|Del\\.)\\s*"),
    name_clean = str_remove(name_no_title, "\\s*\\[.*\\]") %>% str_squish(),
    eng_name = str_replace(name_clean, "^([^,]+),\\s*(.+)$", "\\2 \\1")
  ) %>%
  dplyr::select(-name_no_title, -name_clean)
legis_sum0$congress <- as.character(legis_sum0$congress)

# matching variable name in congress_basic
congress_basic <- congress_basic %>% rename(eng_name = direct_order_name)
```

#### \* special patches

The database has a override problem with some congress members. For example, Sen. Blunt Rochester, Lisa \[D-DE\] was elected as senator in 119th congress, but the database mistakebly override her information before as senator, while she was a representative. Those who are identified will be corrected as a special path in this chuck.

special patch1: patch for "Sen. Blunt Rochester, Lisa \[D-DE\]"

```{r}
#| label: patch_blunt_rochester
#| echo: false

# å®šä¹‰ä¿®è¡¥ç›®æ ‡
patch_name <- "Sen. Blunt Rochester, Lisa [D-DE]"
patch_congress <- 118  # å¯é€‰ï¼šæŒ‡å®šå±Šæ¬¡ï¼Œç¡®ä¿å”¯ä¸€å®šä½
new_chamber <- "House of Representatives"
new_district <- "At Large"

# ---- Step 1: ç²¾ç¡®é”å®šåŒ¹é…å¯¹è±¡ ----
target_legis <- legis_sum0 %>%
  filter(full_name == patch_name) %>%
  distinct(full_name, congress)

target_adver <- adver_sum0 %>%
  filter(full_name == patch_name) %>%
  distinct(full_name, congress)

if (nrow(target_legis) > 1 | nrow(target_adver) > 1) {
  warning("âš ï¸ æœ‰å¤šä¸ªåŒ¹é…è®°å½•ï¼Œè¯·ç¡®è®¤æ˜¯å¦éœ€è¦é™åˆ¶ç‰¹å®š Congressï¼ˆä¾‹å¦‚ 118ï¼‰ï¼")
}

# ---- Step 2: å®‰å…¨æ›´æ–°å‡½æ•° ----
safe_patch <- function(df, name, congress = NULL, new_chamber, new_district) {
  df %>%
    mutate(
      chamber = case_when(
        !is.na(full_name) &
          full_name == name &
          (is.null(congress) | .data$congress == congress) ~ new_chamber,
        TRUE ~ chamber
      ),
      district = case_when(
        !is.na(full_name) &
          full_name == name &
          (is.null(congress) | .data$congress == congress) ~ new_district,
        TRUE ~ district
      )
    )
}

# ---- Step 3: åº”ç”¨æ›´æ–° ----
legis_sum0 <- safe_patch(legis_sum0, patch_name, patch_congress, new_chamber, new_district)
adver_sum0 <- safe_patch(adver_sum0, patch_name, patch_congress, new_chamber, new_district)

# ---- Step 4: æ£€æŸ¥ç»“æœ ----
legis_sum0 %>% 
  filter(full_name == patch_name) %>%
  dplyr::select(full_name, congress, chamber, district)

adver_sum0 %>% 
  filter(full_name == patch_name) %>%
  dplyr::select(full_name, congress, chamber, district)

```

special patch2: for congressmen "Sen. Menendez, Robert \[D-NJ\]" and "Rep. Menendez, Robert \[D-NJ-8\]", since they have different eng_name but extracting from full_name cannot automatically discern the difference

```{r}
#| label: special_clean_menendez
#| echo: false
special_clean_menendez <- function(df) {
  df <- df %>%
    mutate(
      eng_name = case_when(
        # Senator Robert Menendez (NJ, district 99 or 0)
        full_name == "Sen. Menendez, Robert [D-NJ]" |
        (state_code == "NJ" & district %in% c(99, 0) & str_detect(full_name, "Menendez")) ~ "Bob Menendez",
        
        # Representative Robert Menendez (NJ-8)
        full_name == "Rep. Menendez, Robert [D-NJ-8]" |
        (state_code == "NJ" & district == 8 & str_detect(full_name, "Menendez")) ~ "Rob Menendez",
        
        TRUE ~ eng_name
      )
    )
  return(df)
}

# Apply the special cleaning function
congress_basic <- special_clean_menendez(congress_basic)
adver_sum0 <- special_clean_menendez(adver_sum0)
legis_sum0 <- special_clean_menendez(legis_sum0)
```

### name mapping

```{r}
#| label: check name missing in main data
#| echo: false

# try to use congress+party+chamber+state_code+district as mapping key
adver_name_check <- adver_sum0 %>%
  filter(is.na(full_name)) %>%
  group_by(congress, party, chamber, state_code, district) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(desc(n))

legis_name_check <- legis_sum0 %>%
  filter(is.na(full_name)) %>%
  group_by(congress, party, chamber, state_code, district) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(desc(n)) # missing == 0, clean

# duplicity check
dupli_name_check <- adver_sum0  %>%
  
  # 1. only checking those full_name == na
  filter(is.na(full_name)) %>%
  
  # 2. group on legislators
  group_by(congress, party, chamber, state_code, district) %>%
  
  # 3. calculating various issue & row numbers
  summarise(
    n_rows = n(),
    n_issue = n_distinct(issue, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  
  # 4. check if duplicate
  mutate(non_unique = n_rows > n_issue) %>%
  
  arrange(desc(n_rows))

# ---- output analysis result ----
cat("ğŸ” å…±æœ‰", sum(dupli_name_check$non_unique), "ç»„ full_name ç¼ºå¤±è®°å½•æ— æ³•å”¯ä¸€æ ‡è¯†è®®å‘˜ã€‚\n")
cat("ğŸ“Š æ€»è®¡ unique ç»„åˆæ•°ï¼š", nrow(dupli_name_check), "\n")

# ---- check specific rowï¼ˆonly thos who are duplicate not due to issueï¼‰ ----
dupli_name_check %>%
  filter(non_unique) %>%
  dplyr::select(congress, party, chamber, state_code, district, n_rows, n_issue)
```

define name matching function

```{r}
#| label: match_bioguide
#| echo: false

# ------ Function: Match bioguide_id based on name and district info ------
normalize_name <- function(name) {
  name %>%
    tolower() %>%
    str_replace_all("\\.", "") %>%     # åˆ é™¤å¥ç‚¹
    str_trim() %>%
    str_replace_all("\\s+", " ")       # å»å¤šä½™ç©ºæ ¼
}

# ---- è¾…åŠ©å‡½æ•°ï¼šå»é™¤ä¸­é—´åï¼Œåªä¿ç•™å + å§“ ----
remove_middle_name <- function(name) {
  name %>%
    str_trim() %>%
    str_split_fixed(" ", n = 3) %>%
    .[, c(1, 2)] %>%
    apply(1, function(x) paste(na.omit(x), collapse = " ")) %>%
    str_trim()
}

# ---- ä¸»å‡½æ•° ----
match_bioguide_id <- function(main_df, congress_basic, 
                              use_step3 = TRUE, 
                              use_step4 = TRUE,
                              verbose = TRUE) {
  
  total_n <- nrow(main_df)
  
  # ---- Step 0: åˆå§‹åŒ– bioguide_id ----
  main_df <- main_df %>% 
    mutate(bioguide_id = NA_character_)
  
  # ---- Step 1: full_name + congress åŒ¹é… ----
  tmp1 <- congress_basic %>%
    group_by(full_name, district_congress) %>%
    slice(1) %>%
    ungroup() %>%
    dplyr::select(full_name, district_congress, bioguide_id1 = bioguide_id)
  
  main_df <- main_df %>%
    left_join(tmp1, by = c("full_name", "congress" = "district_congress")) %>%
    mutate(bioguide_id = coalesce(bioguide_id, bioguide_id1)) %>%
    dplyr::select(-bioguide_id1)
  
  if (verbose) cat("Step 1 matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
  
  # ---- Step 2: eng_name + congress åŒ¹é… ----
  tmp2 <- congress_basic %>%
    group_by(eng_name, district_congress) %>%
    slice(1) %>%
    ungroup() %>%
    dplyr::select(eng_name, district_congress, bioguide_id2 = bioguide_id)
  
  main_df <- main_df %>%
    left_join(tmp2, by = c("eng_name", "congress" = "district_congress")) %>%
    mutate(bioguide_id = coalesce(bioguide_id, bioguide_id2)) %>%
    dplyr::select(-bioguide_id2)
  
  if (verbose) cat("Step 2 matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
  
  # ---- Step 3ï¼ˆå¯é€‰ï¼‰: ä½¿ç”¨ç¨³å®š key åŒ¹é… bioguide_id ----
  if (use_step3) {
    main_df <- main_df %>%
      mutate(id_key = paste(congress, party, chamber, state_code, district, sep = "_"))
    
    congress_basic <- congress_basic %>%
      mutate(id_key = paste(district_congress, party, chamber, state_code, district, sep = "_"))
    
    tmp3 <- congress_basic %>%
      group_by(id_key) %>%
      slice(1) %>%
      ungroup() %>%
      dplyr::select(id_key, bioguide_id3 = bioguide_id, full_name3 = full_name)
    
    n_before <- nrow(main_df)
    
    main_df <- main_df %>%
      left_join(tmp3, by = "id_key", relationship = "many-to-one") %>%
      mutate(
        bioguide_id = coalesce(bioguide_id, bioguide_id3),
        full_name   = if_else(!is.na(bioguide_id3), full_name3, full_name)
      ) %>%
      dplyr::select(-bioguide_id3, -full_name3, -id_key)
    
    stopifnot(nrow(main_df) == n_before)
    
    if (verbose) cat("Step 3 (stable key) matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
    
    dupli_keys <- tmp3 %>% count(id_key) %>% filter(n > 1)
    if (nrow(dupli_keys) > 0) {
      warning("âš ï¸ Warning: duplicate id_key found in congress_basic, may cause ambiguous match.")
    }
  }
  
  # ---- Step 4ï¼ˆå¯é€‰ï¼‰: eng_name only (normalize + å»ä¸­é—´å) ----
  if (use_step4) {
    # æ ‡å‡†åŒ–å¹¶å»é™¤ä¸­é—´å
    congress_basic <- congress_basic %>%
      mutate(eng_name_clean = normalize_name(eng_name) %>% remove_middle_name())
    
    main_df <- main_df %>%
      mutate(eng_name_clean = normalize_name(eng_name) %>% remove_middle_name())
    
    tmp4 <- congress_basic %>%
      group_by(eng_name_clean) %>%
      slice(1) %>%
      ungroup() %>%
      dplyr::select(eng_name_clean, full_name4 = full_name, bioguide_id4 = bioguide_id)
    
    main_df <- main_df %>%
      left_join(tmp4, by = "eng_name_clean") %>%
      mutate(
        bioguide_id = coalesce(bioguide_id, bioguide_id4),
        full_name   = if_else(!is.na(bioguide_id4), full_name4, full_name)
      ) %>%
      dplyr::select(-bioguide_id4, -full_name4, -eng_name_clean)
    
    if (verbose) cat("Step 4 (normalized + middle name removed) matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
  }
  
  # ---- Step 5: è¾“å‡ºæ€»ç»“ ----
  if (verbose) {
    cat("âœ… Bioguide ID matching complete.\n")
    cat("Remaining NA bioguide_id:", sum(is.na(main_df$bioguide_id)), "\n")
  }
  
  return(main_df)
}

# ------ Apply function to datasets ------
congress_basic$district_congress <- as.character(congress_basic$district_congress)
adver_sum1 <- match_bioguide_id(adver_sum0, congress_basic, use_step3 = TRUE, use_step4 = TRUE)
legis_sum1 <- match_bioguide_id(legis_sum0, congress_basic, use_step3 = FALSE, use_step4 = TRUE)

# Update final datasets
# adver_sum <- adver_sum1
# legis_sum <- legis_sum1

# æŸ¥çœ‹legisç¼ºå¤±
legis_missing <- legis_sum1 %>% 
  filter(is.na(bioguide_id)) %>%
  distinct(full_name, .keep_all = FALSE) %>%
  arrange(full_name)
write.csv(legis_missing, "legis_missing_fullname_list.csv", row.names = FALSE)
```

address missing name issues

```{r}
#| label: missing name solution
#| echo: false

# ------ old_full_name -> new_full_name ------ 
name_map <- data.frame(
  old_full_name = c(
    "David Joyce",
    "J. Hill",
    "John Reed",
    "Marjorie Greene",
    "Richard Shelby"
  ),
  new_full_name = c(
    "Rep. Joyce, David P. [R-OH-14]",
    "Rep. Hill, J. French [R-AR-2]",
    "Sen. Reed, Jack [D-RI]",
    "Rep. Greene, Marjorie Taylor [R-GA-14]",
    "Sen. Shelby, Richard C. [R-AL]"
  ),
  stringsAsFactors = FALSE
)

# ------ clean full_name ------ 
clean_names <- function(x) {
  x %>%
    str_replace_all("\\p{Zs}+", " ") %>%  # å°†æ‰€æœ‰ç©ºç™½æ›¿æ¢ä¸ºæ™®é€šç©ºæ ¼
    str_squish() %>%                      # å‹ç¼©å¤šç©ºæ ¼
    str_trim() %>%
    str_to_lower()
}

legis_sum2 <- legis_sum1 %>%
  mutate(full_name_clean = clean_names(full_name))
name_map <- name_map %>%
  mutate(old_full_name_clean = clean_names(old_full_name))

# ------ update full_name ------ 
legis_sum2 <- legis_sum2 %>%
  left_join(name_map, by = c("full_name" = "old_full_name")) %>%
  mutate(
    full_name = coalesce(new_full_name, full_name),
    updated_flag = !is.na(new_full_name)  # flage updated rows
  ) %>%
  dplyr::select(-new_full_name)

# ------ bioguide match ------

update_rows <- which(legis_sum2$updated_flag & is.na(legis_sum2$bioguide_id))

# full_name + congress as only key
legis_sum2$key <- paste0(legis_sum2$full_name, "_", legis_sum2$congress)
congress_basic$key <- paste0(congress_basic$full_name, "_", congress_basic$district_congress)

matched_ids <- congress_basic$bioguide_id[match(legis_sum2$key[update_rows], congress_basic$key)]
legis_sum2$bioguide_id[update_rows] <- matched_ids

legis_sum1 <- legis_sum2 %>% dplyr::select(-key, -full_name_clean, -old_full_name_clean, -updated_flag)
```

## ideology update

The original ideology data in the main database is standardized. We use ideology data at \[GovTrack\](<https://www.govtrack.us/about/analysis#ideology>) to replace them. ref: [Tauberer, Joshua](http://razor.occams.info/). 2012. Observing the Unobservables in the U.S. Congress, presented at Law Via the Internet 2012, Cornell Law School, October 2012.

ideology cleansing

```{r}
#| label: ideology-cleansing
#| echo: false

ideology_115_house <- ideology_115_house %>% mutate(congress = 115, chamber = "House of Representatives")
ideology_116_house <- ideology_116_house %>% mutate(congress = 116, chamber = "House of Representatives")
ideology_117_house <- ideology_117_house %>% mutate(congress = 117, chamber = "House of Representatives")
ideology_118_house <- ideology_118_house %>% mutate(congress = 118, chamber = "House of Representatives")
ideology_115_senate <- ideology_115_senate %>% mutate(congress = 115, chamber = "Senate")
ideology_116_senate <- ideology_116_senate %>% mutate(congress = 116, chamber = "Senate")
ideology_117_senate <- ideology_117_senate %>% mutate(congress = 117, chamber = "Senate")
ideology_118_senate <- ideology_118_senate %>% mutate(congress = 118, chamber = "Senate")

chamber_ideology <- bind_rows(
  ideology_115_house,
  ideology_116_house,
  ideology_117_house,
  ideology_118_house,
  ideology_115_senate,
  ideology_116_senate,
  ideology_117_senate,
  ideology_118_senate)
summary(chamber_ideology$congress)

chamber_ideology$congress <- as.character(chamber_ideology$congress)
```

ideology merge

```{r}
#| label: ideology-merge
#| echo: false

merge_ideology <- function(df, ideology_df, verbose = TRUE) {
  
  # Step 0: æ ¼å¼ç»Ÿä¸€
  df <- df %>%
    mutate(
      bioguide_id = toupper(str_trim(bioguide_id)),
      congress    = as.character(congress),
      chamber     = tolower(str_trim(chamber))
    )
  
  ideology_df <- ideology_df %>%
    mutate(
      bioguide_id = toupper(str_trim(bioguide_id)),
      congress    = as.character(congress),
      chamber     = tolower(str_trim(chamber))
    ) %>%
    # Step 1: å»é‡ï¼Œç¡®ä¿å”¯ä¸€åŒ¹é…
    group_by(bioguide_id, congress, chamber) %>%
    slice(1) %>%
    ungroup()
  
  # Step 2: é€‰æ‹©å¿…è¦åˆ—
  ideology_df <- ideology_df %>%
    dplyr::select(bioguide_id, congress, chamber, ideology) %>%
    rename(ideology_new = ideology)
  
  # Step 3: left_join
  df <- df %>%
    left_join(ideology_df, by = c("bioguide_id", "congress", "chamber")) %>%
    mutate(ideology = coalesce(ideology, ideology_new)) %>%
    dplyr::select(-ideology_new)
  
  # Step 4: è¾“å‡ºåŒ¹é…æƒ…å†µ
  if (verbose) {
    n_missing <- sum(is.na(df$ideology))
    cat("âœ… Merge complete. Remaining NA ideology:", n_missing, "\n")
  }
  
  return(df)
}

adver_sum1 <- merge_ideology(adver_sum1, chamber_ideology)
legis_sum1 <- merge_ideology(legis_sum1, chamber_ideology)
```

ideology missing distribution: missing at random

```{r}
#| label: ideology-missing
#| echo: false

check_missing_ideology <- function(df, df_name = "dataset") {
  missing_df <- df %>% filter(is.na(ideology))
  
  cat("âœ…", df_name, "total missing:", nrow(missing_df), "/", nrow(df), "\n\n")
  
  # Missing by party
  cat("Missing by party:\n")
  print(table(missing_df$party))
  cat("\n")
  
  # Missing by state
  cat("Missing by state:\n")
  print(table(missing_df$state_code))
  cat("\n")
  
  # Missing by chamber
  cat("Missing by chamber:\n")
  print(table(missing_df$chamber))
  cat("\n")
  
  # Cross-tab: party x chamber
  cat("Missing by party x chamber:\n")
  print(table(missing_df$party, missing_df$chamber))
}

check_missing_ideology(adver_sum1, "adver_sum1")
check_missing_ideology(legis_sum1, "legis_sum1")
```

# data aggregation and generation

## individual level aggregation

generate function: generate_decision_with_traits()

> This function aggregates prediction and importance metrics for each legislator across different datasets, such as train, test,or merged. It computes the relative importance of 3 behavioral modes - intl, dom, and prof, and assigns each legislator a dominant decision category based on their most prominent behavior. It finally merges these aggregated results with demographic and institutional traits like gender, party, and ideology.

```{r}
#| label: generate-decision-with-traits
#| echo: false
# ---- Function: generate_decision_with_traits ----
generate_decision_with_traits <- function(df, mode = "all") {
  # parameter validation
  if (!mode %in% c("all", "train", "test", "merged")) {
    stop("mode must be 'all', 'train', 'test', or 'merged'")
  }

  # ---- step 1: data filtering ----
  df_subset <- if (mode %in% c("all", "merged")) df else df %>% filter(dataset == mode)

  # ---- step 2: data aggregation ----
  group_vars <- if (mode == "merged") {
    c("full_name", "congress")
  } else {
    c("full_name", "congress", "dataset")
  }

  df_clean <- df_subset %>%
    group_by(across(all_of(group_vars))) %>%
    summarise(
      importance_intl = sum(importance_intl, na.rm = TRUE),
      importance_dom  = sum(importance_dom,  na.rm = TRUE),
      importance_prof = sum(importance_prof, na.rm = TRUE),
      importance_all  = sum(importance_all,  na.rm = TRUE),
      pred = mean(pred, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      intl_percentage = ifelse(importance_all > 0, importance_intl / importance_all, NA_real_),
      dom_percentage  = ifelse(importance_all > 0, importance_dom  / importance_all, NA_real_),
      prof_percentage = ifelse(importance_all > 0, importance_prof / importance_all, NA_real_),
      max_val = pmax(intl_percentage, dom_percentage, prof_percentage, na.rm = TRUE),
      decision = case_when(
        is.na(max_val) ~ NA_character_,
        intl_percentage == max_val & dom_percentage != max_val & prof_percentage != max_val ~ "intl",
        dom_percentage  == max_val & intl_percentage != max_val & prof_percentage != max_val ~ "dom",
        prof_percentage == max_val & intl_percentage != max_val & dom_percentage != max_val ~ "prof",
        TRUE ~ "tie"
      )
    ) %>%
    dplyr::select(-max_val, -importance_all)

  # ---- step3: trait merging ----
  traits <- df %>%
    dplyr::select(full_name, congress, dataset, party, chamber, committee_el,
           gender, age, seniority, ideology, district, state_code, bioguide_id) %>%
    distinct()

  if (mode == "merged") {
    traits <- traits %>%
      group_by(full_name, congress) %>%
      summarise(
        party = first(party),
        chamber = first(chamber),
        committee_el = first(na.omit(committee_el)),
        gender = first(gender),
        age = mean(age, na.rm = TRUE),
        seniority = mean(seniority, na.rm = TRUE),
        ideology = mean(ideology, na.rm = TRUE),
        district = first(district),
        state_code = first(state_code),
        bioguide_id = first(bioguide_id),
        .groups = "drop"
      )

    df_final <- df_clean %>%
      left_join(traits, by = c("full_name", "congress"))
  } else {
    df_final <- df_clean %>%
      left_join(traits, by = c("full_name", "congress", "dataset"))
  }

  # ---- step 4: join and label formatting ----
  df_final <- df_final %>%
    mutate(gender = factor(gender, levels = c(0, 1), labels = c("Female", "Male")))

  return(df_final)
}

# ---- application ----
#df_train <- generate_decision_with_traits_dual(df, mode = "train")
#df_test <- generate_decision_with_traits_dual(df, mode = "test")

# adv
adver_cg <- generate_decision_with_traits(adver_sum1, mode = "merged")
# legis
legis_cg <- generate_decision_with_traits(legis_sum1, mode = "merged")
```

## topic level aggregation

generate function: generate_decision_with_issue()

> This function processes legislative data to summarize each legislator's issue-level decision pattern (international, domestic, or professional). It groups the data by legislator, Congress session, and issue, aggregates importance scores, and calculates the dominant decision type for each group.

```{r}
#| label: generate decision with issues
#| echo: false
generate_decision_with_issues <- function(df, set_name = "all") {
  # Step 1: Optional filter by dataset (train/test)
  if (set_name %in% c("train", "test")) {
    df <- df %>% filter(dataset == set_name)
  }

  # Step 2: Group by issue-congress level and summarize
  df_clean <- df %>%
    group_by(issue, congress, committee_el) %>%  # ä¿ç•™ dataset ä¿¡æ¯
    summarise(
      label = sum(label, na.rm = TRUE),
      pred = mean(pred, na.rm = TRUE),
      importance_intl = sum(importance_intl, na.rm = TRUE),
      importance_dom = sum(importance_dom, na.rm = TRUE),
      importance_prof = sum(importance_prof, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      total = importance_intl + importance_dom + importance_prof,
      intl_percentage = ifelse(total > 0, importance_intl / total, NA_real_),
      dom_percentage  = ifelse(total > 0, importance_dom  / total, NA_real_),
      prof_percentage = ifelse(total > 0, importance_prof / total, NA_real_),
      max_val = pmax(intl_percentage, dom_percentage, prof_percentage, na.rm = TRUE),
      decision = case_when(
        is.na(max_val) ~ NA_character_,
        intl_percentage == max_val & dom_percentage != max_val & prof_percentage != max_val ~ "intl",
        dom_percentage  == max_val & intl_percentage != max_val & prof_percentage != max_val ~ "dom",
        prof_percentage == max_val & intl_percentage != max_val & dom_percentage  != max_val ~ "prof",
        TRUE ~ "tie"
      )
    ) %>%
    dplyr::select(-max_val, -total)

  return(df_clean)
}

# ---- application ----
adver_tp <- generate_decision_with_issues(adver_sum)
legis_tp <- generate_decision_with_issues(legis_sum)
```

# overall descriptive analysis for individual

This block visualizes the distribution of legislators' decision types (intl/dom/prof) in both adver and legis datasets. It includes overall bar plots and congress-specific facet plots. Additionally, it inspects label distributions across congress, party, chamber, gender, and committee.

## distribution plots

overall

```{r}
#| label: overall barplot
#| echo: false

# adver
ggplot(adver_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  geom_text(stat='count', aes(label=..count..), vjust=-0.8, size=5) +
  labs(title = "decision mode by congressmen adver",
       x = "decision mode",
       y = "number") +
  theme_minimal(base_size = 14)


#legis
ggplot(legis_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  geom_text(stat='count', aes(label=..count..), vjust=-0.8, size=5) +
  labs(title = "decision mode by congressmen legis",
       x = "decision mode",
       y = "number") +
  theme_minimal(base_size = 14)
```

by congress

```{r}
#| label: overall barplot by congress
ggplot(adver_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  facet_wrap(~ congress, scales = "free_y") +
  labs(title = "decision mode by congressmen adver",
       x = "Decision Mode",
       y = "Number") +
  theme_minimal(base_size = 12)

ggplot(legis_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  facet_wrap(~ congress, scales = "free_y") +
  labs(title = "decision mode by congressmen legis",
       x = "Decision Mode",
       y = "Number") +
  theme_minimal(base_size = 12)
```

## distribution map

### map dataset generation and cleansing

```{r}
#| label: mapdata preparation
#| echo: false

# ---- mapdata for house ----
adver_cg_heatmap <- adver_cg %>%
  filter(chamber == "house of representatives")

legis_cg_heatmap <- legis_cg %>%
  filter(chamber == "house of representatives")

# ---- mapdata for senate ----
adver_cg_heatmap1 <- adver_cg %>%
  filter(chamber == "senate")

legis_cg_heatmap1 <- legis_cg %>%
  filter(chamber == "senate")
```

district cleansing

```{r}
#| label: district cleansing for mapdata
#| echo: false

unique(adver_cg_heatmap$district[is.na(as.integer(adver_cg_heatmap$district))]) # debug district data issue

adver_cg_heatmap  <- adver_cg_heatmap  %>%
  mutate(
    district_clean = case_when(
      grepl("At Large", district, ignore.case = TRUE) ~ "00",
      state_code %in% c("DC", "AS", "GU", "MP", "PR", "VI") ~ "98",
      grepl("^[0-9]+$", district) ~ sprintf("%02d", as.integer(district)),
      grepl("^[0-9]+(st|nd|rd|th)$", district, ignore.case = TRUE) ~ sprintf(
        "%02d", as.integer(str_extract(district, "^[0-9]+"))
      ),
      TRUE ~ NA_character_  
    ),
    state_district = paste0(state_code, "-", district_clean)
  ) # turn at-large into 00
unique(adver_cg_heatmap$district_clean[is.na(as.integer(adver_cg_heatmap$district_clean))]) # check results

unique(legis_cg_heatmap$district[is.na(as.integer(legis_cg_heatmap$district))]) # debug district data issue

legis_cg_heatmap  <- legis_cg_heatmap  %>%
  mutate(
    district_clean = case_when(
      grepl("At Large", district, ignore.case = TRUE) ~ "00",
      state_code %in% c("DC", "AS", "GU", "MP", "PR", "VI") ~ "98",
      grepl("^[0-9]+$", district) ~ sprintf("%02d", as.integer(district)),
      grepl("^[0-9]+(st|nd|rd|th)$", district, ignore.case = TRUE) ~ sprintf(
        "%02d", as.integer(str_extract(district, "^[0-9]+"))
      ),
      TRUE ~ NA_character_  
    ),
    state_district = paste0(state_code, "-", district_clean)
  )
unique(legis_cg_heatmap$district_clean[is.na(as.integer(legis_cg_heatmap$district_clean))]) 
```

### flip-key construction 

```{r}
#| label: state flip key
#| echo: false

# fips-state
fips_state_map <- data.frame(
  fips = c(
    "01","02","04","05","06","08","09","10","12","13","15","16","17","18","19",
    "20","21","22","23","24","25","26","27","28","29","30","31","32","33","34",
    "35","36","37","38","39","40","41","42","44","45","46","47","48","49","50",
    "51","53","54","55","56","11","60","66","69","72","78"
  ),
  state = c(
    "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA",
    "KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ",
    "NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT",
    "VA","WA","WV","WI","WY","DC","AS","GU","MP","PR","VI"
  ),
  stringsAsFactors = FALSE
)

# custom transformers
state_to_fips <- function(state_code) {
  res <- fips_state_map$fips[match(state_code, fips_state_map$state)]
  return(res)
}

fips_to_state <- function(fips_code) {
  # make sure fips_code is character
  fips_code <- sprintf("%02s", as.character(fips_code))
  res <- fips_state_map$state[match(fips_code, fips_state_map$fips)]
  return(res)
}

# test
fips_to_state("01")  # shoule be "AL"
fips_to_state(9)     # shoule be "CT"
fips_to_state(23)   # shoule be ME
fips_to_state(44)   # shoule be RI
fips_to_state(6)   # shoule be CA
```

### house map generation function

```{r}
#| label: map function
#| echo: false

# ------------------ house map function ------------------
plot_decision_map_by_congress <- function(congress_num,
                                          decision_data,
                                          model_type = c("adver", "legis"),
                                          save_path = NULL,
                                          save_width = 10,
                                          save_height = 7) {
  model_type <- match.arg(model_type)
  
  # ---- congress match ----
  map_year <- switch(
    as.character(congress_num),
    "115" = 2016,
    "116" = 2020,
    "117" = 2020,
    "118" = 2022,
    stop("Unsupported congress number.")
  )
  
  # ---- district match ----
  district_col <- switch(
    as.character(congress_num),
    "115" = "CD115FP",
    "116" = "CD116FP",
    "117" = "CD116FP",
    "118" = "CD118FP",
    stop("Unsupported congress number.")
  )
  
  # ---- local fallback paths ----
  local_paths <- list(
    "115" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/map data from us census/cb_2016_us_cd115_500k/cb_2016_us_cd115_500k.shp",
    "116" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/map data from us census/tl_2020_us_cd116/tl_2020_us_cd116.shp",
    "117" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/map data from us census/tl_2020_us_cd116/tl_2020_us_cd116.shp", # same as 116
    "118" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/input/map data from us census/cb_2022_us_cd118_20m/cb_2022_us_cd118_20m.shp"
  )
  
  # ---- load map data ----
  message("ğŸ—ºï¸ Loading congressional district map for ", congress_num, "th Congress...")
  cd_map <- tryCatch(
    {
      tigris::congressional_districts(cb = TRUE, year = map_year)
    },
    error = function(e) {
      message("âš ï¸ Cloud download failed. Loading from local file instead...")
      sf::st_read(local_paths[[as.character(congress_num)]], quiet = TRUE)
    }
  )
  
  # ---- map data cleaning ----
  cd_map <- cd_map %>%
    mutate(
      state_code = fips_to_state(STATEFP),
      district_code = as.character(!!rlang::sym(district_col)),
      district_clean = sprintf("%02d", as.integer(district_code)),
      state_district = stringr::str_trim(paste0(state_code, "-", district_clean))
    )
  
  # ---- decision data preparing ----
  decision_df <- decision_data %>%
    filter(congress == as.character(congress_num)) %>%
    mutate(
      state_district = stringr::str_trim(as.character(state_district)),
      party = case_when(
        party %in% c("R", "Republican", "REP") ~ "R",
        party %in% c("D", "Democratic", "DEM") ~ "D",
        party %in% c("I", "Independent", "IND") ~ "I",
        TRUE ~ NA_character_
      ),
      decision = case_when(
        decision %in% c("intl", "international") ~ "intl",
        decision %in% c("dom", "domestic") ~ "dom",
        decision %in% c("prof", "professional") ~ "prof",
        TRUE ~ NA_character_
      )
    )
  
  # ---- join map ----
  plot_df <- cd_map %>%
    left_join(decision_df %>% dplyr::select(state_district, decision, party),
              by = "state_district") %>%
    mutate(
      group_var = ifelse(
        is.na(party) | is.na(decision) | party == "" | decision == "",
        "missing",
        paste0(party, "_", decision)
      )
    )
  
  # ---- color scheme ----
  pal_vec <- c(
    "R_intl" = "#ef8a62", "R_dom" = "#b2182b", "R_prof" = "#fddbc7",
    "I_intl" = "#9e9ac8", "I_dom" = "#756bb1", "I_prof" = "#dadaeb",
    "D_intl" = "#67a9cf", "D_dom" = "#2166ac", "D_prof" = "#d1e5f0",
    "missing" = "grey80"
  )
  
  all_levels <- names(pal_vec)
  plot_df <- plot_df %>%
    mutate(group_var = factor(group_var, levels = all_levels))
  
  # ---- main map ----
  main_map <- ggplot(plot_df) +
    geom_sf(aes(fill = group_var), color = "white", size = 0.1) +
    scale_fill_manual(values = pal_vec, drop = FALSE, name = "Party + Decision") +
    labs(
      title = paste0(
        ifelse(model_type == "adver", "Adver", "Legis"),
        " Decision Mode by District (", congress_num, "th Congress)"
      )
    ) +
    theme_minimal(base_size = 14) +
    theme(legend.position = "bottom") +
    coord_sf(xlim = c(-125, -65), ylim = c(24, 50), expand = FALSE)
  
  # ---- Alaska & Hawaii ----
  alaska_map <- ggplot(filter(plot_df, state_code == "AK")) +
    geom_sf(aes(fill = group_var), color = "white", size = 0.1) +
    scale_fill_manual(values = pal_vec, guide = "none") +
    coord_sf(xlim = c(-180, -130), ylim = c(50, 72), expand = FALSE) +
    theme_void()
  
  hawaii_map <- ggplot(filter(plot_df, state_code == "HI")) +
    geom_sf(aes(fill = group_var), color = "white", size = 0.1) +
    scale_fill_manual(values = pal_vec, guide = "none") +
    coord_sf(xlim = c(-161, -154), ylim = c(18, 23), expand = FALSE) +
    theme_void()
  
  # ---- combine ----
  final_map <- cowplot::ggdraw() +
    cowplot::draw_plot(main_map, 0, 0, 1, 1) +
    cowplot::draw_plot(alaska_map, x = 0.03, y = 0.15, width = 0.25, height = 0.25) +
    cowplot::draw_plot(hawaii_map, x = 0.20, y = 0.15, width = 0.25, height = 0.25)
  
  if (!is.null(save_path)) {
    ggsave(filename = save_path, plot = final_map, width = save_width, height = save_height)
  }
  
  return(final_map)
}

# ---- application ----
# adver
plot_decision_map_by_congress(115, adver_cg_heatmap, model_type = "adver",
                               save_path = "adver_115_map.png")

plot_decision_map_by_congress(116, adver_cg_heatmap, model_type = "adver",
                              save_path = "adver_116_map.png")

plot_decision_map_by_congress(117, adver_cg_heatmap, model_type = "adver",
                              save_path = "adver_117_map.png")

plot_decision_map_by_congress(118, adver_cg_heatmap, model_type = "adver",
                              save_path = "adver_118_map.png")

# legis

plot_decision_map_by_congress(115, legis_cg_heatmap, model_type = "legis",
                              save_path = "legis_115_map.png")

plot_decision_map_by_congress(116, legis_cg_heatmap, model_type = "legis",
                              save_path = "legis_116_map.png")

plot_decision_map_by_congress(117, legis_cg_heatmap, model_type = "legis",
                              save_path = "legis_117_map.png")

plot_decision_map_by_congress(118, legis_cg_heatmap, model_type = "legis",
                              save_path = "legis_118_map.png")
```

### senate map function (need further debug)

```{r}
#| label: senate map function
#| echo: false

# ------------------ senate map functionï¼ˆneeds further debugï¼‰ ------------------
#plot_decision_map_by_congress_senate_debug <- function(congress_num,
#                                                       decision_data,
#                                                       model_type = c("adver", "legis"),
#                                                       save_path = NULL,
#                                                       save_width = 10,
#                                                       save_height = 7,
#                                                       shapefile_path = #"cb_2020_us_state_20m/cb_2020_us_state_20m.shp") {
#  library(dplyr)
#  library(sf)
#  library(ggplot2)
#  library(stringr)
  
#  model_type <- match.arg(model_type)
  
#  cat("???? å¼€å§‹è¯»å–å·åœ°å›¾...\n")
#  states_map <- sf::st_read(shapefile_path, quiet = TRUE) %>%
#    filter(!STUSPS %in% c("PR", "VI", "GU", "MP", "AS")) %>%
#    mutate(state_code = toupper(STUSPS))
  
#  cat("å·åœ°å›¾æ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(states_map %>% st_drop_geometry() %>% select(STATEFP, STUSPS, state_code)))
  
#  cat("???? è¯»å–å†³ç­–æ•°æ®...\n")
  
#  decision_df <- decision_data %>%
#    filter(congress == as.character(congress_num)) %>%
#    mutate(
#      state_code = toupper(str_trim(as.character(state_code))),
#      party = as.character(party),
#      decision = as.character(decision)
#    ) %>%
#    group_by(state_code) %>%
#    summarize(
#      party = first(na.omit(party)),
#      decision = first(na.omit(decision)),
#      group_var = ifelse(
#        is.na(party) | is.na(decision) | party == "" | decision == "",
#        "missing",
#        paste0(party, "_", decision)
#      ),
#      .groups = "drop"
#    )
  
#  cat("å†³ç­–æ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(decision_df))
  
#  missing_states <- setdiff(decision_df$state_code, states_map$state_code)
#  if (length(missing_states) > 0) {
#    warning("è¿™äº› state_code åœ¨åœ°å›¾æ•°æ®ä¸­æ‰¾ä¸åˆ°: ", paste(missing_states, collapse = ", #"))
#  } else {
#    cat("??? æ‰€æœ‰ state_code éƒ½åŒ¹é…ã€‚\n")
#  }
  
#  cat("???? è®¡ç®—å·ä¸­å¿ƒç‚¹...\n")
#  state_centroids <- states_map %>%
#    st_centroid() %>%
#    st_coordinates() %>%
#    as.data.frame() %>%
#    mutate(state_code = states_map$state_code)
  
#  cat("å·ä¸­å¿ƒç‚¹æ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(state_centroids))
  
#  cat("???? åˆå¹¶å†³ç­–æ•°æ®å’Œä¸­å¿ƒç‚¹...\n")
#  plot_points <- decision_df %>%
#    left_join(state_centroids, by = "state_code")
  
#  cat("åˆå¹¶åæ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(plot_points))
  
#  if (nrow(plot_points) == 0) {
#    stop("??? åˆå¹¶åæ²¡æœ‰æ•°æ®ï¼è¯·æ£€æŸ¥ state_code æ˜¯å¦ä¸€è‡´ã€‚")
#  }
  
#  plot_points <- plot_points %>%
#    group_by(state_code) %>%
#    mutate(
#      X = X + runif(n(), -0.3, 0.3),
#      Y = Y + runif(n(), -0.3, 0.3)
#    ) %>%
#    ungroup()
  
#  pal_vec <- c(
#    "R_intl"  = "#b2182b", "R_dom"   = "#ef8a62", "R_prof"  = "#fddbc7",
#    "I_intl"  = "#756bb1", "I_dom"   = "#9e9ac8", "I_prof"  = "#dadaeb",
#    "D_intl"  = "#2166ac", "D_dom"   = "#67a9cf", "D_prof"  = "#d1e5f0",
#    "missing" = "grey80"
#  )
  
#  all_levels <- c("R_intl","R_dom","R_prof",
#                  "I_intl","I_dom","I_prof",
#                  "D_intl","D_dom","D_prof",
#                  "missing")
  
#  plot_points <- plot_points %>%
#    mutate(group_var = factor(group_var, levels = all_levels))
  
#  pal_vec <- pal_vec[names(pal_vec) %in% levels(plot_points$group_var)]
  
#  main_map <- ggplot() +
#    geom_sf(data = states_map, fill = "white", color = "black", size = 0.2) +
#    geom_point(data = plot_points,
#               aes(x = X, y = Y, fill = group_var),
#               shape = 21, size = 3, color = "black") +
#    scale_fill_manual(values = pal_vec, drop = FALSE, name = "Party + Decision") +
#    labs(
#      title = paste0(ifelse(model_type == "adver", "Adver", "Legis"),
#                     " Senate Decision Mode by State (", congress_num, "th)")
#    ) +
#    theme_minimal(base_size = 14) +
#    theme(legend.position = "bottom") +
#    coord_sf(xlim = c(-125, -65), ylim = c(24, 50), expand = FALSE)
  
#  if (!is.null(save_path)) {
#    ggsave(filename = save_path, plot = main_map, width = save_width, height = #save_height)
#  }
  
#  return(list(
#    plot = main_map,
#    states_map = states_map,
#    decision_df = decision_df,
#    state_centroids = state_centroids,
#    plot_points = plot_points
#  ))
#}
```

```{r}
#| label: senate map debug
#| echo: false

# plot_decision_map_by_congress_senate_debug(
#  115,
#  adver_cg_heatmap1,
#  model_type = "adver",
#  save_path = "adver_115_map_state.png",
#  shapefile_path = "cb_2020_us_state_20m/cb_2020_us_state_20m.shp"
#)

#unique(states_map$state_code)
#unique(adver_cg_heatmap1$state_code)

# map cleansing ----

# 1. è¯»å–æœ¬åœ° shapefile
#states_map <- st_read("cb_2020_us_state_20m/cb_2020_us_state_20m.shp")

# 2. å»æ‰ä¸æ˜¯å·çš„åŒºåŸŸï¼ˆæ¯”å¦‚æ³¢å¤šé»å„ã€å…³å²›ç­‰ï¼‰
#states_map <- states_map %>% 
#  filter(!STUSPS %in% c("PR", "VI", "GU", "MP", "AS"))

# 3. æ”¹åˆ—åï¼ŒæŠŠ STUSPS ä½œä¸º state_code
#states_map <- states_map %>%
#  mutate(state_code = STUSPS)

# 4. åˆå¹¶ shapefile å’Œä½ çš„æ•°æ®
#plot_df <- states_map %>%
#  left_join(adver_cg_heatmap1 %>% 
#              select(state_code, decision, party),
#            by = "state_code") %>%
#  mutate(
#    party = as.character(party),
#    decision = as.character(decision),
#    group_var = ifelse(
#      is.na(party) | is.na(decision) | party == "" | decision == "",
#      "missing",
#      paste0(party, "_", decision)
#    )
#  )

```

# overall descriptive analysis for issues

## analysis based on original data

### news_data

hereby using original data news_data and bills_data to depict issues

```{r}
#| label: news_data cleansing
#| echo: false

news_data_aug <- news_data %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    adver_cg %>%
      mutate(congress = as.integer(congress)) %>% 
      dplyr::select(bioguide_id, congress, chamber, gender, party, committee_el),
    by = c("mid" = "bioguide_id", "congress" = "congress")
  )

news_data$congress <- as.character(news_data$congress)

missing_keys <- news_data %>%
  dplyr::select(mid, congress) %>%
  distinct() %>%
  anti_join(adver_sum1 %>% dplyr::select(bioguide_id, congress) %>% distinct(),
            by = c("mid" = "bioguide_id", "congress"))

news_data_clean <- news_data_aug %>%
  filter(!is.na(chamber), !is.na(gender), !is.na(party)) 
# already proven that these data belongs to legislators who did not continue to serve the congress

```

issues have major change on news data from 115th to 118th congress

```{r}
#| label: issues news dramatic change
#| echo: false

issue_trend <- news_data_clean %>%
  group_by(congress, issue) %>%
  summarise(news_count = n(), .groups = "drop")

# find the most drastic change 
issue_trend_change <- issue_trend %>%
  group_by(issue) %>%
  summarize(
    change = (news_count[congress == max(as.numeric(congress))] - news_count[congress == min(as.numeric(congress))]) /
             news_count[congress == min(as.numeric(congress))],
    .groups = "drop"
  ) %>%
  arrange(desc(abs(change)))  # rank according to the absolute change

top_issues <- issue_trend_change %>% slice(1:10) %>% pull(issue)


# plot
p <- ggplot(issue_trend %>% filter(issue %in% top_issues),
       aes(x = as.numeric(congress), y = news_count, color = issue)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "issue change 115â€“118",
    x = "Congress",
    y = "news number",
    color = "issue"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Dark2") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

ggsave("issue change most 115â€“118_news.png", plot = p, width = 8, height = 4, dpi = 300)
```

trends plot for all issues

```{r}
#| label: issues news all trend
#| echo: false

n_colors <- length(unique(issue_trend$issue)) # è·å–è®®é¢˜æ•°é‡
colors <- distinctColorPalette(n_colors)

p <- ggplot(issue_trend, aes(x = as.numeric(congress), y = news_count, color = issue)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "issue change per Congress",
    x = "Congress",
    y = "news number",
    color = "issue"
  ) +
  theme_minimal() +
  scale_color_manual(values = colors) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )


ggsave("issue change all 115â€“118_news.png", plot = p, width = 10, height = 8, dpi = 300)
```

issue attention by gender and party

```{r}
#| label: gender party issue attention
#| echo: false

# 1. æ¯ä¸ªè®®å‘˜åœ¨æ¯å±Šå¯¹æŸè®®é¢˜çš„å…³æ³¨æ¬¡æ•°
issue_counts_mid <- news_data_clean %>%
  group_by(congress, gender, party, mid, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. èšåˆåˆ° gender Ã— party å±‚é¢
issue_counts_gender_party <- issue_counts_mid %>%
  group_by(congress, gender, party, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

# 3. å–æ¯å±Šæ¯ä¸ª gender Ã— party çš„ Top 5 è®®é¢˜
top_issues_gender_party <- issue_counts_gender_party %>%
  group_by(congress, gender, party) %>%
  slice_max(order_by = total_mentions, n = 5, with_ties = FALSE) %>%
  arrange(congress, gender, party, desc(total_mentions))

# æŸ¥çœ‹ç»“æœ
top_issues_gender_party

# å¯¼å‡ºä¸º CSV
write.csv(top_issues_gender_party, "top_issues_gender_party_news.csv", row.names = FALSE)

```

calculating shanon-entropy for issue news

```{r}
#| label: issues shanon entropy news
#| echo: false

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress Ã— issue çš„å‡ºç°æ¬¡æ•°
issue_dist <- news_data_clean %>%
  filter(!is.na(mid), !is.na(issue), !is.na(congress)) %>%
  group_by(mid, congress, issue, gender, chamber, party) %>%
  summarise(n = n(), .groups = "drop")

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress çš„æ€»æ–°é—»æ•°
issue_total <- issue_dist %>%
  group_by(mid, congress, gender, chamber, party) %>%
  summarise(total = sum(n), .groups = "drop")

# åˆå¹¶å¹¶è®¡ç®— p_k
issue_prob <- issue_dist %>%
  left_join(issue_total,
            by = c("mid", "congress", "gender", "chamber", "party")) %>%
  mutate(p = n / total)

# è®¡ç®— Shannon entropy
entropy_news <- issue_prob %>%
  group_by(mid, congress, gender, chamber, party) %>%
  summarise(
    shannon_entropy = -sum(p * log(p)),   # é»˜è®¤è‡ªç„¶å¯¹æ•°
    n_issues = n_distinct(issue),
    total_news = sum(n),
    .groups = "drop"
  )
head(entropy_news)

# plot
entropy_summary <- entropy_news %>%
  group_by(congress) %>%
  summarise(mean_entropy = mean(shannon_entropy, na.rm = TRUE),
            median_entropy = median(shannon_entropy, na.rm = TRUE))
p <- ggplot(entropy_summary, aes(x = congress, y = mean_entropy)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x = "Congress", y = "Mean Shannon Entropy",
       title = "News Average Attention Diversity by Congress")

ggsave("Average Attention Diversity by Congress-news.png", plot = p, width = 8, height = 4, dpi = 300)
```

### bills data

bills data cleansing

```{r}
#| label: bills data cleansing
#| echo: false

bills_data_aug <- bills_data %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    legis_cg %>%
      mutate(congress = as.integer(congress)) %>% 
      dplyr::select(bioguide_id, congress, chamber, gender, party, committee_el),
    by = c("bioguide_id" = "bioguide_id", "congress" = "congress")
  )

summary(bills_data_aug)
sum(is.na(bills_data_aug$party))
```

issues have major change on bills data from 115th to 118th congress

```{r}
#| label: issues bills dramatic change
#| echo: false

issue_trend <- bills_data_aug %>%
  group_by(congress, issue) %>%
  summarise(news_count = n(), .groups = "drop")

# ----- æ‰¾å‡ºå˜åŒ–æœ€å‰§çƒˆçš„è®®é¢˜ -----
issue_trend_change <- issue_trend %>%
  group_by(issue) %>%
  summarize(
    change = (news_count[congress == max(as.numeric(congress))] - news_count[congress == min(as.numeric(congress))]) /
             news_count[congress == min(as.numeric(congress))],
    .groups = "drop"
  ) %>%
  arrange(desc(abs(change)))  # æŒ‰ç»å¯¹å˜åŒ–æ’åº
top_issues <- issue_trend_change %>% slice(1:10) %>% pull(issue)

# ----- plot -----
p <- ggplot(issue_trend %>% filter(issue %in% top_issues),
       aes(x = as.numeric(congress), y = news_count, color = issue)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Top Issues Trend Across Congress 115â€“118",
    x = "Congress",
    y = "bills number",
    color = "issue"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Paired") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

ggsave("issue change most 115â€“118_bills.png", plot = p, width = 8, height = 4, dpi = 300)
```

bills trends plot for all issues

```{r}
#| label: issues bills all trend
#| echo: false
#| 
n_colors <- length(unique(issue_trend$issue)) # è·å–è®®é¢˜æ•°é‡
colors <- distinctColorPalette(n_colors)

p <- ggplot(issue_trend, aes(x = as.numeric(congress), y = news_count, color = issue)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "issue change per Congress",
    x = "Congress",
    y = "bills number",
    color = "issue"
  ) +
  theme_minimal() +
  scale_color_manual(values = colors) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )


ggsave("issue change all 115â€“118_bills.png", plot = p, width = 10, height = 8, dpi = 300)
```

calculating shanon-entropy for bills news

```{r}
#| label: issues shanon entropy bills
#| echo: false

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress Ã— issue çš„å‡ºç°æ¬¡æ•°
issue_dist <- bills_data_aug %>%
  filter(!is.na(bioguide_id), !is.na(issue), !is.na(congress)) %>%
  group_by(bioguide_id, congress, issue, gender, chamber, party) %>%
  summarise(n = n(), .groups = "drop")

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress çš„æ€»æ–°é—»æ•°
issue_total <- issue_dist %>%
  group_by(bioguide_id, congress, gender, chamber, party) %>%
  summarise(total = sum(n), .groups = "drop")

# åˆå¹¶å¹¶è®¡ç®— p_k
issue_prob <- issue_dist %>%
  left_join(issue_total,
            by = c("bioguide_id", "congress", "gender", "chamber", "party")) %>%
  mutate(p = n / total)

# è®¡ç®— Shannon entropy
entropy_bills <- issue_prob %>%
  group_by(bioguide_id, congress, gender, chamber, party) %>%
  summarise(
    shannon_entropy = -sum(p * log(p)),   # é»˜è®¤è‡ªç„¶å¯¹æ•°
    n_issues = n_distinct(issue),
    total_news = sum(n),
    .groups = "drop"
  )
head(entropy_bills)

# violin plot
ggplot(entropy_bills, aes(x = factor(congress), y = shannon_entropy)) +
  geom_violin(fill = "skyblue", alpha = 0.5) +
  geom_boxplot(width = 0.1, outlier.size = 0.5) +
  theme_minimal() +
  labs(x = "Congress", y = "Shannon Entropy",
       title = "Distribution of Attention Diversity per Congress")

# line graph
entropy_summary <- entropy_bills %>%
  group_by(congress) %>%
  summarise(mean_entropy = mean(shannon_entropy, na.rm = TRUE),
            median_entropy = median(shannon_entropy, na.rm = TRUE))
p <- ggplot(entropy_summary, aes(x = congress, y = mean_entropy)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x = "Congress", y = "Mean Shannon Entropy",
       title = "Bills Average Attention Diversity by Congress")

ggsave("Average Attention Diversity by Congress-bills.png", plot = p, width = 8, height = 4, dpi = 300)
```

## issue analysis using adver_tp and legis_tp

### issue heatmap by congress

```{r}
#| label: issue heatmap by congress
#| echo: false

plot_decision_mode_heatmap <- function(df, title = "Decision Mode by Issue and Congress", save_path = NULL) {

  # æ£€æŸ¥å˜é‡
  required_vars <- c("issue", "congress", "decision")
  if (!all(required_vars %in% names(df))) {
    stop("Input dataframe must contain columns: issue, congress, decision.")
  }

  # æ•°æ®å‡†å¤‡
  df <- df %>%
    dplyr::mutate(
      decision = factor(decision, levels = c("intl", "dom", "prof")),
      congress = as.factor(congress)
    )

  # ç»˜å›¾
  p <- ggplot(df, aes(x = congress, y = reorder(issue, desc(issue)), fill = decision)) +
    geom_tile(color = "white") +
    scale_fill_manual(
      values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c"),
      na.value = "grey90"
    ) +
    labs(
      title = title,
      x = "Congress",
      y = "Issue",
      fill = "Decision Mode"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid = element_blank()
    )

  # ä¿å­˜å›¾ç‰‡ï¼ˆå¦‚æœæä¾›äº†è·¯å¾„ï¼‰
  if (!is.null(save_path)) {
    ggsave(filename = save_path, plot = p, width = 8, height = 6, dpi = 300)
  }

  return(p)
}

# use of function plot_decision_mode_heatmap()
plot_decision_mode_heatmap(legis_tp, title = "Legislative Decision Mode by Issue and Congress", save_path = "legis_mode.png")
plot_decision_mode_heatmap(adver_tp, title = "Advertise Decision Mode by Issue and Congress", save_path = "adver_mode.png")

```

### focal issue of each congress

```{r}
#| label: congress focal issue
#| echo: false

plot_issue_trend_by_congress <- function(df, 
                                         save_path = NULL, 
                                         file_name = "issue_trend_heatmap.png",
                                         width = 10, 
                                         height = 8, 
                                         dpi = 300,
                                         scale_type = c("raw", "normalized", "log")) {

  scale_type <- match.arg(scale_type)

  issue_congress_label <- df %>%
    filter(!is.na(issue), !is.na(congress), !is.na(label)) %>%
    group_by(congress, issue) %>%
    summarise(total_label = sum(label, na.rm = TRUE), .groups = "drop")

  # Apply scale transformation
  if (scale_type == "normalized") {
    issue_congress_label <- issue_congress_label %>%
      group_by(congress) %>%
      mutate(scaled_label = total_label / sum(total_label, na.rm = TRUE)) %>%
      ungroup()
    fill_col <- "scaled_label"
    fill_title <- "Normalized\nProportion"
  } else if (scale_type == "log") {
    issue_congress_label <- issue_congress_label %>%
      mutate(scaled_label = log1p(total_label))  # log(1 + x)
    fill_col <- "scaled_label"
    fill_title <- "Log(Label + 1)"
  } else {
    fill_col <- "total_label"
    fill_title <- "Label Count"
  }

  heatmap_plot <- ggplot(issue_congress_label, aes(x = factor(congress), y = reorder(issue, desc(issue)), fill = .data[[fill_col]])) +
    geom_tile(color = "white") +
    scale_fill_gradient(low = "#fee8c8", high = "#e34a33") +
    labs(
      title = "Most Discussed Issues by Congress",
      x = "Congress",
      y = "Issue",
      fill = fill_title
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  print(heatmap_plot)

  if (!is.null(save_path)) {
    ggsave(filename = save_path, plot = heatmap_plot, width = width, height = height, dpi = dpi)
  }

  return(invisible(heatmap_plot))
}

plot_issue_trend_by_congress(adver_tp, save_path = "adver_issue_trend.png", scale_type = "normalized")
plot_issue_trend_by_congress(legis_tp, save_path ="legis_issue_trend.png", scale_type = "normalized")

```

# lgbm features importance analysis

# key characteristics analysis 

this part will use regression and logistic model to see the key relationship between legislators' personal characteristics and decision mode

## dependent variables: is.dom 

### data cleansing

```{r}
#| label: is.dom data preparing
#| echo: false

# turn decision into is.dom
adver_cg <- adver_cg %>%
  mutate(is.dom = ifelse(decision == "dom", 1, 0))
legis_cg <- legis_cg %>%
  mutate(is.dom = ifelse(decision == "dom", 1, 0))

# turn party into is.republican
adver_cg <- adver_cg %>% 
  mutate(is.republican = ifelse(party == "Republican", 1, 0))
legis_cg <- legis_cg %>% 
  mutate(is.republican = ifelse(party == "Republican", 1, 0))

# turn categorical vector into numeric 
adver_cg$gender_numeric <- ifelse(adver_cg$gender == "Male", 1, 0)
legis_cg$gender_numeric <- ifelse(legis_cg$gender == "Male", 1, 0)

legis_cg$chamber_numeric <- ifelse(legis_cg$chamber == "Senate", 1, 0)
adver_cg$chamber_numeric <- ifelse(adver_cg$chamber == "Senate", 1, 0)
```

check co-linearity

```{r}
#| label: is.dom co-linerality check
#| echo: false

# age vs seniority
cor(adver_cg$age, adver_cg$seniority, use = "complete.obs")
cor(legis_cg$age, legis_cg$seniority, use = "complete.obs")

# ideology vs chamber
boxplot(ideology ~ is.republican, data = adver_cg)
boxplot(ideology ~ is.republican, data = legis_cg)
cor.test(adver_cg$ideology, adver_cg$is.republican, method = "pearson") 

# ideology vs chamber
boxplot(ideology ~ chamber, data = adver_cg)
boxplot(ideology ~ chamber, data = legis_cg)
cor.test(adver_cg$ideology, adver_cg$chamber_numeric, method = "pearson") 

boxplot(ideology ~ gender, data = adver_cg)
boxplot(ideology ~ gender, data = legis_cg)
cor.test(adver_cg$ideology, adver_cg$gender_numeric, method = "pearson") 

# is.republican vs chamber
table(adver_cg$is.republican, adver_cg$chamber)
chisq.test(table(adver_cg$is.republican, adver_cg$chamber))

table(legis_cg$is.republican, legis_cg$chamber)
chisq.test(table(legis_cg$is.republican, legis_cg$chamber))

# is.republican vs gender
table(adver_cg$is.republican, adver_cg$gender)
chisq.test(table(adver_cg$is.republican, adver_cg$chamber))

table(legis_cg$is.republican, legis_cg$chamber)
chisq.test(table(legis_cg$is.republican, legis_cg$chamber))
```

### multiple variables logit model 

lasso

```{r}
#| label: is.dom logit mul1
#| echo: false

run_glmnet_selection <- function(data, formula, alpha = 1, family = "binomial") {
  # å¤„ç†ç¼ºå¤±å€¼
  complete_data <- model.frame(formula, data = data, na.action = na.omit)
  
  # è‡ªå˜é‡çŸ©é˜µ
  X <- model.matrix(formula, data = complete_data)[,-1]
  
  # å› å˜é‡
  y <- complete_data[[as.character(formula[[2]])]]
  
  # æ‹Ÿåˆ lasso/ridge/elnet
  cv_fit <- cv.glmnet(X, y, family = family, alpha = alpha)
  
  # å¯è§†åŒ–äº¤å‰éªŒè¯è¯¯å·®
  plot(cv_fit, main = paste("CV for alpha =", alpha, ", family =", family))
  
  # è¾“å‡ºæœ€ä½³ lambda å’Œç³»æ•°
  cat("Best lambda:", cv_fit$lambda.min, "\n")
  print(coef(cv_fit, s = "lambda.min"))
  
  return(cv_fit)
}

# adver
cv_lasso_adver <- run_glmnet_selection(adver_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "binomial")
cv_ridge_adver <- run_glmnet_selection(adver_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "binomial")
cv_elnet_adver <- run_glmnet_selection(adver_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "binomial")

# legis
cv_lasso_legis <- run_glmnet_selection(legis_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "binomial")
cv_ridge_legis <- run_glmnet_selection(legis_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "binomial")
cv_elnet_legis <- run_glmnet_selection(legis_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "binomial")
```

set reference

```{r}
#| label: is.dom logit mul2
#| echo: false

# set references
set_reference_levels <- function(df,
                                 ref_party = "democratic",
                                 ref_is.republican = "0",
                                 ref_chamber = "Senate") {
  
  if ("party" %in% names(df)) {
    df$party <- factor(df$party)  # è½¬æ¢ä¸ºfactor
    df$party <- relevel(df$party, ref = ref_party)  # è®¾ç½®reference level
  }
  
   if ("party" %in% names(df)) {
    df$is.republican <- factor(df$is.republican)  # è½¬æ¢ä¸ºfactor
    df$is.republican <- relevel(df$is.republican, ref = ref_is.republican)  # è®¾ç½®reference level
  }
  
  if ("chamber" %in% names(df)) {
    df$chamber <- factor(df$chamber)
    df$chamber <- relevel(df$chamber, ref = ref_chamber)
  }
  
  return(df)
}

adver_cg <- set_reference_levels(adver_cg,
                                 ref_party = "Democratic",
                                 ref_is.republican = "0",
                                 ref_chamber = "senate")

legis_cg <- set_reference_levels(legis_cg,
                                 ref_party = "Democratic",
                                 ref_is.republican = "0",
                                 ref_chamber = "senate")
```

set analysis function to save time

```{r}
#| label: is.dom logit mul3
#| echo: false

# analysis function
analyze_logit_model <- function(model) {
  library(broom)
  
  tidy_model <- tryCatch(
    tidy(model, conf.int = TRUE),
    error = function(e) {
      message("Error in tidy(): ", e$message)
      return(NULL)
    }
  )
  
  if (is.null(tidy_model)) return(NULL)
  
  # æ£€æŸ¥æ˜¯å¦åŒ…å« conf.low å’Œ conf.highï¼Œè‹¥æ— åˆ™ç”¨ NA å¡«å……
  if (!"conf.low" %in% names(tidy_model)) tidy_model$conf.low <- NA
  if (!"conf.high" %in% names(tidy_model)) tidy_model$conf.high <- NA
  
  coefs <- tidy_model %>%
    mutate(
      odds_ratio = exp(estimate),
      conf.low.or = exp(conf.low),
      conf.high.or = exp(conf.high),
      significance = case_when(
        p.value < 0.001 ~ "***",
        p.value < 0.01  ~ "**",
        p.value < 0.05  ~ "*",
        p.value < 0.1   ~ ".",
        TRUE ~ ""
      )
    ) %>%
    dplyr::select(term, estimate, odds_ratio, conf.low.or, conf.high.or,
           std.error, p.value, significance)
  
  print(summary(model))
  print(coefs)
  
  # pseudo R-squared (McFadden)
  if (requireNamespace("pscl", quietly = TRUE)) {
    library(pscl)
    cat("\nPseudo R-squared:\n")
    print(pscl::pR2(model))
  } else {
    message("Install 'pscl' package for pseudo R-squared calculation.")
  }
  
  return(coefs)
}
```

models training - adver

```{r}
#| label: is.dom logit mul4
#| echo: false

# model 0
adver_logit0 <- glm(is.dom ~ age + is.republican + ideology + chamber + seniority + gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# adjusted model
adver_logit1 <- glm(is.dom ~ age +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit2 <- glm(is.dom ~ age +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit3 <- glm(is.dom ~ seniority +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit4 <- glm(is.dom ~ seniority +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# results
modelsummary(
  list(
    "Adver All" = adver_logit0,
    "1" = adver_logit1,
    "2" = adver_logit2,
    "3" = adver_logit3,
    "4" = adver_logit4
  ),
  fmt = 3,
  stars = TRUE,
  output = "logitmodel_adver_isdom.html",
  escape = FALSE,
  gof_omit = "AIC|BIC"
)

# ---- vif check ----
vif(adver_logit0)
vif(adver_logit1)
vif(adver_logit2)
vif(adver_logit3)
vif(adver_logit4)
```

models training - legis

```{r}
#| label: is.dom logit mul5
#| echo: false

# model 0
legis_logit0 <- glm(is.dom ~ age + is.republican + ideology + chamber + seniority + gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# adjusted models
legis_logit1 <- glm(is.dom ~ age +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

legis_logit2 <- glm(is.dom ~ age +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

legis_logit3 <- glm(is.dom ~ seniority +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

legis_logit4 <- glm(is.dom ~ seniority +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# results
modelsummary(
  list(
    "Legis All" = legis_logit0,
    "1" = legis_logit1,
    "2" = legis_logit2,
    "3" = legis_logit3,
    "4" = legis_logit4
  ),
  fmt = 3,
  stars = TRUE,
  output = "logitmodel_legis_isdom.html",
  escape = FALSE,
  gof_omit = "AIC|BIC"
)

# ---- vif check ----
vif(legis_logit0)
vif(legis_logit1)
vif(legis_logit2)
vif(legis_logit3)
vif(legis_logit4)
```

#### residual check for logit model

```{r}
#| label: logit model residual check
#| echo: false

plot_logit_residuals <- function(model_list, data, output_dir = "logit_residual_plots", n = 1000) {
  
  # å¦‚æœè¾“å‡ºæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå°±æ–°å»º
  if (!dir.exists(output_dir)) {
    dir.create(output_dir)
  }
  
  for (model_name in names(model_list)) {
    model <- model_list[[model_name]]
    
    # ç”Ÿæˆæ®‹å·®
    res <- simulateResiduals(fittedModel = model, n = n)
    
    # è‡ªåŠ¨è·å–è‡ªå˜é‡ï¼ˆå»æ‰å› å˜é‡ï¼‰
    predictors <- all.vars(formula(model))[-1]
    predictors <- predictors[predictors %in% colnames(data)]  # åªä¿ç•™å­˜åœ¨çš„åˆ—
    
    # è®¾ç½®è¾“å‡ºæ–‡ä»¶ï¼ˆä¸€ä¸ªå¤§å›¾ï¼‰
    png(file.path(output_dir, paste0("residuals_", model_name, "_all.png")),
        width = 2400, height = 1600, res = 200)
    
    # è®¾ç½®å¤§å›¾å¸ƒå±€ï¼šæ ¹æ®å˜é‡ä¸ªæ•°è‡ªåŠ¨æ’ç‰ˆï¼ˆ2åˆ—ï¼‰
    n_pred <- length(predictors)
    n_row <- ceiling(n_pred / 2)
    par(mfrow = c(n_row, 2), mar = c(4, 4, 3, 1))  # è°ƒæ•´è¾¹è·ï¼Œé¿å…æ ‡é¢˜é‡å 
    
    # éå† predictor ç”»å­å›¾
    for (var in predictors) {
      plotResiduals(res, predictor = data[[var]],
                    main = paste("Residuals vs", var, "\n(", model_name, ")"))
    }
    
    dev.off()
  }
  
  cat("âœ… æ¯ä¸ªæ¨¡å‹çš„æ‰€æœ‰ predictor æ®‹å·®å›¾å·²åˆå¹¶ä¿å­˜è‡³ï¼š", output_dir, "\n")
}

# ----------------------------

# æ¨¡å‹åˆ—è¡¨
model_list_adver_dom_logit <- list(
  "adver_dom_logit1" = adver_logit1,
  "adver_dom_logit2" = adver_logit2,
  "adver_dom_logit3" = adver_logit3,
  "adver_dom_logit4" = adver_logit4
)

model_list_legis_dom_logit <- list(
  "legis_dom_logit1" = legis_logit1,
  "legis_dom_logit2" = legis_logit2,
  "legis_dom_logit3" = legis_logit3,
  "legis_dom_logit4" = legis_logit4
)

# è°ƒç”¨å‡½æ•°
plot_logit_residuals(model_list_adver_dom_logit, adver_cg)
plot_logit_residuals(model_list_legis_dom_logit, legis_cg)
```

### single variable logit model 

models training - adver

```{r}
#| label: is.dom logit sin1
#| echo: false

#adver
adver_logit_age <- glm(is.dom ~ age + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_ideology <- glm(is.dom ~ ideology + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_is.republican <- glm(is.dom ~ is.republican + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_gender <- glm(is.dom ~ gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_chamber <- glm(is.dom ~ chamber + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_seniority <- glm(is.dom ~ seniority + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# result
modelsummary(
  list(
    "1" = adver_logit_age,
    "2" = adver_logit_ideology,
    "3" = adver_logit_is.republican,
    "4" = adver_logit_gender,
    "5" = adver_logit_chamber,
    "6" = adver_logit_seniority
  ),
  fmt = 3,
  stars = TRUE,
  output = "logitmodel_adver_seperated_isdom.html",
  escape = FALSE,
  gof_omit = "AIC|BIC"
)
```

models training - legis

```{r}
#| label: is.dom logit sin2
#| echo: false

legis_logit_age <- glm(is.dom ~ age + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_ideology <- glm(is.dom ~ ideology + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_is.republican <- glm(is.dom ~ is.republican + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_gender <- glm(is.dom ~ gender + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_chamber <- glm(is.dom ~ chamber + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_seniority <- glm(is.dom ~ seniority + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

# result
modelsummary(
  list(
    "1" = legis_logit_age,
    "2" = legis_logit_ideology,
    "3" = legis_logit_is.republican,
    "4" = legis_logit_gender,
    "5" = legis_logit_chamber,
    "6" = legis_logit_seniority
  ),
  fmt = 3,
  stars = TRUE,
  output = "logitmodel_legis_seperated_isdom.html",
  escape = FALSE,
  gof_omit = "AIC|BIC"
)
```

coefficient plot

```{r}
#| label: is.dom coefficient plot
#| echo: false

# ----- model lists -----
adver_lm_models <- list(
  age = adver_logit_age,
  ideology = adver_logit_ideology,
  is_republican = adver_logit_is.republican,
  gender = adver_logit_gender,
  chamber = adver_logit_chamber,
  seniority = adver_logit_seniority
)

legis_lm_models <- list(
  age = legis_logit_age,
  ideology = legis_logit_ideology,
  is_republican = legis_logit_is.republican,
  gender = legis_logit_gender,
  chamber = legis_logit_chamber,
  seniority = legis_logit_seniority
)


# ----- extract coefficient and clean -----
# adver
coef_adver <- map_df(names(adver_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_adver_clean <- coef_adver %>%
  filter(!grepl("Intercept|congress", term))

# legis
coef_legis <- map_df(names(legis_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_legis_clean <- coef_legis %>%
  filter(!grepl("Intercept|congress", term))


# ----- estimate and 95% CI -----
p <- ggplot(coef_adver_clean, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
ggsave("adver_logit_single_coefficient.png", plot = p, width = 8, height = 4, dpi = 300)

p1 <- ggplot(coef_legis_clean, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
ggsave("legis_logit_single_coefficient.png", plot = p1, width = 8, height = 4, dpi = 300)

```

## dependent variables: dom_percentage 

### multiple variables regression model

lasso

```{r}
#| label: dom.percentage lm mul1
#| echo: false

# adver
cv_lasso_adver1 <- run_glmnet_selection(
  data = adver_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 1,
  family = "gaussian"  
)

cv_ridge_adver1 <- run_glmnet_selection(
  data = adver_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0,
  family = "gaussian"  
)

cv_elnet_adver1 <- run_glmnet_selection(
  data = adver_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0.5,
  family = "gaussian"  
)

# legis
cv_lasso_legis1 <- run_glmnet_selection(
  data = legis_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 1,
  family = "gaussian"  
)

cv_ridge_legis1 <- run_glmnet_selection(
  data = legis_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0,
  family = "gaussian"  
)

cv_elnet_legis1 <- run_glmnet_selection(
  data = legis_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0.5,
  family = "gaussian"  
)
```

models training - adver

```{r}
#| label: dom.percentage lm mul2
#| echo: false

# original
adver_lm0 <- lm(dom_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = adver_cg)

# adjusted
adver_lm1 <- lm(dom_percentage ~ age + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm2 <- lm(dom_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm3 <- lm(dom_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm4 <- lm(dom_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

# result
modelsummary(
  list(
    "Adver LM" = adver_lm0,
    "1" = adver_lm1,
    "2" = adver_lm2,
    "3" = adver_lm3,
    "4" = adver_lm4
  ),
  fmt = 3,
  stars = TRUE,
  output = "lmmodels_adver_dom.html",
  escape = FALSE
)

# ---- vif check ----
vif(adver_lm0)
vif(adver_lm1)
vif(adver_lm2)
vif(adver_lm3)
vif(adver_lm4)
```

models training - legis

```{r}
#| label: dom.percentage lm mul3
#| echo: false

# original
legis_lm0 <- lm(dom_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = legis_cg)

# adjusted
legis_lm1 <- lm(dom_percentage ~ age + 
                     chamber + gender + is.republican 
                     + as.factor(congress),   data = legis_cg )

legis_lm2 <- lm(dom_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm3 <- lm(dom_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm4 <- lm(dom_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "Legis LM" = legis_lm0,
    "1" = legis_lm1,
    "2" = legis_lm2,
    "3" = legis_lm3,
    "4" = legis_lm4
  ),
  fmt = 3,
  stars = TRUE,
  output = "lmmodels_legis_dom.html",
  escape = FALSE
)

# ---- vif check ----
vif(legis_lm0)
vif(legis_lm1)
vif(legis_lm2)
vif(legis_lm3)
vif(legis_lm4)
```

adver_lm0 marginal effects

```{r}
#| label: dom.percentage marginal effects adver
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age <- ggpredict(adver_lm0, terms = "age")
eff_ideo <- ggpredict(adver_lm0, terms = "ideology")
eff_sen <- ggpredict(adver_lm0, terms = "seniority")
eff_gender <- ggpredict(adver_lm0, terms = "gender")

# ideology
p1 <- ggplot(eff_ideo, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted Domestic Percentage",
    title = "Marginal Effect of Ideology on Domestic Percentage"
  ) +
  theme_minimal(base_size = 14)
ggsave("ideology_marginal_effect_adver.png", plot = p1, width = 8, height = 4, dpi = 300)
```

legis_lm0 marginal effects

```{r}
#| label: dom.percentage marginal effects legis
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age1 <- ggpredict(legis_lm0, terms = "age")
eff_ideo1 <- ggpredict(legis_lm0, terms = "ideology")
eff_sen1 <- ggpredict(legis_lm0, terms = "seniority")
eff_gender1 <- ggpredict(legis_lm0, terms = "gender")

# ideology
p2 <- ggplot(eff_ideo1, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted Domestic Percentage",
    title = "Marginal Effect of Ideology on Domestic Percentage Legis"
  ) +
  theme_minimal(base_size = 14)
ggsave("ideology_marginal_effect_legis.png", plot = p2, width = 8, height = 4, dpi = 300)
```

### single variable regression model

models training - adver

```{r}
#| label: dom.percentage lm sin1
#| echo: false

adver_cg_age1 <- lm(dom_percentage ~ age +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_ideology1 <- lm(dom_percentage ~ ideology +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_is.republican1 <- lm(dom_percentage ~ is.republican +
                     as.factor(congress), 
               data = adver_cg)

adver_cg_chamber1 <- lm(dom_percentage ~ chamber +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_gender1 <- lm(dom_percentage ~ gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_seniority1 <- lm(dom_percentage ~ seniority +
                     as.factor(congress), 
                   data = adver_cg)

# result
modelsummary(
  list(
    "1" = adver_cg_age1,
    "2" = adver_cg_ideology1,
    "3" = adver_cg_is.republican1,
    "4" = adver_cg_gender1,
    "5" = adver_cg_chamber1,
    "6" = adver_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = "lmmodel_adver_seperated_dom.html",
  escape = FALSE
)
```

models training - legis

```{r}
#| label: dom.percentage lm sin2
#| echo: false

legis_cg_age1 <- lm(dom_percentage ~ age +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_ideology1 <- lm(dom_percentage ~ ideology +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_is.republican1 <- lm(dom_percentage ~ is.republican +
                     as.factor(congress), 
               data = legis_cg)

legis_cg_chamber1 <- lm(dom_percentage ~ chamber +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_gender1 <- lm(dom_percentage ~ gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_seniority1 <- lm(dom_percentage ~ seniority +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "1" = legis_cg_age1,
    "2" = legis_cg_ideology1,
    "3" = legis_cg_is.republican1,
    "4" = legis_cg_gender1,
    "5" = legis_cg_chamber1,
    "6" = legis_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = "lmmodel_legis_seperated_dom.html",
  escape = FALSE
)
```

single variable model coefficient plot

```{r}
#| label: dom.percentage coefficient plot
#| echo: false

# ----- model lists -----
adver_lm_models <- list(
  age = adver_cg_age1,
  ideology = adver_cg_ideology1,
  is_republican = adver_cg_is.republican1,
  gender = adver_cg_gender1,
  chamber = adver_cg_chamber1,
  seniority = adver_cg_seniority1
)

legis_lm_models <- list(
  age = legis_cg_age1,
  ideology = legis_cg_ideology1,
  is_republican = legis_cg_is.republican1,
  gender = legis_cg_gender1,
  chamber = legis_cg_chamber1,
  seniority = legis_cg_seniority1
)


# ----- extract coefficient and clean -----
# adver
coef_adver <- map_df(names(adver_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_adver_clean <- coef_adver %>%
  filter(!grepl("Intercept|congress", term))

# legis
coef_legis <- map_df(names(legis_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_legis_clean <- coef_legis %>%
  filter(!grepl("Intercept|congress", term))


# ----- estimate and 95% CI -----
p <- ggplot(coef_adver_clean, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
ggsave("adver_lm_single_coefficient.png", plot = p, width = 8, height = 4, dpi = 300)

p1 <- ggplot(coef_legis_clean, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
ggsave("legis_lm_single_coefficient.png", plot = p1, width = 8, height = 4, dpi = 300)

```

### robustness check

```{r}
#| label: dom.percentage robust check
#| echo: false

# æ‰¹é‡ç”Ÿæˆçº¿æ€§æ¨¡å‹çš„è¯Šæ–­å›¾
plot_lm_diagnostics <- function(model_list, output_dir = "lm_diagnostics_plots") {
  
  if (!dir.exists(output_dir)) {
    dir.create(output_dir)
  }

  for (model_name in names(model_list)) {
    model <- model_list[[model_name]]
    
    # 1. QQ Plot
    p1 <- ggplot(model, aes(sample = .stdresid)) +
      stat_qq() + stat_qq_line(color = "red") +
      labs(title = paste0("QQ Plot - ", model_name),
           y = "Standardized Residuals") +
      theme_minimal()

    # 2. æ®‹å·® vs æ‹Ÿåˆå€¼
    df <- augment(model)
    p2 <- ggplot(df, aes(.fitted, .resid)) +
      geom_point(alpha = 0.6) +
      geom_smooth(method = "loess", se = FALSE, color = "blue") +
      geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
      labs(title = paste0("Residuals vs Fitted - ", model_name),
           x = "Fitted values", y = "Residuals") +
      theme_minimal()

    # 3. Cook's Distance
    p3 <- ggplot(df, aes(seq_along(.cooksd), .cooksd)) +
      geom_bar(stat = "identity", fill = "tomato", alpha = 0.7) +
      labs(title = paste0("Cook's Distance - ", model_name),
           x = "Observation", y = "Cook's D") +
      theme_minimal()

    # 4. æ æ†å›¾
    p4 <- ggplot(df, aes(.hat, .std.resid)) +
      geom_point(alpha = 0.6) +
      geom_smooth(method = "loess", se = FALSE, color = "blue") +
      labs(title = paste0("Leverage vs Std Residuals - ", model_name),
           x = "Leverage", y = "Standardized Residuals") +
      theme_minimal()

    # åˆå¹¶å›¾åƒ
    combined_plot <- (p1 | p2) / (p3 | p4)

    # ä¿å­˜
    ggsave(filename = file.path(output_dir, paste0("diagnostic_", model_name, ".png")),
           plot = combined_plot,
           width = 12, height = 10, dpi = 300)
  }

  cat("æ‰€æœ‰è¯Šæ–­å›¾å·²ä¿å­˜è‡³ï¼š", output_dir, "\n")
}

# è°ƒç”¨

# æ„å»ºæ¨¡å‹åˆ—è¡¨

model_adver_lm_dom_multiple <- list(
  "adver_dom0" = adver_lm0,
  "adver_dom1" = adver_lm1,
  "adver_dom2" = adver_lm2,
  "adver_dom3" = adver_lm3,
  "adver_dom4" = adver_lm4
)

models_adver_lm_dom <- list(
  "age_dom" = adver_cg_age1,
  "ideology_dom" = adver_cg_ideology1,
  "is.republican_dom" = adver_cg_is.republican1,
  "gender_dom" = adver_cg_gender1,
  "chamber_dom" = adver_cg_chamber1,
  "seniority_dom" = adver_cg_seniority1
)

model_legis_lm_dom_multiple <- list(
  "legis_dom" = legis_lm0,
  "legis_dom1" = legis_lm1,
  "legis_dom2" = legis_lm2,
  "legis_dom3" = legis_lm3,
  "legis_dom4" = legis_lm4
)

models_legis_lm_dom <- list(
  "legis_age_dom" = legis_cg_age1,
  "legis_ideology_dom" = legis_cg_ideology1,
  "legis_is.republican_dom" = legis_cg_is.republican1,
  "legis_gender_dom" = legis_cg_gender1,
  "legis_chamber_dom" = legis_cg_chamber1,
  "legis_seniority_dom" = legis_cg_seniority1
)


# è¿è¡Œå‡½æ•°
plot_lm_diagnostics(model_adver_lm_dom_multiple)
plot_lm_diagnostics(model_legis_lm_dom_multiple)
plot_lm_diagnostics(models_adver_lm_dom)
plot_lm_diagnostics(models_legis_lm_dom)

```

## interaction model

### dependent variable: is.dom

adver

```{r}
#| label: is.dom interaction adver
#| echo: false

# ideology * gender

adver_inter1 <- glm(is.dom ~ age + seniority + is.republican + chamber + ideology*gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(adver_inter1)

# ideology * gender
adver_inter2 <- glm(is.dom ~ age + seniority + is.republican + gender + chamber*ideology + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(adver_inter2)

# is.republican * gender
adver_inter3 <- glm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(legis_inter3)

# is.republican * chamber
adver_inter4 <- glm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(legis_inter4)

# effects
interact_plot(adver_inter1, pred = ideology, modx = gender, interval = TRUE)
sim_slopes(adver_inter1, pred = ideology, modx = gender)

interact_plot(adver_inter2, pred = ideology, modx = chamber, interval = TRUE)
sim_slopes(adver_inter2, pred = ideology, modx = chamber)

interact_plot(adver_inter3, pred = is.republican, modx = gender, interval = TRUE)
sim_slopes(adver_inter3, pred = is.republican, modx = gender)

interact_plot(adver_inter4, pred = is.republican, modx = chamber, interval = TRUE)
sim_slopes(adver_inter4, pred = is.republican, modx = chamber)


```

legis

```{r}
#| label: is.dom interaction legis
#| echo: false

# ideology * gender
legis_inter1 <- glm(is.dom ~ age + seniority + is.republican + chamber + ideology*gender + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter1)

# ideology * chamber
legis_inter2 <- glm(is.dom ~ age + seniority + is.republican*gender + chamber + ideology + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter2)


# is.republican * gender
legis_inter3 <- glm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter3)

# is.republican * chamber
legis_inter4 <- glm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter4)


# effects
interact_plot(legis_inter1, pred = ideology, modx = gender, interval = TRUE)
sim_slopes(legis_inter1, pred = ideology, modx = gender)

interact_plot(legis_inter2, pred = ideology, modx = chamber, interval = TRUE)
sim_slopes(legis_inter2, pred = ideology, modx = chamber)

interact_plot(legis_inter3, pred = is.republican, modx = gender, interval = TRUE)
sim_slopes(legis_inter3, pred = is.republican, modx = gender)

interact_plot(legis_inter4, pred = is.republican, modx = chamber, interval = TRUE)
sim_slopes(legis_inter4, pred = is.republican, modx = chamber)

```

### dependent variable: dom_percentage

adver

```{r}
#| label: dom.percentage interaction adver
#| echo: false

# ideology * gender
adver_lm_inter1 <- lm(dom_percentage ~ age + chamber + is.republican + ideology*gender + as.factor(congress),
                   data = adver_cg)
summary(adver_lm_inter1)

# ideology * chamber
adver_lm_inter2 <- lm(dom_percentage ~ age + ideology*chamber + is.republican + gender + as.factor(congress),
                   data = adver_cg)
summary(adver_lm_inter2)

# is.republican * gender
adver_lm_inter3 <- lm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = adver_cg)
summary(adver_lm_inter3)

# is.republican * chamber
adver_lm_inter4 <- lm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = adver_cg)
summary(adver_lm_inter4)

# ---- effect ----
interact_plot(adver_lm_inter1, pred = ideology, modx = gender, data = adver_cg)
interact_plot(adver_lm_inter2, pred = ideology, modx = chamber, data = adver_cg)
interact_plot(adver_lm_inter3, pred = is.republican, modx = gender, data = adver_cg)
interact_plot(adver_lm_inter4, pred = is.republican, modx = chamber, data = adver_cg)
```

legis

```{r}
#| label: dom.percentage interaction legis
#| echo: false

# ideology * gender
legis_lm_inter1 <- lm(dom_percentage ~ age + chamber + is.republican + ideology*gender + as.factor(congress),
                   data = legis_cg)
summary(legis_lm_inter1)

# ideology * chamber
legis_lm_inter2 <- lm(dom_percentage ~ age + ideology*chamber + is.republican + gender + as.factor(congress),
                   data = legis_cg)
summary(legis_lm_inter2)

# is.republican * gender
legis_lm_inter3 <- lm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = legis_cg)
summary(legis_lm_inter3)

# is.republican * chamber
legis_lm_inter4 <- lm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = legis_cg)
summary(legis_lm_inter4)

# ---- effect ----
interact_plot(legis_lm_inter1, pred = ideology, modx = gender, data = legis_cg)
interact_plot(legis_lm_inter2, pred = ideology, modx = chamber, data = legis_cg)
interact_plot(legis_lm_inter3, pred = is.republican, modx = gender, data = legis_cg)
interact_plot(legis_lm_inter4, pred = is.republican, modx = chamber, data = legis_cg)
```
