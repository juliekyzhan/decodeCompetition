---
title: "descriptive_analysis_1112"
author: "Kunya Zhan"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  html:
   toc: true
   toc-depth: 3
   number-sections: true
   code-fold: true
   code-summary: "Show/Hide Code"
   smooth-scroll: true
   df-print: paged
   code-tools: true
   highlight-style: atom-one
   toc-location: left
editor: visual
---

## Descriptive Analysis Party Focus

This Quarto document reorganizes the analyses from *data_mining_1111.qmd*, with a specific focus on party-level differences in legislator's legislative behavioral patterns. It consists two main sections:

\begin{itemize}

\item **Descriptive analysis**: concise the overview of the original *decodeCompetition dataset*, emphasizing cross-party contrasts in key indicators;

\item **Model-based analysis**: identifies the main characteristic shaping these patterns through regression and logistic models, highlighting how party affiliation conditions their effects.set up

\end{itemize}

1.  

    ```{r}
    #| label: setup
    #| include: false

    # Create an output directory if it doesn't exist
    output_dir <- "output"
    if (!dir.exists(output_dir)) dir.create(output_dir)

    # Default chunk options
    knitr::opts_chunk$set(
      echo = TRUE,
      fig.path = file.path(output_dir, ""),   # figures from chunks
      cache.path = file.path(output_dir, "cache/")
    )

    # A helper function to save plots/data consistently
    save_to_output <- function(filename, plot = NULL, data = NULL, ...) {
      full_path <- file.path(output_dir, filename)
      dir.create(dirname(full_path), recursive = TRUE, showWarnings = FALSE)
      
      if (!is.null(plot)) {
        ggplot2::ggsave(filename = full_path, plot = plot, ...)
        message("✅ Saved plot to: ", full_path)
      } else if (!is.null(data)) {
        write.csv(data, full_path, row.names = FALSE, ...)
        message("✅ Saved data to: ", full_path)
      } else {
        message("⚠️ No plot or data provided. Returning path only: ", full_path)
      }
      
      return(full_path)
    }
    ```

    ### Packages Installing if not already installed

    ```{r}
    #| label: install_libraries
    #| echo: false
    #| message: false
    #| warning: false

    # 设置默认 CRAN 源，防止未指定镜像导致 install.packages 报错
    options(repos = c(CRAN = "https://cloud.r-project.org"))

    # 所需包列表
    packages <- c(
      "Rcpp", "dplyr", "stringr", "readr", "ggplot2", "tidyr", "readxl", "scales", 
      "showtext", "sysfonts", "skimr", "plm", "car", "glmnet", 
      "Rtsne", "networkD3", "cluster", "factoextra", "pROC", "lme4", 
      "MuMIn", "nnet", "DHARMa", "tigris", "ggeffects", "stargazer",
      "htmltools", "tidyverse", "ggcorrplot", "purrr", "broom.mixed", 
      "performance", "lattice", "fmsb", "kableExtra", "broom", 
      "knitr", "ggnewscale", "modelsummary", "pscl", "ggfortify", 
      "rlang", "patchwork", "segmented", "tidytext", "mgcv", "splines", 
      "interactions", "RColorBrewer", "cowplot", "ggbreak", "randomcoloR",
      "marginaleffects", "ggrepel", "grid"
    )

    # Install only if missing
    for (pkg in packages) {
      if (!require(pkg, character.only = TRUE)) {
        install.packages(pkg)
      }
    }

    # Load all packages
    lapply(packages, library, character.only = TRUE)
    ```

    # 1. Data cleansing

    ## 1.1 data acquisition

    ```{r}
    #| label: load_data
    #| echo: false
    #| message: false
    #| warning: false

    # ----- main databases -----
    # train data
    legis_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/legis_analysis_all.xlsx"
    legis_all <- read_excel(legis_path)

    # lightgbm original result 
    legis_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/legis_train_data.csv")
    legis_data <- legis_data %>%
      mutate(issue = str_to_title(issue)) # clean issue format

    # lightgbm cleaned result
    # cleaning methods on "data_mining_1111.qmd"
    legis_sum1 <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/ds_input/legis_sum1.csv")

    # lightgbm cleaned result on legislator-level
    legis_cg <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/ds_input/legis_cg.csv")

    # lightgbm cleaned result on topic-level
    legis_tp <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/ds_input/legis_tp.csv")


    # ----- supplementary databases -----
    # legislator identity data
    bioguide_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/members_district_1103.xlsx"
    bioguide <- read_excel(bioguide_path)

    # original news data
    news_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/115_118_news_data_new1.csv"
    news_data <- read_csv(news_data_path)

    # original legislative data
    bills_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/115-118_congress_data_new.csv"
    bills_data <- read_csv(bills_data_path)

    # district data
    district_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/district_data/district_data.csv")
    ```

    ## 1.2 matching variables and special patch

    ```{r}
    #| label: matching variables 
    #| echo: false

    # ------ matching variables map ------
    match_vars <- c(
      "leverage_pl", "leverage_ne", "committee_pl", "committee_ne",
      "employ_industry_pl", "employ_industry_ne",
      "payroll_industry_pl", "payroll_industry_ne",
      "ethnicity_pl", "ethnicity_ne",
      "party_value_pl", "party_value_ne",
      "party_score_pl", "party_score_ne"
    )

    # ------ Add raw columns ------
    legis_data_raw <- legis_data %>%
      rename_with(.cols = all_of(match_vars), .fn = ~ paste0(.x, "_raw"))
    legis_all <- legis_all %>%
      left_join(
        legis_data_raw %>% dplyr::select(full_name, issue, congress, ends_with("_raw")),
        by = c("full_name", "issue", "congress")
      )

    # ------ Sanity check ------
    stopifnot(all(paste0(match_vars, "_raw") %in% names(legis_all)))
    ```

    #### special clean: aggregate independents into republican or democratic 

    ```{r}
    #| label: aggregate_independents
    #| echo: false

    independents <- legis_cg %>%
      filter(party == "Independent")

    unique(independents$full_name)

    # change their party affiliation according their caucus belongings
    legis_cg <- legis_cg %>%
      mutate(
        party = case_when(
          full_name == "Rep. Amash, Justin [R-MI-3]" ~ "Republican",
          full_name == "Rep. Mitchell, Paul [R-MI-10]" ~ "Republican",
          full_name == "Sen. King, Angus S., Jr. [I-ME]" ~ "Democratic",
          full_name == "Sen. Sanders, Bernard [I-VT]" ~ "Democratic",
          full_name == "Sen. Sinema, Kyrsten [I-AZ]" ~ "Democratic",
          TRUE ~ party  # 其他人保持原党派
        )
      )

    ```

    # 2. overall descriptive analysis for individual

    This block visualizes the distribution of legislators' decision types (intl/dom/prof) in both adver and legis datasets. It includes overall bar plots and congress-specific facet plots. Additionally, it inspects label distributions across congress, party, chamber, gender, and committee.

    ## 2.1 distribution plots

    overall

    ```{r}
    #| label: overall barplot
    #| echo: false

    ggplot(legis_cg, aes(x = decision, fill = decision)) +
      geom_bar() +
      scale_fill_manual(
        values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
      ) +
      geom_text(stat='count', aes(label=..count..), vjust=-0.8, size=5) +
      labs(title = "decision mode by congressmen legis",
           x = "decision mode",
           y = "number") +
      theme_minimal(base_size = 14)
    ```

    by congress

    ```{r}
    #| label: overall barplot by congress
    #| echo: false

    ggplot(legis_cg, aes(x = decision, fill = decision)) +
      geom_bar() +
      geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
      scale_fill_manual(
        values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
      ) +
      facet_wrap(~ congress, scales = "free_y") +
      labs(title = "decision mode by congressmen legis",
           x = "Decision Mode",
           y = "Number") +
      theme_minimal(base_size = 12)
    ```

    by party

    ```{r}
    #| label: overall barplot by party
    #| echo: false

    ggplot(legis_cg, aes(x = decision, fill = decision)) +
      geom_bar() +
      geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
      scale_fill_manual(
        values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
      ) +
      facet_wrap(~ party, scales = "free_y") +
      labs(title = "decision mode by congressmen legis",
           x = "Decision Mode",
           y = "Number") +
      theme_minimal(base_size = 12)

    ```

    ## 2.2 interaction plot of ideology and party

    ```{r}
    #| label: scatter_plot_ideology_and_party
    #| echo: false

    # intl_percenatge
    ggplot(legis_cg, aes(x = ideology, y = intl_percentage, color = party)) +
      geom_point(alpha = 0.7, size = 3) +
      scale_color_manual(
        values = c(
          "Democratic" = "#2E74C0",  # 蓝色
          "Republican" = "#CB454A"   # 红色
        )
      ) +
      labs(
        title = "Ideology vs International Mode by Party",
        x = "Ideology",
        y = "International Percentage",
        color = "Party"
      ) +
      theme_minimal(base_size = 13) +
      theme(
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "top"
      ) +
      geom_smooth(method = "lm", se = FALSE)

    # prof_percentage
    ggplot(legis_cg, aes(x = ideology, y = prof_percentage, color = party)) +
      geom_point(alpha = 0.7, size = 3) +
      scale_color_manual(
        values = c(
          "Democratic" = "#2E74C0",  # 蓝色
          "Republican" = "#CB454A"   # 红色
        )
      ) +
      labs(
        title = "Ideology vs Professional Mode by Party",
        x = "Ideology",
        y = "Professional Percentage",
        color = "Party"
      ) +
      theme_minimal(base_size = 13) +
      theme(
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "top"
      ) +
      geom_smooth(method = "lm", se = FALSE)

    # dom_percentage
    ggplot(legis_cg, aes(x = ideology, y = dom_percentage, color = party)) +
      geom_point(alpha = 0.7, size = 3) +
      scale_color_manual(
        values = c(
          "Democratic" = "#2E74C0",  # 蓝色
          "Republican" = "#CB454A"   # 红色
        )
      ) +
      labs(
        title = "Ideology vs Domestic Mode by Party",
        x = "Ideology",
        y = "Domestic Percentage",
        color = "Party"
      ) +
      theme_minimal(base_size = 13) +
      theme(
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "top"
      ) +
      geom_smooth(method = "lm", se = FALSE)
    ```

    # 3. overall descriptive analysis for issues

    ## 3.1 analysis based on original data

    ### 3.1.1 news_data

    hereby using original data news_data and bills_data to depict issues

    # 6. district analysis - logit regression

    ```{r}
    #| label: data cleansing
    #| echo: false

    # turn decision into is.dom

    legis_cg <- legis_cg %>%
      mutate(is.dom = ifelse(decision == "dom", 1, 0))

    # turn party into is.republican
    legis_cg <- legis_cg %>% 
      mutate(is.republican = ifelse(party == "Republican", 1, 0))

    # turn categorical vector into numeric 
    legis_cg$gender_numeric <- ifelse(legis_cg$gender == "Male", 1, 0)
    legis_cg$chamber_numeric <- ifelse(legis_cg$chamber == "Senate", 1, 0)

    # add district data into adver_cg/legis_cg
    district_data$congress <- as.character(district_data$congress)
    legis_cg <- as.character(legis_cg$congress)

    legis_merged <- legis_cg %>%
      left_join(
        district_data,
        by = c("congress", "state_code", "district")
      )

    # set vars_to_check 
    vars_to_check <- c(
      "high_edu_share",
      "foreign_born_ratio",
      "white_ratio",
      "black_or_african_american_ratio",
      "asian_ratio",
      "american_indian_and_alaska_native_ratio",
      "native_hawaiian_and_other_pacific_islander_ratio",
      "white_collar_share",
      "blue_collar_share",
      "agriculture_share",
      "median_household_income_that_year",
      "age", "seniority", "ideology", "is.republican", "chamber", "gender"
    )

    # filter different level data
    dem_legis <- legis_merged %>%
      filter(party == "Democratic")
    rep_legis <- legis_merged %>%
      filter(party == "Republican")

    hosue_legis <- legis_merged %>%
      filter(chamber == "house of representatives")
    senate_legis <- legis_merged %>%
      filter(chamber == "senate")

    legis_115 <- legis_merged %>%
      filter(congress == "115")
    legis_116 <- legis_merged %>%
      filter(congress == "116")
    legis_117 <- legis_merged %>%
      filter(congress == "117")
    legis_118 <- legis_merged %>%
      filter(congress == "118")
    ```

    ## 6.1 focus on education

    ```{r}
    #| label: district_analysis_logit_legis_dem_edu
    #| echo: false

    # 一、核心模型（最简版本）
    model11 <- glm(
      is.dom ~ high_edu_share,
      data = dem_legis,
      family = binomial(link = "logit")
    )

    # 二、扩展控制模型（控制选区结构异质性）
    model21 <- glm(
      is.dom ~ high_edu_share + 
        median_household_income_that_year + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = dem_legis,
      family = binomial(link = "logit")
    )

    model21a <- glm(
      is.dom ~ high_edu_share + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = dem_legis,
      family = binomial(link = "logit")
    )

    # 尝试构建综合指标
    dem_legis <-dem_legis %>%
      mutate(
        edu_white = standardize(high_edu_share) + standardize(white_collar_share)
      )
    model22 <- glm(
      is.dom ~ edu_white + 
        median_household_income_that_year + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = dem_legis,
      family = binomial(link = "logit")
    )

    model22a <- glm(
      is.dom ~ edu_white + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = dem_legis,
      family = binomial(link = "logit")
    )

    # 三、稳健模型（控制议员层级变量）
    # ideology
    model31 <- glm(
      is.dom ~ high_edu_share + 
        median_household_income_that_year + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share + 
        ideology  + gender_numeric + age ,
      data = dem_legis,
      family = binomial(link = "logit")
    )


    # 四、模型诊断与比较
    # 1. 检查多重共线性
    vif(model21)
    vif(model22)
    vif(model31)
    cor(dplyr::select(dem_legis, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

    # 2. 模型比较表
    modelsummary(
      list(
        "Model 1: Simple-education" = model11,
        "Model 2: District controls-edu" = model21,
        "Model 2a: District controls(!income)" = model21a,
        "Model 3: District controls-edu_white" = model22,
        "Model 3a: District controls(!income)" = model22a,
        "Model 4: + Individual controls(ideo)" = model31
      ),
      fmt = 3,
      stars = TRUE,
      output = file.path(output_dir, "logit_legis_dem_district_edu.html"),
      escape = FALSE
    )

    # 五、可视化：边际效应（Marginal Effects）
    # 高等教育比例的边际效应
    edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
    plot(edu_effect) +
      labs(
        title = "Marginal Effect (control district)",
        x = "High Education Share",
        y = "Predicted Probability (is.dom)"
      ) +
      theme_minimal(base_size = 14)

    # 高等教育比例的边际效应（去掉income）
    edu_effect <- ggpredict(model21a, terms = "high_edu_share [all]")
    plot(edu_effect) +
      labs(
        title = "Marginal Effect (control district, !income)",
        x = "High Education Share",
        y = "Predicted Probability (is.dom)"
      ) +
      theme_minimal(base_size = 14)

    # 白领比例的边际效应
    eduwhite_effect <- ggpredict(model22, terms = "edu_white [all]")
    plot(eduwhite_effect) +
      labs(
        title = "Marginal Effect of edu_white",
        x = "Edu + White-collar composite",
        y = "Predicted Probability (is.dom)"
      ) +
      theme_minimal(base_size = 14)

    # 白领比例的边际效应
    eduwhite_effect <- ggpredict(model22a, terms = "edu_white [all]")
    plot(eduwhite_effect) +
      labs(
        title = "Marginal Effect of edu_white",
        x = "Edu + White-collar composite",
        y = "Predicted Probability (is.dom)"
      ) +
      theme_minimal(base_size = 14)

    ```

    ```{r}
    #| label: district_analysis_logit_avder_rep_edu
    #| echo: false

    # 一、核心模型（最简版本）

    model11 <- glm(
      is.dom ~ high_edu_share,
      data = rep_adver,
      family = binomial(link = "logit")
    )

    # 二、扩展控制模型（控制选区结构异质性）
    model21 <- glm(
      is.dom ~ high_edu_share + 
        median_household_income_that_year + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = rep_adver,
      family = binomial(link = "logit")
    )

    model21a <- glm(
      is.dom ~ high_edu_share +  foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = rep_adver,
      family = binomial(link = "logit")
    )


    # 尝试构建综合指标
    rep_adver <- rep_adver %>%
      mutate(
        edu_white = standardize(high_edu_share) + standardize(white_collar_share)
      )
    model22 <- glm(
      is.dom ~ edu_white + 
        median_household_income_that_year + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = rep_adver,
      family = binomial(link = "logit")
    )

    model22a <- glm(
      is.dom ~ edu_white + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share,
      data = rep_adver,
      family = binomial(link = "logit")
    )

    # 三、稳健模型（控制议员层级变量）
    # ideology
    model31 <- glm(
      is.dom ~ high_edu_share + 
        median_household_income_that_year + foreign_born_ratio + asian_ratio +
        white_ratio + black_or_african_american_ratio + agriculture_share + 
        ideology  + gender_numeric + age ,
      data = rep_adver,
      family = binomial(link = "logit")
    )


    # 四、模型诊断与比较
    # 1. 检查多重共线性
    vif(model21)
    vif(model22)
    vif(model31)

    # 2. 模型比较表
    # 2. 模型比较表
    modelsummary(
      list(
        "Model 1: Simple-education" = model11,
        "Model 2: District controls-edu" = model21,
        "Model 2a: District controls(!income)" = model21a,
        "Model 3: District controls-edu_white" = model22,
        "Model 3a: District controls(!income)" = model22a,
        "Model 4: + Individual controls(ideo)" = model31
      ),
      fmt = 3,
      stars = TRUE,
      output = file.path(output_dir, "logit_adver_rep_district_edu.html"),
      escape = FALSE
    )

    # 五、可视化：边际效应（Marginal Effects）
    # 高等教育比例的边际效应
    edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
    plot(edu_effect) +
      labs(
        title = "Marginal Effect (control district)",
        x = "High Education Share",
        y = "Predicted Probability (is.dom)"
      ) +
      theme_minimal(base_size = 14)

    # 高等教育比例的边际效应（去掉income）
    edu_effect <- ggpredict(model21a, terms = "high_edu_share [all]")
    plot(edu_effect) +
      labs(
        title = "Marginal Effect (control district, !income)",
        x = "High Education Share",
        y = "Predicted Probability (is.dom)"
      ) +
      theme_minimal(base_size = 14)

    # 白领比例的边际效应
    eduwhite_effect <- ggpredict(model22, terms = "edu_white [all]")
    plot(eduwhite_effect) +
      labs(
        title = "Marginal Effect of edu_white",
        x = "Edu + White-collar composite",
        y = "Predicted Probability (is.dom)"
      ) +
      theme_minimal(base_size = 14)
    ```
