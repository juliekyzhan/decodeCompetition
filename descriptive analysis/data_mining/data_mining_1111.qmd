---
title: "data_mining_1112"
author: "Kunya Zhan"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  html:
   toc: true
   toc-depth: 3
   number-sections: true
   code-fold: true
   code-summary: "Show/Hide Code"
   smooth-scroll: true
   df-print: paged
   code-tools: true
   highlight-style: atom-one
   toc-location: left
editor: visual
---

# Data Mining

This quarto document reorganizes the analyses from *descriptive analysis 1021.Rmd*, focusing on data mining and pattern discovery in the *decodeCompetition dataset*. It consists two main sections:

1.  **Data Mining**: exploration of the original dataset to identify salient patterns and cross-party differences;
2.  **Model-based analysis:** identification of key characteristics through regression and logistic models.

## set up

```{r}
#| label: setup
#| include: false

# Create an output directory if it doesn't exist
output_dir <- "output"
if (!dir.exists(output_dir)) dir.create(output_dir)

# Default chunk options
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = file.path(output_dir, ""),   # figures from chunks
  cache.path = file.path(output_dir, "cache/")
)

# A helper function to save plots/data consistently
save_to_output <- function(filename, plot = NULL, data = NULL, ...) {
  full_path <- file.path(output_dir, filename)
  dir.create(dirname(full_path), recursive = TRUE, showWarnings = FALSE)
  
  if (!is.null(plot)) {
    ggplot2::ggsave(filename = full_path, plot = plot, ...)
    message("âœ… Saved plot to: ", full_path)
  } else if (!is.null(data)) {
    write.csv(data, full_path, row.names = FALSE, ...)
    message("âœ… Saved data to: ", full_path)
  } else {
    message("âš ï¸ No plot or data provided. Returning path only: ", full_path)
  }
  
  return(full_path)
}
```

### Packages Installing if not already installed

```{r}
#| label: install_libraries
#| echo: false
#| message: false
#| warning: false

# è®¾ç½®é»˜è®¤ CRAN æºï¼Œé˜²æ­¢æœªæŒ‡å®šé•œåƒå¯¼è‡´ install.packages æŠ¥é”™
options(repos = c(CRAN = "https://cloud.r-project.org"))

# æ‰€éœ€åŒ…åˆ—è¡¨
packages <- c(
  "Rcpp", "dplyr", "stringr", "readr", "ggplot2", "tidyr", "readxl", "scales", 
  "showtext", "sysfonts", "skimr", "plm", "car", "glmnet", 
  "Rtsne", "networkD3", "cluster", "factoextra", "pROC", "lme4", 
  "MuMIn", "nnet", "DHARMa", "tigris", "ggeffects", "stargazer",
  "htmltools", "tidyverse", "ggcorrplot", "purrr", "broom.mixed", 
  "performance", "lattice", "fmsb", "kableExtra", "broom", 
  "knitr", "ggnewscale", "modelsummary", "pscl", "ggfortify", 
  "rlang", "patchwork", "segmented", "tidytext", "mgcv", "splines", 
  "interactions", "RColorBrewer", "cowplot", "ggbreak", "randomcoloR",
  "marginaleffects", "ggrepel", "grid"
)

# Install only if missing
for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
  }
}

# Load all packages
lapply(packages, library, character.only = TRUE)
```

# 1. Data cleansing

## 1.1 data acquisition

```{r}
#| label: load_data
#| echo: false
#| message: false
#| warning: false

# ----- main databases -----
adver_sum_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/adver_analysis_sum.xlsx"
legis_sum_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/legis_analysis_sum.xlsx"

adver_sum <- read_excel(adver_sum_path)
legis_sum <- read_excel(legis_sum_path)

adver_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/adver_analysis_all.xlsx"
legis_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/legis_analysis_all.xlsx"

adver_all <- read_excel(adver_path)
legis_all <- read_excel(legis_path)

adver_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/adver_train_data.csv")
legis_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/legis_train_data.csv")


# ----- supplementary databases -----
bioguide_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/members_district_1103.xlsx"
bioguide <- read_excel(bioguide_path)

# ideology
ideology_115_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2018-senate-ideology.csv")
ideology_115_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2018-house-ideology.csv")
ideology_116_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2020-senate-ideology.csv")
ideology_116_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2020-house-ideology.csv")
ideology_117_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2022-senate-ideology.csv")
ideology_117_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2022-house-ideology.csv")
ideology_118_senate <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2024-senate-ideology.csv")
ideology_118_house <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/new ideology/govtrack-stats-2024-house-ideology.csv")

# original news data
news_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/115_118_news_data_new1.csv"
news_data <- read_csv(news_data_path)

# original legislative data
bills_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/115-118_congress_data_new.csv"
bills_data <- read_csv(bills_data_path)

# district data
district_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/district_data/district_data.csv")
```

## 1.2 matching variables and special patch

```{r}
#| label: matching variables 
#| echo: false

# ------ matching variables map ------
match_vars <- c(
  "leverage_pl", "leverage_ne", "committee_pl", "committee_ne",
  "employ_industry_pl", "employ_industry_ne",
  "payroll_industry_pl", "payroll_industry_ne",
  "ethnicity_pl", "ethnicity_ne",
  "party_value_pl", "party_value_ne",
  "party_score_pl", "party_score_ne"
)

# ------ Add raw columns ------
adver_data_raw <- adver_data %>%
  rename_with(.cols = all_of(match_vars), .fn = ~ paste0(.x, "_raw"))
adver_all <- adver_all %>%
  left_join(
    adver_data_raw %>% dplyr::select(full_name, issue, congress, ends_with("_raw")),
    by = c("full_name", "issue", "congress")
  )

legis_data_raw <- legis_data %>%
  rename_with(.cols = all_of(match_vars), .fn = ~ paste0(.x, "_raw"))
legis_all <- legis_all %>%
  left_join(
    legis_data_raw %>% dplyr::select(full_name, issue, congress, ends_with("_raw")),
    by = c("full_name", "issue", "congress")
  )


# ------ Sanity check ------
stopifnot(all(paste0(match_vars, "_raw") %in% names(adver_all)))
stopifnot(all(paste0(match_vars, "_raw") %in% names(legis_all)))
```

#### special clean for legis_sum and legis data

```{r}
#| label: special clean for legis
#| echo: false

legis_data <- legis_data %>%
  mutate(issue = str_to_title(issue))

legis_sum <- legis_sum %>%
  mutate(issue = str_to_title(issue))
```

## 1.3 name cleansing

### 1.3.1 preparing bioguide as matching map

name cleansing: addressing issues that some full_name are missing

```{r}
#| label: name missing check in congress_basic
#| echo: false
congress_basic <- bioguide %>%
  dplyr::select(
    bioguide_id, full_name, direct_order_name, chamber, member_type,
    party, state_name, state_code, district, gender,
    birth_year, death_year, congress
  ) %>%
  distinct() 

# ---- check missing full_name inside bioguide ----
missing_name_df <- congress_basic %>%
  filter(is.na(full_name) | full_name == "") %>%
  dplyr::select(bioguide_id, direct_order_name, chamber, state_code, district, party, congress) %>%
  arrange(chamber, state_code, district)

write_csv(missing_name_df, "missing_name_df.csv")
```

```{r}
#| label: clean_name_bioguide_before
#| echo: false

# ------ Step 0: Create direct_order_name -> full_name mapping ------
name_map <- tibble::tibble(
  direct_order_name = c(
    "Mike Rogers", "J. French Hill", "Dave Min", "Cory Mills",
    "Marjorie Taylor Greene", "David P. Joyce", "Michael Baumgartner",
    "Mark  Begich", "Richard C. Shelby", "Mark Udall", "Chuck Grassley",
    "Daniel Coats", "Joe Donnelly", "Pat Roberts", "Rand Paul", "David Vitter",
    "Carl Levin", "Al  Franken", "Claire McCaskill", "Richard Burr",
    "John Hoeven", "Heidi  Heitkamp", "Kelly Ayotte", "Dean Heller",
    "Rob Portman", "Ron Wyden", "Jack Reed", "Sheldon Whitehouse",
    "Lindsey Graham", "Tim Johnson", "Bob Corker"
  ),
  full_name = c(
    "Rep. Rogers, Mike [R-AL-3]", "Rep. Hill, J. French [R-AR-2]",
    "Rep. Min, Dave [D-CA-47]", "Rep. Mills, Cory [R-FL-7]",
    "Rep. Greene, Marjorie Taylor [R-GA-14]", "Rep. Joyce, David P. [R-OH-14]",
    "Rep. Baumgartner, Michael [R-WA-5]", "Sen. Begich, Mark [D-AK]",
    "Sen. Shelby, Richard C. [R-AL]", "Sen. Udall, Mark [D-CO]",
    "Sen. Grassley, Charles E. [R-IA]", "Sen. Coats, Daniel R. [R-IN]",
    "Sen. Donnelly, Joe [D-IN]", "Sen. Roberts, Patrick J. [R-KS]",
    "Sen. Paul, Randal H. [R-KY]", "Sen. Vitter, David [R-LA]",
    "Sen. Levin, Carl [D-MI]", "Sen. Franken, Al [D-MN]",
    "Sen. McCaskill, Claire [D-MO]", "Sen. Burr, Richard [R-NC]",
    "Sen. Hoeven, John [R-ND]", "Sen. Heitkamp, Heidi [D-ND]",
    "Sen. Ayotte, Kelly [R-NH]", "Sen. Heller, Dean [R-NV]",
    "Sen. Portman, Robert J. [R-OH]", "Sen. Wyden, Ronald [D-OR]",
    "Sen. Reed, Jack [D-RI]", "Sen. Whitehouse, Sheldon [D-RI]",
    "Sen. Graham, Lindsey [R-SC]", "Sen. Johnson, Timothy M. [D-SD]",
    "Sen. Corker, Robert P. [R-TN]"
  )
)
missing_name_df <- missing_name_df %>%
  left_join(name_map, by = "direct_order_name")

# ------ Step 1: Define helper to clean names ------
clean_names <- function(x) {
  x %>%
    stringr::str_replace_all("\\p{Zs}+", " ") %>%
    stringr::str_squish() %>%
    stringr::str_trim() %>%
    stringr::str_to_lower()
}

congress_basic <- congress_basic %>%
  mutate(direct_order_name_clean = clean_names(direct_order_name))
missing_name_df <- missing_name_df %>%
  mutate(direct_order_name_clean = clean_names(direct_order_name))

# ------ Step 2: Fill missing full_name using mapping ------
congress_basic <- congress_basic %>%
  left_join(
    missing_name_df %>% dplyr::select(direct_order_name_clean, full_name) %>% distinct(),
    by = "direct_order_name_clean"
  ) %>%
  mutate(full_name = ifelse(is.na(full_name.x), full_name.y, full_name.x)) %>%
  dplyr::select(-ends_with(".x"), -ends_with(".y"), -direct_order_name_clean)

# Verify no missing names remain
cat("Number of remaining missing full_name:", sum(is.na(congress_basic$full_name)), "\n")
```

district cleansing: matching district code in main databases

```{r}
#| label: clean district
#| echo: false
congress_basic <- congress_basic %>%
  mutate(
    district = as.character(district),
    district = case_when(
      is.na(district) & chamber == "Senate" ~ "99",
      is.na(district) & chamber == "House of Representatives" ~ "At Large",
      TRUE ~ district
    )
  )
```

age cleansing: create age_to_date to match ages in main database and prepare age_to_congress to replace ages in main databases

```{r}
#| label: clean age
#| echo: false
# ------ delete 119th congress data  ------
congress_basic <- congress_basic %>%
  filter(congress != 119)

# ------ Define congress start years ------
congress_year_map <- tibble(
  congress = c(115, 116, 117, 118),
  congress_start_year = c(2017, 2019, 2021, 2023)
)

# ------ Compute ages ------
congress_basic <- congress_basic %>%
  # Join start year info
  left_join(congress_year_map, by = "congress") %>%
  
  # Compute age
  mutate(
    age_to_date = 2025 - birth_year,
    age_to_congress = congress_start_year - birth_year,
    
    # Handle missing birth_year
    age_to_date = if_else(!is.na(birth_year), age_to_date, NA_real_),
    age_to_congress = if_else(!is.na(birth_year) & !is.na(congress_start_year),
                              age_to_congress, NA_real_)
  )
cat("âœ… Age calculation completed.\n")
```

### 1.3.2 name cleansing adver_sum & legis_sum and special patches

main database name extracting

```{r}
#| label: name extracting
#| echo: false

adver_sum0 <- adver_sum %>%
  mutate(
    name_no_title = str_remove(full_name, "^\\s*(Sen\\.|Rep\\.|Del\\.)\\s*"),
    name_clean = str_remove(name_no_title, "\\s*\\[.*\\]") %>% str_squish(),
    eng_name = str_replace(name_clean, "^([^,]+),\\s*(.+)$", "\\2 \\1")
  ) %>%
  dplyr::select(-name_no_title, -name_clean)
adver_sum0$congress <- as.character(adver_sum0$congress)

legis_sum0 <- legis_sum %>%
  mutate(
    name_no_title = str_remove(full_name, "^\\s*(Sen\\.|Rep\\.|Del\\.)\\s*"),
    name_clean = str_remove(name_no_title, "\\s*\\[.*\\]") %>% str_squish(),
    eng_name = str_replace(name_clean, "^([^,]+),\\s*(.+)$", "\\2 \\1")
  ) %>%
  dplyr::select(-name_no_title, -name_clean)
legis_sum0$congress <- as.character(legis_sum0$congress)

# matching variable name in congress_basic
congress_basic <- congress_basic %>% rename(eng_name = direct_order_name)
```

#### \* special patches

The database has a override problem with some congress members. For example, Sen. Blunt Rochester, Lisa \[D-DE\] was elected as senator in 119th congress, but the database mistakebly override her information before as senator, while she was a representative. Those who are identified will be corrected as a special path in this chuck.

special patch1: patch for "Sen. Blunt Rochester, Lisa \[D-DE\]"

```{r}
#| label: patch_blunt_rochester
#| echo: false

# å®šä¹‰ä¿®è¡¥ç›®æ ‡
patch_name <- "Sen. Blunt Rochester, Lisa [D-DE]"
patch_congress <- 118  # å¯é€‰ï¼šæŒ‡å®šå±Šæ¬¡ï¼Œç¡®ä¿å”¯ä¸€å®šä½
new_chamber <- "House of Representatives"
new_district <- "At Large"

# ---- Step 1: ç²¾ç¡®é”å®šåŒ¹é…å¯¹è±¡ ----
target_legis <- legis_sum0 %>%
  filter(full_name == patch_name) %>%
  distinct(full_name, congress)

target_adver <- adver_sum0 %>%
  filter(full_name == patch_name) %>%
  distinct(full_name, congress)

if (nrow(target_legis) > 1 | nrow(target_adver) > 1) {
  warning("âš ï¸ æœ‰å¤šä¸ªåŒ¹é…è®°å½•ï¼Œè¯·ç¡®è®¤æ˜¯å¦éœ€è¦é™åˆ¶ç‰¹å®š Congressï¼ˆä¾‹å¦‚ 118ï¼‰ï¼")
}

# ---- Step 2: å®‰å…¨æ›´æ–°å‡½æ•° ----
safe_patch <- function(df, name, congress = NULL, new_chamber, new_district) {
  df %>%
    mutate(
      chamber = case_when(
        !is.na(full_name) &
          full_name == name &
          (is.null(congress) | .data$congress == congress) ~ new_chamber,
        TRUE ~ chamber
      ),
      district = case_when(
        !is.na(full_name) &
          full_name == name &
          (is.null(congress) | .data$congress == congress) ~ new_district,
        TRUE ~ district
      )
    )
}

# ---- Step 3: åº”ç”¨æ›´æ–° ----
legis_sum0 <- safe_patch(legis_sum0, patch_name, patch_congress, new_chamber, new_district)
adver_sum0 <- safe_patch(adver_sum0, patch_name, patch_congress, new_chamber, new_district)

# ---- Step 4: æ£€æŸ¥ç»“æœ ----
legis_sum0 %>% 
  filter(full_name == patch_name) %>%
  dplyr::select(full_name, congress, chamber, district)

adver_sum0 %>% 
  filter(full_name == patch_name) %>%
  dplyr::select(full_name, congress, chamber, district)

```

special patch2: for congressmen "Sen. Menendez, Robert \[D-NJ\]" and "Rep. Menendez, Robert \[D-NJ-8\]", since they have different eng_name but extracting from full_name cannot automatically discern the difference

```{r}
#| label: special_clean_menendez
#| echo: false
special_clean_menendez <- function(df) {
  df <- df %>%
    mutate(
      eng_name = case_when(
        # Senator Robert Menendez (NJ, district 99 or 0)
        full_name == "Sen. Menendez, Robert [D-NJ]" |
        (state_code == "NJ" & district %in% c(99, 0) & str_detect(full_name, "Menendez")) ~ "Bob Menendez",
        
        # Representative Robert Menendez (NJ-8)
        full_name == "Rep. Menendez, Robert [D-NJ-8]" |
        (state_code == "NJ" & district == 8 & str_detect(full_name, "Menendez")) ~ "Rob Menendez",
        
        TRUE ~ eng_name
      )
    )
  return(df)
}

# Apply the special cleaning function
congress_basic <- special_clean_menendez(congress_basic)
adver_sum0 <- special_clean_menendez(adver_sum0)
legis_sum0 <- special_clean_menendez(legis_sum0)
```

### 1.3.3 name mapping

```{r}
#| label: check name missing in main data
#| echo: false

# try to use congress+party+chamber+state_code+district as mapping key
adver_name_check <- adver_sum0 %>%
  filter(is.na(full_name)) %>%
  group_by(congress, party, chamber, state_code, district) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(desc(n))

legis_name_check <- legis_sum0 %>%
  filter(is.na(full_name)) %>%
  group_by(congress, party, chamber, state_code, district) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(desc(n)) # missing == 0, clean

# duplicity check
dupli_name_check <- adver_sum0  %>%
  
  # 1. only checking those full_name == na
  filter(is.na(full_name)) %>%
  
  # 2. group on legislators
  group_by(congress, party, chamber, state_code, district) %>%
  
  # 3. calculating various issue & row numbers
  summarise(
    n_rows = n(),
    n_issue = n_distinct(issue, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  
  # 4. check if duplicate
  mutate(non_unique = n_rows > n_issue) %>%
  
  arrange(desc(n_rows))

# ---- output analysis result ----
cat("ğŸ” å…±æœ‰", sum(dupli_name_check$non_unique), "ç»„ full_name ç¼ºå¤±è®°å½•æ— æ³•å”¯ä¸€æ ‡è¯†è®®å‘˜ã€‚\n")
cat("ğŸ“Š æ€»è®¡ unique ç»„åˆæ•°ï¼š", nrow(dupli_name_check), "\n")

# ---- check specific rowï¼ˆonly thos who are duplicate not due to issueï¼‰ ----
dupli_name_check %>%
  filter(non_unique) %>%
  dplyr::select(congress, party, chamber, state_code, district, n_rows, n_issue)
```

define name matching function

```{r}
#| label: match_bioguide
#| echo: false

# ------ Function: Match bioguide_id based on name and district info ------
normalize_name <- function(name) {
  name %>%
    tolower() %>%
    str_replace_all("\\.", "") %>%     # åˆ é™¤å¥ç‚¹
    str_trim() %>%
    str_replace_all("\\s+", " ")       # å»å¤šä½™ç©ºæ ¼
}

# ---- è¾…åŠ©å‡½æ•°ï¼šå»é™¤ä¸­é—´åï¼Œåªä¿ç•™å + å§“ ----
remove_middle_name <- function(name) {
  name %>%
    str_trim() %>%
    str_split_fixed(" ", n = 3) %>%
    .[, c(1, 2)] %>%
    apply(1, function(x) paste(na.omit(x), collapse = " ")) %>%
    str_trim()
}

# ---- ä¸»å‡½æ•° ----
match_bioguide_id <- function(main_df, congress_basic, 
                              use_step3 = TRUE, 
                              use_step4 = TRUE,
                              verbose = TRUE) {
  
  total_n <- nrow(main_df)
  
  # ---- Step 0: åˆå§‹åŒ– bioguide_id ----
  main_df <- main_df %>% 
    mutate(bioguide_id = NA_character_)
  
  # ---- Step 1: full_name + congress åŒ¹é… ----
  tmp1 <- congress_basic %>%
    group_by(full_name, congress) %>%
    slice(1) %>%
    ungroup() %>%
    dplyr::select(full_name, congress, bioguide_id1 = bioguide_id)
  
  main_df <- main_df %>%
    left_join(tmp1, by = c("full_name", "congress" = "congress")) %>%
    mutate(bioguide_id = coalesce(bioguide_id, bioguide_id1)) %>%
    dplyr::select(-bioguide_id1)
  
  if (verbose) cat("Step 1 matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
  
  # ---- Step 2: eng_name + congress åŒ¹é… ----
  tmp2 <- congress_basic %>%
    group_by(eng_name, congress) %>%
    slice(1) %>%
    ungroup() %>%
    dplyr::select(eng_name, congress, bioguide_id2 = bioguide_id)
  
  main_df <- main_df %>%
    left_join(tmp2, by = c("eng_name", "congress" = "congress")) %>%
    mutate(bioguide_id = coalesce(bioguide_id, bioguide_id2)) %>%
    dplyr::select(-bioguide_id2)
  
  if (verbose) cat("Step 2 matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
  
  # ---- Step 3ï¼ˆå¯é€‰ï¼‰: ä½¿ç”¨ç¨³å®š key åŒ¹é… bioguide_id ----
  if (use_step3) {
    main_df <- main_df %>%
      mutate(id_key = paste(congress, party, chamber, state_code, district, sep = "_"))
    
    congress_basic <- congress_basic %>%
      mutate(id_key = paste(congress, party, chamber, state_code, district, sep = "_"))
    
    tmp3 <- congress_basic %>%
      group_by(id_key) %>%
      slice(1) %>%
      ungroup() %>%
      dplyr::select(id_key, bioguide_id3 = bioguide_id, full_name3 = full_name)
    
    n_before <- nrow(main_df)
    
    main_df <- main_df %>%
      left_join(tmp3, by = "id_key", relationship = "many-to-one") %>%
      mutate(
        bioguide_id = coalesce(bioguide_id, bioguide_id3),
        full_name   = if_else(!is.na(bioguide_id3), full_name3, full_name)
      ) %>%
      dplyr::select(-bioguide_id3, -full_name3, -id_key)
    
    stopifnot(nrow(main_df) == n_before)
    
    if (verbose) cat("Step 3 (stable key) matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
    
    dupli_keys <- tmp3 %>% count(id_key) %>% filter(n > 1)
    if (nrow(dupli_keys) > 0) {
      warning("âš ï¸ Warning: duplicate id_key found in congress_basic, may cause ambiguous match.")
    }
  }
  
  # ---- Step 4ï¼ˆå¯é€‰ï¼‰: eng_name only (normalize + å»ä¸­é—´å) ----
  if (use_step4) {
    # æ ‡å‡†åŒ–å¹¶å»é™¤ä¸­é—´å
    congress_basic <- congress_basic %>%
      mutate(eng_name_clean = normalize_name(eng_name) %>% remove_middle_name())
    
    main_df <- main_df %>%
      mutate(eng_name_clean = normalize_name(eng_name) %>% remove_middle_name())
    
    tmp4 <- congress_basic %>%
      group_by(eng_name_clean) %>%
      slice(1) %>%
      ungroup() %>%
      dplyr::select(eng_name_clean, full_name4 = full_name, bioguide_id4 = bioguide_id)
    
    main_df <- main_df %>%
      left_join(tmp4, by = "eng_name_clean") %>%
      mutate(
        bioguide_id = coalesce(bioguide_id, bioguide_id4),
        full_name   = if_else(!is.na(bioguide_id4), full_name4, full_name)
      ) %>%
      dplyr::select(-bioguide_id4, -full_name4, -eng_name_clean)
    
    if (verbose) cat("Step 4 (normalized + middle name removed) matched:", sum(!is.na(main_df$bioguide_id)), "/", total_n, "\n")
  }
  
  # ---- Step 5: è¾“å‡ºæ€»ç»“ ----
  if (verbose) {
    cat("âœ… Bioguide ID matching complete.\n")
    cat("Remaining NA bioguide_id:", sum(is.na(main_df$bioguide_id)), "\n")
  }
  
  return(main_df)
}

# ------ Apply function to datasets ------
congress_basic$congress <- as.character(congress_basic$congress)
adver_sum1 <- match_bioguide_id(adver_sum0, congress_basic, use_step3 = TRUE, use_step4 = TRUE)
legis_sum1 <- match_bioguide_id(legis_sum0, congress_basic, use_step3 = FALSE, use_step4 = TRUE)

# Update final datasets
# adver_sum <- adver_sum1
# legis_sum <- legis_sum1

# æŸ¥çœ‹legisç¼ºå¤±
legis_missing <- legis_sum1 %>% 
  filter(is.na(bioguide_id)) %>%
  distinct(full_name, .keep_all = FALSE) %>%
  arrange(full_name)
save_to_output("legis_missing_fullname_list.csv", data = legis_missing)

```

```{r}
#| label: further addressing missing bioguide
#| echo: false

bioguide_map <- tibble(
  name = c(
    "David Joyce",
    "J. Hill",
    "John Reed",
    "Marjorie Greene",
    "Rep. Bishop, Sanford D., Jr. [D-GA-2]",
    "Rep. Conyers, John, Jr. [D-MI-13]",
    "Rep. Garcia, Jesus G. \"Chuy\" [D-IL-4]",
    "Rep. Kennedy, Joseph P., III [D-MA-4]",
    "Rep. Pallone, Frank, Jr. [D-NJ-6]",
    "Rep. Pascrell, Bill, Jr. [D-NJ-9]",
    "Rep. Payne, Donald M., Jr. [D-NJ-10]",
    "Rep. Sensenbrenner, F. James, Jr. [R-WI-5]",
    "Rep. Weber, Randy K., Sr. [R-TX-14]",
    "Richard Shelby",
    "Sen. Manchin, Joe, III [D-WV]",
    "Rep. Ryan, Paul [R-WI-1]"
  ),
  bioguide_id = c(
    "J000295",  # David Joyce
    "H001072",  # French Hill
    "R000122",  # Jack (John F.) Reed
    "G000596",  # Marjorie Taylor Greene
    "B000490",  # Sanford D. Bishop Jr.
    "C000714",  # John Conyers, Jr.
    "G000586",  # JesÃºs G. "Chuy" GarcÃ­a
    "K000379",  # Joseph P. Kennedy III
    "P000034",  # Frank Pallone Jr.
    "P000096",  # Bill Pascrell Jr.
    "P000604",  # Donald M. Payne Jr.
    "S000244",  # F. James Sensenbrenner
    "W000814",  # Randy K. Weber
    "S000320",  # Richard C. Shelby
    "M001183",  # Joe Manchin
    "R000570"   # Paul Ryan
  )
)

adver_sum1 <- adver_sum1 %>%
  # ç”¨æ˜ å°„è¡¨å·¦è¿æ¥è¿›æ¥ï¼ˆæŠŠæ˜ å°„è¡¨çš„ bioguide_id åŠ å…¥ä¸º new_bioguideï¼‰
  left_join(bioguide_map %>% rename(map_name = name, map_bioguide = bioguide_id),
            by = c("full_name" = "map_name")) %>%

  # å¦‚æœåŸè¡¨å·²æœ‰ bioguide_idï¼Œä¼˜å…ˆä¿ç•™ï¼›å¦åˆ™ä½¿ç”¨æ˜ å°„è¡¨çš„å€¼
  mutate(
    bioguide_id = coalesce(bioguide_id, map_bioguide)
  ) %>%

  # æ¸…ç†ä¸´æ—¶åˆ—
  dplyr::select(-map_bioguide)

legis_sum1 <- legis_sum1 %>%
  # ç”¨æ˜ å°„è¡¨å·¦è¿æ¥è¿›æ¥ï¼ˆæŠŠæ˜ å°„è¡¨çš„ bioguide_id åŠ å…¥ä¸º new_bioguideï¼‰
  left_join(bioguide_map %>% rename(map_name = name, map_bioguide = bioguide_id),
            by = c("full_name" = "map_name")) %>%

  # å¦‚æœåŸè¡¨å·²æœ‰ bioguide_idï¼Œä¼˜å…ˆä¿ç•™ï¼›å¦åˆ™ä½¿ç”¨æ˜ å°„è¡¨çš„å€¼
  mutate(
    bioguide_id = coalesce(bioguide_id, map_bioguide)
  ) %>%

  # æ¸…ç†ä¸´æ—¶åˆ—
  dplyr::select(-map_bioguide)
```

address missing name issues

```{r}
#| label: missing name solution_before
#| echo: false

# ------ old_full_name -> new_full_name ------ 
# name_map <- data.frame(
#  old_full_name = c(
#    "David Joyce",
#    "J. Hill",
#    "John Reed",
#    "Marjorie Greene",
#    "Richard Shelby"
#  ),
#  new_full_name = c(
#    "Rep. Joyce, David P. [R-OH-14]",
#    "Rep. Hill, J. French [R-AR-2]",
#    "Sen. Reed, Jack [D-RI]",
#    "Rep. Greene, Marjorie Taylor [R-GA-14]",
#    "Sen. Shelby, Richard C. [R-AL]"
#  ),
#  stringsAsFactors = FALSE
#)

# ------ clean full_name ------ 
#clean_names <- function(x) {
#  x %>%
#    str_replace_all("\\p{Zs}+", " ") %>%  # å°†æ‰€æœ‰ç©ºç™½æ›¿æ¢ä¸ºæ™®é€šç©ºæ ¼
#    str_squish() %>%                      # å‹ç¼©å¤šç©ºæ ¼
#    str_trim() %>%
#    str_to_lower()
#}

#legis_sum2 <- legis_sum1 %>%
#  mutate(full_name_clean = clean_names(full_name))
#name_map <- name_map %>%
#  mutate(old_full_name_clean = clean_names(old_full_name))

# ------ update full_name ------ 
#legis_sum2 <- legis_sum2 %>%
#  left_join(name_map, by = c("full_name" = "old_full_name")) %>%
#  mutate(
#    full_name = coalesce(new_full_name, full_name),
#   updated_flag = !is.na(new_full_name)  # flage updated rows
#  ) %>%
#  dplyr::select(-new_full_name)

# ------ bioguide match ------

#update_rows <- which(legis_sum2$updated_flag & is.na(legis_sum2$bioguide_id))

# full_name + congress as only key
#legis_sum2$key <- paste0(legis_sum2$full_name, "_", legis_sum2$congress)
#congress_basic$key <- paste0(congress_basic$full_name, "_", congress_basic$congress)

#matched_ids <- congress_basic$bioguide_id[match(legis_sum2$key[update_rows], #congress_basic$key)]
#legis_sum2$bioguide_id[update_rows] <- matched_ids

#legis_sum1 <- legis_sum2 %>% dplyr::select(-key, -full_name_clean, -old_full_name_clean, #-updated_flag)
```

## 1.4 ideology update

The original ideology data in the main database is standardized. We use ideology data at \[GovTrack\](<https://www.govtrack.us/about/analysis#ideology>) to replace them. ref: [Tauberer, Joshua](http://razor.occams.info/). 2012. Observing the Unobservables in the U.S. Congress, presented at Law Via the Internet 2012, Cornell Law School, October 2012.

ideology cleansing

```{r}
#| label: ideology-cleansing
#| echo: false

ideology_115_house <- ideology_115_house %>% mutate(congress = 115, chamber = "House of Representatives")
ideology_116_house <- ideology_116_house %>% mutate(congress = 116, chamber = "House of Representatives")
ideology_117_house <- ideology_117_house %>% mutate(congress = 117, chamber = "House of Representatives")
ideology_118_house <- ideology_118_house %>% mutate(congress = 118, chamber = "House of Representatives")
ideology_115_senate <- ideology_115_senate %>% mutate(congress = 115, chamber = "Senate")
ideology_116_senate <- ideology_116_senate %>% mutate(congress = 116, chamber = "Senate")
ideology_117_senate <- ideology_117_senate %>% mutate(congress = 117, chamber = "Senate")
ideology_118_senate <- ideology_118_senate %>% mutate(congress = 118, chamber = "Senate")

chamber_ideology <- bind_rows(
  ideology_115_house,
  ideology_116_house,
  ideology_117_house,
  ideology_118_house,
  ideology_115_senate,
  ideology_116_senate,
  ideology_117_senate,
  ideology_118_senate)
summary(chamber_ideology$congress)

chamber_ideology$congress <- as.character(chamber_ideology$congress)
```

ideology merge

```{r}
#| label: ideology-merge
#| echo: false

merge_ideology <- function(df, ideology_df, verbose = TRUE) {
  
  df <- df %>%
    mutate(
      bioguide_id = toupper(stringr::str_trim(bioguide_id)),
      congress    = as.character(congress),
      chamber     = tolower(stringr::str_trim(chamber))
    )
  
  ideology_df <- ideology_df %>%
    mutate(
      bioguide_id = toupper(stringr::str_trim(bioguide_id)),
      congress    = as.character(congress),
      chamber     = tolower(stringr::str_trim(chamber))
    ) %>%
    group_by(bioguide_id, congress, chamber) %>%
    slice(1) %>%
    ungroup() %>%
    dplyr::select(bioguide_id, congress, chamber, ideology) %>%
    rename(ideology_new = ideology)
  
  df <- df %>%
    left_join(ideology_df, by = c("bioguide_id", "congress", "chamber")) %>%
    mutate(
      ideology = ideology_new,
      matched  = !is.na(ideology_new)
    ) %>%
    dplyr::select(-ideology_new)
  
  if (verbose) {
    n_missing <- sum(is.na(df$ideology))
    n_matched <- sum(df$matched)
    cat("âœ… Merge complete.\n")
    cat("  â€¢ Matched:", n_matched, "\n")
    cat("  â€¢ Remaining NA ideology:", n_missing, "\n")
  }
  
  return(df)
}

adver_sum1 <- merge_ideology(adver_sum1, chamber_ideology)
legis_sum1 <- merge_ideology(legis_sum1, chamber_ideology)

# save adver_sum1/legis_sum1
save_to_output("adver_sum1.csv", data = adver_sum1)
save_to_output("legis_sum1.csv", data = legis_sum1)
```

ideology missing distribution: missing at random

```{r}
#| label: ideology-missing
#| echo: false

check_missing_ideology <- function(df, df_name = "dataset") {
  missing_df <- df %>% filter(is.na(ideology))
  
  cat("âœ…", df_name, "total missing:", nrow(missing_df), "/", nrow(df), "\n\n")
  
  # Missing by party
  cat("Missing by party:\n")
  print(table(missing_df$party))
  cat("\n")
  
  # Missing by state
  cat("Missing by state:\n")
  print(table(missing_df$state_code))
  cat("\n")
  
  # Missing by chamber
  cat("Missing by chamber:\n")
  print(table(missing_df$chamber))
  cat("\n")
  
  # Cross-tab: party x chamber
  cat("Missing by party x chamber:\n")
  print(table(missing_df$party, missing_df$chamber))
}

check_missing_ideology(adver_sum1, "adver_sum1")
check_missing_ideology(legis_sum1, "legis_sum1")
```

# 2. data aggregation and generation

## 2.1 individual level aggregation

generate function: generate_decision_with_traits()

> This function aggregates prediction and importance metrics for each legislator across different datasets, such as train, test,or merged. It computes the relative importance of 3 behavioral modes - intl, dom, and prof, and assigns each legislator a dominant decision category based on their most prominent behavior. It finally merges these aggregated results with demographic and institutional traits like gender, party, and ideology.

```{r}
#| label: generate-decision-with-traits
#| echo: false
# ---- Function: generate_decision_with_traits ----
generate_decision_with_traits <- function(df, mode = "all") {
  # parameter validation
  if (!mode %in% c("all", "train", "test", "merged")) {
    stop("mode must be 'all', 'train', 'test', or 'merged'")
  }

  # ---- step 1: data filtering ----
  df_subset <- if (mode %in% c("all", "merged")) df else df %>% filter(dataset == mode)

  # ---- step 2: data aggregation ----
  group_vars <- if (mode == "merged") {
    c("full_name", "congress")
  } else {
    c("full_name", "congress", "dataset")
  }

  df_clean <- df_subset %>%
    group_by(across(all_of(group_vars))) %>%
    summarise(
      importance_intl = sum(importance_intl, na.rm = TRUE),
      importance_dom  = sum(importance_dom,  na.rm = TRUE),
      importance_prof = sum(importance_prof, na.rm = TRUE),
      importance_all  = sum(importance_all,  na.rm = TRUE),
      pred = mean(pred, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      intl_percentage = ifelse(importance_all > 0, importance_intl / importance_all, NA_real_),
      dom_percentage  = ifelse(importance_all > 0, importance_dom  / importance_all, NA_real_),
      prof_percentage = ifelse(importance_all > 0, importance_prof / importance_all, NA_real_),
      max_val = pmax(intl_percentage, dom_percentage, prof_percentage, na.rm = TRUE),
      decision = case_when(
        is.na(max_val) ~ NA_character_,
        intl_percentage == max_val & dom_percentage != max_val & prof_percentage != max_val ~ "intl",
        dom_percentage  == max_val & intl_percentage != max_val & prof_percentage != max_val ~ "dom",
        prof_percentage == max_val & intl_percentage != max_val & dom_percentage != max_val ~ "prof",
        TRUE ~ "tie"
      )
    ) %>%
    dplyr::select(-max_val, -importance_all)

  # ---- step3: trait merging ----
  traits <- df %>%
    dplyr::select(full_name, congress, dataset, party, chamber, committee_el,
           gender, age, seniority, ideology, district, state_code, bioguide_id) %>%
    distinct()

  if (mode == "merged") {
    traits <- traits %>%
      group_by(full_name, congress) %>%
      summarise(
        party = first(party),
        chamber = first(chamber),
        committee_el = first(na.omit(committee_el)),
        gender = first(gender),
        age = mean(age, na.rm = TRUE),
        seniority = mean(seniority, na.rm = TRUE),
        ideology = mean(ideology, na.rm = TRUE),
        district = first(district),
        state_code = first(state_code),
        bioguide_id = first(bioguide_id),
        .groups = "drop"
      )

    df_final <- df_clean %>%
      left_join(traits, by = c("full_name", "congress"))
  } else {
    df_final <- df_clean %>%
      left_join(traits, by = c("full_name", "congress", "dataset"))
  }

  # ---- step 4: join and label formatting ----
  df_final <- df_final %>%
    mutate(gender = factor(gender, levels = c(0, 1), labels = c("Female", "Male")))

  return(df_final)
}

# ---- application ----
#df_train <- generate_decision_with_traits_dual(df, mode = "train")
#df_test <- generate_decision_with_traits_dual(df, mode = "test")

# adv
adver_cg <- generate_decision_with_traits(adver_sum1, mode = "merged")
# legis
legis_cg <- generate_decision_with_traits(legis_sum1, mode = "merged")

# save
save_to_output("adver_cg.csv", data = adver_cg)
save_to_output("legis_cg.csv", data = legis_cg)
```

## 2.2 topic level aggregation

generate function: generate_decision_with_issue()

> This function processes legislative data to summarize each legislator's issue-level decision pattern (international, domestic, or professional). It groups the data by legislator, Congress session, and issue, aggregates importance scores, and calculates the dominant decision type for each group.

```{r}
#| label: generate decision with issues
#| echo: false
generate_decision_with_issues <- function(df, set_name = "all") {
  # Step 1: Optional filter by dataset (train/test)
  if (set_name %in% c("train", "test")) {
    df <- df %>% filter(dataset == set_name)
  }

  # Step 2: Group by issue-congress level and summarize
  df_clean <- df %>%
    group_by(issue, congress, committee_el, party) %>%  # ä¿ç•™ dataset ä¿¡æ¯
    summarise(
      label = sum(label, na.rm = TRUE),
      pred = mean(pred, na.rm = TRUE),
      importance_intl = sum(importance_intl, na.rm = TRUE),
      importance_dom = sum(importance_dom, na.rm = TRUE),
      importance_prof = sum(importance_prof, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      total = importance_intl + importance_dom + importance_prof,
      intl_percentage = ifelse(total > 0, importance_intl / total, NA_real_),
      dom_percentage  = ifelse(total > 0, importance_dom  / total, NA_real_),
      prof_percentage = ifelse(total > 0, importance_prof / total, NA_real_),
      max_val = pmax(intl_percentage, dom_percentage, prof_percentage, na.rm = TRUE),
      decision = case_when(
        is.na(max_val) ~ NA_character_,
        intl_percentage == max_val & dom_percentage != max_val & prof_percentage != max_val ~ "intl",
        dom_percentage  == max_val & intl_percentage != max_val & prof_percentage != max_val ~ "dom",
        prof_percentage == max_val & intl_percentage != max_val & dom_percentage  != max_val ~ "prof",
        TRUE ~ "tie"
      )
    ) %>%
    dplyr::select(-max_val, -total)

  return(df_clean)
}

# ---- application ----
adver_tp <- generate_decision_with_issues(adver_sum)
legis_tp <- generate_decision_with_issues(legis_sum)

# save adver_sum1/legis_sum1
save_to_output("adver_tp.csv", data = adver_tp)
save_to_output("legis_tp.csv", data = legis_tp)
```

# 3. overall descriptive analysis for individual

This block visualizes the distribution of legislators' decision types (intl/dom/prof) in both adver and legis datasets. It includes overall bar plots and congress-specific facet plots. Additionally, it inspects label distributions across congress, party, chamber, gender, and committee.

## 3.1 distribution plots

overall

```{r}
#| label: overall barplot
#| echo: false

# adver
ggplot(adver_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  geom_text(stat='count', aes(label=..count..), vjust=-0.8, size=5) +
  labs(title = "decision mode by congressmen adver",
       x = "decision mode",
       y = "number") +
  theme_minimal(base_size = 14)


#legis
ggplot(legis_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  geom_text(stat='count', aes(label=..count..), vjust=-0.8, size=5) +
  labs(title = "decision mode by congressmen legis",
       x = "decision mode",
       y = "number") +
  theme_minimal(base_size = 14)
```

by congress

```{r}
#| label: overall barplot by congress
#| echo: false

ggplot(adver_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  facet_wrap(~ congress, scales = "free_y") +
  labs(title = "decision mode by congressmen adver",
       x = "Decision Mode",
       y = "Number") +
  theme_minimal(base_size = 12)

ggplot(legis_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  facet_wrap(~ congress, scales = "free_y") +
  labs(title = "decision mode by congressmen legis",
       x = "Decision Mode",
       y = "Number") +
  theme_minimal(base_size = 12)
```

seats change each congress

```{r}
#| label: legislators yaml clean
#| echo: false

# find yaml
yaml_dir <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/legislators list yaml"  
yaml_files <- list.files(yaml_dir, pattern = "\\.yaml$", full.names = TRUE)

# clean yaml
read_yaml_to_df <- function(file) {
  # è¯»å– YAML
  yaml_data <- yaml::read_yaml(file)
  
  # æå–å±Šæ•°ï¼ˆä¾‹å¦‚ä» legislators-current117.yaml å¾—åˆ° 117ï¼‰
  congress_num <- str_extract(basename(file), "\\d{3}") %>% as.integer()
  
  # å±•å¼€æ¯ä¸ªè®®å‘˜çš„æ•°æ®
  df <- map_dfr(yaml_data, function(x) {
    tibble::as_tibble(x$id)
  })
  
  # æ·»åŠ  congress æ ‡è¯†åˆ—
  df <- df %>% mutate(congress = congress_num)
  
  return(df)
}
  
# è¯»å–æ‰€æœ‰ YAML æ–‡ä»¶å¹¶æ‹¼èµ·æ¥
legislators115_118 <- map_dfr(yaml_files, read_yaml_to_df)

# match bioguide åŒ¹é…å…šæ´¾å’Œæ€§åˆ«
# ç¡®ä¿ key å”¯ä¸€
bioguide_meta <- bioguide %>%
  dplyr::select(bioguide_id, full_name, congress, party, gender, chamber) %>%
  distinct(bioguide_id, congress, .keep_all = TRUE)

legislators115_118$congress <- as.character(legislators115_118$congress)
bioguide_meta$congress <- as.character(bioguide_meta$congress)

# åˆæ­¥åŒ¹é…
legislators_cleaned <- legislators115_118 %>%
  left_join(
    bioguide_meta %>% dplyr::select(bioguide_id, full_name, congress, party, gender, chamber),
    by = c("bioguide" = "bioguide_id", "congress" = "congress")
  )

# å»ºç«‹æ˜ å°„è¡¨
members <- data.frame(
  bioguide_id = c("S001219","S001204","S001177","R000600","P000610","M001219","L000605","J000303","B001245"),
  full_name   = c(
    "Rep. Sempolinski, Joseph [R-NY-23]",
    "Del. San Nicolas, Michael F. Q. [D-GU-At-Large]",
    "Del. Sablan, Gregorio Kilili Camacho [D-MP-At-Large]",
    "Del. Radewagen, Aumua Amata Coleman [R-AS-At-Large]",
    "Del. Plaskett, Stacey E. [D-VI-At-Large]",
    "Del. Moylan, James [R-GU-At-Large]",
    "Rep. Lee Carter, Erica [D-TX-18]",
    "Del. Jones, Brenda [D-MI-At-Large]",
    "Del. Bordallo, Madeleine [D-GU-At-Large]"
  ),
  party       = c("Republican","Democratic","Democratic","Republican","Democratic","Republican","Democratic","Democratic","Democratic"),
  gender      = c("M","M","M","F","F","M","F","F","F"),
  chamber     = c(
    "House of Representatives",
    "House of Representatives",
    "House of Representatives",
    "House of Representatives",
    "House of Representatives",
    "House of Representatives",
    "House of Representatives",
    "House of Representatives",
    "House of Representatives"
  ),
  stringsAsFactors = FALSE
)

# åŒ¹é…ç¼ºå°‘çš„
legislators_cleaned <- legislators_cleaned %>%
  left_join(
    members %>%
      dplyr::select(bioguide_id, party_fix = party, gender_fix = gender, chamber_fix = chamber),
    by = c("bioguide" = "bioguide_id")
  ) %>%
  mutate(
    party   = ifelse(is.na(party) & !is.na(party_fix), party_fix, party),
    gender  = ifelse(is.na(gender) & !is.na(gender_fix), gender_fix, gender),
    chamber = ifelse(is.na(chamber) & !is.na(chamber_fix), chamber_fix, chamber)
  ) %>%
  dplyr::select(-party_fix, -gender_fix, -chamber_fix)  # åˆ é™¤ä¸­é—´å˜é‡
```

#### waiting for cleaning (code)

```{r}
#| label: seats change each congress
#| echo: false


# 1) å…ˆåšå¹²å‡€çš„æ±‡æ€»è¡¨ï¼ˆæŒ‰ distinct bioguideï¼‰
party_seat_trend <- legislators_cleaned %>%
  mutate(
    party = as.character(party),
    congress = as.numeric(congress),
    chamber = as.character(chamber)
  ) %>%
  filter(!is.na(party), !is.na(bioguide), !is.na(chamber)) %>%
  group_by(congress, chamber, party) %>%
  summarise(seat_count = n_distinct(bioguide), .groups = "drop") 

# 2) è¡¥é½æ‰€æœ‰å¯èƒ½çš„ (chamber, party, congress) ç»„åˆï¼ˆé˜²æ­¢ç¼ºå±Šå¯¼è‡´ lag è¡Œä¸ºä¸ç¨³å®šï¼‰
all_congress <- sort(unique(party_seat_trend$congress))
all_chamber  <- sort(unique(party_seat_trend$chamber))
all_party    <- sort(unique(party_seat_trend$party))

party_seat_trend <- party_seat_trend %>%
  complete(chamber = all_chamber, party = all_party, congress = all_congress) %>%
  arrange(chamber, party, congress) %>%
  # æŠŠç¼ºå¤±çš„ seat_count ç”¨ NA ä¿ç•™ï¼ˆä¸è¦å¡« 0ï¼Œä¾¿äºåŒºåˆ†â€œç¡®å® 0â€ä¸â€œæ— æ•°æ®â€ï¼‰
  mutate(seat_count = ifelse(is.na(seat_count), NA_integer_, seat_count))

# 3) è®¡ç®— prev_seat, seat_changeï¼ˆä½¿ç”¨ order_by ä»¥é˜²ä¸‡ä¸€ï¼‰
party_seat_trend <- party_seat_trend %>%
  group_by(chamber, party) %>%
  arrange(congress, .by_group = TRUE) %>%
  mutate(
    prev_seat = dplyr::lag(seat_count, order_by = congress),
    seat_change = ifelse(is.na(prev_seat), NA_integer_, seat_count - prev_seat),
    seat_change_pct = ifelse(!is.na(prev_seat) & prev_seat != 0,
                             (seat_count - prev_seat) / prev_seat * 100,
                             NA_real_),
    direction = case_when(
      is.na(seat_change) ~ "",
      seat_change > 0 ~ "â†‘",
      seat_change < 0 ~ "â†“",
      seat_change == 0 ~ "â†’"
    )
  ) %>%
  ungroup()

# 4) è°ƒè¯•è¾“å‡ºï¼šæ£€æŸ¥æ¯ä¸ª (chamber, party) çš„è¡Œï¼Œçœ‹çœ‹ prev_seat æ˜¯å¦å’Œä½ é¢„æœŸä¸€è‡´
debug_check <- party_seat_trend %>%
  filter(!is.na(seat_count)) %>%
  arrange(chamber, party, congress)

print(debug_check)

# 5) å¯è§†åŒ–ï¼šçº¿ + ç‚¹ + æ•°å­—æ ‡æ³¨
seg_data <- party_seat_trend %>%
  filter(!is.na(prev_seat) & !is.na(seat_count)) %>%
  mutate(prev_congress = dplyr::lag(congress, order_by = congress)) %>%
  filter(!is.na(prev_congress)) # ä¿è¯å¯ç”»çº¿æ®µ

ggplot(party_seat_trend, aes(x = congress, y = seat_count, color = party, group = party)) +
  geom_line(size = 1.1, na.rm = TRUE) +
  geom_point(size = 3, na.rm = TRUE) +
  # æ•°å­—æ ‡æ³¨ï¼ˆåªæ˜¾ç¤ºå¸­ä½æ•°ï¼‰
  geom_text_repel(
    aes(label = ifelse(is.na(seat_count), "", seat_count)),
    size = 3.8,
    fontface = "bold",
    nudge_y = 5,
    na.rm = TRUE
  ) +
  facet_wrap(~ chamber, scales = "free_y") +
  scale_color_manual(
    values = c("Democratic" = "#1f77b4", "Republican" = "#d62728"),
    na.value = "grey50"
  ) +
  scale_x_continuous(breaks = all_congress) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Party Seat Counts Across Congress Sessions by Chamber",
    x = "Congress",
    y = "Number of Members",
    color = "Party"
  ) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    strip.text = element_text(face = "bold")
  )
```

## 3.2 distribution map

### 3.2.1 map dataset generation and cleansing

```{r}
#| label: mapdata preparation
#| echo: false

# ---- mapdata for house ----
adver_cg_heatmap <- adver_cg %>%
  filter(chamber == "house of representatives")

legis_cg_heatmap <- legis_cg %>%
  filter(chamber == "house of representatives")

# ---- mapdata for senate ----
adver_cg_heatmap1 <- adver_cg %>%
  filter(chamber == "senate")

legis_cg_heatmap1 <- legis_cg %>%
  filter(chamber == "senate")
```

district cleansing

```{r}
#| label: district cleansing for mapdata
#| echo: false

unique(adver_cg_heatmap$district[is.na(as.integer(adver_cg_heatmap$district))]) # debug district data issue

adver_cg_heatmap  <- adver_cg_heatmap  %>%
  mutate(
    district_clean = case_when(
      grepl("At Large", district, ignore.case = TRUE) ~ "00",
      state_code %in% c("DC", "AS", "GU", "MP", "PR", "VI") ~ "98",
      grepl("^[0-9]+$", district) ~ sprintf("%02d", as.integer(district)),
      grepl("^[0-9]+(st|nd|rd|th)$", district, ignore.case = TRUE) ~ sprintf(
        "%02d", as.integer(str_extract(district, "^[0-9]+"))
      ),
      TRUE ~ NA_character_  
    ),
    state_district = paste0(state_code, "-", district_clean)
  ) # turn at-large into 00
unique(adver_cg_heatmap$district_clean[is.na(as.integer(adver_cg_heatmap$district_clean))]) # check results

unique(legis_cg_heatmap$district[is.na(as.integer(legis_cg_heatmap$district))]) # debug district data issue

legis_cg_heatmap  <- legis_cg_heatmap  %>%
  mutate(
    district_clean = case_when(
      grepl("At Large", district, ignore.case = TRUE) ~ "00",
      state_code %in% c("DC", "AS", "GU", "MP", "PR", "VI") ~ "98",
      grepl("^[0-9]+$", district) ~ sprintf("%02d", as.integer(district)),
      grepl("^[0-9]+(st|nd|rd|th)$", district, ignore.case = TRUE) ~ sprintf(
        "%02d", as.integer(str_extract(district, "^[0-9]+"))
      ),
      TRUE ~ NA_character_  
    ),
    state_district = paste0(state_code, "-", district_clean)
  )
unique(legis_cg_heatmap$district_clean[is.na(as.integer(legis_cg_heatmap$district_clean))]) 
```

### 3.2.2 flip-key construction

```{r}
#| label: state flip key
#| echo: false

# fips-state
fips_state_map <- data.frame(
  fips = c(
    "01","02","04","05","06","08","09","10","12","13","15","16","17","18","19",
    "20","21","22","23","24","25","26","27","28","29","30","31","32","33","34",
    "35","36","37","38","39","40","41","42","44","45","46","47","48","49","50",
    "51","53","54","55","56","11","60","66","69","72","78"
  ),
  state = c(
    "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA",
    "KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ",
    "NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT",
    "VA","WA","WV","WI","WY","DC","AS","GU","MP","PR","VI"
  ),
  stringsAsFactors = FALSE
)

# custom transformers
state_to_fips <- function(state_code) {
  res <- fips_state_map$fips[match(state_code, fips_state_map$state)]
  return(res)
}

fips_to_state <- function(fips_code) {
  # make sure fips_code is character
  fips_code <- sprintf("%02s", as.character(fips_code))
  res <- fips_state_map$state[match(fips_code, fips_state_map$fips)]
  return(res)
}

# test
fips_to_state("01")  # shoule be "AL"
fips_to_state(9)     # shoule be "CT"
fips_to_state(23)   # shoule be ME
fips_to_state(44)   # shoule be RI
fips_to_state(6)   # shoule be CA
```

### 3.2.3 house map generation function

```{r}
#| label: map function
#| echo: false

# ------------------ house map function ------------------
plot_decision_map_by_congress <- function(congress_num,
                                          decision_data,
                                          model_type = c("adver", "legis"),
                                          save_path = NULL,
                                          save_width = 10,
                                          save_height = 7) {
  model_type <- match.arg(model_type)
  
  # ---- congress match ----
  map_year <- switch(
    as.character(congress_num),
    "115" = 2016,
    "116" = 2020,
    "117" = 2020,
    "118" = 2022,
    stop("Unsupported congress number.")
  )
  
  # ---- district match ----
  district_col <- switch(
    as.character(congress_num),
    "115" = "CD115FP",
    "116" = "CD116FP",
    "117" = "CD116FP",
    "118" = "CD118FP",
    stop("Unsupported congress number.")
  )
  
  # ---- local fallback paths ----
  local_paths <- list(
    "115" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/map data from us census/cb_2016_us_cd115_500k/cb_2016_us_cd115_500k.shp",
    "116" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/map data from us census/tl_2020_us_cd116/tl_2020_us_cd116.shp",
    "117" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/map data from us census/tl_2020_us_cd116/tl_2020_us_cd116.shp", # same as 116
    "118" = "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/map data from us census/cb_2022_us_cd118_20m/cb_2022_us_cd118_20m.shp"
  )
  
  # ---- load map data ----
  message("ğŸ—ºï¸ Loading congressional district map for ", congress_num, "th Congress...")
  cd_map <- tryCatch(
    {
      tigris::congressional_districts(cb = TRUE, year = map_year)
    },
    error = function(e) {
      message("âš ï¸ Cloud download failed. Loading from local file instead...")
      sf::st_read(local_paths[[as.character(congress_num)]], quiet = TRUE)
    }
  )
  
  # ---- map data cleaning ----
  cd_map <- cd_map %>%
    mutate(
      state_code = fips_to_state(STATEFP),
      district_code = as.character(!!rlang::sym(district_col)),
      district_clean = sprintf("%02d", as.integer(district_code)),
      state_district = stringr::str_trim(paste0(state_code, "-", district_clean))
    )
  
  # ---- decision data preparing ----
  decision_df <- decision_data %>%
    filter(congress == as.character(congress_num)) %>%
    mutate(
      state_district = stringr::str_trim(as.character(state_district)),
      party = case_when(
        party %in% c("R", "Republican", "REP") ~ "R",
        party %in% c("D", "Democratic", "DEM") ~ "D",
        party %in% c("I", "Independent", "IND") ~ "I",
        TRUE ~ NA_character_
      ),
      decision = case_when(
        decision %in% c("intl", "international") ~ "intl",
        decision %in% c("dom", "domestic") ~ "dom",
        decision %in% c("prof", "professional") ~ "prof",
        TRUE ~ NA_character_
      )
    )
  
  # ---- join map ----
  plot_df <- cd_map %>%
    left_join(decision_df %>% dplyr::select(state_district, decision, party),
              by = "state_district") %>%
    mutate(
      group_var = ifelse(
        is.na(party) | is.na(decision) | party == "" | decision == "",
        "missing",
        paste0(party, "_", decision)
      )
    )
  
  # ---- color scheme ----
  pal_vec <- c(
    "R_intl" = "#ef8a62", "R_dom" = "#b2182b", "R_prof" = "#fddbc7",
    "I_intl" = "#9e9ac8", "I_dom" = "#756bb1", "I_prof" = "#dadaeb",
    "D_intl" = "#67a9cf", "D_dom" = "#2166ac", "D_prof" = "#d1e5f0",
    "missing" = "grey80"
  )
  
  all_levels <- names(pal_vec)
  plot_df <- plot_df %>%
    mutate(group_var = factor(group_var, levels = all_levels))
  
  # ---- main map ----
  main_map <- ggplot(plot_df) +
    geom_sf(aes(fill = group_var), color = "white", size = 0.1) +
    scale_fill_manual(values = pal_vec, drop = FALSE, name = "Party + Decision") +
    labs(
      title = paste0(
        ifelse(model_type == "adver", "Adver", "Legis"),
        " Decision Mode by District (", congress_num, "th Congress)"
      )
    ) +
    theme_minimal(base_size = 14) +
    theme(legend.position = "bottom") +
    coord_sf(xlim = c(-125, -65), ylim = c(24, 50), expand = FALSE)
  
  # ---- Alaska & Hawaii ----
  alaska_map <- ggplot(filter(plot_df, state_code == "AK")) +
    geom_sf(aes(fill = group_var), color = "white", size = 0.1) +
    scale_fill_manual(values = pal_vec, guide = "none") +
    coord_sf(xlim = c(-180, -130), ylim = c(50, 72), expand = FALSE) +
    theme_void()
  
  hawaii_map <- ggplot(filter(plot_df, state_code == "HI")) +
    geom_sf(aes(fill = group_var), color = "white", size = 0.1) +
    scale_fill_manual(values = pal_vec, guide = "none") +
    coord_sf(xlim = c(-161, -154), ylim = c(18, 23), expand = FALSE) +
    theme_void()
  
  # ---- combine ----
  final_map <- cowplot::ggdraw() +
    cowplot::draw_plot(main_map, 0, 0, 1, 1) +
    cowplot::draw_plot(alaska_map, x = 0.03, y = 0.15, width = 0.25, height = 0.25) +
    cowplot::draw_plot(hawaii_map, x = 0.20, y = 0.15, width = 0.25, height = 0.25)
  
  if (!is.null(save_path)) {
  save_to_output(
    filename = save_path,
    plot = final_map,
    width = save_width,
    height = save_height
  )
}
  
  return(final_map)
}
```

```{r}
#| label: map function application
#| echo: false

# adver
plot_decision_map_by_congress(115, adver_cg_heatmap, model_type = "adver",
                               save_path = "maps/adver_115_map.png")

plot_decision_map_by_congress(116, adver_cg_heatmap, model_type = "adver",
                              save_path = "maps/adver_116_map.png")

plot_decision_map_by_congress(117, adver_cg_heatmap, model_type = "adver",
                              save_path = "maps/adver_117_map.png")

plot_decision_map_by_congress(118, adver_cg_heatmap, model_type = "adver",
                              save_path = "maps/adver_118_map.png")

# legis

plot_decision_map_by_congress(115, legis_cg_heatmap, model_type = "legis",
                              save_path = "maps/legis_115_map.png")

plot_decision_map_by_congress(116, legis_cg_heatmap, model_type = "legis",
                              save_path = "maps/legis_116_map.png")

plot_decision_map_by_congress(117, legis_cg_heatmap, model_type = "legis",
                              save_path = "maps/legis_117_map.png")

plot_decision_map_by_congress(118, legis_cg_heatmap, model_type = "legis",
                              save_path = "maps/legis_118_map.png")
```

### 3.2.4 senate map function (need further debug)

```{r}
#| label: senate map function
#| echo: false

# ------------------ senate map functionï¼ˆneeds further debugï¼‰ ------------------
#plot_decision_map_by_congress_senate_debug <- function(congress_num,
#                                                       decision_data,
#                                                       model_type = c("adver", "legis"),
#                                                       save_path = NULL,
#                                                       save_width = 10,
#                                                       save_height = 7,
#                                                       shapefile_path = #"cb_2020_us_state_20m/cb_2020_us_state_20m.shp") {
#  library(dplyr)
#  library(sf)
#  library(ggplot2)
#  library(stringr)
  
#  model_type <- match.arg(model_type)
  
#  cat("???? å¼€å§‹è¯»å–å·åœ°å›¾...\n")
#  states_map <- sf::st_read(shapefile_path, quiet = TRUE) %>%
#    filter(!STUSPS %in% c("PR", "VI", "GU", "MP", "AS")) %>%
#    mutate(state_code = toupper(STUSPS))
  
#  cat("å·åœ°å›¾æ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(states_map %>% st_drop_geometry() %>% select(STATEFP, STUSPS, state_code)))
  
#  cat("???? è¯»å–å†³ç­–æ•°æ®...\n")
  
#  decision_df <- decision_data %>%
#    filter(congress == as.character(congress_num)) %>%
#    mutate(
#      state_code = toupper(str_trim(as.character(state_code))),
#      party = as.character(party),
#      decision = as.character(decision)
#    ) %>%
#    group_by(state_code) %>%
#    summarize(
#      party = first(na.omit(party)),
#      decision = first(na.omit(decision)),
#      group_var = ifelse(
#        is.na(party) | is.na(decision) | party == "" | decision == "",
#        "missing",
#        paste0(party, "_", decision)
#      ),
#      .groups = "drop"
#    )
  
#  cat("å†³ç­–æ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(decision_df))
  
#  missing_states <- setdiff(decision_df$state_code, states_map$state_code)
#  if (length(missing_states) > 0) {
#    warning("è¿™äº› state_code åœ¨åœ°å›¾æ•°æ®ä¸­æ‰¾ä¸åˆ°: ", paste(missing_states, collapse = ", #"))
#  } else {
#    cat("??? æ‰€æœ‰ state_code éƒ½åŒ¹é…ã€‚\n")
#  }
  
#  cat("???? è®¡ç®—å·ä¸­å¿ƒç‚¹...\n")
#  state_centroids <- states_map %>%
#    st_centroid() %>%
#    st_coordinates() %>%
#    as.data.frame() %>%
#    mutate(state_code = states_map$state_code)
  
#  cat("å·ä¸­å¿ƒç‚¹æ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(state_centroids))
  
#  cat("???? åˆå¹¶å†³ç­–æ•°æ®å’Œä¸­å¿ƒç‚¹...\n")
#  plot_points <- decision_df %>%
#    left_join(state_centroids, by = "state_code")
  
#  cat("åˆå¹¶åæ•°æ®å‰å‡ è¡Œ:\n")
#  print(head(plot_points))
  
#  if (nrow(plot_points) == 0) {
#    stop("??? åˆå¹¶åæ²¡æœ‰æ•°æ®ï¼è¯·æ£€æŸ¥ state_code æ˜¯å¦ä¸€è‡´ã€‚")
#  }
  
#  plot_points <- plot_points %>%
#    group_by(state_code) %>%
#    mutate(
#      X = X + runif(n(), -0.3, 0.3),
#      Y = Y + runif(n(), -0.3, 0.3)
#    ) %>%
#    ungroup()
  
#  pal_vec <- c(
#    "R_intl"  = "#b2182b", "R_dom"   = "#ef8a62", "R_prof"  = "#fddbc7",
#    "I_intl"  = "#756bb1", "I_dom"   = "#9e9ac8", "I_prof"  = "#dadaeb",
#    "D_intl"  = "#2166ac", "D_dom"   = "#67a9cf", "D_prof"  = "#d1e5f0",
#    "missing" = "grey80"
#  )
  
#  all_levels <- c("R_intl","R_dom","R_prof",
#                  "I_intl","I_dom","I_prof",
#                  "D_intl","D_dom","D_prof",
#                  "missing")
  
#  plot_points <- plot_points %>%
#    mutate(group_var = factor(group_var, levels = all_levels))
  
#  pal_vec <- pal_vec[names(pal_vec) %in% levels(plot_points$group_var)]
  
#  main_map <- ggplot() +
#    geom_sf(data = states_map, fill = "white", color = "black", size = 0.2) +
#    geom_point(data = plot_points,
#               aes(x = X, y = Y, fill = group_var),
#               shape = 21, size = 3, color = "black") +
#    scale_fill_manual(values = pal_vec, drop = FALSE, name = "Party + Decision") +
#    labs(
#      title = paste0(ifelse(model_type == "adver", "Adver", "Legis"),
#                     " Senate Decision Mode by State (", congress_num, "th)")
#    ) +
#    theme_minimal(base_size = 14) +
#    theme(legend.position = "bottom") +
#    coord_sf(xlim = c(-125, -65), ylim = c(24, 50), expand = FALSE)
  
#  if (!is.null(save_path)) {
#    save_to_output(filename = save_path, plot = main_map, width = save_width, height = #save_height)
#  }
  
#  return(list(
#    plot = main_map,
#    states_map = states_map,
#    decision_df = decision_df,
#    state_centroids = state_centroids,
#    plot_points = plot_points
#  ))
#}
```

```{r}
#| label: senate map debug
#| echo: false

# plot_decision_map_by_congress_senate_debug(
#  115,
#  adver_cg_heatmap1,
#  model_type = "adver",
#  save_path = "adver_115_map_state.png",
#  shapefile_path = "cb_2020_us_state_20m/cb_2020_us_state_20m.shp"
#)

#unique(states_map$state_code)
#unique(adver_cg_heatmap1$state_code)

# map cleansing ----

# 1. è¯»å–æœ¬åœ° shapefile
#states_map <- st_read("cb_2020_us_state_20m/cb_2020_us_state_20m.shp")

# 2. å»æ‰ä¸æ˜¯å·çš„åŒºåŸŸï¼ˆæ¯”å¦‚æ³¢å¤šé»å„ã€å…³å²›ç­‰ï¼‰
#states_map <- states_map %>% 
#  filter(!STUSPS %in% c("PR", "VI", "GU", "MP", "AS"))

# 3. æ”¹åˆ—åï¼ŒæŠŠ STUSPS ä½œä¸º state_code
#states_map <- states_map %>%
#  mutate(state_code = STUSPS)

# 4. åˆå¹¶ shapefile å’Œä½ çš„æ•°æ®
#plot_df <- states_map %>%
#  left_join(adver_cg_heatmap1 %>% 
#              select(state_code, decision, party),
#            by = "state_code") %>%
#  mutate(
#    party = as.character(party),
#    decision = as.character(decision),
#    group_var = ifelse(
#      is.na(party) | is.na(decision) | party == "" | decision == "",
#      "missing",
#      paste0(party, "_", decision)
#    )
#  )

```

# 4. overall descriptive analysis for issues

## 4.1 analysis based on original data

### 4.1.1 news_data

hereby using original data news_data and bills_data to depict issues

```{r}
#| label: news_data cleansing
#| echo: false

news_data_aug <- news_data %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    bioguide %>%
      mutate(congress = as.integer(congress)) %>% 
      dplyr::select(bioguide_id, congress, chamber, gender, party),
    by = c("mid" = "bioguide_id", "congress" = "congress")
  ) %>%
  filter(congress != 119)

news_data$congress <- as.character(news_data$congress)

missing_keys <- news_data %>%
  dplyr::select(mid, congress) %>%
  distinct() %>%
  anti_join(adver_sum1 %>% dplyr::select(bioguide_id, congress) %>% distinct(),
            by = c("mid" = "bioguide_id", "congress"))

news_data_clean <- news_data_aug %>%
  filter(!is.na(chamber), !is.na(gender), !is.na(party)) 
# already proven that these data belongs to legislators who did not continue to serve the congress

names(news_data)
```

issue YoY&QoQ changes

```{r}
#| label: issues news YoY&MoM
#| echo: false

issue_trend <- news_data_clean %>%
  group_by(congress, issue) %>%
  summarise(news_count = n(), .groups = "drop") 

names(issue_trend)

issue_trend$congress <- as.numeric(issue_trend$congress)
str(issue_trend$congress)

# è®¡ç®—åŒæ¯”ç¯æ¯”
issue_trend_YM <- issue_trend %>%
  # ç¡®ä¿æ²¡æœ‰ä»»ä½•åˆ†ç»„å±æ€§æˆ–å› å­å¹²æ‰°
  ungroup() %>%
  mutate(
    issue = as.character(issue),
    congress = as.numeric(congress)
  ) %>%
  arrange(issue, congress) %>%
  group_by(issue) %>%
  mutate(
    prev_news = dplyr::lag(news_count, 1, default = NA),
    yoy_change = ifelse(!is.na(prev_news) & prev_news != 0,
                        (news_count - prev_news) / prev_news * 100, NA),
    mom_change = ifelse(!is.na(prev_news) & prev_news != 0,
                        (news_count / prev_news) - 1, NA)
  ) %>%
  ungroup()

issue_trend_YM <- issue_trend_YM %>%
  mutate(
    weighted_yoy = yoy_change * sqrt(news_count / max(news_count)),
    z_weighted_yoy = as.numeric(scale(weighted_yoy)),
    z_news = as.numeric(scale(news_count)),
    growth_momentum = 0.7 * z_weighted_yoy + 0.3 * z_news
  )

# å¯é€‰ï¼šä¿ç•™å…³é”®å­—æ®µæŸ¥çœ‹
issue_trend_YM %>%
  filter(issue == "Agriculture and Food")

save_to_output("issues_news_change_YM.csv",  data = issue_trend_YM)

```

```{r}
#| label: issues news YoY&MoM visualization
#| echo: false

# ------ function ------
plot_issue_trend_change <- function(df,
                                    issues = NULL,
                                    save_path = file.path(output_dir, "issue_trend_plots"),
                                    show_yoy = TRUE,
                                    show_mom = TRUE,
                                    width = 8,
                                    height = 5) {

  # æ£€æŸ¥è¾“å‡ºå­ç›®å½•
  if (!dir.exists(save_path)) dir.create(save_path)

  # è‹¥æœªæŒ‡å®š issueï¼Œåˆ™ç»˜åˆ¶å…¨éƒ¨
  if (is.null(issues)) {
    issues <- unique(df$issue)
  }

  message("ğŸ¨ Generating trend plots for ", length(issues), " issues...")

  for (iss in issues) {
    subdf <- df[df$issue == iss, ]

    # ä¿è¯æŒ‰ congress æ’åº
    subdf <- subdf[order(subdf$congress), ]

    # ç»˜å›¾
    p <- ggplot(subdf, aes(x = congress)) +
      geom_line(aes(y = news_count, group = 1, color = "News Count"), linewidth = 1) +
      geom_point(aes(y = news_count, color = "News Count"), size = 2) +
      scale_color_manual(values = c("News Count" = "#2C7BB6", "YoY Change" = "#D7191C", "MoM Change" = "#FDAE61")) +
      labs(
        title = paste0("Issue Trend: ", iss),
        x = "Congress",
        y = "Count / Change (%)",
        color = "Metric"
      ) +
      theme_minimal(base_size = 13) +
      theme(
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "bottom"
      )

    # æ·»åŠ åŒæ¯”ä¸ç¯æ¯”å˜åŒ–æ›²çº¿
    if (show_yoy && "yoy_change" %in% names(subdf)) {
      p <- p + geom_line(aes(y = yoy_change, color = "YoY Change"), linewidth = 1, linetype = "dashed")
    }
    if (show_mom && "mom_change" %in% names(subdf)) {
      p <- p + geom_line(aes(y = mom_change, color = "MoM Change"), linewidth = 1, linetype = "dotted")
    }

    # ä¿å­˜æ–‡ä»¶
    filename <- paste0("issue_trend_", gsub("[^A-Za-z0-9]+", "_", iss), ".png")
    filepath <- file.path(save_path, filename)
    ggsave(filepath, plot = p, width = width, height = height, dpi = 300)

    message("âœ… Saved: ", filepath)
  }

  message("ğŸ‰ All issue trend plots saved to: ", save_path)
}

# ------ aaplication ------
plot_issue_trend_change(
  df = issue_trend_YM,
  save_path = file.path(output_dir, "news_issue_trend_plots"),
  show_yoy = TRUE,
  show_mom = TRUE
)
```

```{r}
#| label: issues news YoY&MoM visualization2
#| echo: false

issue_trend_YM <- issue_trend_YM %>%
  drop_na() %>%
  mutate(congress = as.factor(congress))

ggplot(issue_trend_YM, aes(x = reorder(issue, growth_momentum), y = growth_momentum, fill = congress)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_manual(
    values = c(
      "115" = "#FFD700", 
      "116" = "#2E74C0",  # è“è‰²
      "117" = "#CB454A",  # çº¢è‰²
      "118" = "#009966"   # ç»¿è‰²
    )
  ) +
  theme_minimal() +
  labs(
    title = "Growth Momentum of Issue Mentions by Congress",
    x = "Issue",
    y = "Scaled Growth Momentum",
    fill = "Congress"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.y = element_text(size = 10)
  )
```

issues have major change on news data from 115th to 118th congress

```{r}
#| label: issues news dramatic change
#| echo: false


# find the most drastic change 
issue_trend_change <- issue_trend %>%
  group_by(issue) %>%
  summarize(
    change = (news_count[congress == max(as.numeric(congress))] - news_count[congress == min(as.numeric(congress))]) /
             news_count[congress == min(as.numeric(congress))],
    .groups = "drop"
  ) %>%
  arrange(desc(abs(change)))  # rank according to the absolute change

top_issues <- issue_trend_change %>% slice(1:10) %>% pull(issue)


# plot
p <- ggplot(issue_trend %>% filter(issue %in% top_issues),
       aes(x = as.numeric(congress), y = news_count, color = issue)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "issue change 115â€“118",
    x = "Congress",
    y = "news number",
    color = "issue"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Dark2") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

save_to_output("issue change most 115â€“118_news.png", plot = p, width = 8, height = 4, dpi = 300)
```

trends plot for all issues

```{r}
#| label: issues news all trend
#| echo: false

library(viridis)

issue_trend_pct <- issue_trend %>%
  filter(congress <= 118) %>%   # âœ… æ˜ç¡®å»æ‰ 119 å±Š
  group_by(congress) %>%
  mutate(
    total_news = sum(news_count, na.rm = TRUE),
    pct = (news_count / total_news) * 100
  ) %>%
  ungroup()

issue_trend_last <- issue_trend_pct %>%
  group_by(issue) %>%
  filter(congress == max(congress)) %>%
  ungroup()

unique(news_data_clean$congress)
unique(issue_trend$congress)
unique(issue_trend_pct$congress)
unique(issue_trend_last$congress)


# è‰²å½©æ–¹æ¡ˆæ”¹è¿›
n_colors <- length(unique(issue_trend_pct$issue))
library(ggsci)
library(randomcoloR)

colors <- c(
  pal_npg("nrc")(10),
  pal_d3("category20")(20),
  distinctColorPalette(n_colors)
)[1:n_colors]

p <- ggplot(issue_trend_pct, aes(x = as.numeric(congress), y = pct, color = issue)) +
  geom_line(size = 1) +
  geom_point(size = 1.5) +
  geom_text_repel(
    data = issue_trend_last,
    aes(label = issue),
    size = 3,
    nudge_x = 1,
    direction = "y",
    segment.size = 0.2,
    show.legend = FALSE
  ) +
  labs(
    title = "Issue Share per Congress (as % of total news)",
    x = "Congress",
    y = "Share (%)"
  ) +
  scale_x_continuous(breaks = 115:118) +  # âœ… æ˜ç¡®åªæ˜¾ç¤º115â€“118
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal() +
  scale_color_manual(values = colors) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"
  )

p

save_to_output("issue_share_per_congress_115â€“118_news.png", plot = p, width = 10, height = 8, dpi = 300)
```

news issue attention by party

```{r}
#| label: party issue attention news
#| echo: false

# 1. æ¯ä¸ªè®®å‘˜åœ¨æ¯å±Šå¯¹æŸè®®é¢˜çš„å…³æ³¨æ¬¡æ•°
issue_counts_mid <- news_data_clean %>%
  group_by(party, mid, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. èšåˆåˆ°  party å±‚é¢
issue_counts_party <- issue_counts_mid %>%
  group_by(party, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

issue_counts_party <- issue_counts_party %>%
  filter(!party %in% c("Independent", "I")) 

# ç¡®ä¿æ¯ä¸ªå…šæ´¾å†…éƒ¨æŒ‰æ•°é‡æ’åº
issue_counts_party <- issue_counts_party %>%
  group_by(party) %>%
  mutate(issue = reorder_within(issue, total_mentions, party))

# å¯¼å‡ºä¸º CSV
save_to_output("top_issues_party_news.csv", data = issue_counts_party)

# visualization
p_issue_party_split <- ggplot(issue_counts_party, aes(
  x = reorder(issue, total_mentions),
  y = total_mentions,
  fill = party
)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_x_reordered(labels = function(x) gsub("___.*$", "", x)) + 
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "News Mentions by Issue (Separated by Party)",
    x = "Issue",
    y = "Number of News Mentions"
  ) +
  facet_wrap(~ party, ncol = 1, scales = "free_y") +  # ä¸Šä¸‹åˆ†ä¸¤ä¸ªå›¾
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold")
  )

p_issue_party_split

```

```{r}
#| label: congress issue attention
#| echo: false

# 1. æ¯ä¸ªè®®å‘˜åœ¨æ¯å±Šå¯¹æŸè®®é¢˜çš„å…³æ³¨æ¬¡æ•°
issue_counts_mid <- news_data_clean %>%
  group_by(congress, chamber, party, mid, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. èšåˆåˆ° chamber Ã— party å±‚é¢
top_issues_congress <- issue_counts_mid %>%
  group_by(congress, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

# 3. å–æ¯å±Šæ¯ä¸ª chamber Ã— party çš„ Top 1 è®®é¢˜
top_issues_congress <- top_issues_congress %>%
  group_by(congress) %>%
  slice_max(order_by = total_mentions, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(congress, desc(total_mentions))

ggplot(top_issues_congress, aes(x = fct_reorder(issue, total_mentions), y = total_mentions, fill = as.factor(congress))) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("115"="#FFD700","116"="#2E74C0","117"="#CB454A","118"="#009966")) +
  theme_minimal() +
  labs(
    title = "Top Issue Mentions by Congress",
    x = "Issue",
    y = "Total Mentions",
    fill = "Congress"
  )

# å¯¼å‡ºä¸º CSV
save_to_output("top_issues_congress_news.csv", data = top_issues_congress)

```

calculating shanon-entropy for issue news

```{r}
#| label: issues shanon entropy news
#| echo: false

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress Ã— issue çš„å‡ºç°æ¬¡æ•°
issue_dist <- news_data_clean %>%
  filter(!is.na(mid), !is.na(issue), !is.na(congress)) %>%
  group_by(mid, congress, issue, gender, chamber, party) %>%
  summarise(n = n(), .groups = "drop")

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress çš„æ€»æ–°é—»æ•°
issue_total <- issue_dist %>%
  group_by(mid, congress, gender, chamber, party) %>%
  summarise(total = sum(n), .groups = "drop")

# åˆå¹¶å¹¶è®¡ç®— p_k
issue_prob <- issue_dist %>%
  left_join(issue_total,
            by = c("mid", "congress", "gender", "chamber", "party")) %>%
  mutate(p = n / total)

# è®¡ç®— Shannon entropy
entropy_news <- issue_prob %>%
  group_by(mid, congress, gender, chamber, party) %>%
  summarise(
    shannon_entropy = -sum(p * log(p)),   # é»˜è®¤è‡ªç„¶å¯¹æ•°
    n_issues = n_distinct(issue),
    total_news = sum(n),
    .groups = "drop"
  )
head(entropy_news)

# plot
entropy_summary <- entropy_news %>%
  group_by(congress) %>%
  summarise(mean_entropy = mean(shannon_entropy, na.rm = TRUE),
            median_entropy = median(shannon_entropy, na.rm = TRUE))
p <- ggplot(entropy_summary, aes(x = congress, y = mean_entropy)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x = "Congress", y = "Mean Shannon Entropy",
       title = "News Average Attention Diversity by Congress")

save_to_output("Average Attention Diversity by Congress-news.png", plot = p, width = 8, height = 4, dpi = 300)
```

### 4.1.2 bills data

bills data cleansing

```{r}
#| label: bills data cleansing
#| echo: false

bills_data_aug <- bills_data %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    bioguide %>%
      mutate(congress = as.integer(congress)) %>% 
      dplyr::select(bioguide_id, congress, chamber, gender, party),
    by = c("bioguide_id" = "bioguide_id", "congress" = "congress")
  ) %>%
  filter(congress != 119) 

bills_data_aug <- bills_data_aug %>%
  left_join(
    legis_cg %>%
      mutate(congress = as.integer(congress)) %>%
      dplyr::select(bioguide_id, congress, decision, intl_percentage, prof_percentage, dom_percentage),
    by = c("bioguide_id" = "bioguide_id", "congress" = "congress")
  )

summary(bills_data_aug)
sum(is.na(bills_data_aug$party))
```

```{r}
#| label: issues bills YoY&MoM
#| echo: false

issue_trend <- bills_data_aug %>%
  group_by(congress, issue) %>%
  summarise(news_count = n(), .groups = "drop")

issue_trend$congress <- as.numeric(issue_trend$congress)
str(issue_trend$congress)

# è®¡ç®—åŒæ¯”ç¯æ¯”
issue_trend_YM <- issue_trend %>%
  # ç¡®ä¿æ²¡æœ‰ä»»ä½•åˆ†ç»„å±æ€§æˆ–å› å­å¹²æ‰°
  ungroup() %>%
  mutate(
    issue = as.character(issue),
    congress = as.numeric(congress)
  ) %>%
  arrange(issue, congress) %>%
  group_by(issue) %>%
  mutate(
    prev_news = dplyr::lag(news_count, 1, default = NA),
    yoy_change = ifelse(!is.na(prev_news) & prev_news != 0,
                        (news_count - prev_news) / prev_news * 100, NA),
    mom_change = ifelse(!is.na(prev_news) & prev_news != 0,
                        (news_count / prev_news) - 1, NA)
  ) %>%
  ungroup()

# å¯é€‰ï¼šä¿ç•™å…³é”®å­—æ®µæŸ¥çœ‹
issue_trend_YM %>%
  filter(issue == "Agriculture and Food")

issue_trend_YM <- issue_trend_YM %>%
  mutate(
    weighted_yoy = yoy_change * sqrt(news_count / max(news_count)),
    z_weighted_yoy = as.numeric(scale(weighted_yoy)),
    z_news = as.numeric(scale(news_count)),
    growth_momentum = 0.7 * z_weighted_yoy + 0.3 * z_news
  )

save_to_output("issues_bills_change_YM.csv", data = issue_trend_YM)

# ----- visualization -----
plot_issue_trend_change(
  df = issue_trend_YM,
  save_path = file.path(output_dir, "bills_issue_trend_plots"),
  show_yoy = TRUE,
  show_mom = TRUE
)
```

```{r}
#| label: issues bills YoY&MoM visualization2
#| echo: false

issue_trend_YM <- issue_trend_YM %>%
  drop_na() %>%
  mutate(congress = as.factor(congress))

ggplot(issue_trend_YM, aes(x = reorder(issue, growth_momentum), y = growth_momentum, fill = congress)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_manual(
    values = c(
      "115" = "#FFD700", 
      "116" = "#2E74C0",  # è“è‰²
      "117" = "#CB454A",  # çº¢è‰²
      "118" = "#009966"   # ç»¿è‰²
    )
  ) +
  theme_minimal() +
  labs(
    title = "Growth Momentum of Issue Mentions Bills",
    x = "Issue",
    y = "Scaled Growth Momentum",
    fill = "Congress"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.y = element_text(size = 10)
  )
```

issues have major change on bills data from 115th to 118th congress

```{r}
#| label: issues bills dramatic change
#| echo: false


# ----- æ‰¾å‡ºå˜åŒ–æœ€å‰§çƒˆçš„è®®é¢˜ -----
issue_trend_change <- issue_trend %>%
  group_by(issue) %>%
  summarize(
    change = (news_count[congress == max(as.numeric(congress))] - news_count[congress == min(as.numeric(congress))]) /
             news_count[congress == min(as.numeric(congress))],
    .groups = "drop"
  ) %>%
  arrange(desc(abs(change)))  # æŒ‰ç»å¯¹å˜åŒ–æ’åº
top_issues <- issue_trend_change %>% slice(1:10) %>% pull(issue)

# ----- plot -----
p <- ggplot(issue_trend %>% filter(issue %in% top_issues),
       aes(x = as.numeric(congress), y = news_count, color = issue)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Top Issues Trend Across Congress 115â€“118",
    x = "Congress",
    y = "bills number",
    color = "issue"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Paired") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

save_to_output("issue change most 115â€“118_bills.png", plot = p, width = 8, height = 4, dpi = 300)
```

bills trends plot for all issues

```{r}
#| label: issues bills all trend
#| echo: false

issue_trend_pct <- issue_trend %>%
  filter(congress <= 118) %>%   # âœ… æ˜ç¡®å»æ‰ 119 å±Š
  group_by(congress) %>%
  mutate(
    total_news = sum(news_count, na.rm = TRUE),
    pct = (news_count / total_news) * 100
  ) %>%
  ungroup()

issue_trend_last <- issue_trend_pct %>%
  group_by(issue) %>%
  filter(congress == max(congress)) %>%
  ungroup()

unique(news_data_clean$congress)
unique(issue_trend$congress)
unique(issue_trend_pct$congress)
unique(issue_trend_last$congress)


# è‰²å½©æ–¹æ¡ˆæ”¹è¿›
n_colors <- length(unique(issue_trend_pct$issue))
library(ggsci)
library(randomcoloR)

colors <- c(
  pal_npg("nrc")(10),
  pal_d3("category20")(20),
  distinctColorPalette(n_colors)
)[1:n_colors]

p <- ggplot(issue_trend_pct, aes(x = as.numeric(congress), y = pct, color = issue)) +
  geom_line(size = 1) +
  geom_point(size = 1.5) +
  geom_text_repel(
    data = issue_trend_last,
    aes(label = issue),
    size = 3,
    nudge_x = 1,
    direction = "y",
    segment.size = 0.2,
    show.legend = FALSE
  ) +
  labs(
    title = "Issue Share per Congress (as % of total bills)",
    x = "Congress",
    y = "Share (%)"
  ) +
  scale_x_continuous(breaks = 115:118) +  # âœ… æ˜ç¡®åªæ˜¾ç¤º115â€“118
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal() +
  scale_color_manual(values = colors) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"
  )

p

save_to_output("issue_share_per_congress_115â€“118_bills.png", plot = p, width = 10, height = 8, dpi = 300)
```

```{r}
#| label: chamber party bills issue attention
#| echo: false

# 1. æ¯ä¸ªè®®å‘˜åœ¨æ¯å±Šå¯¹æŸè®®é¢˜çš„å…³æ³¨æ¬¡æ•°
issue_counts_mid <- bills_data_aug %>%
  group_by(congress, chamber, party, bioguide_id, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. èšåˆåˆ° chamber Ã— party å±‚é¢
issue_counts_chamber_party <- issue_counts_mid %>%
  group_by(congress, chamber, party, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

# 3. å–æ¯å±Šæ¯ä¸ª chamber Ã— party çš„ Top 1 è®®é¢˜
top_issues_chamber_party <- issue_counts_chamber_party %>%
  group_by(congress, chamber, party) %>%
  slice_max(order_by = total_mentions, n = 1, with_ties = FALSE) %>%
  arrange(congress, chamber, party, desc(total_mentions))

# æŸ¥çœ‹ç»“æœ
top_issues_chamber_party

# å¯¼å‡ºä¸º CSV
save_to_output("top_issues_chamber_party_bills.csv", data = top_issues_chamber_party)

```

```{r}
#| label: congress issue attention bills
#| echo: false

# 1. æ¯ä¸ªè®®å‘˜åœ¨æ¯å±Šå¯¹æŸè®®é¢˜çš„å…³æ³¨æ¬¡æ•°
issue_counts_mid <- bills_data_aug %>%
  group_by(congress, chamber, party, bioguide_id, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. èšåˆåˆ° chamber Ã— party å±‚é¢
top_issues_congress <- issue_counts_mid %>%
  group_by(congress, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

# 3. å–æ¯å±Šæ¯ä¸ª chamber Ã— party çš„ Top 1 è®®é¢˜
top_issues_congress <- top_issues_congress %>%
  group_by(congress) %>%
  slice_max(order_by = total_mentions, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(congress, desc(total_mentions))

ggplot(top_issues_congress, aes(x = fct_reorder(issue, total_mentions), y = total_mentions, fill = as.factor(congress))) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("115"="#FFD700","116"="#2E74C0","117"="#CB454A","118"="#009966")) +
  theme_minimal() +
  labs(
    title = "Top Issue Mentions by Congress",
    x = "Issue",
    y = "Total Mentions",
    fill = "Congress"
  )

# å¯¼å‡ºä¸º CSV
save_to_output("top_issues_congress_bills.csv", data = top_issues_congress)

```

```{r}
#| label: party issue attention bills
#| echo: false

# 1. æ¯ä¸ªè®®å‘˜åœ¨æ¯å±Šå¯¹æŸè®®é¢˜çš„å…³æ³¨æ¬¡æ•°
issue_counts_mid <- bills_data_aug %>%
  group_by(party, bioguide_id, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. èšåˆåˆ°  party å±‚é¢
issue_counts_party <- issue_counts_mid %>%
  group_by(party, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

issue_counts_party <- issue_counts_party %>%
  filter(!party %in% c("Independent", "I")) 

# ç¡®ä¿æ¯ä¸ªå…šæ´¾å†…éƒ¨æŒ‰æ•°é‡æ’åº
issue_counts_party <- issue_counts_party %>%
  group_by(party) %>%
  mutate(issue = reorder_within(issue, total_mentions, party))

# å¯¼å‡ºä¸º CSV
save_to_output("top_issues_party_news.csv", data = issue_counts_party)

# visualization
p_issue_party_split <- ggplot(issue_counts_party, aes(
  x = reorder(issue, total_mentions),
  y = total_mentions,
  fill = party
)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_x_reordered(labels = function(x) gsub("___.*$", "", x)) + 
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Bills Mentions by Issue (Separated by Party)",
    x = "Issue",
    y = "Number of Bills Mentions"
  ) +
  facet_wrap(~ party, ncol = 1, scales = "free_y") +  # ä¸Šä¸‹åˆ†ä¸¤ä¸ªå›¾
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold")
  )

p_issue_party_split

```

```{r}
#| label: congress issue attention bills party
#| echo: false

# ---- 1. æ•°æ®æ¸…ç† ----
bills_clean <- bills_data_aug %>%
  filter(!is.na(issue) & issue != "") %>%          # å»æ‰è®®é¢˜ç¼ºå¤±
  filter(!party %in% c("Independent", "I"))        # å»æ‰ç‹¬ç«‹å…šæ´¾

# ---- 2. èšåˆç»Ÿè®¡ ----
bills_count <- bills_clean %>%
  group_by(congress, party, issue) %>%
  summarise(
    bill_count = n(),      # æ¯å±Šå›½ä¼šã€å…šæ´¾ã€è®®é¢˜çš„æ³•æ¡ˆæ•°é‡
    .groups = "drop"
  )

# ---- 3. å¯è§†åŒ– ----
library(ggplot2)
library(patchwork)

plot_bill_count <- function(data, congress_num) {
  data %>%
    filter(congress == congress_num) %>%
    ggplot(aes(x = reorder(issue, bill_count), y = bill_count, fill = party)) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(
      values = c(
        "Democratic" = "#2E74C0",  # è“è‰²
        "Republican" = "#CB454A"   # çº¢è‰²
      )
    ) +
    labs(
      title = paste0("Number of Bills by Party â€” ", congress_num, "th Congress"),
      x = "Issue",
      y = "Number of Bills"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "top"
    )
}

# ---- 4. ç”Ÿæˆå››å±Šå›½ä¼šçš„å›¾ ----
p115 <- plot_bill_count(bills_count, 115)
p116 <- plot_bill_count(bills_count, 116)
p117 <- plot_bill_count(bills_count, 117)
p118 <- plot_bill_count(bills_count, 118)


p115
p116
p117
p118

```

calculating shanon-entropy for bills news

```{r}
#| label: issues shanon entropy bills
#| echo: false

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress Ã— issue çš„å‡ºç°æ¬¡æ•°
issue_dist <- bills_data_aug %>%
  filter(!is.na(bioguide_id), !is.na(issue), !is.na(congress)) %>%
  group_by(bioguide_id, congress, issue, gender, chamber, party) %>%
  summarise(n = n(), .groups = "drop")

# è®¡ç®—æ¯ä¸ªè®®å‘˜åœ¨æ¯ä¸ª congress çš„æ€»æ–°é—»æ•°
issue_total <- issue_dist %>%
  group_by(bioguide_id, congress, gender, chamber, party) %>%
  summarise(total = sum(n), .groups = "drop")

# åˆå¹¶å¹¶è®¡ç®— p_k
issue_prob <- issue_dist %>%
  left_join(issue_total,
            by = c("bioguide_id", "congress", "gender", "chamber", "party")) %>%
  mutate(p = n / total)

# è®¡ç®— Shannon entropy
entropy_bills <- issue_prob %>%
  group_by(bioguide_id, congress, gender, chamber, party) %>%
  summarise(
    shannon_entropy = -sum(p * log(p)),   # é»˜è®¤è‡ªç„¶å¯¹æ•°
    n_issues = n_distinct(issue),
    total_news = sum(n),
    .groups = "drop"
  )
head(entropy_bills)

# violin plot
ggplot(entropy_bills, aes(x = factor(congress), y = shannon_entropy)) +
  geom_violin(fill = "skyblue", alpha = 0.5) +
  geom_boxplot(width = 0.1, outlier.size = 0.5) +
  theme_minimal() +
  labs(x = "Congress", y = "Shannon Entropy",
       title = "Distribution of Attention Diversity per Congress")

# line graph
entropy_summary <- entropy_bills %>%
  group_by(congress) %>%
  summarise(mean_entropy = mean(shannon_entropy, na.rm = TRUE),
            median_entropy = median(shannon_entropy, na.rm = TRUE))
p <- ggplot(entropy_summary, aes(x = congress, y = mean_entropy)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x = "Congress", y = "Mean Shannon Entropy",
       title = "Bills Average Attention Diversity by Congress")

save_to_output("Average Attention Diversity by Congress-bills.png", plot = p, width = 8, height = 4, dpi = 300)
```

### 4.1.3 legislators fulfill promise check

```{r}
#| label: legislator fulfill promise dataset
#| echo: false

# Step 1: å¯¹newsæ•°æ®æ±‡æ€»
news_summary <- news_data_aug %>%
  group_by(congress, chamber, gender, party, issue, mid) %>%
  summarise(news_count = n(), .groups = "drop") %>%
  mutate(news_flag = 1) %>%
  rename(legislator_id = mid)

# Step 2: å¯¹billsæ•°æ®æ±‡æ€»
bills_summary <- bills_data_aug %>%
  group_by(congress, chamber, gender, party, issue, bioguide_id) %>%
  summarise(bill_count = n(), .groups = "drop") %>%
  mutate(bill_flag = 1) %>%
  rename(legislator_id = bioguide_id)


# Step 3: ç»Ÿä¸€å­—æ®µåå†joinï¼ˆç°åœ¨æ˜¯ä¸€å¯¹ä¸€æˆ–ä¸€å¯¹é›¶ï¼‰
merged_data <- full_join(
  news_summary,
  bills_summary,
  by = c("congress", "issue", "chamber", "gender", "party", "legislator_id"),
  suffix = c("_news", "_bill")
) 

merged_data <- merged_data %>%
  mutate(
    news_count = replace_na(news_count, 0),
    bill_count = replace_na(bill_count, 0),
    news_flag = replace_na(news_flag, 0),
    bill_flag = replace_na(bill_flag, 0),
    fulfilled = ifelse(news_flag == 1 & bill_flag == 1, 1, 0)
  ) %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    legis_cg %>%
      mutate(congress = as.integer(congress)) %>%
      dplyr::select(congress, bioguide_id, decision, intl_percentage, prof_percentage, dom_percentage),
    by = c("legislator_id" = "bioguide_id", "congress" = "congress")
  )

# Step 4: è¡¥é½NA
merged_data <- merged_data %>%
  mutate(
    fulfilled = ifelse(news_flag == 1 & bill_flag == 1, 1, 0)
  ) %>%
  drop_na()

# Step 5: è®¡ç®—å…‘ç°æŒ‡æ ‡
merged_data <- merged_data %>%
  mutate(
    fulfilled = ifelse(news_flag == 1 & bill_flag == 1, 1, 0)
  )

merged_clean <- merged_data %>%
  filter(if_all(everything(), ~ !is.na(.)))

names(merged_clean)

# Step 6: å¯é€‰ï¼šç»Ÿè®¡å±‚çº§ç»“æœï¼ˆä¾‹å¦‚æ¯ä¸ªè®®é¢˜çš„å…‘ç°æ¯”ä¾‹ï¼‰
issue_summary <- merged_data %>%
  group_by(congress, issue, gender, party) %>%
  summarise(
    total_news = sum(news_flag),
    total_bills = sum(bill_flag),
    fulfilled_cases = sum(fulfilled),
    fulfillment_rate = fulfilled_cases / total_news,
    .groups = "drop"
  )

```

```{r}
#| label: legislator fulfill promise fulfill rate analysis
#| echo: false

cor(merged_data$bill_count, merged_data$news_count, use="complete.obs")

# ------- party   -------
slope_party <- merged_data %>%
  filter(!party %in% c("Independent", "I")) %>%
  group_by(party) %>%
  summarise(
    slope = coef(lm(news_count ~ bill_count))[2]
  )%>%
  mutate(
    x = Inf,             
    y = c(Inf, Inf * 0.9) 
  )

p_party <- ggplot(merged_data %>% filter(!party %in% c("Independent", "I")),
                  aes(x = bill_count, y = news_count, color = party)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(
    data = slope_party,
    aes(x = Inf, y = Inf,
        label = paste0("Slope = ", round(slope, 2))),
    hjust = 1.1, vjust = c(2, 4),
    size = 4, show.legend = FALSE
  ) +
  scale_color_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Legislative vs Promotional Activities by Party",
    x = "Number of Bills Sponsored",
    y = "Number of News Mentions",
    color = "Party"
  ) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))


# ------- gender   -------
slope_gender <- merged_data %>%
  group_by(gender) %>%
  summarise(
    slope = coef(lm(news_count ~ bill_count))[2]
  )%>%
  mutate(
    x = Inf,              # æ”¾åœ¨å›¾å³è¾¹
    y = c(Inf, Inf * 0.9) # ç¨å¾®é”™å¼€ä¸€ç‚¹é«˜åº¦
  )

p_gender <- ggplot(merged_data, aes(x = bill_count, y = news_count, color = gender)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(
    data = slope_gender,
    aes(x = Inf, y = Inf,
        label = paste0("Slope = ", round(slope, 2))),
    hjust = 1.1, vjust = c(2, 4),
    size = 4, show.legend = FALSE
  ) +
  scale_color_manual(values = c("M" = "#1F78B4", "F" = "#E31A1C")) +
  labs(
    title = "Legislative vs Promotional Activities by Gender",
    x = "Number of Bills Sponsored",
    y = "Number of News Mentions",
    color = "Gender"
  ) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))


p_party
p_gender
```

```{r}
#| label: legislator fulfill promise party issues attention
#| echo: false

# ------ fulfill rate top5 issues by party  ------
top5_issue_by_party <- issue_summary %>%
  filter(!is.na(fulfillment_rate)) %>%
  group_by(congress, party) %>%
  arrange(desc(fulfillment_rate), .by_group = TRUE) %>%
  slice_head(n = 5) %>%
  ungroup()

top5_issue_by_party %>%
  arrange(congress, party, desc(fulfillment_rate)) %>%
  dplyr::select(congress, party, issue, fulfillment_rate)

ggplot(top5_issue_by_party, 
       aes(x = reorder(issue, fulfillment_rate), 
           y = fulfillment_rate, 
           fill = party)) +
  geom_col(position = "dodge") +
  coord_flip() +
  facet_wrap(~ congress, scales = "free_y") +
  scale_fill_manual(
    values = c(
      "Democratic" = "#2E74C0",  # è“
      "Republican" = "#CB454A"   # çº¢
    )
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Top 5 Issues by Fulfillment Rate per Party and Congress",
    x = "Issue",
    y = "Fulfillment Rate"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top",
    strip.text = element_text(face = "bold")
  )




```

```{r}
#| label: legislator fulfill promise party across congress analysis
#| echo: false

# 1. case rate
# å…šæ´¾ç»´åº¦ï¼ˆå»æ‰ç‹¬ç«‹å…šæ´¾ï¼‰
party_fulfill <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%  # å»æ‰ç‹¬ç«‹å…šæ´¾
  group_by(party, issue) %>%
  summarise(
    total = n(),
    fulfilled = sum(fulfilled == 1),
    fulfill_rate = fulfilled / total,
    .groups = "drop"
  )

# 2. visualization - across congress - split
p_party_split <- ggplot(party_fulfill, aes(x = reorder(issue, fulfill_rate), y = fulfill_rate, fill = party)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Fulfillment Rate by Issue (Separated by Party)",
    x = "Issue",
    y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~ party, ncol = 1) +  # æ‹†æˆä¸¤ä¸ªå›¾ï¼Œæ¯ä¸ªå…šä¸€ä¸ª
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold")
  )
p_party_split

# 3. visualization - across congress
p_dem <- ggplot(subset(party_fulfill, party == "Democratic"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#2E74C0") +
  geom_text(
    aes(label = scales::percent(fulfill_rate, accuracy = 0.1)),
    hjust = -0.1, size = 3.5
  ) +
  coord_flip() +
  labs(
    title = "Democratic: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, max(party_fulfill$fulfill_rate) * 1.1)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

p_rep <- ggplot(subset(party_fulfill, party == "Republican"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#CB454A") +
  geom_text(
    aes(label = scales::percent(fulfill_rate, accuracy = 0.1)),
    hjust = -0.1, size = 3.5
  ) +
  coord_flip() +
  labs(
    title = "Republican: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, max(party_fulfill$fulfill_rate) * 1.1)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
p_dem
p_rep

# 4. visualization - all congress (with total)
# --- æ°‘ä¸»å…š ---
p_dem <- ggplot(subset(party_fulfill, party == "Democratic"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#2E74C0") +
  geom_text(aes(
    label = paste0(
      scales::percent(fulfill_rate, accuracy = 1),
      "\n(n=", total, ")"
    )
  ),
  hjust = -0.1, size = 3.2) +
  coord_flip() +
  labs(
    title = "Democratic: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1.05)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# --- å…±å’Œå…š ---
p_rep <- ggplot(subset(party_fulfill, party == "Republican"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#CB454A") +
  geom_text(aes(
    label = paste0(
      scales::percent(fulfill_rate, accuracy = 1),
      "\n(n=", total, ")"
    )
  ),
  hjust = -0.1, size = 3.2) +
  coord_flip() +
  labs(
    title = "Republican: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1.05)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

p_dem
p_rep

```

```{r}
#| label: legislator fulfill promise party each congress analysis rate
#| echo: false

# 1. case rate by congress
party_fulfill_congress <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%  # å»æ‰ç‹¬ç«‹å…šæ´¾
  group_by(congress, party, issue) %>%
  summarise(
    total = n(),
    fulfilled = sum(fulfilled == 1),
    fulfill_rate = fulfilled / total,
    .groups = "drop"
  )

# 2. visualization - across congress
plot_fulfill_by_congress <- function(data, congress_num) {
  data %>%
    filter(congress == congress_num) %>%
    ggplot(aes(x = reorder(issue, fulfill_rate), y = fulfill_rate, fill = party)) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(
      values = c(
        "Democratic" = "#2E74C0",
        "Republican" = "#CB454A"
      )
    ) +
    labs(
      title = paste0("Fulfillment Rate by Party â€” ", congress_num, "th Congress"),
      x = "Issue",
      y = "Fulfillment Rate"
    ) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "top"
    )
}

# plot
p115 <- plot_fulfill_by_congress(party_fulfill_congress, 115)
p116 <- plot_fulfill_by_congress(party_fulfill_congress, 116)
p117 <- plot_fulfill_by_congress(party_fulfill_congress, 117)
p118 <- plot_fulfill_by_congress(party_fulfill_congress, 118)

p115
p116
p117
p118

```

```{r}
#| label: legislator fulfill promise party each congress analysis count
#| echo: false

# ---- 1. æ•°æ®å‡†å¤‡ ----
party_issue_count <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%   # å»æ‰ç‹¬ç«‹å…šæ´¾
  group_by(congress, party, issue) %>%
  summarise(
    total_cases = n(),                      # æ€»æ ·æœ¬æ•°
    fulfilled_cases = sum(fulfilled == 1),  # å…‘ç°æ¬¡æ•°
    fulfill_rate = mean(fulfilled == 1),    # å…‘ç°ç‡
    .groups = "drop"
  )

# ---- 2. å¯è§†åŒ–å‡½æ•° ----
plot_fulfill_count <- function(data, congress_num) {
  
  # å½“å‰å±Šæ•°æ®
  df <- data %>% filter(congress == congress_num)
  
  # è®¡ç®—å½“å‰å±Šå¹³å‡å…‘ç°ç‡ï¼ˆæŒ‰å…šæ´¾ï¼‰
  avg_rates <- df %>%
    group_by(party) %>%
    summarise(mean_rate = mean(fulfill_rate, na.rm = TRUE)) %>%
    mutate(label = paste0(party, ": ", scales::percent(mean_rate, accuracy = 0.1)))
  
  # ç»˜å›¾
  p <- ggplot(df, aes(x = reorder(issue, fulfilled_cases), y = fulfilled_cases, fill = party)) +
    geom_col(position = "dodge") +
    geom_text(aes(label = fulfilled_cases),
              position = position_dodge(width = 0.9),
              hjust = -0.2,
              size = 3.2) +
    coord_flip() +
    scale_fill_manual(
      values = c(
        "Democratic" = "#2E74C0",  # è“è‰²
        "Republican" = "#CB454A"   # çº¢è‰²
      )
    ) +
    labs(
      title = paste0("Fulfilled Cases by Party â€” ", congress_num, "th Congress"),
      x = "Issue",
      y = "Number of Fulfilled Cases",
      caption = paste("Average Fulfillment Rate â€”", 
                      paste(avg_rates$label, collapse = " | "))
    ) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "top",
      plot.caption = element_text(hjust = 0.5, face = "italic", size = 10)
    )
  
  return(p)
}

# ---- 3. ç”Ÿæˆå››å±Šå›½ä¼šå›¾ ----
p115 <- plot_fulfill_count(party_issue_count, 115)
p116 <- plot_fulfill_count(party_issue_count, 116)
p117 <- plot_fulfill_count(party_issue_count, 117)
p118 <- plot_fulfill_count(party_issue_count, 118)


p115
p116
p117
p118

```

```{r}
#| label: legislator fulfill promise party across congress analysis per person
#| echo: false

# ---- 1. ç»Ÿè®¡æ¯å±Šå›½ä¼šæ¯ä¸ªå…šæ´¾çš„å…‘ç°äººæ¬¡ ----
party_fulfill_person <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%  # å»æ‰ç‹¬ç«‹å…šæ´¾
  group_by(congress, party, legislator_id) %>%   # æŒ‰è®®å‘˜ç»Ÿè®¡
  summarise(
    fulfilled_flag = any(fulfilled == 1),        # æ˜¯å¦è‡³å°‘å…‘ç°è¿‡ä¸€æ¬¡
    .groups = "drop"
  ) %>%
  group_by(congress, party) %>%
  summarise(
    fulfilled_persons = sum(fulfilled_flag),     # å…‘ç°è¿‡çš„äººæ¬¡
    total_persons = n(),                         # è¯¥å±Šè¯¥å…šæ´¾å‚ä¸çš„æ€»äººæ•°
    fulfill_rate = fulfilled_persons / total_persons,
    .groups = "drop"
  )

# ---- 2. å¯è§†åŒ–ï¼šå„å±Šå›½ä¼šä¸åŒå…šæ´¾çš„å…‘ç°äººæ¬¡ ----
p_person <- ggplot(party_fulfill_person, aes(x = as.factor(congress), y = fulfilled_persons, 
                                             group = party, color = party)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  geom_text(aes(label = fulfilled_persons), vjust = -0.6, size = 3) +
  scale_color_manual(
    values = c(
      "Democratic" = "#2E74C0",  # è“è‰²
      "Republican" = "#CB454A"   # çº¢è‰²
    )
  ) +
  labs(
    title = "Number of Legislators with Fulfilled Issues by Party and Congress",
    x = "Congress",
    y = "Number of Legislators (Fulfilled â‰¥ 1 Issue)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

p_person

```

```{r}
#| label: legislator fulfill promise chamber across congress with decision
#| echo: false

p_person_decision <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%
  group_by(congress, party, decision, legislator_id) %>%
  summarise(fulfilled_flag = any(fulfilled == 1), .groups = "drop") %>%
  group_by(congress, party, decision) %>%
  summarise(
    fulfilled_persons = sum(fulfilled_flag),
    .groups = "drop"
  ) %>%
  ggplot(aes(
    x = as.factor(congress),
    y = fulfilled_persons,
    group = interaction(party, decision),
    color = party,
    shape = decision
  )) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Fulfilled Legislators by Party, Congress, and Decision Type",
    x = "Congress",
    y = "Number of Legislators"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

p_person_decision

```

```{r}
#| label: legislator fulfill promise gender across congress analysis per person
#| echo: false

# ---- 1. ç»Ÿè®¡æ¯å±Šå›½ä¼šä¸åŒæ€§åˆ«çš„å…‘ç°äººæ¬¡ ----
gender_fulfill_person <- merged_clean %>%
  filter(!is.na(gender)) %>%  # å»æ‰ç¼ºå¤±æ€§åˆ«æ•°æ®
  group_by(congress, gender, legislator_id) %>%   # æŒ‰è®®å‘˜ç»Ÿè®¡
  summarise(
    fulfilled_flag = any(fulfilled == 1),         # æ˜¯å¦è‡³å°‘å…‘ç°è¿‡ä¸€æ¬¡
    .groups = "drop"
  ) %>%
  group_by(congress, gender) %>%
  summarise(
    fulfilled_persons = sum(fulfilled_flag),      # å…‘ç°è¿‡çš„äººæ¬¡
    total_persons = n(),                          # è¯¥å±Šè¯¥æ€§åˆ«å‚ä¸çš„æ€»äººæ•°
    fulfill_rate = fulfilled_persons / total_persons,
    .groups = "drop"
  )

# ---- 2. å¯è§†åŒ–ï¼šå„å±Šå›½ä¼šä¸åŒæ€§åˆ«çš„å…‘ç°äººæ¬¡ ----
p_gender_person <- ggplot(gender_fulfill_person, aes(
  x = as.factor(congress), y = fulfilled_persons,
  group = gender, color = gender
)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  geom_text(aes(label = fulfilled_persons), vjust = -0.6, size = 3) +
  scale_color_manual(
    values = c(
      "M" = "#1F78B4",  # ç”·æ€§è“è‰²
      "F" = "#E31A1C"   # å¥³æ€§çº¢è‰²
    ),
    labels = c("M" = "Male", "F" = "Female")
  ) +
  labs(
    title = "Number of Legislators with Fulfilled Issues by Gender and Congress",
    x = "Congress",
    y = "Number of Legislators (Fulfilled â‰¥ 1 Issue)",
    color = "Gender"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

p_gender_person

```

```{r}
#| label: legislator fulfill promise chamber across congress analysis
#| echo: false

# è®®é™¢ç»´åº¦
chamber_fulfill <- merged_clean %>%
  group_by(chamber, issue) %>%
  summarise(
    total = n(),
    fulfilled = sum(fulfilled == 1),
    fulfill_rate = fulfilled / total,
    .groups = "drop"
  )


# ---- chamber ----
p_chamber <- ggplot(chamber_fulfill, aes(x = reorder(issue, fulfill_rate), y = fulfill_rate, fill = chamber)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_viridis_d(option = "plasma", end = 0.9) +
  labs(
    title = "Fulfillment Rate by Chamber across Issues",
    x = "Issue",
    y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5))

p_party
p_chamber

```

## 4.2 issue analysis using adver_tp and legis_tp

### 4.2.1 issue heatmap by congress

```{r}
#| label: issue heatmap by congress
#| echo: false

plot_decision_mode_heatmap <- function(df, title = "Decision Mode by Issue and Congress", save_path = NULL) {

  # æ£€æŸ¥å˜é‡
  required_vars <- c("issue", "congress", "decision")
  if (!all(required_vars %in% names(df))) {
    stop("Input dataframe must contain columns: issue, congress, decision.")
  }

  # æ•°æ®å‡†å¤‡
  df <- df %>%
    dplyr::mutate(
      decision = factor(decision, levels = c("intl", "dom", "prof")),
      congress = as.factor(congress)
    )

  # ç»˜å›¾
  p <- ggplot(df, aes(x = congress, y = reorder(issue, desc(issue)), fill = decision)) +
    geom_tile(color = "white") +
    scale_fill_manual(
      values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c"),
      na.value = "grey90"
    ) +
    labs(
      title = title,
      x = "Congress",
      y = "Issue",
      fill = "Decision Mode"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid = element_blank()
    )

  # ä¿å­˜å›¾ç‰‡ï¼ˆå¦‚æœæä¾›äº†è·¯å¾„ï¼‰
  if (!is.null(save_path)) {
    save_to_output(filename = save_path, plot = p, width = 8, height = 6, dpi = 300)
  }

  return(p)
}

# use of function plot_decision_mode_heatmap()
plot_decision_mode_heatmap(legis_tp, title = "Legislative Decision Mode by Issue and Congress", save_path = "legis_mode.png")
plot_decision_mode_heatmap(adver_tp, title = "Advertise Decision Mode by Issue and Congress", save_path = "adver_mode.png")

```

### 4.2.2 focal issue of each congress

```{r}
#| label: congress focal issue
#| echo: false

plot_issue_trend_by_congress <- function(df, 
                                         save_path = NULL, 
                                         file_name = "issue_trend_heatmap.png",
                                         width = 10, 
                                         height = 8, 
                                         dpi = 300,
                                         scale_type = c("raw", "normalized", "log")) {

  scale_type <- match.arg(scale_type)

  issue_congress_label <- df %>%
    filter(!is.na(issue), !is.na(congress), !is.na(label)) %>%
    group_by(congress, issue) %>%
    summarise(total_label = sum(label, na.rm = TRUE), .groups = "drop")

  # Apply scale transformation
  if (scale_type == "normalized") {
    issue_congress_label <- issue_congress_label %>%
      group_by(congress) %>%
      mutate(scaled_label = total_label / sum(total_label, na.rm = TRUE)) %>%
      ungroup()
    fill_col <- "scaled_label"
    fill_title <- "Normalized\nProportion"
  } else if (scale_type == "log") {
    issue_congress_label <- issue_congress_label %>%
      mutate(scaled_label = log1p(total_label))  # log(1 + x)
    fill_col <- "scaled_label"
    fill_title <- "Log(Label + 1)"
  } else {
    fill_col <- "total_label"
    fill_title <- "Label Count"
  }

  heatmap_plot <- ggplot(issue_congress_label, aes(x = factor(congress), y = reorder(issue, desc(issue)), fill = .data[[fill_col]])) +
    geom_tile(color = "white") +
    scale_fill_gradient(low = "#fee8c8", high = "#e34a33") +
    labs(
      title = "Most Discussed Issues by Congress",
      x = "Congress",
      y = "Issue",
      fill = fill_title
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  print(heatmap_plot)

  if (!is.null(save_path)) {
    save_to_output(filename = save_path, plot = heatmap_plot, width = width, height = height, dpi = dpi)
  }

  return(invisible(heatmap_plot))
}

plot_issue_trend_by_congress(adver_tp, save_path = "adver_issue_trend.png", scale_type = "normalized")
plot_issue_trend_by_congress(legis_tp, save_path ="legis_issue_trend.png", scale_type = "normalized")

```

### 4.2.3 committee issue attention

```{r}
#| label: committee issue attention
#| echo: false

# 1. æ¯ä¸ªå§”å‘˜ä¼šåœ¨æ¯å±Šå¯¹æŸè®®é¢˜çš„å…³æ³¨æ¬¡æ•°
issue_counts_mid <- news_data_clean %>%
  group_by(congress, committee_el, mid, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. èšåˆåˆ°å§”å‘˜ä¼šå±‚é¢
issue_counts_party <- issue_counts_mid %>%
  group_by(congress, committee_el, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

# 3. å–æ¯å±Šå§”å‘˜ä¼š Top 1 è®®é¢˜
top_issues_committee_el <- issue_counts_party %>%
  group_by(congress, committee_el) %>%
  slice_max(order_by = total_mentions, n = 1, with_ties = FALSE) %>%
  arrange(congress, committee_el, desc(total_mentions))

top_issues_committee_el

save_to_output("top_issues_party_committee.csv", data = top_issues_committee_el)

```

# 5. lgbm features importance analysis

# 6. key characteristics analysis

this part will use regression and logistic model to see the key relationship between legislators' personal characteristics and decision mode

## 6.0 preparing

### 6.0.1 data cleansing

```{r}
#| label: data cleansing
#| echo: false

# turn decision into is.dom
adver_cg <- adver_cg %>%
  mutate(is.dom = ifelse(decision == "dom", 1, 0))
legis_cg <- legis_cg %>%
  mutate(is.dom = ifelse(decision == "dom", 1, 0))

adver_cg <- adver_cg %>%
  mutate(is.prof = ifelse(decision == "prof", 1, 0))
legis_cg <- legis_cg %>%
  mutate(is.prof = ifelse(decision == "prof", 1, 0))

# turn party into is.republican
adver_cg <- adver_cg %>% 
  mutate(is.republican = ifelse(party == "Republican", 1, 0))
legis_cg <- legis_cg %>% 
  mutate(is.republican = ifelse(party == "Republican", 1, 0))

# turn categorical vector into numeric 
adver_cg$gender_numeric <- ifelse(adver_cg$gender == "Male", 1, 0)
legis_cg$gender_numeric <- ifelse(legis_cg$gender == "Male", 1, 0)

legis_cg$chamber_numeric <- ifelse(legis_cg$chamber == "Senate", 1, 0)
adver_cg$chamber_numeric <- ifelse(adver_cg$chamber == "Senate", 1, 0)

# add district data into adver_cg/legis_cg
district_data$congress <- as.character(district_data$congress)

adver_merged <- adver_cg %>%
  left_join(
    district_data,
    by = c("congress", "state_code", "district")
  )

legis_merged <- legis_cg %>%
  left_join(
    district_data,
    by = c("congress", "state_code", "district")
  )

# set vars_to_check 
vars_to_check <- c(
  "high_edu_share",
  "foreign_born_ratio",
  "white_ratio",
  "black_or_african_american_ratio",
  "asian_ratio",
  "american_indian_and_alaska_native_ratio",
  "native_hawaiian_and_other_pacific_islander_ratio",
  "white_collar_share",
  "blue_collar_share",
  "agriculture_share",
  "median_household_income_that_year",
  "age", "seniority", "ideology", "is.republican", "chamber", "gender"
)
```

```{r}
#| label: district group analysis data preparing
#| echo: false

# filter different level data
dem_adver <- adver_merged %>%
  filter(party == "Democratic")
rep_adver <- adver_merged %>%
  filter(party == "Republican")

hosue_adver <- adver_merged %>%
  filter(chamber == "house of representatives")
senate_adver <- adver_merged %>%
  filter(chamber == "senate")

dem_legis <- legis_merged %>%
  filter(party == "Democratic")
rep_legis <- legis_merged %>%
  filter(party == "Republican")

hosue_legis <- legis_merged %>%
  filter(chamber == "house of representatives")
senate_legis <- legis_merged %>%
  filter(chamber == "senate")

adver_115 <- adver_merged %>%
  filter(congress == "115")
adver_116 <- adver_merged %>%
  filter(congress == "116")
adver_117 <- adver_merged %>%
  filter(congress == "117")
adver_118 <- adver_merged %>%
  filter(congress == "118")

legis_115 <- legis_merged %>%
  filter(congress == "115")
legis_116 <- legis_merged %>%
  filter(congress == "116")
legis_117 <- legis_merged %>%
  filter(congress == "117")
legis_118 <- legis_merged %>%
  filter(congress == "118")


```

### 6.0.2 co-linerality check

```{r}
#| label: co-linerality check demographic 
#| echo: false


# ---- demographic variables -----
# age vs seniority
#cor(adver_cg$age, adver_cg$seniority, use = "complete.obs")
#cor(legis_cg$age, legis_cg$seniority, use = "complete.obs")

# ideology vs chamber
#boxplot(ideology ~ is.republican, data = adver_cg)
#boxplot(ideology ~ is.republican, data = legis_cg)
#cor.test(adver_cg$ideology, adver_cg$is.republican, method = "pearson") 

# ideology vs chamber
#boxplot(ideology ~ chamber, data = adver_cg)
#boxplot(ideology ~ chamber, data = legis_cg)
#cor.test(adver_cg$ideology, adver_cg$chamber_numeric, method = "pearson") 

#boxplot(ideology ~ gender, data = adver_cg)
#boxplot(ideology ~ gender, data = legis_cg)
#cor.test(adver_cg$ideology, adver_cg$gender_numeric, method = "pearson") 

# is.republican vs chamber
#table(adver_cg$is.republican, adver_cg$chamber)
#chisq.test(table(adver_cg$is.republican, adver_cg$chamber))

#table(legis_cg$is.republican, legis_cg$chamber)
#chisq.test(table(legis_cg$is.republican, legis_cg$chamber))

# is.republican vs gender
#table(adver_cg$is.republican, adver_cg$gender)
#chisq.test(table(adver_cg$is.republican, adver_cg$chamber))

#table(legis_cg$is.republican, legis_cg$chamber)
#chisq.test(table(legis_cg$is.republican, legis_cg$chamber))

```

```{r}
#| label: co-linerality check function
#| echo: false

check_collinearity <- function(data, vars = NULL, show_plot = TRUE, max_name_length = 12) {
  # ---- Step 1. å˜é‡é¢„å¤„ç† ----
  if (is.null(vars)) vars <- names(data)
  df <- dplyr::select(data, dplyr::all_of(vars))
  
  # ---- Step 2. åˆ¤æ–­å˜é‡ç±»å‹ ----
  var_types <- sapply(df, function(x) {
    if (is.numeric(x)) "numeric" else "categorical"
  })
  
  # ---- Step 3. åˆå§‹åŒ–ç»“æœå®¹å™¨ ----
  results <- list(
    numeric_numeric = NULL,
    categorical_numeric = NULL,
    categorical_categorical = NULL
  )
  
  # ---- Step 4. æ•°å€¼-æ•°å€¼ï¼šçš®å°”é€Šç›¸å…³ + çƒ­åŠ›å›¾ ----
  num_vars <- names(var_types[var_types == "numeric"])
  if (length(num_vars) >= 2) {
    num_df <- df %>%
      dplyr::select(dplyr::all_of(num_vars)) %>%
      dplyr::mutate(dplyr::across(everything(), as.numeric))
    
    cor_mat <- cor(num_df, use = "pairwise.complete.obs")
    results$numeric_numeric <- cor_mat
    
    if (show_plot) {
      # ç¼©çŸ­é•¿å˜é‡åç”¨äºæ˜¾ç¤º
      short_names <- substr(colnames(cor_mat), 1, max_name_length)
      colnames(cor_mat) <- short_names
      rownames(cor_mat) <- short_names
      
      # å¯¹ç§°çƒ­åŠ›å›¾ï¼Œæ–¹ä¾¿æŸ¥çœ‹
      corrplot::corrplot(
        cor_mat,
        method = "color",
        type = "full",     # full æ˜¾ç¤ºå¯¹ç§°çŸ©é˜µ
        tl.cex = 0.7,      # ç¼©å°å­—ä½“
        tl.col = "black",  # æ ‡ç­¾é¢œè‰²
        number.cex = 0.6,  # æ•°å­—å¤§å°
        diag = TRUE,       # ä¿ç•™å¯¹è§’çº¿
        mar = c(0, 0, 1, 0)
      )
    }
  }
  
  # ---- Step 5. æ•°å€¼-åˆ†ç±»ï¼šANOVAæ£€éªŒ ----
  cat_vars <- names(var_types[var_types == "categorical"])
  if (length(cat_vars) > 0 && length(num_vars) > 0) {
    cat_num_tests <- expand.grid(numeric = num_vars, categorical = cat_vars, 
                                 stringsAsFactors = FALSE)
    results$categorical_numeric <- cat_num_tests %>%
      dplyr::mutate(
        p_value = purrr::map2_dbl(numeric, categorical, function(num, cat) {
          formula <- as.formula(paste(num, "~", cat))
          tryCatch({
            summary(aov(formula, data = df))[[1]][["Pr(>F)"]][1]
          }, error = function(e) NA)
        })
      )
  }
  
  # ---- Step 6. åˆ†ç±»-åˆ†ç±»ï¼šå¡æ–¹æ£€éªŒ ----
  if (length(cat_vars) >= 2) {
    cat_tests <- expand.grid(var1 = cat_vars, var2 = cat_vars, 
                             stringsAsFactors = FALSE)
    cat_tests <- cat_tests[cat_tests$var1 != cat_tests$var2, ]
    results$categorical_categorical <- cat_tests %>%
      dplyr::mutate(
        p_value = purrr::map2_dbl(var1, var2, function(v1, v2) {
          tbl <- table(df[[v1]], df[[v2]])
          tryCatch(chisq.test(tbl)$p.value, error = function(e) NA)
        })
      )
  }
  
  # ---- Step 7. è¾“å‡ºç»“æœ ----
  message("âœ… Collinearity check completed.")
  return(results)
}

# ç¬¬äºŒä¸ªå‡½æ•°ï¼š çœ‹æ•°å€¼*æ•°å€¼çš„på€¼

check_numeric_pvalues_star <- function(data, vars = NULL) {
  if (is.null(vars)) vars <- names(data)
  df <- data[, vars]
  
  # åªä¿ç•™æ•°å€¼å‹å˜é‡
  num_vars <- names(df)[sapply(df, is.numeric)]
  n <- length(num_vars)
  
  if (n < 2) stop("æ•°å€¼å‹å˜é‡å°‘äº 2 ä¸ªï¼Œæ— æ³•è®¡ç®—ç›¸å…³æ€§")
  
  # åˆå§‹åŒ–ç»“æœåˆ—è¡¨
  res <- data.frame(
    var1 = character(),
    var2 = character(),
    correlation = numeric(),
    p_value = numeric(),
    significance = character(),
    stringsAsFactors = FALSE
  )
  
  # å¾ªç¯è®¡ç®—ç›¸å…³æ€§å’Œ p å€¼
  for (i in 1:(n-1)) {
    for (j in (i+1):n) {
      x <- df[[num_vars[i]]]
      y <- df[[num_vars[j]]]
      # ä»…ä½¿ç”¨ä¸ä¸º NA çš„è§‚æµ‹
      valid <- complete.cases(x, y)
      if (sum(valid) < 3) {
        cor_val <- NA
        p_val <- NA
      } else {
        test <- cor.test(x[valid], y[valid])
        cor_val <- test$estimate
        p_val <- test$p.value
      }
      # æ ¹æ® p å€¼åŠ æ˜Ÿå·
      sig <- if (is.na(p_val)) "" else if (p_val < 0.001) "***" else if (p_val < 0.01) "**" else if (p_val < 0.05) "*" else ""
      
      res <- rbind(res, data.frame(
        var1 = num_vars[i],
        var2 = num_vars[j],
        correlation = cor_val,
        p_value = p_val,
        significance = sig,
        stringsAsFactors = FALSE
      ))
    }
  }
  
  return(res)
}
```

```{r}
#| label: co-linerality check 
#| echo: false

# æŸ¥çœ‹æ•°å€¼å‹å˜é‡é—´çš„ç›¸å…³çŸ©é˜µ
collinearity_result <- check_collinearity(adver_merged, vars_to_check, show_plot = TRUE)
collinearity_result1 <- check_collinearity(legis_merged, vars_to_check, show_plot = TRUE)


collinearity_result$numeric_numeric
collinearity_result1$numeric_numeric

# æŸ¥çœ‹æ•°å€¼å‹å˜é‡é—´çš„på€¼
numeric_results <- check_numeric_pvalues_star(adver_merged, vars_to_check)
numeric_results1 <- check_numeric_pvalues_star(legis_merged, vars_to_check)

# æŸ¥çœ‹åˆ†ç±» vs æ•°å€¼ çš„ ANOVA æ˜¾è‘—æ€§
collinearity_result$categorical_numeric %>% 
  dplyr::filter(p_value < 0.05)
collinearity_result1$categorical_numeric %>% 
  dplyr::filter(p_value < 0.05)

# æŸ¥çœ‹åˆ†ç±» vs åˆ†ç±» çš„å¡æ–¹ç»“æœ
collinearity_result$categorical_categorical
collinearity_result1$categorical_categorical
```

```{r}
#| label: co-linerality filter 
#| echo: false

# ç­›é€‰ç›¸å…³æ€§é«˜ä¸”æ˜¾è‘—çš„å˜é‡
filter_high_corr <- function(results, cor_threshold = 0.5, sig_level = 0.05) {
  # ä¿ç•™ç»å¯¹ç›¸å…³ç³»æ•°å¤§äºé˜ˆå€¼ä¸” p å€¼å°äºæ˜¾è‘—æ€§æ°´å¹³çš„è¡Œ
  filtered <- results %>%
    dplyr::filter(abs(correlation) >= cor_threshold & p_value <= sig_level)
  
  # æŒ‰ç›¸å…³ç³»æ•°ç»å¯¹å€¼ä»å¤§åˆ°å°æ’åº
  filtered <- filtered %>%
    dplyr::arrange(desc(abs(correlation)))
  
  return(filtered)
}

# ä½¿ç”¨ç¤ºä¾‹ï¼šç­›é€‰ |r| >= 0.5 ä¸” p < 0.05
high_corr_vars <- filter_high_corr(numeric_results, cor_threshold = 0.5, sig_level = 0.05)
high_corr_vars1 <- filter_high_corr(numeric_results1, cor_threshold = 0.5, sig_level = 0.05)

high_corr_vars
high_corr_vars1
```

```{r}
#| label: set preference
#| echo: false

# set references
set_reference_levels <- function(df,
                                 ref_party = "democratic",
                                 ref_is.republican = "0",
                                 ref_chamber = "Senate") {
  
  if ("party" %in% names(df)) {
    df$party <- factor(df$party)  # è½¬æ¢ä¸ºfactor
    df$party <- relevel(df$party, ref = ref_party)  # è®¾ç½®reference level
  }
  
   if ("party" %in% names(df)) {
    df$is.republican <- factor(df$is.republican)  # è½¬æ¢ä¸ºfactor
    df$is.republican <- relevel(df$is.republican, ref = ref_is.republican)  # è®¾ç½®reference level
  }
  
  if ("chamber" %in% names(df)) {
    df$chamber <- factor(df$chamber)
    df$chamber <- relevel(df$chamber, ref = ref_chamber)
  }
  
  return(df)
}

adver_cg <- set_reference_levels(adver_cg,
                                 ref_party = "Democratic",
                                 ref_is.republican = "0",
                                 ref_chamber = "senate")

legis_cg <- set_reference_levels(legis_cg,
                                 ref_party = "Democratic",
                                 ref_is.republican = "0",
                                 ref_chamber = "senate")
```

```{r}
#| label: lasso function
#| echo: false

run_glmnet_selection <- function(data, formula, alpha = 1, family = "binomial") {
  # å¤„ç†ç¼ºå¤±å€¼
  complete_data <- model.frame(formula, data = data, na.action = na.omit)
  
  # è‡ªå˜é‡çŸ©é˜µ
  X <- model.matrix(formula, data = complete_data)[,-1]
  
  # å› å˜é‡
  y <- complete_data[[as.character(formula[[2]])]]
  
  # æ‹Ÿåˆ lasso/ridge/elnet
  cv_fit <- cv.glmnet(X, y, family = family, alpha = alpha)
  
  # å¯è§†åŒ–äº¤å‰éªŒè¯è¯¯å·®
  plot(cv_fit, main = paste("CV for alpha =", alpha, ", family =", family))
  
  # è¾“å‡ºæœ€ä½³ lambda å’Œç³»æ•°
  cat("Best lambda:", cv_fit$lambda.min, "\n")
  print(coef(cv_fit, s = "lambda.min"))
  
  return(cv_fit)
}
```

```{r}
#| label: logit-analysis function
#| echo: false

# analysis function
analyze_logit_model <- function(model) {
  library(broom)
  
  tidy_model <- tryCatch(
    tidy(model, conf.int = TRUE),
    error = function(e) {
      message("Error in tidy(): ", e$message)
      return(NULL)
    }
  )
  
  if (is.null(tidy_model)) return(NULL)
  
  # æ£€æŸ¥æ˜¯å¦åŒ…å« conf.low å’Œ conf.highï¼Œè‹¥æ— åˆ™ç”¨ NA å¡«å……
  if (!"conf.low" %in% names(tidy_model)) tidy_model$conf.low <- NA
  if (!"conf.high" %in% names(tidy_model)) tidy_model$conf.high <- NA
  
  coefs <- tidy_model %>%
    mutate(
      odds_ratio = exp(estimate),
      conf.low.or = exp(conf.low),
      conf.high.or = exp(conf.high),
      significance = case_when(
        p.value < 0.001 ~ "***",
        p.value < 0.01  ~ "**",
        p.value < 0.05  ~ "*",
        p.value < 0.1   ~ ".",
        TRUE ~ ""
      )
    ) %>%
    dplyr::select(term, estimate, odds_ratio, conf.low.or, conf.high.or,
           std.error, p.value, significance)
  
  print(summary(model))
  print(coefs)
  
  # pseudo R-squared (McFadden)
  if (requireNamespace("pscl", quietly = TRUE)) {
    library(pscl)
    cat("\nPseudo R-squared:\n")
    print(pscl::pR2(model))
  } else {
    message("Install 'pscl' package for pseudo R-squared calculation.")
  }
  
  return(coefs)
}
```

```{r}
#| label: residual check function
#| echo: false

plot_logit_residuals <- function(model_list, data, 
                                 subfolder = "logit_residual_plots", 
                                 n = 1000) {
  # ä½¿ç”¨å…¨å±€ output_dir å˜é‡
  if (!exists("output_dir")) {
    output_dir <- "output"
  }

  # å­ç›®å½•å®Œæ•´è·¯å¾„
  save_dir <- file.path(output_dir, subfolder)

  # è‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º
  if (!dir.exists(save_dir)) {
    dir.create(save_dir, recursive = TRUE)
  }

  # éå†æ¨¡å‹
  for (model_name in names(model_list)) {
    model <- model_list[[model_name]]

    # ç”Ÿæˆæ®‹å·®
    res <- simulateResiduals(fittedModel = model, n = n)

    # è‡ªåŠ¨è·å–è‡ªå˜é‡ï¼ˆå»æ‰å› å˜é‡ï¼‰
    predictors <- all.vars(formula(model))[-1]
    predictors <- predictors[predictors %in% colnames(data)]  # åªä¿ç•™å­˜åœ¨çš„åˆ—

    # è®¾ç½®è¾“å‡ºè·¯å¾„
    file_path <- file.path(save_dir, paste0("residuals_", model_name, "_all.png"))

    # ç”»å›¾å¹¶ä¿å­˜
    png(file_path, width = 2400, height = 1600, res = 200)
    n_pred <- length(predictors)
    n_row <- ceiling(n_pred / 2)
    par(mfrow = c(n_row, 2), mar = c(4, 4, 3, 1))

    for (var in predictors) {
      plotResiduals(res, predictor = data[[var]],
                    main = paste("Residuals vs", var, "\n(", model_name, ")"))
    }

    dev.off()
  }

  cat("âœ… All residual plots saved under:", save_dir, "\n")
}
```

```{r}
#| label: lm robust check function
#| echo: false

plot_lm_diagnostics <- function(model_list, output_dir = "lm_diagnostics_plots") {
  
  # ç¡®ä¿åœ¨ output/ ä¸‹åˆ›å»ºå­ç›®å½•
  full_output_dir <- file.path("output", output_dir)
  if (!dir.exists(full_output_dir)) {
    dir.create(full_output_dir, recursive = TRUE)
  }

  for (model_name in names(model_list)) {
    model <- model_list[[model_name]]
    
    # 1. QQ Plot
    p1 <- ggplot(model, aes(sample = .stdresid)) +
      stat_qq() + stat_qq_line(color = "red") +
      labs(title = paste0("QQ Plot - ", model_name),
           y = "Standardized Residuals") +
      theme_minimal()

    # 2. æ®‹å·® vs æ‹Ÿåˆå€¼
    df <- augment(model)
    p2 <- ggplot(df, aes(.fitted, .resid)) +
      geom_point(alpha = 0.6) +
      geom_smooth(method = "loess", se = FALSE, color = "blue") +
      geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
      labs(title = paste0("Residuals vs Fitted - ", model_name),
           x = "Fitted values", y = "Residuals") +
      theme_minimal()

    # 3. Cook's Distance
    p3 <- ggplot(df, aes(seq_along(.cooksd), .cooksd)) +
      geom_bar(stat = "identity", fill = "tomato", alpha = 0.7) +
      labs(title = paste0("Cook's Distance - ", model_name),
           x = "Observation", y = "Cook's D") +
      theme_minimal()

    # 4. æ æ†å›¾
    p4 <- ggplot(df, aes(.hat, .std.resid)) +
      geom_point(alpha = 0.6) +
      geom_smooth(method = "loess", se = FALSE, color = "blue") +
      labs(title = paste0("Leverage vs Std Residuals - ", model_name),
           x = "Leverage", y = "Standardized Residuals") +
      theme_minimal()

    combined_plot <- (p1 | p2) / (p3 | p4)

    # ä¿å­˜ï¼ˆsave_to_output è‡ªåŠ¨æ‹¼ä¸Š "output" å‰ç¼€ï¼‰
    save_to_output(
      filename = file.path(output_dir, paste0("diagnostic_", model_name, ".png")),
      plot = combined_plot,
      width = 12, height = 10, dpi = 300
    )
  }

  cat("âœ… æ‰€æœ‰è¯Šæ–­å›¾å·²ä¿å­˜è‡³ï¼š", full_output_dir, "\n")
}
```

## 6.1 dependent variable: is.dom

### 6.1.1 multiple variables logit model

lasso - demographic

```{r}
#| label: is.dom logit lasso1
#| echo: false

# adver
cv_lasso_adver <- run_glmnet_selection(adver_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "binomial")
cv_ridge_adver <- run_glmnet_selection(adver_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "binomial")
cv_elnet_adver <- run_glmnet_selection(adver_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "binomial")

# legis
cv_lasso_legis <- run_glmnet_selection(legis_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "binomial")
cv_ridge_legis <- run_glmnet_selection(legis_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "binomial")
cv_elnet_legis <- run_glmnet_selection(legis_cg, is.dom ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "binomial")
```

lasso - add district_data

```{r}
#| label: is.dom logit lasso2
#| echo: false

# adver
cv_lasso_adver <- run_glmnet_selection(adver_merged, is.dom ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 1,
  family = "binomial")
cv_ridge_adver <- run_glmnet_selection(adver_merged, is.dom ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0,
  family = "binomial")
cv_elnet_adver <- run_glmnet_selection(adver_merged, is.dom ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0.5,
  family = "binomial")

# legis
cv_lasso_legis <- run_glmnet_selection(legis_merged, is.dom ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 1,
  family = "binomial")
cv_ridge_legis <- run_glmnet_selection(legis_merged, is.dom ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0,
  family = "binomial")
cv_elnet_legis <- run_glmnet_selection(legis_merged, is.dom ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0.5,
  family = "binomial")
```

models training - adver

```{r}
#| label: is.dom logit mul2
#| echo: false

# model 0
adver_logit0 <- glm(is.dom ~ age + is.republican + ideology + chamber + seniority + gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# adjusted model
adver_logit1 <- glm(is.dom ~ age +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit2 <- glm(is.dom ~ age +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit3 <- glm(is.dom ~ seniority +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit4 <- glm(is.dom ~ seniority +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# ---- vif check ----
vif(adver_logit0)
vif(adver_logit1)
vif(adver_logit2)
vif(adver_logit3)
vif(adver_logit4)

# results
modelsummary(
  list(
    "Adver All" = adver_logit0,
    "1" = adver_logit1,
    "2" = adver_logit2,
    "3" = adver_logit3,
    "4" = adver_logit4
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logitmodel_adver_isdom.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)


```

```{r}
#| label: is.dom logit district
#| echo: false

adver_logit_district0 <- glm(is.dom ~ high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# adjusted model
# keep education
adver_logit_district1 <- glm(is.dom ~ high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + agriculture_share + median_household_income_that_year + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# keep occupation (blue_collar) 
adver_logit_district2 <- glm(is.dom ~ foreign_born_ratio + asian_ratio + white_ratio + black_or_african_american_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + median_household_income_that_year + blue_collar_share + agriculture_share + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# keep household
adver_logit_district3 <- glm(is.dom ~ foreign_born_ratio + white_ratio + black_or_african_american_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + median_household_income_that_year + agriculture_share + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())


# ---- vif check ----
vif(adver_logit_district0)
vif(adver_logit_district1)
vif(adver_logit_district2)
vif(adver_logit_district3)

# results
modelsummary(
  list(
    "Adver All" = adver_logit_district0,
    "1" = adver_logit_district1,
    "2" = adver_logit_district2,
    "3" = adver_logit_district3
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logitmodel_adver_isdom_district.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)

```

```{r}
#| label: is.dom logit mixed
#| echo: false

adver_logit_mixed0 <- glm(is.dom ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# adjusted model
# education
adver_logit_mixed1 <- glm(is.dom ~ age + ideology + chamber + gender +  high_edu_share + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# immigration
adver_logit_mixed2 <- glm(is.dom ~ age + ideology + chamber + gender +  foreign_born_ratio + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# occupation
adver_logit_mixed3 <- glm(is.dom ~ age + ideology + chamber + gender +  blue_collar_share + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# race
adver_logit_mixed4 <- glm(is.dom ~ age + ideology + chamber + gender + black_or_african_american_ratio + asian_ratio + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# income
adver_logit_mixed5 <- glm(is.dom ~ age + ideology + chamber + gender + median_household_income_that_year + as.factor(congress), 
                   data = adver_merged, 
                   family = binomial())

# ---- vif check ----
vif(adver_logit_mixed0)
vif(adver_logit_mixed1)
vif(adver_logit_mixed2)
vif(adver_logit_mixed3)
vif(adver_logit_mixed4)
vif(adver_logit_mixed5)

# results
modelsummary(
  list(
    "Adver All" = adver_logit_mixed0,
    "1" = adver_logit_mixed1,
    "2" = adver_logit_mixed2,
    "3" = adver_logit_mixed3,
    "4" = adver_logit_mixed4,
    "5" = adver_logit_mixed5
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logitmodel_adver_isdom_mixed.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)
```

models training - legis

```{r}
#| label: is.dom logit mul3
#| echo: false

# model 0
legis_logit0 <- glm(is.dom ~ age + is.republican + ideology + chamber + seniority + gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# adjusted models
legis_logit1 <- glm(is.dom ~ age +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

legis_logit2 <- glm(is.dom ~ age +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

legis_logit3 <- glm(is.dom ~ seniority +  chamber + is.republican +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

legis_logit4 <- glm(is.dom ~ seniority +  chamber + ideology +  gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# results
modelsummary(
  list(
    "Legis All" = legis_logit0,
    "1" = legis_logit1,
    "2" = legis_logit2,
    "3" = legis_logit3,
    "4" = legis_logit4
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logitmodel_legis_isdom.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)


# ---- vif check ----
vif(legis_logit0)
vif(legis_logit1)
vif(legis_logit2)
vif(legis_logit3)
vif(legis_logit4)
```

```{r}
#| label: is.dom logit district1
#| echo: false

legis_logit_district0 <- glm(is.dom ~ high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), 
                   data = legis_merged, 
                   family = binomial())

# adjusted model
# keep education
legis_logit_district1 <- glm(is.dom ~ high_edu_share + foreign_born_ratio +  black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + agriculture_share + median_household_income_that_year + as.factor(congress), 
                   data = legis_merged, 
                   family = binomial())

# keep occupation (blue_collar) 
legis_logit_district2 <- glm(is.dom ~ foreign_born_ratio + asian_ratio +  black_or_african_american_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + median_household_income_that_year + blue_collar_share + agriculture_share + as.factor(congress), 
                   data = legis_merged, 
                   family = binomial())

legis_logit_district3 <- glm(is.dom ~ foreign_born_ratio + white_ratio + black_or_african_american_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + median_household_income_that_year + agriculture_share + as.factor(congress), 
                   data = legis_merged, 
                   family = binomial())


# ---- vif check ----
vif(legis_logit_district0)
vif(legis_logit_district1)
vif(legis_logit_district2)
vif(legis_logit_district3)

# results
modelsummary(
  list(
    "Legis All" = legis_logit_district0,
    "1" = legis_logit_district1,
    "2" = legis_logit_district2,
    "3" = legis_logit_district3
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logitmodel_legis_isdom_district.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)


```

#### residual check for logit model

```{r}
#| label: logit model residual check
#| echo: false

# æ¨¡å‹åˆ—è¡¨
model_list_adver_dom_logit <- list(
  "adver_dom_logit1" = adver_logit1,
  "adver_dom_logit2" = adver_logit2,
  "adver_dom_logit3" = adver_logit3,
  "adver_dom_logit4" = adver_logit4
)

model_list_legis_dom_logit <- list(
  "legis_dom_logit1" = legis_logit1,
  "legis_dom_logit2" = legis_logit2,
  "legis_dom_logit3" = legis_logit3,
  "legis_dom_logit4" = legis_logit4
)

# è°ƒç”¨å‡½æ•°
plot_logit_residuals(model_list_adver_dom_logit, adver_cg)
plot_logit_residuals(model_list_legis_dom_logit, legis_cg)
```

### 6.1.2 single variable logit model

models training - adver

```{r}
#| label: is.dom logit sin1
#| echo: false

#adver
adver_logit_age <- glm(is.dom ~ age + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_ideology <- glm(is.dom ~ ideology + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_is.republican <- glm(is.dom ~ is.republican + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_gender <- glm(is.dom ~ gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_chamber <- glm(is.dom ~ chamber + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_seniority <- glm(is.dom ~ seniority + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

adver_logit_seniority <- glm(is.dom ~ seniority + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())

# result
modelsummary(
  list(
    "1" = adver_logit_age,
    "2" = adver_logit_ideology,
    "3" = adver_logit_is.republican,
    "4" = adver_logit_gender,
    "5" = adver_logit_chamber,
    "6" = adver_logit_seniority
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logitmodel_adver_seperated_isdom.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)
```

```{r}
#| label: is.dom logit sin district1
#| echo: false

# æ‰€æœ‰è‡ªå˜é‡åˆ—è¡¨
vars <- c(
  "age", "party", "ideology", "chamber", "gender", "seniority",
  "high_edu_share", "foreign_born_ratio", "white_ratio", 
  "black_or_african_american_ratio", "asian_ratio",
  "american_indian_and_alaska_native_ratio", 
  "native_hawaiian_and_other_pacific_islander_ratio",
  "white_collar_share", "blue_collar_share", "agriculture_share",
  "median_household_income_that_year"
)

# å¯¹æ¯ä¸ªè‡ªå˜é‡å¾ªç¯å»ºæ¨¡å‹ï¼Œå¹¶æ•´ç†ç»“æœ
adver_single_models <- vars %>%
  map_df(function(v) {
    formula_str <- paste0("is.dom ~ ", v, " + as.factor(congress)")
    m <- glm(as.formula(formula_str), data = adver_merged, family = binomial())
    
    tidy(m) %>%
      filter(term == v) %>%
      mutate(var = v,
             OR = exp(estimate)) # è½¬æ¢ä¸ºodds ratioæ–¹ä¾¿è§£è¯»
  })

# æŸ¥çœ‹ç»“æœ
adver_single_models %>%
  dplyr::select(var, estimate, std.error, statistic, p.value, OR) %>%
  arrange(p.value)

adver_single_models %>%
  mutate(sig = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    p.value < 0.1 ~ "+",
    TRUE ~ ""
  )) %>%
  ggplot(aes(x = reorder(var, estimate), y = estimate, color = p.value < 0.05)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                    ymax = estimate + 1.96 * std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(x = "Variables", y = "Logit Coefficient (is.dom)",
       title = "Single-variable Logit Results (with Congress FE)")

```

models training - legis

```{r}
#| label: is.dom logit sin2
#| echo: false

legis_logit_age <- glm(is.dom ~ age + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_ideology <- glm(is.dom ~ ideology + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_is.republican <- glm(is.dom ~ is.republican + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_gender <- glm(is.dom ~ gender + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_chamber <- glm(is.dom ~ chamber + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

legis_logit_seniority <- glm(is.dom ~ seniority + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())

# result
modelsummary(
  list(
    "1" = legis_logit_age,
    "2" = legis_logit_ideology,
    "3" = legis_logit_is.republican,
    "4" = legis_logit_gender,
    "5" = legis_logit_chamber,
    "6" = legis_logit_seniority
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logitmodel_legis_seperated_isdom.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)
```

```{r}
#| label: is.dom logit sin district2
#| echo: false

# å¯¹æ¯ä¸ªè‡ªå˜é‡å¾ªç¯å»ºæ¨¡å‹ï¼Œå¹¶æ•´ç†ç»“æœ
legis_single_models <- vars %>%
  map_df(function(v) {
    formula_str <- paste0("is.dom ~ ", v, " + as.factor(congress)")
    m <- glm(as.formula(formula_str), data = legis_merged, family = binomial())
    
    tidy(m) %>%
      filter(term == v) %>%
      mutate(var = v,
             OR = exp(estimate)) # è½¬æ¢ä¸ºodds ratioæ–¹ä¾¿è§£è¯»
  })

# æŸ¥çœ‹ç»“æœ
legis_single_models %>%
  dplyr::select(var, estimate, std.error, statistic, p.value, OR) %>%
  arrange(p.value)

legis_single_models %>%
  mutate(sig = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    p.value < 0.1 ~ "+",
    TRUE ~ ""
  )) %>%
  ggplot(aes(x = reorder(var, estimate), y = estimate, color = p.value < 0.05)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                    ymax = estimate + 1.96 * std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(x = "Variables", y = "Logit Coefficient (is.dom)",
       title = "Single-variable Logit Results (with Congress FE)")

```

coefficient plot

```{r}
#| label: is.dom coefficient plot
#| echo: false

# ----- model lists -----
adver_lm_models <- list(
  age = adver_logit_age,
  ideology = adver_logit_ideology,
  is_republican = adver_logit_is.republican,
  gender = adver_logit_gender,
  chamber = adver_logit_chamber,
  seniority = adver_logit_seniority
)

legis_lm_models <- list(
  age = legis_logit_age,
  ideology = legis_logit_ideology,
  is_republican = legis_logit_is.republican,
  gender = legis_logit_gender,
  chamber = legis_logit_chamber,
  seniority = legis_logit_seniority
)


# ----- extract coefficient and clean -----
# adver
coef_adver <- map_df(names(adver_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_adver_clean <- coef_adver %>%
  filter(!grepl("Intercept|congress", term))

# legis
coef_legis <- map_df(names(legis_lm_models), function(name) {
  tidy(legis_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_legis_clean <- coef_legis %>%
  filter(!grepl("Intercept|congress", term))


# ----- estimate and 95% CI -----
p1 <- ggplot(coef_adver_clean, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("adver_logit_single_coefficient.png", plot = p, width = 8, height = 4, dpi = 300)

p2 <- ggplot(coef_legis_clean, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("legis_logit_single_coefficient.png", plot = p1, width = 8, height = 4, dpi = 300)

```

## 6.2 dependent variable: dom_percentage

### 6.2.1 multiple variables regression model

lasso

```{r}
#| label: dom.percentage lm mul1
#| echo: false

# adver
cv_lasso_adver1 <- run_glmnet_selection(
  data = adver_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 1,
  family = "gaussian"  
)

cv_ridge_adver1 <- run_glmnet_selection(
  data = adver_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0,
  family = "gaussian"  
)

cv_elnet_adver1 <- run_glmnet_selection(
  data = adver_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0.5,
  family = "gaussian"  
)

# legis
cv_lasso_legis1 <- run_glmnet_selection(
  data = legis_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 1,
  family = "gaussian"  
)

cv_ridge_legis1 <- run_glmnet_selection(
  data = legis_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0,
  family = "gaussian"  
)

cv_elnet_legis1 <- run_glmnet_selection(
  data = legis_cg,
  formula = dom_percentage ~ age + is.republican + ideology + chamber + gender + seniority + as.factor(congress),
  alpha = 0.5,
  family = "gaussian"  
)
```

models training - adver

```{r}
#| label: dom.percentage lm mul2
#| echo: false

# original
adver_lm0 <- lm(dom_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = adver_cg)

# adjusted
adver_lm1 <- lm(dom_percentage ~ age + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm2 <- lm(dom_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm3 <- lm(dom_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm4 <- lm(dom_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

# result
modelsummary(
  list(
    "Adver LM" = adver_lm0,
    "1" = adver_lm1,
    "2" = adver_lm2,
    "3" = adver_lm3,
    "4" = adver_lm4
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_adver_dom.html"),
  escape = FALSE
)

# ---- vif check ----
vif(adver_lm0)
vif(adver_lm1)
vif(adver_lm2)
vif(adver_lm3)
vif(adver_lm4)
```

models training - legis

```{r}
#| label: dom.percentage lm mul3
#| echo: false

# original
legis_lm0 <- lm(dom_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = legis_cg)

# adjusted
legis_lm1 <- lm(dom_percentage ~ age + 
                     chamber + gender + is.republican 
                     + as.factor(congress),   data = legis_cg )

legis_lm2 <- lm(dom_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm3 <- lm(dom_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm4 <- lm(dom_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "Legis LM" = legis_lm0,
    "1" = legis_lm1,
    "2" = legis_lm2,
    "3" = legis_lm3,
    "4" = legis_lm4
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_legis_dom.html"),
  escape = FALSE
)

# ---- vif check ----
vif(legis_lm0)
vif(legis_lm1)
vif(legis_lm2)
vif(legis_lm3)
vif(legis_lm4)
```

adver_lm0 marginal effects

```{r}
#| label: dom.percentage marginal effects adver
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age <- ggpredict(adver_lm0, terms = "age")
eff_ideo <- ggpredict(adver_lm0, terms = "ideology")
eff_sen <- ggpredict(adver_lm0, terms = "seniority")
eff_gender <- ggpredict(adver_lm0, terms = "gender")

# ideology
p1 <- ggplot(eff_ideo, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted Domestic Percentage",
    title = "Marginal Effect of Ideology on Domestic Percentage"
  ) +
  theme_minimal(base_size = 14)
save_to_output("ideology_marginal_effect_adver_dom.png", plot = p1, width = 8, height = 4, dpi = 300)
```

legis_lm0 marginal effects

```{r}
#| label: dom.percentage marginal effects legis
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age1 <- ggpredict(legis_lm0, terms = "age")
eff_ideo1 <- ggpredict(legis_lm0, terms = "ideology")
eff_sen1 <- ggpredict(legis_lm0, terms = "seniority")
eff_gender1 <- ggpredict(legis_lm0, terms = "gender")

# ideology
p2 <- ggplot(eff_ideo1, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted Domestic Percentage",
    title = "Marginal Effect of Ideology on Domestic Percentage Legis"
  ) +
  theme_minimal(base_size = 14)
save_to_output("ideology_marginal_effect_legis_dom.png", plot = p2, width = 8, height = 4, dpi = 300)
```

### 6.2.2 single variable regression model

models training - adver

```{r}
#| label: dom.percentage lm sin1
#| echo: false

adver_cg_age1 <- lm(dom_percentage ~ age +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_ideology1 <- lm(dom_percentage ~ ideology +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_is.republican1 <- lm(dom_percentage ~ is.republican +
                     as.factor(congress), 
               data = adver_cg)

adver_cg_chamber1 <- lm(dom_percentage ~ chamber +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_gender1 <- lm(dom_percentage ~ gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_seniority1 <- lm(dom_percentage ~ seniority +
                     as.factor(congress), 
                   data = adver_cg)

# result
modelsummary(
  list(
    "1" = adver_cg_age1,
    "2" = adver_cg_ideology1,
    "3" = adver_cg_is.republican1,
    "4" = adver_cg_gender1,
    "5" = adver_cg_chamber1,
    "6" = adver_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodel_adver_seperated_dom.html"),
  escape = FALSE
)
```

models training - legis

```{r}
#| label: dom.percentage lm sin2
#| echo: false

legis_cg_age1 <- lm(dom_percentage ~ age +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_ideology1 <- lm(dom_percentage ~ ideology +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_is.republican1 <- lm(dom_percentage ~ is.republican +
                     as.factor(congress), 
               data = legis_cg)

legis_cg_chamber1 <- lm(dom_percentage ~ chamber +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_gender1 <- lm(dom_percentage ~ gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_seniority1 <- lm(dom_percentage ~ seniority +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "1" = legis_cg_age1,
    "2" = legis_cg_ideology1,
    "3" = legis_cg_is.republican1,
    "4" = legis_cg_gender1,
    "5" = legis_cg_chamber1,
    "6" = legis_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodel_legis_seperated_dom.html"),
  escape = FALSE
)
```

single variable model coefficient plot

```{r}
#| label: dom.percentage coefficient plot
#| echo: false

# ----- model lists -----
adver_lm_models <- list(
  age = adver_cg_age1,
  ideology = adver_cg_ideology1,
  is_republican = adver_cg_is.republican1,
  gender = adver_cg_gender1,
  chamber = adver_cg_chamber1,
  seniority = adver_cg_seniority1
)

legis_lm_models <- list(
  age = legis_cg_age1,
  ideology = legis_cg_ideology1,
  is_republican = legis_cg_is.republican1,
  gender = legis_cg_gender1,
  chamber = legis_cg_chamber1,
  seniority = legis_cg_seniority1
)


# ----- extract coefficient and clean -----
# adver
coef_adver1 <- map_df(names(adver_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_adver_clean1 <- coef_adver1 %>%
  filter(!grepl("Intercept|congress", term))

# legis
coef_legis1 <- map_df(names(legis_lm_models), function(name) {
  tidy(legis_lm_models[[name]]) %>%  
    mutate(model = name)
})
coef_legis_clean1 <- coef_legis1 %>%
  filter(!grepl("Intercept|congress", term))

# ----- estimate and 95% CI -----
p3 <- ggplot(coef_adver_clean1, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("adver_lm_single_coefficient_dom.png", plot = p3, width = 8, height = 4, dpi = 300)

p4 <- ggplot(coef_legis_clean1, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("legis_lm_single_coefficient_dom.png", plot = p4, width = 8, height = 4, dpi = 300)

```

### robustness check

```{r}
#| label: dom.percentage robust check
#| echo: false


# æ„å»ºæ¨¡å‹åˆ—è¡¨
model_adver_lm_dom_multiple <- list(
  "adver_dom0" = adver_lm0,
  "adver_dom1" = adver_lm1,
  "adver_dom2" = adver_lm2,
  "adver_dom3" = adver_lm3,
  "adver_dom4" = adver_lm4
)

models_adver_lm_dom <- list(
  "age_dom" = adver_cg_age1,
  "ideology_dom" = adver_cg_ideology1,
  "is.republican_dom" = adver_cg_is.republican1,
  "gender_dom" = adver_cg_gender1,
  "chamber_dom" = adver_cg_chamber1,
  "seniority_dom" = adver_cg_seniority1
)

model_legis_lm_dom_multiple <- list(
  "legis_dom" = legis_lm0,
  "legis_dom1" = legis_lm1,
  "legis_dom2" = legis_lm2,
  "legis_dom3" = legis_lm3,
  "legis_dom4" = legis_lm4
)

models_legis_lm_dom <- list(
  "legis_age_dom" = legis_cg_age1,
  "legis_ideology_dom" = legis_cg_ideology1,
  "legis_is.republican_dom" = legis_cg_is.republican1,
  "legis_gender_dom" = legis_cg_gender1,
  "legis_chamber_dom" = legis_cg_chamber1,
  "legis_seniority_dom" = legis_cg_seniority1
)


# è¿è¡Œå‡½æ•°
plot_lm_diagnostics(model_adver_lm_dom_multiple)
plot_lm_diagnostics(model_legis_lm_dom_multiple)
plot_lm_diagnostics(models_adver_lm_dom)
plot_lm_diagnostics(models_legis_lm_dom)

```

## 6.3 dependent variable: prof_percentage

### 6.3.1 multiple variables regression model

lasso

```{r}
#| label: prof_percentage lm lasso
#| echo: false

# adver
cv_lasso_adver2 <- run_glmnet_selection(adver_cg, prof_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "gaussian")
cv_ridge_adver2 <- run_glmnet_selection(adver_cg, prof_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "gaussian")
cv_elnet_adver2 <- run_glmnet_selection(adver_cg, prof_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "gaussian")

# legis
cv_lasso_legis2 <- run_glmnet_selection(legis_cg, prof_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "gaussian")
cv_ridge_legis2 <- run_glmnet_selection(legis_cg, prof_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "gaussian")
cv_elnet_legis2 <- run_glmnet_selection(legis_cg, prof_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "gaussian")

```

```{r}
#| label: prof_percentage lm lasso2
#| echo: false

#| label: is.dom logit lasso2
#| echo: false

# adver
cv_lasso_adver <- run_glmnet_selection(adver_merged, prof_percentage ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 1,
  family = "gaussian")
cv_ridge_adver <- run_glmnet_selection(adver_merged, prof_percentage ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0,
  family = "gaussian")
cv_elnet_adver <- run_glmnet_selection(adver_merged, prof_percentage ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0.5,
  family = "gaussian")

# legis
cv_lasso_legis <- run_glmnet_selection(legis_merged, prof_percentage ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 1,
  family = "gaussian")
cv_ridge_legis <- run_glmnet_selection(legis_merged, prof_percentage ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0,
  family = "gaussian")
cv_elnet_legis <- run_glmnet_selection(legis_merged, prof_percentage ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), alpha = 0.5,
  family = "gaussian")

```

models training - adver

```{r}
#| label: prof.percentage lm mul2
#| echo: false

# original
adver_lm01 <- lm(prof_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = adver_cg)

# adjusted
adver_lm11 <- lm(prof_percentage ~ age + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm21 <- lm(prof_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm31 <- lm(prof_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm41 <- lm(prof_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

# ---- vif check ----
vif(adver_lm0)
vif(adver_lm1)
vif(adver_lm2)
vif(adver_lm3)
vif(adver_lm4)

# result
modelsummary(
  list(
    "Adver LM" = adver_lm01,
    "1" = adver_lm11,
    "2" = adver_lm21,
    "3" = adver_lm31,
    "4" = adver_lm41
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_adver_prof.html"),
  escape = FALSE
)

```

```{r}
#| label: prof.percentage lm district
#| echo: false

adver_lm_mixed0 <- lm(prof_percentage ~ age + party + ideology + chamber + gender + seniority + high_edu_share + foreign_born_ratio + white_ratio + black_or_african_american_ratio + asian_ratio + american_indian_and_alaska_native_ratio + native_hawaiian_and_other_pacific_islander_ratio + white_collar_share + blue_collar_share + agriculture_share + median_household_income_that_year + as.factor(congress), 
                   data = adver_merged)

# adjusted model
# education
adver_lm_mixed1 <- lm(prof_percentage ~ age + ideology + chamber + gender +  high_edu_share + as.factor(congress), 
                   data = adver_merged)

# immigration
adver_lm_mixed2 <- lm(prof_percentage ~ age + ideology + chamber + gender +  foreign_born_ratio + as.factor(congress), 
                   data = adver_merged)

# occupation
adver_lm_mixed3 <- lm(prof_percentage ~ age + ideology + chamber + gender +  blue_collar_share + as.factor(congress), 
                   data = adver_merged)

# race
adver_lm_mixed4 <- lm(prof_percentage ~ age + ideology + chamber + gender + black_or_african_american_ratio + asian_ratio + as.factor(congress), 
                   data = adver_merged)

# income
adver_lm_mixed5 <- lm(prof_percentage ~ age + ideology + chamber + gender + median_household_income_that_year + as.factor(congress), 
                   data = adver_merged)

# ---- vif check ----
vif(adver_lm_mixed0)
vif(adver_lm_mixed1)
vif(adver_lm_mixed2)
vif(adver_lm_mixed3)
vif(adver_lm_mixed4)
vif(adver_lm_mixed5)

# results
modelsummary(
  list(
    "Adver All" = adver_lm_mixed0,
    "1" = adver_lm_mixed1,
    "2" = adver_lm_mixed2,
    "3" = adver_lm_mixed3,
    "4" = adver_lm_mixed4,
    "5" = adver_lm_mixed5
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodel_adver_prof_mixed.html"),
  escape = FALSE,
  gof_omit = "AIC|BIC"
)
```

models training - legis

```{r}
#| label: prof.percentage lm mul3
#| echo: false

# original
legis_lm01 <- lm(prof_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = legis_cg)

# adjusted
legis_lm11 <- lm(prof_percentage ~ age + 
                     chamber + gender + is.republican 
                     + as.factor(congress),   data = legis_cg )

legis_lm21 <- lm(prof_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm31 <- lm(prof_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm41 <- lm(prof_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "Legis LM" = legis_lm01,
    "1" = legis_lm11,
    "2" = legis_lm21,
    "3" = legis_lm31,
    "4" = legis_lm41
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_legis_prof.html"),
  escape = FALSE
)

# ---- vif check ----
vif(legis_lm0)
vif(legis_lm1)
vif(legis_lm2)
vif(legis_lm3)
vif(legis_lm4)
```

```{r}
#| label: prof_and_dom_lmresult_summarize
#| echo: false

# result
modelsummary(
  list(
    "Adver_dom_is.republican" = adver_lm21,
    "Adver_dom_ideology" = adver_lm31,
    "Adver_prof_is.republican" = adver_lm21,
    "Adver_prof_ideology" = adver_lm31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_adver_all.html"),
  escape = FALSE
)

modelsummary(
  list(
    "Legis_dom_is.republican" = legis_lm21,
    "Legis_dom_ideology" = legis_lm31,
    "Legis_prof_is.republican" = legis_lm21,
    "Legis_prof_ideology" = legis_lm31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_legis_all.html"),
  escape = FALSE
)
```

adver_lm0 marginal effects

```{r}
#| label: prof.percentage marginal effects adver
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age <- ggpredict(adver_lm0, terms = "age")
eff_ideo <- ggpredict(adver_lm0, terms = "ideology")
eff_sen <- ggpredict(adver_lm0, terms = "seniority")
eff_gender <- ggpredict(adver_lm0, terms = "gender")

# ideology
p1 <- ggplot(eff_ideo, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted Professional Percentage",
    title = "Marginal Effect of Ideology on Professional Percentage"
  ) +
  theme_minimal(base_size = 14)
save_to_output("ideology_marginal_effect_adver_prof.png", plot = p1, width = 8, height = 4, dpi = 300)
```

legis_lm0 marginal effects

```{r}
#| label: prof.percentage marginal effects legis
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age1 <- ggpredict(legis_lm0, terms = "age")
eff_ideo1 <- ggpredict(legis_lm0, terms = "ideology")
eff_sen1 <- ggpredict(legis_lm0, terms = "seniority")
eff_gender1 <- ggpredict(legis_lm0, terms = "gender")

# ideology
p2 <- ggplot(eff_ideo1, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted Professional Percentage",
    title = "Marginal Effect of Ideology on Professional Percentage Legis"
  ) +
  theme_minimal(base_size = 14)
save_to_output("ideology_marginal_effect_legis_prof.png", plot = p2, width = 8, height = 4, dpi = 300)
```

### 6.3.2 single variable regression model

models training - adver

```{r}
#| label: prof.percentage lm sin1
#| echo: false

adver_cg_age1 <- lm(prof_percentage ~ age +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_ideology1 <- lm(prof_percentage ~ ideology +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_is.republican1 <- lm(prof_percentage ~ is.republican +
                     as.factor(congress), 
               data = adver_cg)

adver_cg_chamber1 <- lm(prof_percentage ~ chamber +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_gender1 <- lm(prof_percentage ~ gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_seniority1 <- lm(prof_percentage ~ seniority +
                     as.factor(congress), 
                   data = adver_cg)

# result
modelsummary(
  list(
    "1" = adver_cg_age1,
    "2" = adver_cg_ideology1,
    "3" = adver_cg_is.republican1,
    "4" = adver_cg_gender1,
    "5" = adver_cg_chamber1,
    "6" = adver_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodel_adver_seperated_prof.html"),
  escape = FALSE
)
```

```{r}
#| label: prof.percentage lm sin district1
#| echo: false

adver_single_models <- vars %>%
  map_df(function(v) {
    formula_str <- paste0("prof_percentage ~ ", v, " + as.factor(congress)")
    m <- lm(as.formula(formula_str), data = adver_merged)
    
    tidy(m) %>%
      filter(term == v) %>%
      mutate(var = v)
  })

# æŸ¥çœ‹ç»“æœ
adver_single_models %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

# å¯è§†åŒ–æ˜¾è‘—æ€§ä¸æ–¹å‘
adver_single_models %>%
  mutate(sig = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    p.value < 0.1 ~ "+",
    TRUE ~ ""
  )) %>%
  ggplot(aes(x = reorder(var, estimate), y = estimate, color = p.value < 0.05)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                    ymax = estimate + 1.96 * std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(x = "Variables", 
       y = "Coefficient (prof_percentage)",
       title = "Single-variable Linear Regression Results (with Congress FE)")
```

models training - legis

```{r}
#| label: prof.percentage lm sin2
#| echo: false

legis_cg_age1 <- lm(prof_percentage ~ age +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_ideology1 <- lm(prof_percentage ~ ideology +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_is.republican1 <- lm(prof_percentage ~ is.republican +
                     as.factor(congress), 
               data = legis_cg)

legis_cg_chamber1 <- lm(prof_percentage ~ chamber +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_gender1 <- lm(prof_percentage ~ gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_seniority1 <- lm(prof_percentage ~ seniority +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "1" = legis_cg_age1,
    "2" = legis_cg_ideology1,
    "3" = legis_cg_is.republican1,
    "4" = legis_cg_gender1,
    "5" = legis_cg_chamber1,
    "6" = legis_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodel_legis_seperated_prof.html"),
  escape = FALSE
)
```

```{r}
#| label: prof.percentage lm sin district2
#| echo: false

legis_single_models <- vars %>%
  map_df(function(v) {
    formula_str <- paste0("prof_percentage ~ ", v, " + as.factor(congress)")
    m <- lm(as.formula(formula_str), data = legis_merged)
    
    tidy(m) %>%
      filter(term == v) %>%
      mutate(var = v)
  })

# æŸ¥çœ‹ç»“æœ
legis_single_models %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

# å¯è§†åŒ–æ˜¾è‘—æ€§ä¸æ–¹å‘
legis_single_models %>%
  mutate(sig = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    p.value < 0.1 ~ "+",
    TRUE ~ ""
  )) %>%
  ggplot(aes(x = reorder(var, estimate), y = estimate, color = p.value < 0.05)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                    ymax = estimate + 1.96 * std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(x = "Variables", 
       y = "Coefficient (prof_percentage)",
       title = "Single-variable Linear Regression Results (with Congress FE)")
```

single variable model coefficient plot

```{r}
#| label: prof.percentage coefficient plot
#| echo: false

# ----- model lists -----
adver_lm_models <- list(
  age = adver_cg_age1,
  ideology = adver_cg_ideology1,
  is_republican = adver_cg_is.republican1,
  gender = adver_cg_gender1,
  chamber = adver_cg_chamber1,
  seniority = adver_cg_seniority1
)

legis_lm_models <- list(
  age = legis_cg_age1,
  ideology = legis_cg_ideology1,
  is_republican = legis_cg_is.republican1,
  gender = legis_cg_gender1,
  chamber = legis_cg_chamber1,
  seniority = legis_cg_seniority1
)


# ----- extract coefficient and clean -----
# adver
coef_adver1 <- map_df(names(adver_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_adver_clean1 <- coef_adver1 %>%
  filter(!grepl("Intercept|congress", term))

# legis
coef_legis1 <- map_df(names(legis_lm_models), function(name) {
  tidy(legis_lm_models[[name]]) %>%  
    mutate(model = name)
})
coef_legis_clean1 <- coef_legis1 %>%
  filter(!grepl("Intercept|congress", term))

# ----- estimate and 95% CI -----
p3 <- ggplot(coef_adver_clean1, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("adver_lm_single_coefficient_prof.png", plot = p3, width = 8, height = 4, dpi = 300)

p4 <- ggplot(coef_legis_clean1, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("legis_lm_single_coefficient_prof.png", plot = p4, width = 8, height = 4, dpi = 300)

```

### robustness check

```{r}
#| label: prof.percentage robust check
#| echo: false


# æ„å»ºæ¨¡å‹åˆ—è¡¨
model_adver_lm_dom_multiple <- list(
  "adver_dom0" = adver_lm0,
  "adver_dom1" = adver_lm1,
  "adver_dom2" = adver_lm2,
  "adver_dom3" = adver_lm3,
  "adver_dom4" = adver_lm4
)

models_adver_lm_dom <- list(
  "age_dom" = adver_cg_age1,
  "ideology_dom" = adver_cg_ideology1,
  "is.republican_dom" = adver_cg_is.republican1,
  "gender_dom" = adver_cg_gender1,
  "chamber_dom" = adver_cg_chamber1,
  "seniority_dom" = adver_cg_seniority1
)

model_legis_lm_dom_multiple <- list(
  "legis_dom" = legis_lm0,
  "legis_dom1" = legis_lm1,
  "legis_dom2" = legis_lm2,
  "legis_dom3" = legis_lm3,
  "legis_dom4" = legis_lm4
)

models_legis_lm_dom <- list(
  "legis_age_dom" = legis_cg_age1,
  "legis_ideology_dom" = legis_cg_ideology1,
  "legis_is.republican_dom" = legis_cg_is.republican1,
  "legis_gender_dom" = legis_cg_gender1,
  "legis_chamber_dom" = legis_cg_chamber1,
  "legis_seniority_dom" = legis_cg_seniority1
)


# è¿è¡Œå‡½æ•°
plot_lm_diagnostics(model_adver_lm_dom_multiple)
plot_lm_diagnostics(model_legis_lm_dom_multiple)
plot_lm_diagnostics(models_adver_lm_dom)
plot_lm_diagnostics(models_legis_lm_dom)
```

## 6.4 dependent variable: intl_percentage

### 6.4.1 multiple variables regression model

lasso

```{r}
#| label: intl_percentage logit mul1
#| echo: false

# adver
cv_lasso_adver3 <- run_glmnet_selection(adver_cg, intl_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "gaussian")
cv_ridge_adver3 <- run_glmnet_selection(adver_cg, intl_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "gaussian")
cv_elnet_adver3 <- run_glmnet_selection(adver_cg, intl_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "gaussian")

# legis
cv_lasso_legis3 <- run_glmnet_selection(legis_cg, intl_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 1,
  family = "gaussian")
cv_ridge_legis3 <- run_glmnet_selection(legis_cg, intl_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0,
  family = "gaussian")
cv_elnet_legis3 <- run_glmnet_selection(legis_cg, intl_percentage ~ age + party + ideology + chamber + gender + seniority + as.factor(congress), alpha = 0.5,
  family = "gaussian")

```

models training - adver

```{r}
#| label: intl.percentage lm mul2
#| echo: false

# original
adver_lm0 <- lm(intl_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = adver_cg)

# adjusted
adver_lm1 <- lm(intl_percentage ~ age + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm2 <- lm(intl_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm3 <- lm(intl_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_lm4 <- lm(intl_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = adver_cg)

# result
modelsummary(
  list(
    "Adver LM" = adver_lm0,
    "1" = adver_lm1,
    "2" = adver_lm2,
    "3" = adver_lm3,
    "4" = adver_lm4
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_adver_intl.html"),
  escape = FALSE
)

# ---- vif check ----
vif(adver_lm0)
vif(adver_lm1)
vif(adver_lm2)
vif(adver_lm3)
vif(adver_lm4)
```

models training - legis

```{r}
#| label: intl.percentage lm mul3
#| echo: false

# original
legis_lm0 <- lm(intl_percentage ~ age + 
                     is.republican + ideology + seniority+ 
                     chamber + gender + 
                     as.factor(congress), 
                   data = legis_cg)

# adjusted
legis_lm1 <- lm(intl_percentage ~ age + 
                     chamber + gender + is.republican 
                     + as.factor(congress),   data = legis_cg )

legis_lm2 <- lm(intl_percentage ~ age + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm3 <- lm(intl_percentage ~ seniority + 
                     ideology + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_lm4 <- lm(intl_percentage ~ seniority + 
                     is.republican + 
                     chamber + gender +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "Legis LM" = legis_lm0,
    "1" = legis_lm1,
    "2" = legis_lm2,
    "3" = legis_lm3,
    "4" = legis_lm4
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodels_legis_intl.html"),
  escape = FALSE
)

# ---- vif check ----
vif(legis_lm0)
vif(legis_lm1)
vif(legis_lm2)
vif(legis_lm3)
vif(legis_lm4)
```

adver_lm0 marginal effects

```{r}
#| label: intl.percentage marginal effects adver
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age <- ggpredict(adver_lm0, terms = "age")
eff_ideo <- ggpredict(adver_lm0, terms = "ideology")
eff_sen <- ggpredict(adver_lm0, terms = "seniority")
eff_gender <- ggpredict(adver_lm0, terms = "gender")

# ideology
p1 <- ggplot(eff_ideo, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted International Percentage",
    title = "Marginal Effect of Ideology on International Percentage"
  ) +
  theme_minimal(base_size = 14)
save_to_output("ideology_marginal_effect_adver_intl.png", plot = p1, width = 8, height = 4, dpi = 300)
```

legis_lm0 marginal effects

```{r}
#| label: intl.percentage marginal effects legis
#| echo: false

# è·å–å˜é‡çš„é¢„æµ‹è¾¹é™…æ•ˆåº”
eff_age1 <- ggpredict(legis_lm0, terms = "age")
eff_ideo1 <- ggpredict(legis_lm0, terms = "ideology")
eff_sen1 <- ggpredict(legis_lm0, terms = "seniority")
eff_gender1 <- ggpredict(legis_lm0, terms = "gender")

# ideology
p2 <- ggplot(eff_ideo1, aes(x = x, y = predicted)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Ideology",
    y = "Predicted International Percentage",
    title = "Marginal Effect of Ideology on International Percentage Legis"
  ) +
  theme_minimal(base_size = 14)
save_to_output("ideology_marginal_effect_legis_intl.png", plot = p2, width = 8, height = 4, dpi = 300)
```

### 6.4.2 single variable regression model

models training - adver

```{r}
#| label: intl.percentage lm sin1
#| echo: false

adver_cg_age1 <- lm(intl_percentage ~ age +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_ideology1 <- lm(intl_percentage ~ ideology +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_is.republican1 <- lm(intl_percentage ~ is.republican +
                     as.factor(congress), 
               data = adver_cg)

adver_cg_chamber1 <- lm(intl_percentage ~ chamber +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_gender1 <- lm(intl_percentage ~ gender +
                     as.factor(congress), 
                   data = adver_cg)

adver_cg_seniority1 <- lm(intl_percentage ~ seniority +
                     as.factor(congress), 
                   data = adver_cg)

# result
modelsummary(
  list(
    "1" = adver_cg_age1,
    "2" = adver_cg_ideology1,
    "3" = adver_cg_is.republican1,
    "4" = adver_cg_gender1,
    "5" = adver_cg_chamber1,
    "6" = adver_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodel_adver_seperated_intl.html"),
  escape = FALSE
)
```

```{r}
#| label: intl.percentage lm sin district1
#| echo: false

adver_single_models <- vars %>%
  map_df(function(v) {
    formula_str <- paste0("intl_percentage ~ ", v, " + as.factor(congress)")
    m <- lm(as.formula(formula_str), data = adver_merged)
    
    tidy(m) %>%
      filter(term == v) %>%
      mutate(var = v)
  })

# æŸ¥çœ‹ç»“æœ
adver_single_models %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

# å¯è§†åŒ–æ˜¾è‘—æ€§ä¸æ–¹å‘
adver_single_models %>%
  mutate(sig = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    p.value < 0.1 ~ "+",
    TRUE ~ ""
  )) %>%
  ggplot(aes(x = reorder(var, estimate), y = estimate, color = p.value < 0.05)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                    ymax = estimate + 1.96 * std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(x = "Variables", 
       y = "Coefficient (prof_percentage)",
       title = "Single-variable Linear Regression Results (with Congress FE)")
```

models training - legis

```{r}
#| label: prof.percentage lm sin2
#| echo: false

legis_cg_age1 <- lm(intl_percentage ~ age +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_ideology1 <- lm(intl_percentage ~ ideology +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_is.republican1 <- lm(intl_percentage ~ is.republican +
                     as.factor(congress), 
               data = legis_cg)

legis_cg_chamber1 <- lm(intl_percentage ~ chamber +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_gender1 <- lm(intl_percentage ~ gender +
                     as.factor(congress), 
                   data = legis_cg)

legis_cg_seniority1 <- lm(intl_percentage ~ seniority +
                     as.factor(congress), 
                   data = legis_cg)

# result
modelsummary(
  list(
    "1" = legis_cg_age1,
    "2" = legis_cg_ideology1,
    "3" = legis_cg_is.republican1,
    "4" = legis_cg_gender1,
    "5" = legis_cg_chamber1,
    "6" = legis_cg_seniority1
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lmmodel_legis_seperated_intl.html"),
  escape = FALSE
)
```

```{r}
#| label: intl.percentage lm sin district2
#| echo: false

legis_single_models <- vars %>%
  map_df(function(v) {
    formula_str <- paste0("intl_percentage ~ ", v, " + as.factor(congress)")
    m <- lm(as.formula(formula_str), data = legis_merged)
    
    tidy(m) %>%
      filter(term == v) %>%
      mutate(var = v)
  })

# æŸ¥çœ‹ç»“æœ
legis_single_models %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

# å¯è§†åŒ–æ˜¾è‘—æ€§ä¸æ–¹å‘
legis_single_models %>%
  mutate(sig = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    p.value < 0.1 ~ "+",
    TRUE ~ ""
  )) %>%
  ggplot(aes(x = reorder(var, estimate), y = estimate, color = p.value < 0.05)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                    ymax = estimate + 1.96 * std.error),
                width = 0.2) +
  coord_flip() +
  theme_minimal() +
  labs(x = "Variables", 
       y = "Coefficient (prof_percentage)",
       title = "Single-variable Linear Regression Results (with Congress FE)")

```

single variable model coefficient plot

```{r}
#| label: intl.percentage coefficient plot
#| echo: false

# ----- model lists -----
adver_lm_models <- list(
  age = adver_cg_age1,
  ideology = adver_cg_ideology1,
  is_republican = adver_cg_is.republican1,
  gender = adver_cg_gender1,
  chamber = adver_cg_chamber1,
  seniority = adver_cg_seniority1
)

legis_lm_models <- list(
  age = legis_cg_age1,
  ideology = legis_cg_ideology1,
  is_republican = legis_cg_is.republican1,
  gender = legis_cg_gender1,
  chamber = legis_cg_chamber1,
  seniority = legis_cg_seniority1
)


# ----- extract coefficient and clean -----
# adver
coef_adver1 <- map_df(names(adver_lm_models), function(name) {
  tidy(adver_lm_models[[name]]) %>%
    mutate(model = name)
})
coef_adver_clean1 <- coef_adver1 %>%
  filter(!grepl("Intercept|congress", term))

# legis
coef_legis1 <- map_df(names(legis_lm_models), function(name) {
  tidy(legis_lm_models[[name]]) %>%  
    mutate(model = name)
})
coef_legis_clean1 <- coef_legis1 %>%
  filter(!grepl("Intercept|congress", term))

# ----- estimate and 95% CI -----
p3 <- ggplot(coef_adver_clean1, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("adver_lm_single_coefficient_intl.png", plot = p3, width = 8, height = 4, dpi = 300)

p4 <- ggplot(coef_legis_clean1, aes(x = estimate, y = reorder(model, estimate))) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_errorbarh(aes(xmin = estimate - 1.96 * std.error,
                     xmax = estimate + 1.96 * std.error),
                 height = 0.2, color = "#2c7fb8") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Coefficient Estimates Across Models",
    x = "Coefficient Estimate (with 95% CI)",
    y = "Predictor Variable"
  )
save_to_output("legis_lm_single_coefficient_intl.png", plot = p4, width = 8, height = 4, dpi = 300)

```

### robustness check

```{r}
#| label: intl.percentage robust check
#| echo: false

# æ„å»ºæ¨¡å‹åˆ—è¡¨
model_adver_lm_dom_multiple <- list(
  "adver_dom0" = adver_lm0,
  "adver_dom1" = adver_lm1,
  "adver_dom2" = adver_lm2,
  "adver_dom3" = adver_lm3,
  "adver_dom4" = adver_lm4
)

models_adver_lm_dom <- list(
  "age_dom" = adver_cg_age1,
  "ideology_dom" = adver_cg_ideology1,
  "is.republican_dom" = adver_cg_is.republican1,
  "gender_dom" = adver_cg_gender1,
  "chamber_dom" = adver_cg_chamber1,
  "seniority_dom" = adver_cg_seniority1
)

model_legis_lm_dom_multiple <- list(
  "legis_dom" = legis_lm0,
  "legis_dom1" = legis_lm1,
  "legis_dom2" = legis_lm2,
  "legis_dom3" = legis_lm3,
  "legis_dom4" = legis_lm4
)

models_legis_lm_dom <- list(
  "legis_age_dom" = legis_cg_age1,
  "legis_ideology_dom" = legis_cg_ideology1,
  "legis_is.republican_dom" = legis_cg_is.republican1,
  "legis_gender_dom" = legis_cg_gender1,
  "legis_chamber_dom" = legis_cg_chamber1,
  "legis_seniority_dom" = legis_cg_seniority1
)


# è¿è¡Œå‡½æ•°
plot_lm_diagnostics(model_adver_lm_dom_multiple)
plot_lm_diagnostics(model_legis_lm_dom_multiple)
plot_lm_diagnostics(models_adver_lm_dom)
plot_lm_diagnostics(models_legis_lm_dom)
```

## 6.5 interaction model

### 6.5.1 dependent variable: is.dom

adver

```{r}
#| label: is.dom interaction adver
#| echo: false

# ideology * gender

adver_inter1 <- glm(is.dom ~ age + seniority + is.republican + chamber + ideology*gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(adver_inter1)

# ideology * gender
adver_inter2 <- glm(is.dom ~ age + seniority + is.republican + gender + chamber*ideology + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(adver_inter2)

# is.republican * gender
adver_inter3 <- glm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(legis_inter3)

# is.republican * chamber
adver_inter4 <- glm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = adver_cg, 
                   family = binomial())
analyze_logit_model(legis_inter4)

# effects
interact_plot(adver_inter1, pred = ideology, modx = gender, interval = TRUE)
sim_slopes(adver_inter1, pred = ideology, modx = gender)

interact_plot(adver_inter2, pred = ideology, modx = chamber, interval = TRUE)
sim_slopes(adver_inter2, pred = ideology, modx = chamber)

interact_plot(adver_inter3, pred = is.republican, modx = gender, interval = TRUE)
sim_slopes(adver_inter3, pred = is.republican, modx = gender)

interact_plot(adver_inter4, pred = is.republican, modx = chamber, interval = TRUE)
sim_slopes(adver_inter4, pred = is.republican, modx = chamber)


```

legis

```{r}
#| label: is.dom interaction legis
#| echo: false

# ideology * gender
legis_inter1 <- glm(is.dom ~ age + seniority + is.republican + chamber + ideology*gender + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter1)

# ideology * chamber
legis_inter2 <- glm(is.dom ~ age + seniority + is.republican*gender + chamber + ideology + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter2)


# is.republican * gender
legis_inter3 <- glm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter3)

# is.republican * chamber
legis_inter4 <- glm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = legis_cg, 
                   family = binomial())
analyze_logit_model(legis_inter4)


# effects
interact_plot(legis_inter1, pred = ideology, modx = gender, interval = TRUE)
sim_slopes(legis_inter1, pred = ideology, modx = gender)

interact_plot(legis_inter2, pred = ideology, modx = chamber, interval = TRUE)
sim_slopes(legis_inter2, pred = ideology, modx = chamber)

interact_plot(legis_inter3, pred = is.republican, modx = gender, interval = TRUE)
sim_slopes(legis_inter3, pred = is.republican, modx = gender)

interact_plot(legis_inter4, pred = is.republican, modx = chamber, interval = TRUE)
sim_slopes(legis_inter4, pred = is.republican, modx = chamber)

```

### 6.5.2 dependent variable: dom_percentage(demo)

adver

```{r}
#| label: dom.percentage interaction adver
#| echo: false

# ideology * gender
adver_lm_inter1 <- lm(dom_percentage ~ age + chamber + is.republican + ideology*gender + as.factor(congress),
                   data = adver_cg)
summary(adver_lm_inter1)

# ideology * chamber
adver_lm_inter2 <- lm(dom_percentage ~ age + ideology*chamber + is.republican + gender + as.factor(congress),
                   data = adver_cg)
summary(adver_lm_inter2)

# is.republican * gender
adver_lm_inter3 <- lm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = adver_cg)
summary(adver_lm_inter3)

# is.republican * chamber
adver_lm_inter4 <- lm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = adver_cg)
summary(adver_lm_inter4)

# ---- effect ----
interact_plot(adver_lm_inter1, pred = ideology, modx = gender, data = adver_cg)
interact_plot(adver_lm_inter2, pred = ideology, modx = chamber, data = adver_cg)
interact_plot(adver_lm_inter3, pred = is.republican, modx = gender, data = adver_cg)
interact_plot(adver_lm_inter4, pred = is.republican, modx = chamber, data = adver_cg)
```

legis

```{r}
#| label: dom.percentage interaction legis
#| echo: false

# ideology * gender
legis_lm_inter1 <- lm(dom_percentage ~ age + chamber + is.republican + ideology*gender + as.factor(congress),
                   data = legis_cg)
summary(legis_lm_inter1)

# ideology * chamber
legis_lm_inter2 <- lm(dom_percentage ~ age + ideology*chamber + is.republican + gender + as.factor(congress),
                   data = legis_cg)
summary(legis_lm_inter2)

# is.republican * gender
legis_lm_inter3 <- lm(is.dom ~ age + seniority + ideology + chamber + is.republican*gender + as.factor(congress), 
                   data = legis_cg)
summary(legis_lm_inter3)

# is.republican * chamber
legis_lm_inter4 <- lm(is.dom ~ age + seniority + ideology + gender + is.republican*chamber + as.factor(congress), 
                   data = legis_cg)
summary(legis_lm_inter4)

# ---- effect ----
interact_plot(legis_lm_inter1, pred = ideology, modx = gender, data = legis_cg)
interact_plot(legis_lm_inter2, pred = ideology, modx = chamber, data = legis_cg)
interact_plot(legis_lm_inter3, pred = is.republican, modx = gender, data = legis_cg)
interact_plot(legis_lm_inter4, pred = is.republican, modx = chamber, data = legis_cg)
```

### 6.5.3 dependent variable: dom (district)

```{r}
#| label: dom.percentage interaction adver
#| echo: false

# high_edu_share * gender
adver_lm_inter1 <- lm(dom_percentage ~ age + chamber + ideology + high_edu_share*party + gender + as.factor(congress),
                   data = adver_merged)
summary(adver_lm_inter1)

# blue collar * party
adver_lm_inter2 <- lm(dom_percentage ~ age + ideology + blue_collar_share*party + gender + as.factor(congress),
                   data = adver_merged)
summary(adver_lm_inter2)

# white collar * party
adver_lm_inter3 <- lm(dom_percentage ~ age + ideology + white_collar_share*party + gender + as.factor(congress),
                   data = adver_merged)
summary(adver_lm_inter3)

# white_ratio * party
adver_lm_inter4 <- lm(dom_percentage ~ age + seniority + ideology + chamber + white_ratio*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter4)

# asian_ratio * party
adver_lm_inter5 <- lm(dom_percentage ~ age + seniority + ideology + chamber + asian_ratio*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter5)

# black_ratio * party
adver_lm_inter6 <- lm(dom_percentage ~ age + seniority + ideology + chamber + black_or_african_american_ratio*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter6)

# median_household_income * party
adver_lm_inter7 <- lm(dom_percentage ~ age + seniority + ideology + chamber + median_household_income_that_year*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter7)

# foreignborn * party
adver_lm_inter8 <- lm(dom_percentage ~ age + seniority + ideology + chamber + foreign_born_ratio*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter8)

# ---- effect ----
interact_plot(adver_lm_inter1, pred = high_edu_share, modx = party, data = adver_merged)
interact_plot(adver_lm_inter2, pred = blue_collar_share, modx = party, data = adver_merged)
interact_plot(adver_lm_inter3, pred = white_collar_share, modx = party, data = adver_merged)
interact_plot(adver_lm_inter4, pred = white_ratio, modx = party, data = adver_merged)
interact_plot(adver_lm_inter5, pred = asian_ratio, modx = party, data = adver_merged)
interact_plot(adver_lm_inter6, pred = black_or_african_american_ratio, modx = party, data = adver_merged)
interact_plot(adver_lm_inter7, pred = median_household_income_that_year, modx = party, data = adver_merged)
interact_plot(adver_lm_inter8, pred = foreign_born_ratio, modx = party, data = adver_merged)
```

```{r}
#| label: dom.percentage interaction legis
#| echo: false

# high_edu_share * gender
legis_lm_inter1 <- lm(dom_percentage ~ age + chamber + ideology + high_edu_share*party + gender + as.factor(congress),
                   data = legis_merged)
summary(legis_lm_inter1)

# blue collar * party
legis_lm_inter2 <- lm(dom_percentage ~ age + ideology + blue_collar_share*party + gender + as.factor(congress),
                   data = legis_merged)
summary(legis_lm_inter2)

# white collar * party
legis_lm_inter3 <- lm(dom_percentage ~ age + ideology + white_collar_share*party + gender + as.factor(congress),
                   data = legis_merged)
summary(legis_lm_inter3)

# white_ratio * party
legis_lm_inter4 <- lm(dom_percentage ~ age + seniority + ideology + chamber + white_ratio*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter4)

# asian_ratio * party
legis_lm_inter5 <- lm(dom_percentage ~ age + seniority + ideology + chamber + asian_ratio*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter5)

# black_ratio * party
legis_lm_inter6 <- lm(dom_percentage ~ age + seniority + ideology + chamber + black_or_african_american_ratio*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter6)

# median_household_income * party
legis_lm_inter7 <- lm(dom_percentage ~ age + seniority + ideology + chamber + median_household_income_that_year*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter7)


# median_household_income * party
legis_lm_inter8 <- lm(dom_percentage ~ age + seniority + ideology + chamber + foreign_born_ratio*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter8)

# ---- effect ----
interact_plot(legis_lm_inter1, pred = high_edu_share, modx = party, data = legis_merged)
interact_plot(legis_lm_inter2, pred = blue_collar_share, modx = party, data = legis_merged)
interact_plot(legis_lm_inter3, pred = white_collar_share, modx = party, data = legis_merged)
interact_plot(legis_lm_inter4, pred = white_ratio, modx = party, data = legis_merged)
interact_plot(legis_lm_inter5, pred = asian_ratio, modx = party, data = legis_merged)
interact_plot(legis_lm_inter6, pred = black_or_african_american_ratio, modx = party, data = legis_merged)
interact_plot(legis_lm_inter7, pred = median_household_income_that_year, modx = party, data = legis_merged)
interact_plot(legis_lm_inter8, pred = foreign_born_ratio, modx = party, data = legis_merged)
```

### 6.5.4 dependent variable: prof(district)

district variable\*party and gender

```{r}
#| label: prof.percentage interaction adver
#| echo: false

# high_edu_share * gender
adver_lm_inter1 <- lm(prof_percentage ~ age + chamber + ideology + high_edu_share*party + gender + as.factor(congress),
                   data = adver_merged)
summary(adver_lm_inter1)

# blue collar * party
adver_lm_inter2 <- lm(prof_percentage ~ age + ideology + blue_collar_share*party + gender + as.factor(congress),
                   data = adver_merged)
summary(adver_lm_inter2)

# white collar * party
adver_lm_inter3 <- lm(prof_percentage ~ age + ideology + white_collar_share*party + gender + as.factor(congress),
                   data = adver_merged)
summary(adver_lm_inter3)

# white_ratio * party
adver_lm_inter4 <- lm(prof_percentage ~ age + seniority + ideology + chamber + white_ratio*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter4)

# asian_ratio * party
adver_lm_inter5 <- lm(prof_percentage ~ age + seniority + ideology + chamber + asian_ratio*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter5)

# black_ratio * party
adver_lm_inter6 <- lm(prof_percentage ~ age + seniority + ideology + chamber + black_or_african_american_ratio*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter6)

# median_household_income * party
adver_lm_inter7 <- lm(prof_percentage ~ age + seniority + ideology + chamber + median_household_income_that_year*party +gender + as.factor(congress), 
                   data = adver_merged)
summary(adver_lm_inter7)


# ---- effect ----
interact_plot(adver_lm_inter1, pred = high_edu_share, modx = party, data = adver_merged)
interact_plot(adver_lm_inter2, pred = blue_collar_share, modx = party, data = adver_merged)
interact_plot(adver_lm_inter3, pred = white_collar_share, modx = party, data = adver_merged)
interact_plot(adver_lm_inter4, pred = white_ratio, modx = party, data = adver_merged)
interact_plot(adver_lm_inter5, pred = asian_ratio, modx = party, data = adver_merged)
interact_plot(adver_lm_inter6, pred = black_or_african_american_ratio, modx = party, data = adver_merged)
interact_plot(adver_lm_inter7, pred = median_household_income_that_year, modx = party, data = adver_merged)
```

```{r}
#| label: prof.percentage interaction legis
#| echo: false

# high_edu_share * gender
legis_lm_inter1 <- lm(prof_percentage ~ age + chamber + ideology + high_edu_share*party + gender + as.factor(congress),
                   data = legis_merged)
summary(legis_lm_inter1)

# blue collar * party
legis_lm_inter2 <- lm(prof_percentage ~ age + ideology + blue_collar_share*party + gender + as.factor(congress),
                   data = legis_merged)
summary(legis_lm_inter2)

# white collar * party
legis_lm_inter3 <- lm(prof_percentage ~ age + ideology + white_collar_share*party + gender + as.factor(congress),
                   data = legis_merged)
summary(legis_lm_inter3)

# white_ratio * party
legis_lm_inter4 <- lm(prof_percentage ~ age + seniority + ideology + chamber + white_ratio*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter4)

# asian_ratio * party
legis_lm_inter5 <- lm(prof_percentage ~ age + seniority + ideology + chamber + asian_ratio*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter5)

# black_ratio * party
legis_lm_inter6 <- lm(prof_percentage ~ age + seniority + ideology + chamber + black_or_african_american_ratio*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter6)

# median_household_income * party
legis_lm_inter7 <- lm(prof_percentage ~ age + seniority + ideology + chamber + median_household_income_that_year*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter7)


# median_household_income * party
legis_lm_inter7 <- lm(prof_percentage ~ age + seniority + ideology + chamber + median_household_income_that_year*party +gender + as.factor(congress), 
                   data = legis_merged)
summary(legis_lm_inter7)

# ---- effect ----
interact_plot(legis_lm_inter1, pred = high_edu_share, modx = party, data = legis_merged)
interact_plot(legis_lm_inter2, pred = blue_collar_share, modx = party, data = legis_merged)
interact_plot(legis_lm_inter3, pred = white_collar_share, modx = party, data = legis_merged)
interact_plot(legis_lm_inter4, pred = white_ratio, modx = party, data = legis_merged)
interact_plot(legis_lm_inter5, pred = asian_ratio, modx = party, data = legis_merged)
interact_plot(legis_lm_inter6, pred = black_or_african_american_ratio, modx = party, data = legis_merged)
interact_plot(legis_lm_inter7, pred = median_household_income_that_year, modx = party, data = legis_merged)
```

## 6.6 district data multilateral - liner regression

define function

```{r}
#| label: district data regression funtion
#| echo: false

names(adver_merged)

# å®šä¹‰ä¸€ä¸ªå‡½æ•°ç”¨äºé‡å¤åˆ†ææµç¨‹
run_single_var_reg <- function(dep_var, df, vars) {
  map_df(vars, function(v) {
    # å…ˆåˆ æ‰ NA
    df_sub <- df %>%
      dplyr::select(all_of(c(dep_var, v, "congress"))) %>%
      drop_na()
    
    # æ£€æŸ¥å› å˜é‡å’Œè‡ªå˜é‡æ˜¯å¦å¯ç”¨
    if(n_distinct(df_sub[[v]]) < 2) {
      return(tibble(var = v, estimate = NA, std.error = NA, statistic = NA, p.value = NA))
    }
    
    if(is.factor(df_sub[[v]]) && nlevels(df_sub[[v]]) < 2) {
      return(tibble(var = v, estimate = NA, std.error = NA, statistic = NA, p.value = NA))
    }
    
    # æ ¹æ® congress æ°´å¹³æ•°é€‰æ‹©å…¬å¼
    if("congress" %in% names(df_sub) && n_distinct(df_sub$congress) > 1) {
      formula_str <- paste0(dep_var, " ~ ", v, " + as.factor(congress)")
    } else {
      formula_str <- paste0(dep_var, " ~ ", v)
    }
    
    # å›å½’
    m <- lm(as.formula(formula_str), data = df_sub)
    
    tidy(m) %>%
      filter(term == v) %>%
      mutate(var = v)
  })
}

# å®šä¹‰å¯è§†åŒ–å‡½æ•°
plot_reg_results <- function(df, dep_label, title_prefix = "Adver Regression") {
  df %>%
    mutate(sig = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ "+",
      TRUE ~ ""
    )) %>%
    ggplot(aes(x = reorder(var, estimate), y = estimate, color = p.value < 0.05)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = estimate - 1.96 * std.error,
                      ymax = estimate + 1.96 * std.error),
                  width = 0.2) +
    coord_flip() +
    theme_minimal() +
    labs(
      x = "Variables",
      y = paste0("Coefficient (", dep_label, ")"),
      title = paste0(title_prefix, " â€” ", dep_label)
    )
}

```

### 6.6.1 party level

```{r}
#| label: district_data_analysis_adver_party:democrats
#| echo: false

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(dem_adver[[.x]], na.rm = TRUE) > 1)
]

# 5. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
adver_dem_dom  <- run_single_var_reg("dom_percentage",  dem_adver, valid_vars)
adver_dem_prof <- run_single_var_reg("prof_percentage", dem_adver, valid_vars)
adver_dem_intl <- run_single_var_reg("intl_percentage", dem_adver, valid_vars)

# 6. è¾“å‡ºç»“æœä¸å›¾è¡¨
adver_dem_dom %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_dem_dom, "dom_percentage")

adver_dem_prof %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_dem_prof, "prof_percentage")

adver_dem_intl %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_dem_intl, "intl_percentage")
```

```{r}
#| label: district_data_analysis_adver_party:republicans
#| echo: false

# 1. ç­›é€‰å…±å’Œå…šè®®å‘˜æ‰€åœ¨é€‰åŒº
rep_adver <- adver_merged %>%
  filter(party == "Republican")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(rep_adver[[.x]], na.rm = TRUE) > 1)
]

# 4. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
adver_rep_dom  <- run_single_var_reg("dom_percentage",  rep_adver, valid_vars)
adver_rep_prof <- run_single_var_reg("prof_percentage", rep_adver, valid_vars)
adver_rep_intl <- run_single_var_reg("intl_percentage", rep_adver, valid_vars)


# 6. è¾“å‡ºç»“æœ
adver_rep_dom %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_rep_dom, "dom_percentage")

adver_rep_prof %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_rep_prof, "prof_percentage")

adver_rep_intl %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_rep_intl, "intl_percentage")
```

```{r}
#| label: district_data_analysis_legis_party:democratics
#| echo: false

# 1. ç­›é€‰æ°‘ä¸»å…šå‚è®®å‘˜æ‰€åœ¨é€‰åŒº
dem_legis <- legis_merged %>%
  filter(party == "Democratic")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(senate_adver_dem[[.x]], na.rm = TRUE) > 1)
]

# 4. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
legis_dem_dom <- run_single_var_reg("dom_percentage",  dem_legis, valid_vars)
legis_dem_prof <- run_single_var_reg("prof_percentage", dem_legis, valid_vars)
legis_dem_intl <- run_single_var_reg("intl_percentage", dem_legis, valid_vars)

# 6. è¾“å‡ºç»“æœ
legis_dem_dom %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_dem_dom, "dom_percentage")

legis_dem_prof %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_dem_prof, "prof_percentage")

legis_dem_intl %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_dem_intl, "intl_percentage")

```

```{r}
#| label: district_data_analysis_legis_party:republican
#| echo: false

# 1. ç­›é€‰æ°‘ä¸»å…šå‚è®®å‘˜æ‰€åœ¨é€‰åŒº
rep_legis <- legis_merged %>%
  filter(party == "Republican")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(rep_legis[[.x]], na.rm = TRUE) > 1)
]

# 4. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
legis_rep_dom <- run_single_var_reg("dom_percentage",  rep_legis, valid_vars)
legis_rep_prof <- run_single_var_reg("prof_percentage", rep_legis, valid_vars)
legis_rep_intl <- run_single_var_reg("intl_percentage", rep_legis, valid_vars)

# 6. è¾“å‡ºç»“æœ
legis_rep_dom %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_rep_dom, "dom_percentage")

legis_rep_prof %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_rep_prof, "prof_percentage")

legis_rep_intl %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_rep_intl, "intl_percentage")
```

### 6.6.2 chamber level

```{r}
#| label: district_data_analysis_adver_chamber:house
#| echo: false

# ==== 1. ç­›é€‰ä¼—è®®é™¢è®®å‘˜æ‰€åœ¨é€‰åŒº ====
house_adver <- adver_merged %>%
  filter(chamber == "house of representatives")

# ==== 2. ä»…ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ ====
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(house_adver[[.x]], na.rm = TRUE) > 1)
]

# ==== 5. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼ ====
adver_house_dom  <- run_single_var_reg("dom_percentage",  house_adver, valid_vars)
adver_house_prof <- run_single_var_reg("prof_percentage", house_adver, valid_vars)
adver_house_intl <- run_single_var_reg("intl_percentage", house_adver, valid_vars)

# ==== 6. è¾“å‡ºç»“æœä¸ç»˜å›¾ ====
adver_house_dom %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_house_dom, "dom_percentage")

adver_house_prof %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_house_prof, "prof_percentage")

adver_house_intl %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_house_intl, "intl_percentage")
```

```{r}
#| label: district_data_analysis_adver_chamber:senate
#| echo: false

# 1. ç­›é€‰æ°‘ä¸»å…šå‚è®®å‘˜æ‰€åœ¨é€‰åŒº
senate_adver_dem <- adver_merged %>%
  filter(chamber == "senate", party == "Democratic")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(senate_adver_dem[[.x]], na.rm = TRUE) > 1)
]

# 5. è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼
adver_senate_dom_dem  <- run_single_var_reg("dom_percentage",  senate_adver_dem, valid_vars)
adver_senate_prof_dem <- run_single_var_reg("prof_percentage", senate_adver_dem, valid_vars)
adver_senate_intl_dem <- run_single_var_reg("intl_percentage", senate_adver_dem, valid_vars)

# 6. è¾“å‡ºä¸ç»˜å›¾
adver_senate_dom_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_senate_dom_dem, "dom_percentage")

adver_senate_prof_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_senate_prof_dem, "prof_percentage")

adver_senate_intl_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(adver_senate_intl_dem, "intl_percentage")

```

```{r}
#| label: district_data_analysis_legis_chamber:house
#| echo: false

# ==== 1. ç­›é€‰ä¼—è®®é™¢è®®å‘˜æ‰€åœ¨é€‰åŒº ====
house_legis <- legis_merged %>%
  filter(chamber == "house of representatives")

# ==== 2. ä»…ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ ====
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(house_legis[[.x]], na.rm = TRUE) > 1)
]

# ==== 5. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼ ====
legis_house_dom  <- run_single_var_reg("dom_percentage",  house_legis, valid_vars)
legis_house_prof <- run_single_var_reg("prof_percentage", house_legis, valid_vars)
legis_house_intl <- run_single_var_reg("intl_percentage", house_legis, valid_vars)

# ==== 6. è¾“å‡ºç»“æœä¸ç»˜å›¾ ====
legis_house_dom %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_house_dom, "dom_percentage")

legis_house_prof %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_house_prof, "prof_percentage")

legis_house_intl %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_house_intl, "intl_percentage")

```

```{r}
#| label: district_data_analysis_legis_chamber:senate
#| echo: false

# ==== 1. ç­›é€‰ä¼—è®®é™¢è®®å‘˜æ‰€åœ¨é€‰åŒº ====
senate_legis <- legis_merged %>%
  filter(chamber == "senate")

# ==== 2. ä»…ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ ====
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(senate_legis[[.x]], na.rm = TRUE) > 1)
]

# ==== 5. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼ ====
legis_senate_dom  <- run_single_var_reg("dom_percentage",  senate_legis, valid_vars)
legis_senate_prof <- run_single_var_reg("prof_percentage", senate_legis, valid_vars)
legis_senate_intl <- run_single_var_reg("intl_percentage", senate_legis, valid_vars)

# ==== 6. è¾“å‡ºç»“æœä¸ç»˜å›¾ ====
legis_senate_dom %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_senate_dom, "dom_percentage")

legis_senate_prof %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_senate_prof, "prof_percentage")

legis_senate_intl %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)
plot_reg_results(legis_senate_intl, "intl_percentage")

```

### 6.6.3 party+chamber

```{r}
#| label: district_data_analysis_adver_chamber:senate_dem
#| echo: false

# 1. ç­›é€‰æ°‘ä¸»å…šå‚è®®å‘˜æ‰€åœ¨é€‰åŒº
senate_adver_dem <- adver_merged %>%
  filter(chamber == "senate", party == "Democratic")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(senate_adver_dem[[.x]], na.rm = TRUE) > 1)
]

# 4. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
adver_senate_dom_dem  <- run_single_var_reg("dom_percentage",  senate_adver_dem, valid_vars)
adver_senate_prof_dem <- run_single_var_reg("prof_percentage", senate_adver_dem, valid_vars)
adver_senate_intl_dem <- run_single_var_reg("intl_percentage", senate_adver_dem, valid_vars)

# 6. è¾“å‡ºç»“æœ
adver_senate_dom_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_senate_dom_dem, "dom_percentage")

adver_senate_prof_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_senate_prof_dem, "prof_percentage")

adver_senate_intl_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_senate_intl_dem, "intl_percentage")

```

```{r}
#| label: district_data_analysis_adver_chamber:house_dem
#| echo: false

# 1. ç­›é€‰æ°‘ä¸»å…šå‚è®®å‘˜æ‰€åœ¨é€‰åŒº
house_adver_dem <- adver_merged %>%
  filter(chamber == "house of representatives", party == "Democratic")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(house_adver_dem[[.x]], na.rm = TRUE) > 1)
]

# 3. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
adver_house_dom_dem  <- run_single_var_reg("dom_percentage",  house_adver_dem, valid_vars)
adver_house_prof_dem <- run_single_var_reg("prof_percentage", house_adver_dem, valid_vars)
adver_house_intl_dem <- run_single_var_reg("intl_percentage", house_adver_dem, valid_vars)


# 4. è¾“å‡ºç»“æœ
adver_house_dom_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_house_dom_dem, "dom_percentage")

adver_house_prof_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_house_prof_dem, "prof_percentage")

adver_house_intl_dem %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_house_intl_dem, "intl_percentage")
```

```{r}
#| label: district_data_analysis_adver_chamber:house_rep
#| echo: false

# 1. ç­›é€‰æ°‘ä¸»å…šå‚è®®å‘˜æ‰€åœ¨é€‰åŒº
house_adver_rep <- adver_merged %>%
  filter(chamber == "house of representatives", party == "Republican")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(house_adver_rep[[.x]], na.rm = TRUE) > 1)
]

# 3. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
adver_house_dom_rep  <- run_single_var_reg("dom_percentage",  house_adver_rep, valid_vars)
adver_house_prof_rep <- run_single_var_reg("prof_percentage", house_adver_rep, valid_vars)
adver_house_intl_rep <- run_single_var_reg("intl_percentage", house_adver_rep, valid_vars)


# 4. è¾“å‡ºç»“æœ
adver_house_dom_rep %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_house_dom_rep, "dom_percentage")

adver_house_prof_rep %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_house_prof_rep, "prof_percentage")

adver_house_intl_rep %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_house_intl_rep, "intl_percentage")
```

```{r}
#| label: district_data_analysis_adver_chamber:senate_rep
#| echo: false

# 1. ç­›é€‰æ°‘ä¸»å…šå‚è®®å‘˜æ‰€åœ¨é€‰åŒº
senate_adver_rep <- adver_merged %>%
  filter(chamber == "senate", party == "Republican")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(senate_adver_rep[[.x]], na.rm = TRUE) > 1)
]

# 3. åˆ†åˆ«è®¡ç®—ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„å›å½’ç»“æœ
adver_senate_dom_rep  <- run_single_var_reg("dom_percentage",  senate_adver_rep, valid_vars)
adver_senate_prof_rep <- run_single_var_reg("prof_percentage", senate_adver_rep, valid_vars)
adver_senate_intl_rep <- run_single_var_reg("intl_percentage", senate_adver_rep, valid_vars)


# 4. è¾“å‡ºç»“æœ
adver_senate_dom_rep %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_senate_dom_rep, "dom_percentage")

adver_senate_prof_rep %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_senate_prof_rep, "prof_percentage")

adver_senate_intl_rep %>%
  dplyr::select(var, estimate, std.error, statistic, p.value) %>%
  arrange(p.value)

plot_reg_results(adver_senate_intl_rep, "intl_percentage")

```

### 6.6.4 congress

```{r}
#| label: district_data_analysis_adver_congress_115
#| echo: false

# 1. ç­›é€‰ 116 å±Š
adver_115 <- adver_merged %>%
  filter(congress == "115")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(adver_115[[.x]], na.rm = TRUE) > 1)
]

# 4. è¿è¡Œä¸‰ç§è¡Œä¸ºæ¨¡å¼
adver_115_dom  <- run_single_var_reg("dom_percentage",  adver_115, valid_vars)
adver_115_prof <- run_single_var_reg("prof_percentage", adver_115, valid_vars)
adver_115_intl <- run_single_var_reg("intl_percentage", adver_115, valid_vars)

# 5. è¾“å‡º tidy è¡¨ï¼ˆæŒ‰ p å€¼æ’åºï¼‰
adver_115_dom %>%  arrange(p.value)
adver_115_prof %>% arrange(p.value)
adver_115_intl %>% arrange(p.value)

# 7. ç»˜åˆ¶ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„ç³»æ•°å›¾
plot_reg_results(adver_115_dom, "dom_percentage")
plot_reg_results(adver_115_prof, "prof_percentage")
plot_reg_results(adver_115_intl, "intl_percentage")
```

```{r}
#| label: district_data_analysis_adver_congress_116
#| echo: false

# 1. ç­›é€‰ 116 å±Š
adver_116 <- adver_merged %>%
  filter(congress == "116")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(adver_116[[.x]], na.rm = TRUE) > 1)
]

# 4. è¿è¡Œä¸‰ç§è¡Œä¸ºæ¨¡å¼
adver_116_dom  <- run_single_var_reg("dom_percentage",  adver_116, valid_vars)
adver_116_prof <- run_single_var_reg("prof_percentage", adver_116, valid_vars)
adver_116_intl <- run_single_var_reg("intl_percentage", adver_116, valid_vars)

# 5. è¾“å‡º tidy è¡¨ï¼ˆæŒ‰ p å€¼æ’åºï¼‰
adver_116_dom %>%  arrange(p.value)
adver_116_prof %>% arrange(p.value)
adver_116_intl %>% arrange(p.value)

# 7. ç»˜åˆ¶ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„ç³»æ•°å›¾
plot_reg_results(adver_116_dom, "dom_percentage")
plot_reg_results(adver_116_prof, "prof_percentage")
plot_reg_results(adver_116_intl, "intl_percentage")

```

```{r}
#| label: district_data_analysis_adver_congress_117
#| echo: false


# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(adver_117[[.x]], na.rm = TRUE) > 1)
]

# 4. è¿è¡Œä¸‰ç§è¡Œä¸ºæ¨¡å¼
adver_117_dom  <- run_single_var_reg("dom_percentage",  adver_117, valid_vars)
adver_117_prof <- run_single_var_reg("prof_percentage", adver_117, valid_vars)
adver_117_intl <- run_single_var_reg("intl_percentage", adver_117, valid_vars)

# 5. è¾“å‡º tidy è¡¨ï¼ˆæŒ‰ p å€¼æ’åºï¼‰
adver_117_dom %>%  arrange(p.value)
adver_117_prof %>% arrange(p.value)
adver_117_intl %>% arrange(p.value)

# 7. ç»˜åˆ¶ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„ç³»æ•°å›¾
plot_reg_results(adver_117_dom, "dom_percentage")
plot_reg_results(adver_117_prof, "prof_percentage")
plot_reg_results(adver_117_intl, "intl_percentage")

```

```{r}
#| label: district_data_analysis_adver_congress_118
#| echo: false

# 1. ç­›é€‰ 116 å±Š
adver_118 <- adver_merged %>%
  filter(congress == "118")

# 2. ä¿ç•™æ–¹å·®å¤§äº1çš„å˜é‡ï¼ˆé¿å…å¸¸æ•°åˆ—ï¼‰
valid_vars <- vars_to_check[
  map_lgl(vars_to_check, ~ n_distinct(adver_118[[.x]], na.rm = TRUE) > 1)
]

# 4. è¿è¡Œä¸‰ç§è¡Œä¸ºæ¨¡å¼
adver_118_dom  <- run_single_var_reg("dom_percentage",  adver_118, valid_vars)
adver_118_prof <- run_single_var_reg("prof_percentage", adver_118, valid_vars)
adver_118_intl <- run_single_var_reg("intl_percentage", adver_118, valid_vars)

# 5. è¾“å‡º tidy è¡¨ï¼ˆæŒ‰ p å€¼æ’åºï¼‰
adver_118_dom %>%  arrange(p.value)
adver_118_prof %>% arrange(p.value)
adver_118_intl %>% arrange(p.value)

# 7. ç»˜åˆ¶ä¸‰ç§è¡Œä¸ºæ¨¡å¼çš„ç³»æ•°å›¾
plot_reg_results(adver_118_dom, "dom_percentage")
plot_reg_results(adver_118_prof, "prof_percentage")
plot_reg_results(adver_118_intl, "intl_percentage")
```

## 6.7 district analysis - logit regression

### 6.7.1 focus on edu

```{r}
#| label: district_analysis_logit_avder_edu
#| echo: false

library(datawizard)

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰

model11 <- glm(
  is.dom ~ high_edu_share,
  data = adver_merged,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = adver_merged,
  family = binomial(link = "logit")
)

# å°è¯•æ„å»ºç»¼åˆæŒ‡æ ‡
adver_merged <- adver_merged %>%
  mutate(
    edu_white = standardize(high_edu_share) + standardize(white_collar_share)
  )
model22 <- glm(
  is.dom ~ edu_white + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = adver_merged,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = adver_merged,
  family = binomial(link = "logit")
)

# is.republican
model32 <- glm(
  is.dom ~ high_edu_share +
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    is.republican  + gender_numeric + age ,
  data = adver_merged,
  family = binomial(link = "logit")
)

# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)
vif(model32)

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls-edu" = model21,
    "Model 2: District controls-edu_white" = model22,
    "Model 3: + Individual controls(ideo)" = model31,
    "Model 3: + Individual controls(party)" = model32
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_district_edu.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ç™½é¢†æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
eduwhite_effect <- ggpredict(model22, terms = "edu_white [all]")
plot(eduwhite_effect) +
  labs(
    title = "Marginal Effect of edu_white",
    x = "Edu + White-collar composite",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ============================================================
# å…­ã€ç»“æœè§£é‡Šï¼ˆæ³¨é‡Šå»ºè®®ï¼‰
# ============================================================
# - è‹¥ high_edu_share ç³»æ•°ä¸ºè´Ÿï¼šè¯´æ˜é«˜ç­‰æ•™è‚²ç‡è¶Šé«˜çš„é€‰åŒºï¼Œè¶Šå€¾å‘æ°‘ä¸»å…šï¼›
# - è‹¥ç³»æ•°ä¸ºæ­£ï¼šå¯èƒ½åæ˜ é‡ç»„å°šæœªå®Œå…¨åŒæ­¥ï¼Œæˆ–æ•™è‚²å˜é‡ä¸æ”¶å…¥/æ—è£”å…±çº¿ï¼›
# - å¯è¿›ä¸€æ­¥ä»¥å·æˆ–å±Šä¸ºåˆ†å±‚ (multilevel logit) éªŒè¯ç¨³å¥æ€§ï¼›
# - è‹¥ white_collar_share ä¸ is.republican å‘ˆæ­£ç›¸å…³ï¼Œ
#   å¯èƒ½è¡¨å¾é€‰åŒºâ€œéƒŠåŒºåŒ–ï¼ˆsuburbanizationï¼‰â€æˆ–â€œèŒä¸šä¿å®ˆä¸»ä¹‰â€æ•ˆåº”ã€‚

```

```{r}
#| label: district_analysis_logit_avder_dem_edu
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰

model11 <- glm(
  is.dom ~ high_edu_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ high_edu_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

# å°è¯•æ„å»ºç»¼åˆæŒ‡æ ‡
dem_adver <-dem_adver %>%
  mutate(
    edu_white = standardize(high_edu_share) + standardize(white_collar_share)
  )
model22 <- glm(
  is.dom ~ edu_white + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

model22a <- glm(
  is.dom ~ edu_white + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = dem_adver,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)
cor(dplyr::select(dem_adver, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls-edu" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 3: District controls-edu_white" = model22,
    "Model 3a: District controls(!income)" = model22a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_dem_district_edu.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ç™½é¢†æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
eduwhite_effect <- ggpredict(model22, terms = "edu_white [all]")
plot(eduwhite_effect) +
  labs(
    title = "Marginal Effect of edu_white",
    x = "Edu + White-collar composite",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
#| label: district_analysis_logit_legis_dem_edu
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰

model11 <- glm(
  is.dom ~ high_edu_share,
  data = dem_legis,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_legis,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ high_edu_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_legis,
  family = binomial(link = "logit")
)

# å°è¯•æ„å»ºç»¼åˆæŒ‡æ ‡
dem_legis <-dem_legis %>%
  mutate(
    edu_white = standardize(high_edu_share) + standardize(white_collar_share)
  )
model22 <- glm(
  is.dom ~ edu_white + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_legis,
  family = binomial(link = "logit")
)

model22a <- glm(
  is.dom ~ edu_white + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_legis,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = dem_legis,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)
cor(dplyr::select(dem_legis, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls-edu" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 3: District controls-edu_white" = model22,
    "Model 3a: District controls(!income)" = model22a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_legis_dem_district_edu.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ç™½é¢†æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
eduwhite_effect <- ggpredict(model22, terms = "edu_white [all]")
plot(eduwhite_effect) +
  labs(
    title = "Marginal Effect of edu_white",
    x = "Edu + White-collar composite",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ç™½é¢†æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
eduwhite_effect <- ggpredict(model22a, terms = "edu_white [all]")
plot(eduwhite_effect) +
  labs(
    title = "Marginal Effect of edu_white",
    x = "Edu + White-collar composite",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: district_analysis_logit_avder_rep_edu
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰

model11 <- glm(
  is.dom ~ high_edu_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)


# å°è¯•æ„å»ºç»¼åˆæŒ‡æ ‡
rep_adver <- rep_adver %>%
  mutate(
    edu_white = standardize(high_edu_share) + standardize(white_collar_share)
  )
model22 <- glm(
  is.dom ~ edu_white + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

model22a <- glm(
  is.dom ~ edu_white + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = rep_adver,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls-edu" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 3: District controls-edu_white" = model22,
    "Model 3a: District controls(!income)" = model22a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_rep_district_edu.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ç™½é¢†æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
eduwhite_effect <- ggpredict(model22, terms = "edu_white [all]")
plot(eduwhite_effect) +
  labs(
    title = "Marginal Effect of edu_white",
    x = "Edu + White-collar composite",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
#| label: district_analysis_logit_legis_rep_edu
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰

model11 <- glm(
  is.dom ~ high_edu_share,
  data = rep_legis,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_legis,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_legis,
  family = binomial(link = "logit")
)


# å°è¯•æ„å»ºç»¼åˆæŒ‡æ ‡
rep_legis <- rep_legis %>%
  mutate(
    edu_white = standardize(high_edu_share) + standardize(white_collar_share)
  )
model22 <- glm(
  is.dom ~ edu_white + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_legis,
  family = binomial(link = "logit")
)

model22a <- glm(
  is.dom ~ edu_white + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_legis,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = rep_legis,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls-edu" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 3: District controls-edu_white" = model22,
    "Model 3a: District controls(!income)" = model22a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_legis_rep_district_edu.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ç™½é¢†æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
eduwhite_effect <- ggpredict(model21, terms = "agriculture_share [all]")
plot(eduwhite_effect) +
  labs(
    title = "Marginal Effect ",
    x = "agriculture_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
#| label: district_analysis_logit_edu_check
#| echo: false

model_cross <- glm(
  is.dom ~ high_edu_share * party +
    median_household_income_that_year + foreign_born_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = adver_merged,
  family = binomial
)

model_cross2 <- glm(
  is.dom ~ high_edu_share * party + foreign_born_ratio +
    median_household_income_that_year +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = legis_merged,
  family = binomial
)

model_cross3 <- glm(
  is.dom ~ high_edu_share * party + foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = legis_merged,
  family = binomial
)

modelsummary(
  list(
    "Model 1: Avder cross" = model_cross,
    "Model 2: Legis cross" = model_cross2,
    "Model 3: Legis cross (!income)" = model_cross3
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_district_edu_cross.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_logit_avder_edu_congress
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰

model11 <- glm(
  is.dom ~ high_edu_share,
  data = adver_118,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = adver_118,
  family = binomial(link = "logit")
)

# å°è¯•æ„å»ºç»¼åˆæŒ‡æ ‡
adver_118 <- adver_118 %>%
  mutate(
    edu_white = standardize(high_edu_share) + standardize(white_collar_share)
  )
model22 <- glm(
  is.dom ~ edu_white + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = adver_118,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ high_edu_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = adver_118,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls-edu" = model21,
    "Model 3: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_118_district_edu.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
# é«˜ç­‰æ•™è‚²æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
edu_effect <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# ç™½é¢†æ¯”ä¾‹çš„è¾¹é™…æ•ˆåº”
eduwhite_effect <- ggpredict(model22, terms = "edu_white [all]")
plot(eduwhite_effect) +
  labs(
    title = "Marginal Effect of edu_white",
    x = "Edu + White-collar composite",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

```         
```

### 6.7.2 focus on white collar

```{r}
#| label: district_analysis_logit_avder_whitecollar_dem
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰
model11 <- glm(
  is.dom ~ white_collar_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ white_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ white_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ white_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = dem_adver,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)
cor(dplyr::select(dem_adver, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_dem_district_whitecollar.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
edu_effect <- ggpredict(model21, terms = "white_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "white_collar Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

#ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "white_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "white_collar Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: district_analysis_logit_avder_whitecollar_rep
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰
model11 <- glm(
  is.dom ~ white_collar_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ white_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ white_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ white_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = rep_adver,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)
cor(dplyr::select(dem_adver, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_rep_district_whitecollar.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
edu_effect <- ggpredict(model21, terms = "white_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "white_collar Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

#ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "white_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "white_collar Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

### 6.7.3 focus on blue collar

```{r}
#| label: district_analysis_logit_avder_bluecollar_dem
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰
model11 <- glm(
  is.dom ~ blue_collar_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ blue_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ blue_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = dem_adver,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ blue_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = dem_adver,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)
cor(dplyr::select(dem_adver, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_dem_district_bluecollar.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
edu_effect <- ggpredict(model21, terms = "blue_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "blue_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

#ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "blue_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "blue_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: district_analysis_logit_avder_bluecollar_rep
#| echo: false

# ä¸€ã€æ ¸å¿ƒæ¨¡å‹ï¼ˆæœ€ç®€ç‰ˆæœ¬ï¼‰
model11 <- glm(
  is.dom ~ blue_collar_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

# äºŒã€æ‰©å±•æ§åˆ¶æ¨¡å‹ï¼ˆæ§åˆ¶é€‰åŒºç»“æ„å¼‚è´¨æ€§ï¼‰
model21 <- glm(
  is.dom ~ blue_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

model21a <- glm(
  is.dom ~ blue_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share,
  data = rep_adver,
  family = binomial(link = "logit")
)

# ä¸‰ã€ç¨³å¥æ¨¡å‹ï¼ˆæ§åˆ¶è®®å‘˜å±‚çº§å˜é‡ï¼‰
# ideology
model31 <- glm(
  is.dom ~ blue_collar_share + 
    median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender_numeric + age ,
  data = rep_adver,
  family = binomial(link = "logit")
)


# å››ã€æ¨¡å‹è¯Šæ–­ä¸æ¯”è¾ƒ
# 1. æ£€æŸ¥å¤šé‡å…±çº¿æ€§
vif(model21)
vif(model22)
vif(model31)
cor(dplyr::select(dem_adver, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. æ¨¡å‹æ¯”è¾ƒè¡¨
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 2a: District controls(!income)" = model21a,
    "Model 4: + Individual controls(ideo)" = model31
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_adver_rep_district_bluecollar.html"),
  escape = FALSE
)

# äº”ã€å¯è§†åŒ–ï¼šè¾¹é™…æ•ˆåº”ï¼ˆMarginal Effectsï¼‰
edu_effect <- ggpredict(model21, terms = "blue_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district)",
    x = "blue_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

#ï¼ˆå»æ‰incomeï¼‰
edu_effect <- ggpredict(model21a, terms = "blue_collar_share [all]")
plot(edu_effect) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "blue_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

# 7. core groups zoom

## 7.1 issue selections

As it is shown in previous characteristics analysis, the core group of promoting professional mode is Democratic female liberals, the that of domestic mode is Republican male conservatives. This part aims at discovering their issues selection mode.

```{r}
#| label: data mid match 
#| echo: false

# ç¡®ä¿ key å”¯ä¸€
adver_meta <- adver_sum1 %>%
  dplyr::select(bioguide_id, full_name, congress, party, gender, ideology) %>%
  distinct(bioguide_id, congress, .keep_all = TRUE)

news_data$congress <- as.character(news_data$congress)
news_data1 <- news_data %>%
  left_join(
    adver_meta %>% dplyr::select(bioguide_id, full_name, congress, party, gender, ideology),
    by = c("mid" = "bioguide_id", "congress" = "congress")
  )
news_data1 <- news_data1 %>%
  mutate(gender = dplyr::recode(as.character(gender), `1` = "M", `0` = "F"))


# bills data
legis_meta <- legis_sum1 %>%
  dplyr::select(bioguide_id, full_name, congress, party, gender, ideology) %>%
  distinct(bioguide_id, congress, .keep_all = TRUE)

bills_data$congress <- as.character(bills_data$congress)
bills_data1 <- bills_data %>%
  left_join(
    legis_meta %>% 
      dplyr::select(bioguide_id, full_name, congress, party, gender, ideology), 
    by = c("congress", "bioguide_id" = "bioguide_id")
  )
bills_data1 <- bills_data1 %>%
  mutate(gender = dplyr::recode(as.character(gender), `1` = "M", `0` = "F"))
```

```{r}
#| label: news data selection 
#| echo: false

news_issue_choice<- news_data1 %>%
  filter(!is.na(party), !is.na(gender)) %>%
  group_by(party = party, gender = gender, issue) %>%
  summarise(news_count = n(), .groups = "drop") %>%
  group_by(party, gender) %>%
  mutate(share = news_count / sum(news_count) * 100) %>%
  ungroup()

# pick top-10 table
top_n <- 5
top_issues <- news_issue_choice %>%
  filter(!is.na(party), !is.na(gender)) %>%
  filter((party == "Democratic" & gender == "F") |
         (party == "Democratic" & gender == "M") |
         (party == "Republican" & gender == "F") |
         (party == "Republican" & gender == "M")) %>%
  group_by(party, gender) %>%
  slice_max(order_by = news_count, n = top_n, with_ties = FALSE) %>%
  ungroup()

# Plot: side-by-side bars for the top issues (dodge)
ggplot(top_issues, aes(x = reorder(issue, news_count), y = news_count, fill = interaction(party, gender))) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(
    title = paste0("Top ", top_n, " Issues â€” Democratic Women vs Republican Men"),
    x = "Issue",
    y = "News count",
    fill = "Group"
  ) +
  scale_fill_manual(
    values = c("Democratic.F" = "#74add1", "Democratic.M" = "#1b6ca8", "Republican.F" = "#F08080", "Republican.M" = "#d73027"),
    labels = c("Democratic Female", "Republican Female", "Democratic Male", "Republican Male")
  ) +
  theme_minimal(base_size = 13)

```

```{r}
#| label: bills data selection 
#| echo: false

bills_issue_choice<- bills_data1 %>%
 filter(!is.na(party), !is.na(gender)) %>%
  group_by(party = party, gender = gender, issue) %>%
  summarise(news_count = n(), .groups = "drop") %>%
  group_by(party, gender) %>%
  mutate(share = news_count / sum(news_count) * 100) %>%
  ungroup()

# pick top-10 table
top_n <- 5
top_issues <- bills_issue_choice %>%
  filter(!is.na(party), !is.na(gender)) %>%
  filter((party == "Democratic" & gender == "F") |
         (party == "Democratic" & gender == "M") |
         (party == "Republican" & gender == "F") |
         (party == "Republican" & gender == "M")) %>%
  group_by(party, gender) %>%
  slice_max(order_by = news_count, n = top_n, with_ties = FALSE) %>%
  ungroup()

# Plot: side-by-side bars for the top issues (dodge)
ggplot(top_issues, aes(x = reorder(issue, news_count), y = news_count, fill = interaction(party, gender))) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(
    title = paste0("Top ", top_n, " Issues â€” Democratic Women vs Republican Men"),
    x = "Issue",
    y = "News count",
    fill = "Group"
  ) +
  scale_fill_manual(
    values = c("Democratic.F" = "#74add1", "Democratic.M" = "#1b6ca8", "Republican.F" = "#F08080", "Republican.M" = "#d73027"),
    labels = c("Democratic Female", "Republican Female", "Democratic Male", "Republican Male")
  ) +
  theme_minimal(base_size = 13)

```

## 7.2 issues modes

```{r}
#| label: core groups issues modes_adver
#| echo: false

# 1ï¸âƒ£ åˆ›å»ºç¾¤ä½“å˜é‡
adver_cg1 <- adver_cg %>%
  mutate(
    group = case_when(
      party == "Republican" & gender == "Male" ~ "Republican Men",
      party == "Republican" & gender == "Female" ~ "Republican Women",
      party == "Democratic" & gender == "Male" ~ "Democratic Men",
      party == "Democratic" & gender == "Female" ~ "Democratic Women",
      TRUE ~ NA_character_  # å…¶ä»–å…šæ´¾ä¸º NA
    )
  ) %>%
  filter(!is.na(group)) %>%
  filter(chamber == "senate")

# 2ï¸âƒ£ è®¡ç®—æ¯ä¸ªç¾¤ä½“åœ¨æ¯å±Šå›½ä¼šçš„ä¸‰ç±»æ¨¡å¼å¹³å‡ percentage
avg_modes <- adver_cg1 %>%
  group_by(congress, group) %>%
  summarise(
    intl = mean(intl_percentage, na.rm = TRUE),
    dom = mean(dom_percentage, na.rm = TRUE),
    prof = mean(prof_percentage, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(intl, dom, prof),
               names_to = "mode",
               values_to = "avg_percentage")

avg_modes %>%
  count(congress, mode, group) %>%
  pivot_wider(names_from = group, values_from = n)

# 3ï¸âƒ£ ç»˜å›¾ï¼ˆåˆ†é¢ä¸ºè¡Œä¸ºæ¨¡å¼ï¼‰
plot_mode_trend <- function(data, mode_label, title_suffix) {
  data %>%
    filter(mode == mode_label) %>%
    ggplot(aes(x = congress, y = avg_percentage,
               color = group, group = group)) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_color_manual(
      values = c(
        "Republican Men" = "#d73027",   # çº¢è‰²
        "Republican Women" = "#F08080", # æ·¡çº¢
        "Democratic Men" = "#1b6ca8",   # è“è‰²
        "Democratic Women" = "#74add1"  # æ·¡è“
      ),
      name = "Group"
    ) +
    labs(
      title = paste0("Average ", title_suffix, " Mode Percentage by Group"),
      x = "Congress",
      y = "Average Percentage",
      caption = "Data source: adver_cg"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      legend.position = "bottom",
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10)
    )
}

# ç»˜åˆ¶ä¸‰ä¸ªæ¨¡å¼çš„ç‹¬ç«‹å›¾
plot_intl <- plot_mode_trend(avg_modes, "intl", "International")
plot_dom  <- plot_mode_trend(avg_modes, "dom",  "Domestic")
plot_prof <- plot_mode_trend(avg_modes, "prof", "Professional")

# æ˜¾ç¤ºä¸‰ä¸ªå›¾
plot_intl
plot_dom
plot_prof
```

```{r}
#| label: core groups issues modes_legis
#| echo: false

names(legis_cg)

# 1ï¸âƒ£ åˆ›å»ºç¾¤ä½“å˜é‡
legis_cg1 <- legis_cg1 %>%
  mutate(
    group = case_when(
      party == "Republican" & gender == "Male" ~ "Republican Men",
      party == "Republican" & gender == "Female" ~ "Republican Women",
      party == "Democratic" & gender == "Male" ~ "Democratic Men",
      party == "Democratic" & gender == "Female" ~ "Democratic Women",
      TRUE ~ NA_character_  # å…¶ä»–å…šæ´¾ä¸º NA
    )
  ) %>%
  filter(!is.na(group))

# 2ï¸âƒ£ è®¡ç®—æ¯ä¸ªç¾¤ä½“åœ¨æ¯å±Šå›½ä¼šçš„ä¸‰ç±»æ¨¡å¼å¹³å‡ percentage
avg_modes <- legis_cg %>%
  group_by(congress, group) %>%
  summarise(
    intl = mean(intl_percentage, na.rm = TRUE),
    dom = mean(dom_percentage, na.rm = TRUE),
    prof = mean(prof_percentage, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(intl, dom, prof),
               names_to = "mode",
               values_to = "avg_percentage")

avg_modes %>%
  count(congress, mode, group) %>%
  pivot_wider(names_from = group, values_from = n)

# 3ï¸âƒ£ ç»˜å›¾ï¼ˆåˆ†é¢ä¸ºè¡Œä¸ºæ¨¡å¼ï¼‰
plot_mode_trend <- function(data, mode_label, title_suffix) {
  data %>%
    filter(mode == mode_label) %>%
    ggplot(aes(x = congress, y = avg_percentage,
               color = group, group = group)) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_color_manual(
      values = c(
        "Republican Men" = "#d73027",   # çº¢è‰²
        "Republican Women" = "#F08080", # æ·¡çº¢
        "Democratic Men" = "#1b6ca8",   # è“è‰²
        "Democratic Women" = "#74add1"  # æ·¡è“
      ),
      name = "Group"
    ) +
    labs(
      title = paste0("Average ", title_suffix, " Mode Percentage by Group"),
      x = "Congress",
      y = "Average Percentage",
      caption = "Data source: legis_cg"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      legend.position = "bottom",
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10)
    )
}

# ç»˜åˆ¶ä¸‰ä¸ªæ¨¡å¼çš„ç‹¬ç«‹å›¾
plot_intl <- plot_mode_trend(avg_modes, "intl", "International")
plot_dom  <- plot_mode_trend(avg_modes, "dom",  "Domestic")
plot_prof <- plot_mode_trend(avg_modes, "prof", "Professional")

# æ˜¾ç¤ºä¸‰ä¸ªå›¾
plot_intl
plot_dom
plot_prof
```

## 7.3 congressional district interaction

```{r}
#| label: district data overview
#| echo: false


# ---- æ•´ä½“åˆ†å¸ƒå·®å¼‚ -----
# é•¿æ ¼å¼è½¬æ¢
adver_long <- adver_merged %>%
  dplyr::select(party, high_edu_share, blue_collar_share, agriculture_share, white_ratio, 
                asian_ratio, foreign_born_ratio, median_household_income_that_year) %>%
  pivot_longer(-party, names_to = "variable", values_to = "value")

# ç®±çº¿å›¾
ggplot(adver_long, aes(x = party, y = value, fill = party)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.1, outlier.shape = NA, alpha = 0.7) +
  facet_wrap(~ variable, scales = "free_y") +
  scale_fill_manual(
    values = c(
      "Democratic" = "#2E74C0",  # è“è‰²
      "Independent" = "lightgreen",
      "Republican" = "#CB454A" # çº¢è‰²
    )
  ) +
  theme_minimal() +
  labs(x = "Party", y = "Value",
       title = "District Demographic and Socioeconomic Differences by Party")


# ---- æ•™è‚²ç‡ vs è“é¢†æ¯”ä¾‹ -----
ggplot(adver_merged, aes(x = high_edu_share, y = blue_collar_share, color = party)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(
    values = c(
      "Democratic" = "#2E74C0",  # è“è‰²
      "Independent" = "lightgreen",
      "Republican" = "#CB454A" # çº¢è‰²
    )
  ) +
  theme_minimal() +
  labs(x = "High Education Share", y = "Blue Collar Share",
       title = "Relationship between Education and Occupation by Party")

```
