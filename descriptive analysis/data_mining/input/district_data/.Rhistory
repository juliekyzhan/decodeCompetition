#| label: install_libraries
#| echo: false
# 设置默认 CRAN 源，防止未指定镜像导致 install.packages 报错
options(repos = c(CRAN = "https://cloud.r-project.org"))
# 所需包列表
packages <- c("tidyverse", "janitor", "stringr")
# Install only if missing
for (pkg in packages) {
if (!require(pkg, character.only = TRUE)) {
install.packages(pkg)
}
}
# Load all packages
lapply(packages, library, character.only = TRUE)
#| label: load data function
#| echo: false
load_census_data <- function(file_path) {
# 提取年份
year <- str_extract(basename(file_path), "\\d{4}") %>% as.numeric()
# 计算国会届数（115th Congress 对应 2017）
congress <- 115 + floor((year - 2017) / 2)
# 读取 CSV 数据
df_raw <- read_csv(file_path, skip = 1, col_names = FALSE, show_col_types = FALSE)
# 提取第一行作为列名，并清理
new_names <- df_raw %>%
slice(1) %>%
unlist(use.names = FALSE) %>%
make_clean_names()
# 删除第一行，并重新命名列
df <- df_raw %>%
slice(-1) %>%
set_names(new_names)
# 删除包含 "margin_of_error" 的列
df <- df %>%
dplyr::select(-contains("margin_of_error"))
# 添加 congress 列
df <- df %>%
mutate(congress = congress)
return(df)
}
#| label: district name extraction
#| echo: false
extract_state_district_congress <- function(df, col = "geographic_area_name") {
# 州名与缩写映射表（50州 + DC）
state_map <- data.frame(
state_name = c(state.name, "District of Columbia"),
state_code = c(state.abb, "DC"),
stringsAsFactors = FALSE
)
df %>%
mutate(
# 提取州名（最后一个逗号后面的部分）
state_name = str_trim(str_extract(!!sym(col), "(?<=, ).*$")),
# 匹配州缩写
state_code = state_map$state_code[match(state_name, state_map$state_name)],
# 提取选区信息
district_raw = str_extract(!!sym(col), "Congressional District.*?(?=\\s*\\()"),
# 提取选区逻辑：
# 1. 若包含 "Senator" → 99
# 2. 若包含 "at Large" → "At Large"
# 3. 若包含数字 → 提取数字
# 4. 否则 NA
district = case_when(
str_detect(!!sym(col), "Senator") ~ "99",
str_detect(!!sym(col), "at Large") ~ "At Large",
str_detect(district_raw, "\\d+") ~ str_extract(district_raw, "\\d+"),
TRUE ~ NA_character_
)
) %>%
dplyr::select(-district_raw)
}
#| label: load_education_data
#| echo: false
education_2023 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-5-years/ACSDT5Y2023.B15003-Data.csv")
education_2021 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-5-years/ACSDT5Y2021.B15003-Data.csv")
education_2019 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-5-years/ACSDT5Y2019.B15003-Data.csv")
education_2017 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-5-years/ACSDT5Y2017.B15003-Data.csv")
# 合并四个数据库
education_all <- bind_rows(education_2017, education_2019, education_2021, education_2023)
#| label: load_income_data
#| echo: false
income_2023 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-5-years/ACSDT5Y2023.B19013-Data.csv")
income_2021 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-5-years/ACSDT5Y2021.B19013-Data.csv")
income_2019 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-5-years/ACSDT5Y2019.B19013-Data.csv")
income_2017 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-5-years/ACSDT5Y2017.B19013-Data.csv")
# 合并四个数据库
income_all <- bind_rows(income_2017, income_2019, income_2021, income_2023)
#| label: load_occupation_data
#| echo: false
occupation_2023 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-5-years/ACSDT5Y2023.C24010-Data.csv")
occupation_2021 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-5-years/ACSDT5Y2021.C24010-Data.csv")
occupation_2019 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-5-years/ACSDT5Y2019.C24010-Data.csv")
occupation_2017 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-5-years/ACSDT5Y2017.C24010-Data.csv")
# 合并四个数据库
occupation_all <- bind_rows(occupation_2017, occupation_2019, occupation_2021, occupation_2023)
#| label: load_immigration_data
#| echo: false
immigration_2023 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-5-years/ACSDT5Y2023.B05012-Data.csv")
immigration_2021 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-5-years/ACSDT5Y2021.B05012-Data.csv")
immigration_2019 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-5-years/ACSDT5Y2019.B05012-Data.csv")
immigration_2017 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-5-years/ACSDT5Y2017.B05012-Data.csv")
# 合并四个数据库
immigration_all <- bind_rows(immigration_2017, immigration_2019, immigration_2021, immigration_2023)
#| label: load_race_data
#| echo: false
race_2023 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-5-years/ACSDT5Y2023.B02001-Data.csv")
race_2021 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-5-years/ACSDT5Y2021.B02001-Data.csv")
race_2019 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-5-years/ACSDT5Y2019.B02001-Data.csv")
race_2017 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-5-years/ACSDT5Y2017.B02001-Data.csv")
# 合并四个数据库
race_all <- bind_rows(race_2017, race_2019, race_2021, race_2023)
#| label: clean education_district
#| echo: false
# ---- 提取州代码和选区 ----
education_all <- extract_state_district_congress(education_all, "geographic_area_name")
# ---- 批量转换所有 estimate_total_* 为纯数值 ----
education_all <- education_all %>%
mutate(across(starts_with("estimate_total_"), ~ as.numeric(gsub("[^0-9\\.]", "", as.character(.)))))
education_all <- education_all %>%
mutate(estimate_total = as.numeric(gsub("[^0-9\\.]", "", as.character(estimate_total))))
# ---- 计算高等教育比例 ----
education_all <- education_all %>%
mutate(
high_edu_total = rowSums(
cbind(
estimate_total_bachelors_degree,
estimate_total_masters_degree,
estimate_total_professional_school_degree,
estimate_total_doctorate_degree
),
na.rm = TRUE
),
high_edu_share = ifelse(estimate_total > 0, high_edu_total / estimate_total, NA_real_)
)
# ---- 4. 州级聚合（按 state_code + congress） ----
education_state <- education_all %>%
group_by(state_code, congress) %>%
summarise(
high_edu_total = sum(high_edu_total, na.rm = TRUE),
total_pop = sum(estimate_total, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
high_edu_share = ifelse(total_pop > 0, high_edu_total / total_pop, NA_real_),
district = "99"  # 表示州级
)
# ---- 5. 区级数据统一 district 类型 ----
education_all <- education_all %>%
mutate(district = as.character(district))
education_state <- education_state %>%
mutate(district = as.character(district))
# ---- 6. 合并区级和州级数据，并添加 level 标签 ----
education_all <- bind_rows(education_all, education_state) %>%
mutate(level = ifelse(district == "99", "state", "district")) %>%
arrange(state_code, congress, district)
#| label: clean income_district
#| echo: false
# ---- 提取州代码和选区 ----
income_all <- extract_state_district_congress(income_all, "geographic_area_name")
# ---- 2. 转换 income 列为数值并生成统一列 ----
income_all <- income_all %>%
mutate(
across(
contains("median_household_income"),
~ as.numeric(gsub("[^0-9\\.]", "", as.character(.)))
),
median_household_income_that_year = coalesce(
estimate_median_household_income_in_the_past_12_months_in_2023_inflation_adjusted_dollars,
estimate_median_household_income_in_the_past_12_months_in_2021_inflation_adjusted_dollars,
estimate_median_household_income_in_the_past_12_months_in_2019_inflation_adjusted_dollars,
estimate_median_household_income_in_the_past_12_months_in_2017_inflation_adjusted_dollars
)
)
# ---- 3. 州级汇总 ----
income_state <- income_all %>%
group_by(state_code, congress) %>%
summarise(
median_household_income_that_year = mean(median_household_income_that_year, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
district = "99",
level = "state"
)
# ---- 4. 区级标记 ----
income_all <- income_all %>%
mutate(level = "district")
# ---- 5. 合并区级和州级数据 ----
income_all <- bind_rows(income_all, income_state) %>%
arrange(state_code, congress, district)
#| label: clean income
#| echo: false
# ---- 提取州代码和选区 ----
occupation_all <- extract_state_district_congress(occupation_all, "geographic_area_name")
# 分类计算职业数量
occupation_all1 <- occupation_all %>%
mutate(
across(contains("estimate_total"), ~ as.numeric(gsub("[^0-9\\.]", "", .))),
white_collar = (
estimate_total_male_management_business_science_and_arts_occupations +
estimate_total_male_sales_and_office_occupations +
estimate_total_female_management_business_science_and_arts_occupations +
estimate_total_female_sales_and_office_occupations
),
blue_collar = (
estimate_total_male_production_transportation_and_material_moving_occupations +
estimate_total_male_natural_resources_construction_and_maintenance_occupations -
estimate_total_male_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations +
estimate_total_female_production_transportation_and_material_moving_occupations +
estimate_total_female_natural_resources_construction_and_maintenance_occupations -
estimate_total_female_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations
),
agriculture = (
estimate_total_male_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations +
estimate_total_female_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations
),
total_pop = estimate_total,
white_collar_share = white_collar / total_pop,
blue_collar_share = blue_collar / total_pop,
agriculture_share = agriculture / total_pop
)
occupation_all1 <- occupation_all1 %>%
dplyr::select(any_of(c("state_code", "congress", "district", "white_collar", "blue_collar", "agriculture", "total_pop", "white_collar_share", "blue_collar_share", "agriculture_share")))
#州级汇总
occupation_state <- occupation_all1 %>%
group_by(state_code, congress) %>%
summarise(
white_collar = sum(white_collar, na.rm = TRUE),
blue_collar = sum(blue_collar, na.rm = TRUE),
agriculture = sum(agriculture, na.rm = TRUE),
total_pop = sum(total_pop, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
white_collar_share = white_collar / total_pop,
blue_collar_share = blue_collar / total_pop,
agriculture_share = agriculture / total_pop,
district = "99"
)
#合并 & 添加层级
occupation_all1 <- bind_rows(occupation_all1, occupation_state) %>%
mutate(level = ifelse(district == "99", "state", "district")) %>%
arrange(state_code, congress, district)
#| label: clean immigration
#| echo: false
# ---- 提取州代码和选区 ----
immigration_all <- extract_state_district_congress(immigration_all, "geographic_area_name")
# 清理数字列并计算比例
immigration_all <- immigration_all %>%
mutate(across(contains("estimate_total"), ~ as.numeric(gsub("[^0-9\\.]", "", as.character(.)))),
foreign_born_ratio = ifelse(estimate_total > 0, estimate_total_foreign_born / estimate_total, NA_real_))
# 州级聚合（按 state_code + congress）
immigration_state <- immigration_all %>%
filter(!is.na(state_code)) %>%  # 保证州代码存在
group_by(state_code, congress) %>%
summarise(
foreign_born = sum(estimate_total_foreign_born, na.rm = TRUE),
total_pop = sum(estimate_total, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
foreign_born_ratio = ifelse(total_pop > 0, foreign_born / total_pop, NA_real_),
district = "99"
)
# 合并区级 + 州级数据
immigration_all <- bind_rows(
immigration_all %>% mutate(district = as.character(district)),
immigration_state %>% mutate(district = as.character(district))
) %>%
mutate(level = ifelse(district == "99", "state", "district")) %>%
arrange(state_code, congress, district)
#| label: clean race
#| echo: false
# ---- 提取州代码和选区 ----
race_all <- extract_state_district_congress(race_all, "geographic_area_name")
# 清理数字列并计算比例（加除零保护）
race_all <- race_all %>%
mutate(across(contains("estimate_total"), ~ as.numeric(gsub("[^0-9\\.]", "", as.character(.)))),
white_ratio = ifelse(estimate_total > 0, estimate_total_white_alone / estimate_total, NA_real_),
black_or_african_american_ratio = ifelse(estimate_total > 0, estimate_total_black_or_african_american_alone / estimate_total, NA_real_),
asian_ratio = ifelse(estimate_total > 0, estimate_total_asian_alone / estimate_total, NA_real_),
american_indian_and_alaska_native_ratio = ifelse(estimate_total > 0, estimate_total_american_indian_and_alaska_native_alone / estimate_total, NA_real_),
native_hawaiian_and_other_pacific_islander_ratio = ifelse(estimate_total > 0, estimate_total_native_hawaiian_and_other_pacific_islander_alone / estimate_total, NA_real_))
# 州级聚合（按 state_code + congress）
race_state <- race_all %>%
filter(!is.na(state_code)) %>%
group_by(state_code, congress) %>%
summarise(
estimate_total_white_alone = sum(estimate_total_white_alone, na.rm = TRUE),
estimate_total_black_or_african_american_alone = sum(estimate_total_black_or_african_american_alone, na.rm = TRUE),
estimate_total_asian_alone = sum(estimate_total_asian_alone, na.rm = TRUE),
estimate_total_american_indian_and_alaska_native_alone = sum(estimate_total_american_indian_and_alaska_native_alone, na.rm = TRUE),
estimate_total_native_hawaiian_and_other_pacific_islander_alone = sum(estimate_total_native_hawaiian_and_other_pacific_islander_alone, na.rm = TRUE),
estimate_total = sum(estimate_total, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
white_ratio = ifelse(estimate_total > 0, estimate_total_white_alone / estimate_total, NA_real_),
black_or_african_american_ratio = ifelse(estimate_total > 0, estimate_total_black_or_african_american_alone / estimate_total, NA_real_),
asian_ratio = ifelse(estimate_total > 0, estimate_total_asian_alone / estimate_total, NA_real_),
american_indian_and_alaska_native_ratio = ifelse(estimate_total > 0, estimate_total_american_indian_and_alaska_native_alone / estimate_total, NA_real_),
native_hawaiian_and_other_pacific_islander_ratio = ifelse(estimate_total > 0, estimate_total_native_hawaiian_and_other_pacific_islander_alone / estimate_total, NA_real_),
district = "99"
)
# 合并区级 + 州级数据
race_all <- bind_rows(
race_all %>% mutate(district = as.character(district)),
race_state %>% mutate(district = as.character(district))
) %>%
mutate(level = ifelse(district == "99", "state", "district")) %>%
arrange(state_code, congress, district)
#| label: aggregation
#| echo: false
district_data <- list(
education_all %>% dplyr::select(congress, state_code, district, high_edu_share),
immigration_all %>% dplyr::select(congress, state_code, district, foreign_born_ratio),
race_all %>% dplyr::select(congress, state_code, district, white_ratio, black_or_african_american_ratio, asian_ratio, american_indian_and_alaska_native_ratio, native_hawaiian_and_other_pacific_islander_ratio),
occupation_all1 %>% dplyr::select(congress, state_code, district, white_collar_share, blue_collar_share, agriculture_share),
income_all %>% dplyr::select(congress, state_code, district, median_household_income_that_year)
)
district_data <- reduce(district_data, full_join, by = c("congress", "state_code", "district"))
write_csv(district_data,"district_data.csv")
