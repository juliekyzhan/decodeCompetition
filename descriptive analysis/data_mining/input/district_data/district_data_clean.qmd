---
title: "district data clean"
author: "Kunya Zhan"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  html:
   toc: true
   toc-depth: 3
   number-sections: true
   code-fold: true
   code-summary: "Show/Hide Code"
   smooth-scroll: true
   df-print: paged
   code-tools: true
   highlight-style: atom-one
   toc-location: left
editor: visual
---

## District data clean

This document clean district data from census, and preparing a cleaned data for descriptive analysis of decodeCompetition project.

## load package

```{r}
#| label: install_libraries
#| echo: false
# 设置默认 CRAN 源，防止未指定镜像导致 install.packages 报错
options(repos = c(CRAN = "https://cloud.r-project.org"))

# 所需包列表
packages <- c("tidyverse", "janitor", "stringr")

# Install only if missing
for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
  }
}

# Load all packages
lapply(packages, library, character.only = TRUE)
```

## load data

```{r}
#| label: load data function
#| echo: false

load_census_data <- function(file_path) {
  # ---- 1️⃣ 提取年份 ----
  year <- str_extract(basename(file_path), "\\d{4}") %>% as.numeric()
  
  # ---- 2️⃣ 计算国会届数 ----
  congress <- case_when(
    year %in% c(2017, 2018) ~ 115,
    year == 2019 ~ 116,
    year %in% c(2021, 2022) ~ 117,
    year %in% c(2023, 2024) ~ 118,
    TRUE ~ NA_integer_
  )
  
  # ---- 3️⃣ 读取原始数据 ----
  df_raw <- read_csv(file_path, skip = 1, col_names = FALSE, show_col_types = FALSE)
  
  # ---- 4️⃣ 提取第一行为列名并清理 ----
  new_names <- df_raw %>%
    slice(1) %>%
    unlist(use.names = FALSE) %>%
    make_clean_names()
  
  # ---- 5️⃣ 删除第一行并命名列 ----
  df <- df_raw %>%
    slice(-1) %>%
    set_names(new_names)
  
  # ---- 6️⃣ 删除 margin_of_error 相关列 ----
  df <- df %>%
    dplyr::select(-contains("margin_of_error"))
  
  # ---- 7️⃣ 保留地理标识列（不转数值） ----
  geo_cols <- c("id", "geo_id", "name", "geographic_area_name", "state", "state_code", "district")
  
  df <- df %>%
    mutate(across(
      .cols = setdiff(names(df), geo_cols),
      .fns = ~ suppressWarnings(as.numeric(.x))
    ))
  
  # ---- 8️⃣ 添加 Congress 信息 ----
  df <- df %>%
    mutate(congress = congress)
  
  # ---- 9️⃣ 清理空白行 ----
  df <- df %>%
    filter(if_any(everything(), ~ !is.na(.)))
  
  return(df)
}


combine_census_by_congress <- function(dfs) {
  dfs %>%
    bind_rows() %>%
    # --- 先提取标准化的 state_code 和 district ---
    extract_state_district_congress("geographic_area_name") %>%
    # --- 按届数 + 州 + 选区平均 ---
    group_by(congress, state_code, district) %>%
    summarise(across(where(is.numeric), mean, na.rm = TRUE), .groups = "drop")
}

```

```{r}
#| label: district name extraction
#| echo: false

extract_state_district_congress <- function(df, col = "geographic_area_name") {
  
  # 州名与缩写映射表（50州 + DC）
  state_map <- data.frame(
    state_name = c(state.name, "District of Columbia"),
    state_code = c(state.abb, "DC"),
    stringsAsFactors = FALSE
  )
  
  df %>%
    mutate(
      # 提取州名（最后一个逗号后面的部分）
      state_name = str_trim(str_extract(!!sym(col), "(?<=, ).*$")),
      
      # 匹配州缩写
      state_code = state_map$state_code[match(state_name, state_map$state_name)],
      
      # 提取选区信息
      district_raw = str_extract(!!sym(col), "Congressional District.*?(?=\\s*\\()"),
      
      # 提取选区逻辑：
      # 1. 若包含 "Senator" → 99
      # 2. 若包含 "at Large" → "At Large"
      # 3. 若包含数字 → 提取数字
      # 4. 否则 NA
      district = case_when(
        str_detect(!!sym(col), "Senator") ~ "99",
        str_detect(!!sym(col), "at Large") ~ "At Large",
        str_detect(district_raw, "\\d+") ~ str_extract(district_raw, "\\d+"),
        TRUE ~ NA_character_
      )
    ) %>%
    dplyr::select(-district_raw)
}

```

input age

```{r}
#| label: load_age_data
#| echo: false

age_2023 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/age/ACSDT1Y2023.B01001-Data.csv")
age_2021 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/age/ACSDT1Y2021.B01001-Data.csv")
age_2019 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/age/ACSDT1Y2019.B01001-Data.csv")
age_2017 <- load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/age/ACSDT1Y2017.B01001-Data.csv")

# 合并四个数据库
age_all <- bind_rows(age_2017, age_2019, age_2021, age_2023)
```

```{r}
#| label: load_education_data
#| echo: false


education_all <- combine_census_by_congress(list(
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-multiple-years/ACSDT1Y2017.B15003-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-multiple-years/ACSDT1Y2018.B15003-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-multiple-years/ACSDT1Y2019.B15003-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-multiple-years/ACSDT1Y2021.B15003-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-multiple-years/ACSDT1Y2022.B15003-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-multiple-years/ACSDT1Y2023.B15003-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/education-multiple-years/ACSDT1Y2024.B15003-Data.csv")
))
```

```{r}
#| label: load_income_data
#| echo: false

income_all <- combine_census_by_congress(list(
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-multiple-years/ACSDT1Y2017.B19013-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-multiple-years/ACSDT1Y2018.B19013-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-multiple-years/ACSDT1Y2019.B19013-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-multiple-years/ACSDT1Y2021.B19013-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-multiple-years/ACSDT1Y2022.B19013-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-multiple-years/ACSDT1Y2023.B19013-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/household_income-multiple-years/ACSDT1Y2024.B19013-Data.csv")
))

```

```{r}
#| label: load_occupation_data
#| echo: false

occupation_all <- combine_census_by_congress(list(
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-multiple-years/ACSDT1Y2017.C24010-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-multiple-years/ACSDT1Y2018.C24010-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-multiple-years/ACSDT1Y2019.C24010-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-multiple-years/ACSDT1Y2021.C24010-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-multiple-years/ACSDT1Y2022.C24010-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-multiple-years/ACSDT1Y2023.C24010-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/occupation-multiple-years/ACSDT1Y2024.C24010-Data.csv")
))

```

```{r}
#| label: load_immigration_data
#| echo: false

immigration_all <- combine_census_by_congress(list(
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-multiple-years/ACSDT1Y2017.B05012-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-multiple-years/ACSDT1Y2018.B05012-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-multiple-years/ACSDT1Y2019.B05012-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-multiple-years/ACSDT1Y2021.B05012-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-multiple-years/ACSDT1Y2022.B05012-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-multiple-years/ACSDT1Y2023.B05012-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/immigration-multiple-years/ACSDT1Y2024.B05012-Data.csv")
))

```

```{r}
#| label: load_race_data
#| echo: false


race_all <- combine_census_by_congress(list(
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-multiple-years/ACSDT1Y2017.B02001-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-multiple-years/ACSDT1Y2018.B02001-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-multiple-years/ACSDT1Y2019.B02001-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-multiple-years/ACSDT1Y2021.B02001-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-multiple-years/ACSDT1Y2022.B02001-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-multiple-years/ACSDT1Y2023.B02001-Data.csv"),
  load_census_data("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/input/district_data/race-multiple-years/ACSDT1Y2024.B02001-Data.csv")
))

```

## clean age

```{r}
#| label: clean age
#| echo: false

# ---- 将“Estimate!!Total!!Male!!X years”与“Estimate!!Total!!Female!!X years”汇总 ----
# 首先提取所有年龄段的列名（排除总数列）
age_vars <- names(age_all) %>%
  str_subset("^estimate_total_(male|female)_") %>%  # 匹配男性或女性的年龄段列
  discard(~ str_detect(.x, "total$"))               # 去掉总计列（如 estimate_total_male）

length(age_vars)

# 整理成长表格形式，方便聚合
age_long <- age_all %>%
  pivot_longer(
    cols = all_of(age_vars),
    names_to = "group",
    values_to = "population"
  ) %>%
  mutate(
    age_group = str_remove(group, "^estimate_total_(male|female)_"),
    sex = case_when(
      str_detect(group, "male") ~ "male",
      str_detect(group, "female") ~ "female"
    )
  ) %>%
  group_by(geography, geographic_area_name, congress, age_group) %>%
  summarise(total_population = sum(as.numeric(population), na.rm = TRUE), .groups = "drop")

# 回到宽格式
age_wide <- age_long %>%
  pivot_wider(names_from = age_group, values_from = total_population)

# 最终输出
glimpse(age_wide)


# ---- 提取州代码和选区 ----
age_wide <- extract_state_district_congress(age_wide, "geographic_area_name")
```

## clean education

```{r}
#| label: clean education_district
#| echo: false

# ---- 1. 将所有 estimate_total_* 列转换为数值 ----
education_all <- education_all %>%
  mutate(across(starts_with("estimate_total_"),
                ~ as.numeric(gsub("[^0-9eE\\.-]", "", as.character(.)))))

# ---- 2. 计算高等教育总数和比例 ----
education_all <- education_all %>%
  mutate(
    high_edu_total = ifelse(
      rowSums(!is.na(cbind(estimate_total_bachelors_degree,
                            estimate_total_masters_degree,
                            estimate_total_professional_school_degree,
                            estimate_total_doctorate_degree))) > 0,
      rowSums(cbind(estimate_total_bachelors_degree,
                    estimate_total_masters_degree,
                    estimate_total_professional_school_degree,
                    estimate_total_doctorate_degree), na.rm = TRUE),
      NA_real_
    ),
    high_edu_share = ifelse(estimate_total > 0, high_edu_total / estimate_total, NA_real_)
  )

# ---- 3. 州级聚合（按 state_code + congress） ----
education_state <- education_all %>%
  group_by(state_code, congress) %>%
  summarise(
    high_edu_total = sum(estimate_total_bachelors_degree + 
                         estimate_total_masters_degree + 
                         estimate_total_professional_school_degree + 
                         estimate_total_doctorate_degree, na.rm = TRUE),
    total_pop = sum(estimate_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    high_edu_share = ifelse(total_pop > 0, high_edu_total / total_pop, NA_real_),
    district = "99"  # 表示州级
  )

# ---- 4. 确保 district 列为字符类型，并填充 NA ----
education_all <- education_all %>%
  mutate(district = as.character(district),
         district = ifelse(is.na(district), "NA", district))

education_state <- education_state %>%
  mutate(district = as.character(district))

# ---- 5. 合并区级和州级数据，添加 level 标签 ----
education_all <- bind_rows(education_all, education_state) %>%
  mutate(level = ifelse(district == "99", "state", "district")) %>%
  arrange(state_code, congress, district)
```

## clean income

```{r}
#| label: clean income_district
#| echo: false

# ---- 1. 将所有 income 列转换为数值 ----
income_all <- income_all %>%
  mutate(across(
    contains("median_household_income"),
    ~ as.numeric(gsub("[^0-9eE\\.-]", "", as.character(.)))
  ))

# ---- 2. 生成统一的 median_household_income_that_year 列 ----
income_all <- income_all %>%
  mutate(median_household_income_that_year = coalesce(
    estimate_median_household_income_in_the_past_12_months_in_2023_inflation_adjusted_dollars,
    estimate_median_household_income_in_the_past_12_months_in_2021_inflation_adjusted_dollars,
    estimate_median_household_income_in_the_past_12_months_in_2019_inflation_adjusted_dollars,
    estimate_median_household_income_in_the_past_12_months_in_2017_inflation_adjusted_dollars
  ))

# ---- 3. 州级汇总（按 state_code + congress） ----
income_state <- income_all %>%
  group_by(state_code, congress) %>%
  summarise(
    median_household_income_that_year = mean(median_household_income_that_year, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    district = "99",   # 表示州级
    level = "state"
  )

# ---- 4. 区级标记 ----
income_all <- income_all %>%
  mutate(
    district = as.character(district),
    district = ifelse(is.na(district), "NA", district),
    level = "district"
  )

# ---- 5. 合并区级和州级数据 ----
income_all <- bind_rows(income_all, income_state) %>%
  arrange(state_code, congress, district)

```

## clean occupation

```{r}
#| label: clean income
#| echo: false

names(occupation_all)

# ---- 1. 转换数值列 ----
occupation_all1 <- occupation_all %>%
  mutate(
    across(contains("estimate_total"), ~ as.numeric(gsub("[^0-9\\.]", "", .)))
  )

# ---- 2. 累加白领 ----
occupation_all1 <- occupation_all1 %>%
  mutate(
    white_collar = estimate_total_male_management_business_science_and_arts_occupations +
                   estimate_total_female_management_business_science_and_arts_occupations +
                   estimate_total_male_sales_and_office_occupations +
                   estimate_total_female_sales_and_office_occupations
  )

# ---- 3. 累加蓝领 ----
occupation_all1 <- occupation_all1 %>%
  mutate(
    blue_collar = estimate_total_male_production_transportation_and_material_moving_occupations +
                  estimate_total_female_production_transportation_and_material_moving_occupations +
                  estimate_total_male_natural_resources_construction_and_maintenance_occupations -
                    estimate_total_male_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations +
                  estimate_total_female_natural_resources_construction_and_maintenance_occupations -
                    estimate_total_female_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations
  )

# ---- 4. 累加农业 ----
occupation_all1 <- occupation_all1 %>%
  mutate(
    agriculture = estimate_total_male_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations +
                  estimate_total_female_natural_resources_construction_and_maintenance_occupations_farming_fishing_and_forestry_occupations
  )

# ---- 5. 计算比例 ----
occupation_all1 <- occupation_all1 %>%
  mutate(
    total_pop = estimate_total,
    white_collar_share = white_collar / total_pop,
    blue_collar_share  = blue_collar / total_pop,
    agriculture_share  = agriculture / total_pop
  )

# ---- 6. 选择需要的列 ----
occupation_all1 <- occupation_all1 %>%
  dplyr::select(any_of(c("state_code", "congress", "district",
                         "white_collar", "blue_collar", "agriculture",
                         "total_pop", "white_collar_share", "blue_collar_share", "agriculture_share")))
  
# ---- 7. 州级汇总 ----
occupation_state <- occupation_all1 %>%
  group_by(state_code, congress) %>%
  summarise(
    white_collar = sum(white_collar, na.rm = TRUE),
    blue_collar  = sum(blue_collar, na.rm = TRUE),
    agriculture  = sum(agriculture, na.rm = TRUE),
    total_pop    = sum(total_pop, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    white_collar_share = white_collar / total_pop,
    blue_collar_share  = blue_collar / total_pop,
    agriculture_share  = agriculture / total_pop,
    district = "99"
  )

# ---- 8. 合并区级和州级数据并添加层级标签 ----
occupation_all1 <- bind_rows(occupation_all1, occupation_state) %>%
  mutate(level = ifelse(district == "99", "state", "district")) %>%
  arrange(state_code, congress, district)

```

## clean immigration

```{r}
#| label: clean immigration
#| echo: false


# ---- 1. 清理数字列并计算区级比例 ----
immigration_all <- immigration_all %>%
  mutate(
    across(contains("estimate_total"), ~ as.numeric(gsub("[^0-9\\.]", "", as.character(.)))),
    foreign_born_ratio = ifelse(estimate_total > 0, estimate_total_foreign_born / estimate_total, NA_real_),
    district = as.character(district)  # 确保 district 为字符型
  )

# ---- 2. 州级聚合（按 state_code + congress） ----
immigration_state <- immigration_all %>%
  filter(!is.na(state_code)) %>%  # 保证州代码存在
  group_by(state_code, congress) %>%
  summarise(
    foreign_born = sum(estimate_total_foreign_born, na.rm = TRUE),
    total_pop = sum(estimate_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    foreign_born_ratio = ifelse(total_pop > 0, foreign_born / total_pop, NA_real_),
    district = "99",       # 标记州级
    level = "state"
  )

# ---- 3. 区级标记 ----
immigration_all <- immigration_all %>%
  mutate(level = "district")

# ---- 4. 合并区级和州级数据 ----
immigration_all <- bind_rows(immigration_all, immigration_state) %>%
  arrange(state_code, congress, district)
```

## clean race

```{r}
#| label: clean race
#| echo: false

# ---- 1. 清理数字列并计算区级比例 ----
race_all <- race_all %>%
  mutate(
    across(contains("estimate_total"), ~ as.numeric(gsub("[^0-9\\.]", "", as.character(.)))),
    white_ratio = ifelse(estimate_total > 0, estimate_total_white_alone / estimate_total, NA_real_),
    black_or_african_american_ratio = ifelse(estimate_total > 0, estimate_total_black_or_african_american_alone / estimate_total, NA_real_),
    asian_ratio = ifelse(estimate_total > 0, estimate_total_asian_alone / estimate_total, NA_real_),
    american_indian_and_alaska_native_ratio = ifelse(estimate_total > 0, estimate_total_american_indian_and_alaska_native_alone / estimate_total, NA_real_),
    native_hawaiian_and_other_pacific_islander_ratio = ifelse(estimate_total > 0, estimate_total_native_hawaiian_and_other_pacific_islander_alone / estimate_total, NA_real_),
    district = as.character(district)  # 确保 district 为字符型
  )

# ---- 2. 州级聚合（按 state_code + congress） ----
race_state <- race_all %>%
  filter(!is.na(state_code)) %>%
  group_by(state_code, congress) %>%
  summarise(
    estimate_total_white_alone = sum(estimate_total_white_alone, na.rm = TRUE),
    estimate_total_black_or_african_american_alone = sum(estimate_total_black_or_african_american_alone, na.rm = TRUE),
    estimate_total_asian_alone = sum(estimate_total_asian_alone, na.rm = TRUE),
    estimate_total_american_indian_and_alaska_native_alone = sum(estimate_total_american_indian_and_alaska_native_alone, na.rm = TRUE),
    estimate_total_native_hawaiian_and_other_pacific_islander_alone = sum(estimate_total_native_hawaiian_and_other_pacific_islander_alone, na.rm = TRUE),
    estimate_total = sum(estimate_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    white_ratio = ifelse(estimate_total > 0, estimate_total_white_alone / estimate_total, NA_real_),
    black_or_african_american_ratio = ifelse(estimate_total > 0, estimate_total_black_or_african_american_alone / estimate_total, NA_real_),
    asian_ratio = ifelse(estimate_total > 0, estimate_total_asian_alone / estimate_total, NA_real_),
    american_indian_and_alaska_native_ratio = ifelse(estimate_total > 0, estimate_total_american_indian_and_alaska_native_alone / estimate_total, NA_real_),
    native_hawaiian_and_other_pacific_islander_ratio = ifelse(estimate_total > 0, estimate_total_native_hawaiian_and_other_pacific_islander_alone / estimate_total, NA_real_),
    district = "99",   # 标记州级
    level = "state"
  )

# ---- 3. 区级标记 ----
race_all <- race_all %>%
  mutate(level = "district")

# ---- 4. 合并区级 + 州级数据 ----
race_all <- bind_rows(race_all, race_state) %>%
  arrange(state_code, congress, district)
```

## Aggregation

```{r}
#| label: aggregation
#| echo: false

# 确保 key 列都是字符型
district_data <- list(
  education_all %>% mutate(district = as.character(district), state_code = as.character(state_code)) %>% dplyr::select(congress, state_code, district, high_edu_share),
  immigration_all %>% mutate(district = as.character(district), state_code = as.character(state_code)) %>% dplyr::select(congress, state_code, district, foreign_born_ratio),
  race_all %>% mutate(district = as.character(district), state_code = as.character(state_code)) %>% dplyr::select(congress, state_code, district, white_ratio, black_or_african_american_ratio, asian_ratio, american_indian_and_alaska_native_ratio, native_hawaiian_and_other_pacific_islander_ratio),
  occupation_all1 %>% mutate(district = as.character(district), state_code = as.character(state_code)) %>% dplyr::select(congress, state_code, district, white_collar_share, blue_collar_share, agriculture_share),
  income_all %>% mutate(district = as.character(district), state_code = as.character(state_code)) %>% dplyr::select(congress, state_code, district, median_household_income_that_year)
)

district_data <- reduce(district_data, full_join, by = c("congress", "state_code", "district")) %>%
  arrange(state_code, congress, district)

write_csv(district_data, "district_data.csv")
```
