---
title: "descriptive_analysis_1112"
author: "Kunya Zhan"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  html:
   toc: true
   toc-depth: 3
   number-sections: true
   code-fold: true
   code-summary: "Show/Hide Code"
   smooth-scroll: true
   df-print: paged
   code-tools: true
   highlight-style: atom-one
   toc-location: left
editor: visual
---

# Descriptive Analysis Party Focus

This Quarto document reorganizes the analyses from *data_mining_1111.qmd*, with a specific focus on party-level differences in legislator's legislative behavioral patterns. It consists two main sections:

1.  **Descriptive analysis**: concise the overview of the original *decodeCompetition dataset*, emphasizing cross-party contrasts in key indicators;
2.  **Model-based analysis**: identifies the main characteristic shaping these patterns through regression and logistic models, highlighting how party affiliation conditions their effects.set up

```{r}
#| label: setup
#| include: false

# Create an output directory if it doesn't exist
output_dir <- "output"
if (!dir.exists(output_dir)) dir.create(output_dir)

# Default chunk options
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = file.path(output_dir, ""),   # figures from chunks
  cache.path = file.path(output_dir, "cache/")
)

# A helper function to save plots/data consistently
save_to_output <- function(filename, plot = NULL, data = NULL, ...) {
  full_path <- file.path(output_dir, filename)
  dir.create(dirname(full_path), recursive = TRUE, showWarnings = FALSE)
  
  if (!is.null(plot)) {
    ggplot2::ggsave(filename = full_path, plot = plot, ...)
    message("✅ Saved plot to: ", full_path)
  } else if (!is.null(data)) {
    write.csv(data, full_path, row.names = FALSE, ...)
    message("✅ Saved data to: ", full_path)
  } else {
    message("⚠️ No plot or data provided. Returning path only: ", full_path)
  }
  
  return(full_path)
}
```

## Packages Install

```{r}
#| label: install_libraries
#| echo: false
#| message: false
#| warning: false

# 设置默认 CRAN 源，防止未指定镜像导致 install.packages 报错
options(repos = c(CRAN = "https://cloud.r-project.org"))

# 所需包列表
packages <- c(
  "Rcpp", "dplyr", "stringr", "readr", "ggplot2", "tidyr", "readxl", "scales", 
  "showtext", "sysfonts", "skimr", "plm", "car", "glmnet", 
  "Rtsne", "networkD3", "cluster", "factoextra", "pROC", "lme4", 
  "MuMIn", "nnet", "DHARMa", "tigris", "ggeffects", "stargazer",
  "htmltools", "tidyverse", "ggcorrplot", "purrr", "broom.mixed", 
  "performance", "lattice", "fmsb", "kableExtra", "broom", 
  "knitr", "ggnewscale", "modelsummary", "pscl", "ggfortify", 
  "rlang", "patchwork", "segmented", "tidytext", "mgcv", "splines", 
  "interactions", "RColorBrewer", "cowplot", "ggbreak", "randomcoloR",
  "marginaleffects", "ggrepel", "grid", "lme4"
)

# Install only if missing
for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
  }
}

# Load all packages
lapply(packages, library, character.only = TRUE)
```

# 1. Data cleansing

## 1.1 data acquisition

```{r}
#| label: load_data
#| echo: false
#| message: false
#| warning: false

# ----- main databases -----
# train data
legis_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/legis_analysis_all.xlsx"
legis_all <- read_excel(legis_path)

# lightgbm original result 
legis_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/1022data/legis_train_data.csv")
legis_data <- legis_data %>%
  mutate(issue = str_to_title(issue)) # clean issue format

# lightgbm cleaned result
# cleaning methods on "data_mining_1111.qmd"
legis_sum1 <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/ds_input/legis_sum1.csv")


# ----- supplementary databases -----
# legislator identity data
bioguide_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/members_district_1103.xlsx"
bioguide <- read_excel(bioguide_path)

# original news data
news_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/115_118_news_data_new1.csv"
news_data <- read_csv(news_data_path)

# original legislative data
bills_data_path <- "/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/115-118_congress_data_new.csv"
bills_data <- read_csv(bills_data_path)

# district data
district_data <- read_csv("/Users/kunyazhan/Documents/GitHub/decodeCompetition/descriptive analysis/data_mining/input/district_data/district_data.csv")
```

## 1.2 matching variables and special patch

```{r}
#| label: matching variables 
#| echo: false

# ------ matching variables map ------
match_vars <- c(
  "leverage_pl", "leverage_ne", "committee_pl", "committee_ne",
  "employ_industry_pl", "employ_industry_ne",
  "payroll_industry_pl", "payroll_industry_ne",
  "ethnicity_pl", "ethnicity_ne",
  "party_value_pl", "party_value_ne",
  "party_score_pl", "party_score_ne"
)

# ------ Add raw columns ------
legis_data_raw <- legis_data %>%
  rename_with(.cols = all_of(match_vars), .fn = ~ paste0(.x, "_raw"))
legis_all <- legis_all %>%
  left_join(
    legis_data_raw %>% dplyr::select(full_name, issue, congress, ends_with("_raw")),
    by = c("full_name", "issue", "congress")
  )

# ------ Sanity check ------
stopifnot(all(paste0(match_vars, "_raw") %in% names(legis_all)))
```

### special clean: independents aggregate into R/D

```{r}
#| label: aggregate_independents
#| echo: false

independents <- legis_sum1 %>%
  filter(party == "Independent")
independents <- legis_all %>%
  filter(party == "Independent")


unique(independents$full_name)

# change their party affiliation according their caucus belongings
legis_sum1 <- legis_sum1 %>%
  mutate(
    party = case_when(
      full_name == "Rep. Amash, Justin [R-MI-3]" ~ "Republican",
      full_name == "Rep. Mitchell, Paul [R-MI-10]" ~ "Republican",
      full_name == "Sen. King, Angus S., Jr. [I-ME]" ~ "Democratic",
      full_name == "Sen. Sanders, Bernard [I-VT]" ~ "Democratic",
      full_name == "Sen. Sinema, Kyrsten [I-AZ]" ~ "Democratic",
      TRUE ~ party  
    )
  )
legis_all <- legis_all %>%
  mutate(
    party = case_when(
      full_name == "Rep. Amash, Justin [R-MI-3]" ~ "Republican",
      full_name == "Rep. Mitchell, Paul [R-MI-10]" ~ "Republican",
      full_name == "Sen. King, Angus S., Jr. [I-ME]" ~ "Democratic",
      full_name == "Sen. Sanders, Bernard [I-VT]" ~ "Democratic",
      full_name == "Sen. Sinema, Kyrsten [I-AZ]" ~ "Democratic",
      TRUE ~ party  
    )
  )
```

## 1.3 individual level aggregation

generate function: generate_decision_with_traits()

> This function aggregates prediction and importance metrics for each legislator across different datasets, such as train, test,or merged. It computes the relative importance of 3 behavioral modes - intl, dom, and prof, and assigns each legislator a dominant decision category based on their most prominent behavior. It finally merges these aggregated results with demographic and institutional traits like gender, party, and ideology.

```{r}
#| label: generate-decision-with-traits
#| echo: false
# ---- Function: generate_decision_with_traits ----
generate_decision_with_traits <- function(df, mode = "all") {
  # parameter validation
  if (!mode %in% c("all", "train", "test", "merged")) {
    stop("mode must be 'all', 'train', 'test', or 'merged'")
  }

  # ---- step 1: data filtering ----
  df_subset <- if (mode %in% c("all", "merged")) df else df %>% filter(dataset == mode)

  # ---- step 2: data aggregation ----
  group_vars <- if (mode == "merged") {
    c("full_name", "congress")
  } else {
    c("full_name", "congress", "dataset")
  }

  df_clean <- df_subset %>%
    group_by(across(all_of(group_vars))) %>%
    summarise(
      importance_intl = sum(importance_intl, na.rm = TRUE),
      importance_dom  = sum(importance_dom,  na.rm = TRUE),
      importance_prof = sum(importance_prof, na.rm = TRUE),
      importance_all  = sum(importance_all,  na.rm = TRUE),
      pred = mean(pred, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      intl_percentage = ifelse(importance_all > 0, importance_intl / importance_all, NA_real_),
      dom_percentage  = ifelse(importance_all > 0, importance_dom  / importance_all, NA_real_),
      prof_percentage = ifelse(importance_all > 0, importance_prof / importance_all, NA_real_),
      max_val = pmax(intl_percentage, dom_percentage, prof_percentage, na.rm = TRUE),
      decision = case_when(
        is.na(max_val) ~ NA_character_,
        intl_percentage == max_val & dom_percentage != max_val & prof_percentage != max_val ~ "intl",
        dom_percentage  == max_val & intl_percentage != max_val & prof_percentage != max_val ~ "dom",
        prof_percentage == max_val & intl_percentage != max_val & dom_percentage != max_val ~ "prof",
        TRUE ~ "tie"
      )
    ) %>%
    dplyr::select(-max_val, -importance_all)

  # ---- step3: trait merging ----
  traits <- df %>%
    dplyr::select(full_name, congress, dataset, party, chamber, committee_el,
           gender, age, seniority, ideology, district, state_code, bioguide_id) %>%
    distinct()

  if (mode == "merged") {
    traits <- traits %>%
      group_by(full_name, congress) %>%
      summarise(
        party = first(party),
        chamber = first(chamber),
        committee_el = first(na.omit(committee_el)),
        gender = first(gender),
        age = mean(age, na.rm = TRUE),
        seniority = mean(seniority, na.rm = TRUE),
        ideology = mean(ideology, na.rm = TRUE),
        district = first(district),
        state_code = first(state_code),
        bioguide_id = first(bioguide_id),
        .groups = "drop"
      )

    df_final <- df_clean %>%
      left_join(traits, by = c("full_name", "congress"))
  } else {
    df_final <- df_clean %>%
      left_join(traits, by = c("full_name", "congress", "dataset"))
  }

  # ---- step 4: join and label formatting ----
  df_final <- df_final %>%
    mutate(gender = factor(gender, levels = c(0, 1), labels = c("Female", "Male")))

  return(df_final)
}

# ---- application ----
#df_train <- generate_decision_with_traits_dual(df, mode = "train")
#df_test <- generate_decision_with_traits_dual(df, mode = "test")

# legis
legis_cg <- generate_decision_with_traits(legis_sum1, mode = "merged")
legis_cg <- legis_cg %>%
  filter(!full_name == "NA")
```

## 2.2 topic level aggregation

generate function: generate_decision_with_issue()

> This function processes legislative data to summarize each legislator's issue-level decision pattern (international, domestic, or professional). It groups the data by legislator, Congress session, and issue, aggregates importance scores, and calculates the dominant decision type for each group.

```{r}
#| label: generate decision with issues
#| echo: false

generate_decision_with_issues_issue_level <- function(df, set_name = "all") {
  # Step 1: Optional filter by dataset (train/test)
  if (set_name %in% c("train", "test")) {
    df <- df %>% filter(dataset == set_name)
  }

  # Step 2: Group by issue and congress level
  df_issue <- df %>%
    group_by(issue, congress) %>%
    summarise(
      label = sum(label, na.rm = TRUE),       # total number of decisions
      pred  = mean(pred, na.rm = TRUE),       # average predicted probability if applicable
      importance_intl = sum(importance_intl, na.rm = TRUE),
      importance_dom  = sum(importance_dom, na.rm = TRUE),
      importance_prof = sum(importance_prof, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    # Step 3: Compute percentages
    mutate(
      total = importance_intl + importance_dom + importance_prof,
      intl_percentage = ifelse(total > 0, importance_intl / total, NA_real_),
      dom_percentage  = ifelse(total > 0, importance_dom  / total, NA_real_),
      prof_percentage = ifelse(total > 0, importance_prof / total, NA_real_),
      # Step 4: Determine predominant mode
      max_val = pmax(intl_percentage, dom_percentage, prof_percentage, na.rm = TRUE),
      decision = case_when(
        is.na(max_val) ~ NA_character_,
        intl_percentage == max_val & dom_percentage != max_val & prof_percentage != max_val ~ "intl",
        dom_percentage  == max_val & intl_percentage != max_val & prof_percentage != max_val ~ "dom",
        prof_percentage == max_val & intl_percentage != max_val & dom_percentage  != max_val ~ "prof",
        TRUE ~ "tie"
      )
    ) %>%
    dplyr::select(-max_val, -total)

  return(df_issue)
}


# ---- application ----
legis_tp <- generate_decision_with_issues(legis_sum1)
```

# 2. overall trend by individual

This block visualizes the distribution of legislators' decision types (intl/dom/prof) in both adver and legis datasets. It includes overall bar plots and congress-specific facet plots. Additionally, it inspects label distributions across congress, party, chamber, gender, and committee.

## 2.1 overall mode distribution

overall

```{r}
#| label: overall_barplot
#| echo: false

ggplot(legis_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  geom_text(stat='count', aes(label=..count..), vjust=-0.8, size=5) +
  labs(title = "decision mode by congressmen legis",
       x = "decision mode",
       y = "number") +
  theme_minimal(base_size = 14)
```

congress

```{r}
#| label: overall_barplot_by_congress
#| echo: false

ggplot(legis_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  facet_wrap(~ congress, scales = "free_y") +
  labs(title = "decision mode by congressmen legis",
       x = "Decision Mode",
       y = "Number") +
  theme_minimal(base_size = 12)
```

by party

```{r}
#| label: overall_barplot_by_party
#| echo: false

ggplot(legis_cg, aes(x = decision, fill = decision)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.0, size = 3) +
  scale_fill_manual(
    values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c")
  ) +
  facet_wrap(~ party, scales = "free_y") +
  labs(title = "decision mode by congressmen legis",
       x = "Decision Mode",
       y = "Number") +
  theme_minimal(base_size = 12)
```

## 2.2 times trend of modes across congress

This figure plots the time trends of the international, domestic, and professional behavior modes across congressional sessions. It visualizes both the overall trends and the trends disaggregated by party, allowing comparison of how Democrats and Republicans differ in the evolution, of their behavioral emphases over time.

```{r}
#| label: times-series_trend_of_modes_across_congress
#| echo: false

trend_party <- legis_cg %>%
  filter(party %in% c("Democratic", "Republican")) %>%
  group_by(congress, party) %>%
  summarise(
    intl = mean(intl_percentage, na.rm = TRUE),
    dom  = mean(dom_percentage, na.rm = TRUE),
    prof = mean(prof_percentage, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(intl, dom, prof),
               names_to = "mode",
               values_to = "value")

trend_overall <- legis_cg %>%
  group_by(congress) %>%
  summarise(
    intl = mean(intl_percentage, na.rm = TRUE),
    dom  = mean(dom_percentage, na.rm = TRUE),
    prof = mean(prof_percentage, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(intl, dom, prof),
               names_to = "mode",
               values_to = "value") %>%
  mutate(party = "Overall")

# visualization
ggplot(bind_rows(trend_overall, trend_party),
       aes(x = congress, y = value, color = party, linetype = mode)) +
  geom_line(size = 1.2) +
  scale_color_manual(values = c(
    "Overall" = "black",
    "Democratic" = "#2E74C0",
    "Republican" = "#CB454A"
  )) +
  labs(
    title = "Time-Series Trends in Legislative Mode Percentages",
    x = "Congress",
    y = "Average Percentage",
    linetype = "Mode",
    color = "Party"
  ) +
  theme_minimal(base_size = 14)


```

```{r}
#| label: house_marjority_influence_on_average
#| echo: false

# set house_majority 
house_majority <- data.frame(
   congress = 115:118,
   majority = c("Republican","Democratic","Democratic","Republican")
 )

legis_cg2 <- legis_cg %>%
   left_join(house_majority, by="congress") %>%
   mutate(congress_num = as.numeric(congress))

# 重新设定 'Republican' 为参考类别
legis_cg2$majority <- factor(legis_cg2$majority)
legis_cg2$majority <- relevel(legis_cg2$majority, ref = "Republican")

# model
model_fit <- lm(prof_percentage ~ majority, data = legis_cg2)
summary(model_fit)

# Get predictions based on majority variable
legis_cg2$predicted_prof <- predict(model_fit, newdata = legis_cg2)

# Plot marginal effects by majority
ggplot(legis_cg2, aes(x = majority, y = predicted_prof, fill = majority)) +
  geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  labs(title = "Marginal Effect of Majority on Professional Percentage",
       x = "Majority Party",
       y = "Predicted Professional Mode Percentage") +
  theme_minimal(base_size = 15) +
  scale_fill_manual(values = c("Democrat" = "blue", "Republican" = "red"))

```

## 2.3 Linear trend of the mode share over time

```{r}
#| label: Linear_trend_of_the_professional_mode_share_over_time
#| echo: false


# visualization

model_fit1 <- lm(prof_percentage ~ majority * congress_num, data = legis_cg2)
summary(model_fit1)

# visualization
pred_prof <- ggpredict(model_fit1, terms = c("congress_num [all]", "majority"))

ggplot(pred_prof, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_color_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Marginal Effects of House Majority on Professional Mode",
    x = "Congress Number",
    y = "Predicted Domestic Mode Percentage",
    color = "Majority Party",
    fill = "Majority Party"
  ) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

```

```{r}
#| label: Linear_trend_of_the_domestic_mode_share_over_time
#| echo: false

model_fit2 <- lm(dom_percentage ~ majority * congress_num, data = legis_cg2)
summary(model_fit2)

# visualization
pred_dom <- ggpredict(model_fit2, terms = c("congress_num [all]", "majority"))

ggplot(pred_dom, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_color_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Marginal Effects of House Majority on Domestic Mode",
    x = "Congress Number",
    y = "Predicted Domestic Mode Percentage",
    color = "Majority Party",
    fill = "Majority Party"
  ) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

## 2.4 interaction plot between ideology and party

```{r}
#| label: scatter_plot_ideology_and_party
#| echo: false

# intl_percenatge
ggplot(legis_cg, aes(x = ideology, y = intl_percentage, color = party)) +
  geom_point(alpha = 0.7, size = 3) +
  scale_color_manual(
    values = c(
      "Democratic" = "#2E74C0",  # 蓝色
      "Republican" = "#CB454A"   # 红色
    )
  ) +
  labs(
    title = "Ideology vs International Mode by Party",
    x = "Ideology",
    y = "International Percentage",
    color = "Party"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  ) +
  geom_smooth(method = "lm", se = FALSE)

# prof_percentage
ggplot(legis_cg, aes(x = ideology, y = prof_percentage, color = party)) +
  geom_point(alpha = 0.7, size = 3) +
  scale_color_manual(
    values = c(
      "Democratic" = "#2E74C0",  # 蓝色
      "Republican" = "#CB454A"   # 红色
    )
  ) +
  labs(
    title = "Ideology vs Professional Mode by Party",
    x = "Ideology",
    y = "Professional Percentage",
    color = "Party"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  ) +
  geom_smooth(method = "lm", se = FALSE)

# dom_percentage
ggplot(legis_cg, aes(x = ideology, y = dom_percentage, color = party)) +
  geom_point(alpha = 0.7, size = 3) +
  scale_color_manual(
    values = c(
      "Democratic" = "#2E74C0",  # 蓝色
      "Republican" = "#CB454A"   # 红色
    )
  ) +
  labs(
    title = "Ideology vs Domestic Mode by Party",
    x = "Ideology",
    y = "Domestic Percentage",
    color = "Party"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  ) +
  geom_smooth(method = "lm", se = FALSE)
```

## 2.5 interaction plot between party and committee_el

```{r}
#| label: interaction plot between party and committee_el
#| echo: false

# 对民主党和共和党议员的专业模式占比做比较，按照 chamber 和 committee_el 进行分组
party_prof_percentage <- legis_cg %>%
  filter(party %in% c("Democratic", "Republican")) %>%
  group_by(party, chamber, committee_el) %>%
  summarise(
    avg_prof_percentage = mean(prof_percentage, na.rm = TRUE),
    .groups = "drop"
  )

# 对民主党和共和党议员的专业模式占比做t检验，按 chamber 和 committee_el 分组
t_test_results <- legis_cg %>%
  filter(party %in% c("Democratic", "Republican")) %>%
  group_by(chamber, committee_el) %>%
  summarise(
    t_test = list(t.test(prof_percentage ~ party, data = .)),
    .groups = "drop"
  ) %>%
  mutate(
    p_value = sapply(t_test, function(x) x$p.value),  # 提取p值
    significant = ifelse(p_value < 0.05, "Yes", "No")  # 判断是否显著
  )

# 查看t检验结果
print(t_test_results)

# 可视化：比较两党在不同委员会和不同议院（House/Senate）的专业模式占比
# 针对 House（众议院）的图
p_house <- ggplot(party_prof_percentage %>% filter(chamber == "house of representatives"), 
                  aes(x = committee_el, y = avg_prof_percentage, fill = party)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  coord_flip() +
  labs(
    title = "Professional Mode Percentage by Party and Committee (House)",
    x = "Committee",
    y = "Average Professional Mode Percentage"
  ) +
  theme_minimal(base_size = 13) +
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"), 
    strip.text = element_text(face = "bold")  # 强调每个委员会的标签
  )

# 针对 Senate（参议院）的图
p_senate <- ggplot(party_prof_percentage %>% filter(chamber == "senate"), 
                   aes(x = committee_el, y = avg_prof_percentage, fill = party)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  coord_flip() +
  labs(
    title = "Professional Mode Percentage by Party and Committee (Senate)",
    x = "Committee",
    y = "Average Professional Mode Percentage"
  ) +
  theme_minimal(base_size = 13) +
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"), 
    strip.text = element_text(face = "bold")  # 强调每个委员会的标签
  )

# 显示图表
p_house
p_senate
```

```{r}
#| label: party based committees prof_percentage difference
#| echo: false

# 1. 计算每个委员会中民主党和共和党议员的占比
committee_party_ratio <- legis_sum1 %>%
  group_by(committee_el, party) %>%
  summarise(
    party_count = n(),
    total_count = n_distinct(full_name),
    party_ratio = party_count / total_count,
    .groups = "drop"
  )

# 2. 计算每个委员会中民主党和共和党的占比，并比较
committee_party_comparison <- committee_party_ratio %>%
  filter(party %in% c("Democratic", "Republican")) %>%
  pivot_wider(
    names_from = party,  # 将 party 列的值变为列名
    values_from = party_ratio,  # 将 party_ratio 值填充到相应列
    values_fn = list(party_ratio = mean),  # 处理重复数据（如果有）时，取平均
    values_fill = list(party_ratio = 0)  # 如果某个党派没有出现，填充0
  ) %>%
  rename(
    party_ratio_dem = Democratic,
    party_ratio_rep = Republican
  ) %>%
  # 3. 筛选出民主党占比大于共和党占比的委员会
  filter(party_ratio_dem > party_ratio_rep)

# 查看筛选结果
print(committee_party_comparison)

# 4. 计算这些委员会的专业模式占比（包括两党）
committee_prof_percentage <- legis_sum1 %>%
  filter(committee_el %in% committee_party_comparison$committee_el) %>%
  group_by(committee_el, party) %>%
  summarise(
    avg_prof_percentage = mean(importance_prof, na.rm = TRUE),
    .groups = "drop"
  )

# 5. 可视化民主党和共和党在这些委员会中的专业模式占比
ggplot(committee_prof_percentage, aes(x = committee_el, y = avg_prof_percentage, fill = party)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  coord_flip() +
  labs(
    title = "Professional Mode Percentage by Party in Committees with Higher Democratic Representation",
    x = "Committee",
    y = "Average Professional Mode Percentage"
  ) +
  theme_minimal(base_size = 13) +
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A"))

```

# 3. overall trend by issues

## 3.1 Distribution of Behavior Modes Across Policy Issues

```{r}
#| label: distribution_of_behavior_modes_across_policy_issues
#| echo: false

area_plot_data <- legis_tp %>%
  group_by(issue, congress) %>%
  summarise(
    intl = mean(intl_percentage, na.rm = TRUE),
    dom = mean(dom_percentage, na.rm = TRUE), 
    prof = mean(prof_percentage, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = c(intl, dom, prof),
    names_to = "mode",
    values_to = "percentage"
  ) %>%
  mutate(
    mode = factor(mode,
                  levels = c("intl", "dom", "prof"),
                  labels = c("intl", "dom", "prof")),
    issue_wrap = str_wrap(issue, width = 15)  # 调整宽度以适应您的议题名称
  )

ggplot(area_plot_data, aes(x = congress, y = percentage, fill = mode)) +
  geom_area(alpha = 0.8) +
  scale_fill_manual(
    values = c(
      "prof" = "#00BA38",
      "dom"  = "#F8766D",
      "intl" = "#619CFF"  
    )
  ) +
  facet_wrap(~ issue_wrap, scales = "free_y") +
  labs(
    title = "Distribution of Behavior Modes Across Policy Issues",
    x = "Congress", 
    y = "Mode Percentage",
    fill = "Mode"
  ) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 9, lineheight = 0.9, face = "bold"),
    # 确保分面标签有足够高度
    strip.placement = "outside"
  )
```

```{r}
#| label: issue heatmap by congress
#| echo: false

plot_decision_mode_heatmap <- function(df, title = "Decision Mode by Issue and Congress", save_path = NULL) {

  # 检查变量
  required_vars <- c("issue", "congress", "decision")
  if (!all(required_vars %in% names(df))) {
    stop("Input dataframe must contain columns: issue, congress, decision.")
  }

  # 数据准备
  df <- df %>%
    dplyr::mutate(
      decision = factor(decision, levels = c("intl", "dom", "prof")),
      congress = as.factor(congress)
    )

  # 绘图
  p <- ggplot(df, aes(x = congress, y = reorder(issue, desc(issue)), fill = decision)) +
    geom_tile(color = "white") +
    scale_fill_manual(
      values = c("intl" = "#1f77b4", "dom" = "#ff7f0e", "prof" = "#2ca02c"),
      na.value = "grey90"
    ) +
    labs(
      title = title,
      x = "Congress",
      y = "Issue",
      fill = "Decision Mode"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid = element_blank()
    )

  # 保存图片（如果提供了路径）
  if (!is.null(save_path)) {
    save_to_output(filename = save_path, plot = p, width = 8, height = 6, dpi = 300)
  }

  return(p)
}

# use of function plot_decision_mode_heatmap()
plot_decision_mode_heatmap(legis_tp, title = "Legis Decision Mode of Issue", save_path = "legis_mode.png")

```

```{r}
#| label: issues modes percentage table
#| echo: false

# 计算各议题平均占比
issue_summary <- legis_tp %>%
  group_by(issue) %>%
  summarise(
    intl_pct = mean(intl_percentage, na.rm = TRUE),
    dom_pct = mean(dom_percentage, na.rm = TRUE),
    prof_pct = mean(prof_percentage, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(prof_pct))  # 可以按专业模式占比排序

# 输出表格
kable(issue_summary, digits = 2,
      col.names = c("Issue", "Intl %", "Dom %", "Prof %"),
      caption = "各类议题中三类行为模式占比（按党派分组）")

```

## 3.2 bills data

bills data cleansing

```{r}
#| label: bills data cleansing
#| echo: false

bills_data_aug <- bills_data %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    bioguide %>%
      mutate(congress = as.integer(congress)) %>% 
      dplyr::select(bioguide_id, congress, chamber, gender, party),
    by = c("bioguide_id" = "bioguide_id", "congress" = "congress")
  ) %>%
  filter(congress != 119) 

bills_data_aug <- bills_data_aug %>%
  left_join(
    legis_cg %>%
      mutate(congress = as.integer(congress)) %>%
      dplyr::select(bioguide_id, congress, decision, intl_percentage, prof_percentage, dom_percentage),
    by = c("bioguide_id" = "bioguide_id", "congress" = "congress")
  )

summary(bills_data_aug)
sum(is.na(bills_data_aug$party))

# 变化趋势的数据库
issue_trend <- bills_data_aug %>%
  group_by(congress, issue) %>%
  summarise(news_count = n(), .groups = "drop")

issue_trend$congress <- as.numeric(issue_trend$congress)

```

bills trends plot for all issues

```{r}
#| label: issues bills all trend
#| echo: false

issue_trend_pct <- issue_trend %>%
  filter(congress <= 118) %>%   # ✅ 明确去掉 119 届
  group_by(congress) %>%
  mutate(
    total_news = sum(news_count, na.rm = TRUE),
    pct = (news_count / total_news) * 100
  ) %>%
  ungroup()

issue_trend_last <- issue_trend_pct %>%
  group_by(issue) %>%
  filter(congress == max(congress)) %>%
  ungroup()


# 色彩方案改进
n_colors <- length(unique(issue_trend_pct$issue))
library(ggsci)
library(randomcoloR)

colors <- c(
  pal_npg("nrc")(10),
  pal_d3("category20")(20),
  distinctColorPalette(n_colors)
)[1:n_colors]

p <- ggplot(issue_trend_pct, aes(x = as.numeric(congress), y = pct, color = issue)) +
  geom_line(size = 1) +
  geom_point(size = 1.5) +
  geom_text_repel(
    data = issue_trend_last,
    aes(label = issue),
    size = 3,
    nudge_x = 1,
    direction = "y",
    segment.size = 0.2,
    show.legend = FALSE
  ) +
  labs(
    title = "Issue Share per Congress (as % of total bills)",
    x = "Congress",
    y = "Share (%)"
  ) +
  scale_x_continuous(breaks = 115:118) +  # ✅ 明确只显示115–118
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal() +
  scale_color_manual(values = colors) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"
  )

p

save_to_output("issue_share_per_congress_115–118_bills.png", plot = p, width = 10, height = 8, dpi = 300)
```

```{r}
#| label: chamber party bills issue attention
#| echo: false

# 1. 每个议员在每届对某议题的关注次数
issue_counts_mid <- bills_data_aug %>%
  group_by(congress, chamber, party, bioguide_id, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. 聚合到 chamber × party 层面
issue_counts_chamber_party <- issue_counts_mid %>%
  group_by(congress, chamber, party, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

# 3. 取每届每个 chamber × party 的 Top 1 议题
top_issues_chamber_party <- issue_counts_chamber_party %>%
  group_by(congress, chamber, party) %>%
  slice_max(order_by = total_mentions, n = 1, with_ties = FALSE) %>%
  arrange(congress, chamber, party, desc(total_mentions))

# 查看结果
top_issues_chamber_party

# 导出为 CSV
save_to_output("top_issues_chamber_party_bills.csv", data = top_issues_chamber_party)

```

```{r}
#| label: congress issue attention bills
#| echo: false

# 1. 每个议员在每届对某议题的关注次数
issue_counts_mid <- bills_data_aug %>%
  group_by(congress, chamber, party, bioguide_id, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. 聚合到 chamber × party 层面
top_issues_congress <- issue_counts_mid %>%
  group_by(congress, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

# 3. 取每届每个 chamber × party 的 Top 1 议题
top_issues_congress <- top_issues_congress %>%
  group_by(congress) %>%
  slice_max(order_by = total_mentions, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(congress, desc(total_mentions))

ggplot(top_issues_congress, aes(x = fct_reorder(issue, total_mentions), y = total_mentions, fill = as.factor(congress))) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("115"="#FFD700","116"="#2E74C0","117"="#CB454A","118"="#009966")) +
  theme_minimal() +
  labs(
    title = "Top Issue Mentions by Congress",
    x = "Issue",
    y = "Total Mentions",
    fill = "Congress"
  )

# 导出为 CSV
save_to_output("top_issues_congress_bills.csv", data = top_issues_congress)

```

```{r}
#| label: party issue attention bills
#| echo: false

# 1. 每个议员在每届对某议题的关注次数
issue_counts_mid <- bills_data_aug %>%
  group_by(party, bioguide_id, issue) %>%
  summarise(n_issue_mentions = n(), .groups = "drop")

# 2. 聚合到  party 层面
issue_counts_party <- issue_counts_mid %>%
  group_by(party, issue) %>%
  summarise(total_mentions = sum(n_issue_mentions), .groups = "drop")

issue_counts_party <- issue_counts_party %>%
  filter(!party %in% c("Independent", "I")) 

issue_counts_party <- issue_counts_party %>%
  filter(!issue == "NA") 

# 确保每个党派内部按数量排序
issue_counts_party <- issue_counts_party %>%
  group_by(party) %>%
  mutate(issue = reorder_within(issue, total_mentions, party))

# 导出为 CSV
save_to_output("top_issues_party_news.csv", data = issue_counts_party)

```

```{r}
#| label: party issue attention bills top 10
#| echo: false

# 确保每个党派内部按数量排序并保留前10个议题
issue_counts_party <- issue_counts_party %>%
  group_by(party) %>%
  mutate(issue = reorder_within(issue, total_mentions, party)) %>%
  top_n(10, total_mentions)  # 只保留每个党派前10个议题

# 可视化：每个党派的前10个议题
p_issue_party_split <- ggplot(issue_counts_party, aes(
  x = reorder(issue, total_mentions),
  y = total_mentions,
  fill = party
)) +
  geom_col(show.legend = FALSE) +
  # 添加标签，显示每个条形的总提及次数
  geom_text(aes(label = total_mentions), 
            position = position_dodge(width = 0.7), 
            hjust = -0, size = 4) +  # 设置标签位置和大小
  coord_flip() +
  scale_x_reordered(labels = function(x) gsub("___.*$", "", x)) + 
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Bills Mentions by Issue (Separated by Party)",
    x = "Issue",
    y = "Number of Bills Mentions"
  ) +
  facet_wrap(~ party, ncol = 1, scales = "free_y") +  # 上下分两个图
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold")
  )

# 显示图表
p_issue_party_split

# 导出为图片
save_to_output("bills_choice_by_party_with_labels.png", plot = p_issue_party_split, width = 10, height = 5, dpi = 300)
```

```{r}
#| label: congress issue attention bills party
#| echo: false

# ---- 1. 数据清理 ----
bills_clean <- bills_data_aug %>%
  filter(!is.na(issue) & issue != "") %>%          # 去掉议题缺失
  filter(!party %in% c("Independent", "I"))        # 去掉独立党派

# ---- 2. 聚合统计 ----
bills_count <- bills_clean %>%
  group_by(congress, party, issue) %>%
  summarise(
    bill_count = n(),      # 每届国会、党派、议题的法案数量
    .groups = "drop"
  )

# ---- 3. 可视化 ----
library(ggplot2)
library(patchwork)

plot_bill_count <- function(data, congress_num) {
  data %>%
    filter(congress == congress_num) %>%
    ggplot(aes(x = reorder(issue, bill_count), y = bill_count, fill = party)) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(
      values = c(
        "Democratic" = "#2E74C0",  # 蓝色
        "Republican" = "#CB454A"   # 红色
      )
    ) +
    labs(
      title = paste0("Number of Bills by Party — ", congress_num, "th Congress"),
      x = "Issue",
      y = "Number of Bills"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "top"
    )
}

# ---- 4. 生成四届国会的图 ----
p115 <- plot_bill_count(bills_count, 115)
p116 <- plot_bill_count(bills_count, 116)
p117 <- plot_bill_count(bills_count, 117)
p118 <- plot_bill_count(bills_count, 118)


p115
p116
p117
p118

```

calculating shanon-entropy for bills news

```{r}
#| label: issues shanon entropy bills
#| echo: false

# 计算每个议员在每个 congress × issue 的出现次数
issue_dist <- bills_data_aug %>%
  filter(!is.na(bioguide_id), !is.na(issue), !is.na(congress)) %>%
  group_by(bioguide_id, congress, issue, gender, chamber, party) %>%
  summarise(n = n(), .groups = "drop")

# 计算每个议员在每个 congress 的总新闻数
issue_total <- issue_dist %>%
  group_by(bioguide_id, congress, gender, chamber, party) %>%
  summarise(total = sum(n), .groups = "drop")

# 合并并计算 p_k
issue_prob <- issue_dist %>%
  left_join(issue_total,
            by = c("bioguide_id", "congress", "gender", "chamber", "party")) %>%
  mutate(p = n / total)

# 计算 Shannon entropy
entropy_bills <- issue_prob %>%
  group_by(bioguide_id, congress, gender, chamber, party) %>%
  summarise(
    shannon_entropy = -sum(p * log(p)),   # 默认自然对数
    n_issues = n_distinct(issue),
    total_news = sum(n),
    .groups = "drop"
  )
head(entropy_bills)

# violin plot
ggplot(entropy_bills, aes(x = factor(congress), y = shannon_entropy)) +
  geom_violin(fill = "skyblue", alpha = 0.5) +
  geom_boxplot(width = 0.1, outlier.size = 0.5) +
  theme_minimal() +
  labs(x = "Congress", y = "Shannon Entropy",
       title = "Distribution of Attention Diversity per Congress")

# line graph
entropy_summary <- entropy_bills %>%
  group_by(congress) %>%
  summarise(mean_entropy = mean(shannon_entropy, na.rm = TRUE),
            median_entropy = median(shannon_entropy, na.rm = TRUE))
p <- ggplot(entropy_summary, aes(x = congress, y = mean_entropy)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x = "Congress", y = "Mean Shannon Entropy",
       title = "Bills Average Attention Diversity by Congress")

save_to_output("Average Attention Diversity by Congress-bills.png", plot = p, width = 8, height = 4, dpi = 300)
```

## 3.3 bills number + mode percentage summary

```{r}
#| label: issues modes percentage and number table
#| echo: false

# ---- Step 1: 汇总每个议题的立法数量和平均模式占比 ----
issue_summary <- bills_data_aug %>%
  group_by(issue) %>%
  summarise(
    n_bills = n(),  # 该议题的法案数量
    avg_intl = mean(intl_percentage, na.rm = TRUE),
    avg_dom  = mean(dom_percentage,  na.rm = TRUE),
    avg_prof = mean(prof_percentage, na.rm = TRUE)
  ) %>%
  mutate(
    predominant_mode = case_when(
      avg_intl == pmax(avg_intl, avg_dom, avg_prof) ~ "Intl",
      avg_dom  == pmax(avg_intl, avg_dom, avg_prof) ~ "Dom",
      avg_prof == pmax(avg_intl, avg_dom, avg_prof) ~ "Prof",
      TRUE ~ NA_character_
    )
  ) %>%
  arrange(desc(n_bills))

# ---- Step 2: 统计每个模式占比最高的议题数量 ----
mode_counts <- issue_summary %>%
  group_by(predominant_mode) %>%
  summarise(n_issues = n()) 

# ---- Step 3: 可视化或打印结果 ----
# 打印议题表
print(issue_summary)

# 条形图：每个议题的三类模式占比
issue_summary_long <- issue_summary %>%
  pivot_longer(cols = c(avg_intl, avg_dom, avg_prof), 
               names_to = "mode", 
               values_to = "percentage")

ggplot(issue_summary_long, aes(x = reorder(issue, -n_bills), y = percentage, fill = mode)) +
  geom_col(position = "dodge") +
  labs(
    x = "Issue",
    y = "Average Mode Percentage",
    fill = "Mode",
    title = "议题层面三类行为模式占比"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## 3.4 legislators fulfill promise check

```{r}
#| label: legislator fulfill promise dataset
#| echo: false

# Step 1: 对news数据汇总

news_data_aug <- news_data %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    bioguide %>%
      mutate(congress = as.integer(congress)) %>% 
      dplyr::select(bioguide_id, congress, chamber, gender, party),
    by = c("mid" = "bioguide_id", "congress" = "congress")
  ) %>%
  filter(congress != 119)

news_summary <- news_data_aug %>%
  group_by(congress, chamber, gender, party, issue, mid) %>%
  summarise(news_count = n(), .groups = "drop") %>%
  mutate(news_flag = 1) %>%
  rename(legislator_id = mid)

# Step 2: 对bills数据汇总
bills_summary <- bills_data_aug %>%
  group_by(congress, chamber, gender, party, issue, bioguide_id) %>%
  summarise(bill_count = n(), .groups = "drop") %>%
  mutate(bill_flag = 1) %>%
  rename(legislator_id = bioguide_id)


# Step 3: 统一字段后再join（现在是一对一或一对零）
merged_data <- full_join(
  news_summary,
  bills_summary,
  by = c("congress", "issue", "chamber", "gender", "party", "legislator_id"),
  suffix = c("_news", "_bill")
) 

merged_data <- merged_data %>%
  mutate(
    news_count = replace_na(news_count, 0),
    bill_count = replace_na(bill_count, 0),
    news_flag = replace_na(news_flag, 0),
    bill_flag = replace_na(bill_flag, 0),
    fulfilled = ifelse(news_flag == 1 & bill_flag == 1, 1, 0)
  ) %>%
  mutate(congress = as.integer(congress)) %>%
  left_join(
    legis_cg %>%
      mutate(congress = as.integer(congress)) %>%
      dplyr::select(congress, bioguide_id, decision, intl_percentage, prof_percentage, dom_percentage),
    by = c("legislator_id" = "bioguide_id", "congress" = "congress")
  )

# Step 4: 补齐NA
merged_data <- merged_data %>%
  mutate(
    fulfilled = ifelse(news_flag == 1 & bill_flag == 1, 1, 0)
  ) %>%
  drop_na()

# Step 5: 计算兑现指标
merged_data <- merged_data %>%
  mutate(
    fulfilled = ifelse(news_flag == 1 & bill_flag == 1, 1, 0)
  )

merged_clean <- merged_data %>%
  filter(if_all(everything(), ~ !is.na(.)))

names(merged_clean)

# Step 6: 可选：统计层级结果（例如每个议题的兑现比例）
issue_summary <- merged_data %>%
  group_by(congress, issue, gender, party) %>%
  summarise(
    total_news = sum(news_flag),
    total_bills = sum(bill_flag),
    fulfilled_cases = sum(fulfilled),
    fulfillment_rate = fulfilled_cases / total_news,
    .groups = "drop"
  )

```

```{r}
#| label: legislator fulfill promise fulfill rate analysis
#| echo: false

cor(merged_data$bill_count, merged_data$news_count, use="complete.obs")

# ------- party   -------
slope_party <- merged_data %>%
  filter(!party %in% c("Independent", "I")) %>%
  group_by(party) %>%
  summarise(
    slope = coef(lm(news_count ~ bill_count))[2]
  )%>%
  mutate(
    x = Inf,             
    y = c(Inf, Inf * 0.9) 
  )

p_party <- ggplot(merged_data %>% filter(!party %in% c("Independent", "I")),
                  aes(x = bill_count, y = news_count, color = party)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(
    data = slope_party,
    aes(x = Inf, y = Inf,
        label = paste0("Slope = ", round(slope, 2))),
    hjust = 1.1, vjust = c(2, 4),
    size = 4, show.legend = FALSE
  ) +
  scale_color_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Legislative vs Promotional Activities by Party",
    x = "Number of Bills Sponsored",
    y = "Number of News Mentions",
    color = "Party"
  ) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))


# ------- gender   -------
slope_gender <- merged_data %>%
  group_by(gender) %>%
  summarise(
    slope = coef(lm(news_count ~ bill_count))[2]
  )%>%
  mutate(
    x = Inf,              # 放在图右边
    y = c(Inf, Inf * 0.9) # 稍微错开一点高度
  )

p_gender <- ggplot(merged_data, aes(x = bill_count, y = news_count, color = gender)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(
    data = slope_gender,
    aes(x = Inf, y = Inf,
        label = paste0("Slope = ", round(slope, 2))),
    hjust = 1.1, vjust = c(2, 4),
    size = 4, show.legend = FALSE
  ) +
  scale_color_manual(values = c("M" = "#1F78B4", "F" = "#E31A1C")) +
  labs(
    title = "Legislative vs Promotional Activities by Gender",
    x = "Number of Bills Sponsored",
    y = "Number of News Mentions",
    color = "Gender"
  ) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))


p_party
p_gender
```

```{r}
#| label: legislator fulfill promise party issues attention
#| echo: false

# ------ fulfill rate top5 issues by party  ------
top5_issue_by_party <- issue_summary %>%
  filter(!is.na(fulfillment_rate)) %>%
  group_by(congress, party) %>%
  arrange(desc(fulfillment_rate), .by_group = TRUE) %>%
  slice_head(n = 5) %>%
  ungroup()

top5_issue_by_party %>%
  arrange(congress, party, desc(fulfillment_rate)) %>%
  dplyr::select(congress, party, issue, fulfillment_rate)

ggplot(top5_issue_by_party, 
       aes(x = reorder(issue, fulfillment_rate), 
           y = fulfillment_rate, 
           fill = party)) +
  geom_col(position = "dodge") +
  coord_flip() +
  facet_wrap(~ congress, scales = "free_y") +
  scale_fill_manual(
    values = c(
      "Democratic" = "#2E74C0",  # 蓝
      "Republican" = "#CB454A"   # 红
    )
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Top 5 Issues by Fulfillment Rate per Party and Congress",
    x = "Issue",
    y = "Fulfillment Rate"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top",
    strip.text = element_text(face = "bold")
  )




```

```{r}
#| label: legislator fulfill promise party across congress analysis
#| echo: false

# 1. case rate
# 党派维度（去掉独立党派）
party_fulfill <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%  # 去掉独立党派
  group_by(party, issue) %>%
  summarise(
    total = n(),
    fulfilled = sum(fulfilled == 1),
    fulfill_rate = fulfilled / total,
    .groups = "drop"
  )

# 2. visualization - across congress - split
p_party_split <- ggplot(party_fulfill, aes(x = reorder(issue, fulfill_rate), y = fulfill_rate, fill = party)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_fill_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Fulfillment Rate by Issue (Separated by Party)",
    x = "Issue",
    y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~ party, ncol = 1) +  # 拆成两个图，每个党一个
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold")
  )
p_party_split

# 3. visualization - across congress
p_dem <- ggplot(subset(party_fulfill, party == "Democratic"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#2E74C0") +
  geom_text(
    aes(label = scales::percent(fulfill_rate, accuracy = 0.1)),
    hjust = -0.1, size = 3.5
  ) +
  coord_flip() +
  labs(
    title = "Democratic: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, max(party_fulfill$fulfill_rate) * 1.1)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

p_rep <- ggplot(subset(party_fulfill, party == "Republican"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#CB454A") +
  geom_text(
    aes(label = scales::percent(fulfill_rate, accuracy = 0.1)),
    hjust = -0.1, size = 3.5
  ) +
  coord_flip() +
  labs(
    title = "Republican: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, max(party_fulfill$fulfill_rate) * 1.1)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
p_dem
p_rep

# 4. visualization - all congress (with total)
# --- 民主党 ---
p_dem <- ggplot(subset(party_fulfill, party == "Democratic"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#2E74C0") +
  geom_text(aes(
    label = paste0(
      scales::percent(fulfill_rate, accuracy = 1),
      "\n(n=", total, ")"
    )
  ),
  hjust = -0.1, size = 3.2) +
  coord_flip() +
  labs(
    title = "Democratic: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1.05)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# --- 共和党 ---
p_rep <- ggplot(subset(party_fulfill, party == "Republican"),
                aes(x = reorder(issue, fulfill_rate), y = fulfill_rate)) +
  geom_col(fill = "#CB454A") +
  geom_text(aes(
    label = paste0(
      scales::percent(fulfill_rate, accuracy = 1),
      "\n(n=", total, ")"
    )
  ),
  hjust = -0.1, size = 3.2) +
  coord_flip() +
  labs(
    title = "Republican: Fulfillment Rate by Issue",
    x = "Issue", y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1.05)) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

p_dem
p_rep

```

```{r}
#| label: legislator fulfill promise party each congress analysis rate
#| echo: false

# 1. case rate by congress
party_fulfill_congress <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%  # 去掉独立党派
  group_by(congress, party, issue) %>%
  summarise(
    total = n(),
    fulfilled = sum(fulfilled == 1),
    fulfill_rate = fulfilled / total,
    .groups = "drop"
  )

# 2. visualization - across congress
plot_fulfill_by_congress <- function(data, congress_num) {
  data %>%
    filter(congress == congress_num) %>%
    ggplot(aes(x = reorder(issue, fulfill_rate), y = fulfill_rate, fill = party)) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(
      values = c(
        "Democratic" = "#2E74C0",
        "Republican" = "#CB454A"
      )
    ) +
    labs(
      title = paste0("Fulfillment Rate by Party — ", congress_num, "th Congress"),
      x = "Issue",
      y = "Fulfillment Rate"
    ) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "top"
    )
}

# plot
p115 <- plot_fulfill_by_congress(party_fulfill_congress, 115)
p116 <- plot_fulfill_by_congress(party_fulfill_congress, 116)
p117 <- plot_fulfill_by_congress(party_fulfill_congress, 117)
p118 <- plot_fulfill_by_congress(party_fulfill_congress, 118)

p115
p116
p117
p118

```

```{r}
#| label: legislator fulfill promise party each congress analysis count
#| echo: false

# ---- 1. 数据准备 ----
party_issue_count <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%   # 去掉独立党派
  group_by(congress, party, issue) %>%
  summarise(
    total_cases = n(),                      # 总样本数
    fulfilled_cases = sum(fulfilled == 1),  # 兑现次数
    fulfill_rate = mean(fulfilled == 1),    # 兑现率
    .groups = "drop"
  )

# ---- 2. 可视化函数 ----
plot_fulfill_count <- function(data, congress_num) {
  
  # 当前届数据
  df <- data %>% filter(congress == congress_num)
  
  # 计算当前届平均兑现率（按党派）
  avg_rates <- df %>%
    group_by(party) %>%
    summarise(mean_rate = mean(fulfill_rate, na.rm = TRUE)) %>%
    mutate(label = paste0(party, ": ", scales::percent(mean_rate, accuracy = 0.1)))
  
  # 绘图
  p <- ggplot(df, aes(x = reorder(issue, fulfilled_cases), y = fulfilled_cases, fill = party)) +
    geom_col(position = "dodge") +
    geom_text(aes(label = fulfilled_cases),
              position = position_dodge(width = 0.9),
              hjust = -0.2,
              size = 3.2) +
    coord_flip() +
    scale_fill_manual(
      values = c(
        "Democratic" = "#2E74C0",  # 蓝色
        "Republican" = "#CB454A"   # 红色
      )
    ) +
    labs(
      title = paste0("Fulfilled Cases by Party — ", congress_num, "th Congress"),
      x = "Issue",
      y = "Number of Fulfilled Cases",
      caption = paste("Average Fulfillment Rate —", 
                      paste(avg_rates$label, collapse = " | "))
    ) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
    theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "top",
      plot.caption = element_text(hjust = 0.5, face = "italic", size = 10)
    )
  
  return(p)
}

# ---- 3. 生成四届国会图 ----
p115 <- plot_fulfill_count(party_issue_count, 115)
p116 <- plot_fulfill_count(party_issue_count, 116)
p117 <- plot_fulfill_count(party_issue_count, 117)
p118 <- plot_fulfill_count(party_issue_count, 118)


p115
p116
p117
p118

```

```{r}
#| label: legislator fulfill promise party across congress analysis per person
#| echo: false

# ---- 1. 统计每届国会每个党派的兑现人次 ----
party_fulfill_person <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%  # 去掉独立党派
  group_by(congress, party, legislator_id) %>%   # 按议员统计
  summarise(
    fulfilled_flag = any(fulfilled == 1),        # 是否至少兑现过一次
    .groups = "drop"
  ) %>%
  group_by(congress, party) %>%
  summarise(
    fulfilled_persons = sum(fulfilled_flag),     # 兑现过的人次
    total_persons = n(),                         # 该届该党派参与的总人数
    fulfill_rate = fulfilled_persons / total_persons,
    .groups = "drop"
  )

# ---- 2. 可视化：各届国会不同党派的兑现人次 ----
p_person <- ggplot(party_fulfill_person, aes(x = as.factor(congress), y = fulfilled_persons, 
                                             group = party, color = party)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  geom_text(aes(label = fulfilled_persons), vjust = -0.6, size = 3) +
  scale_color_manual(
    values = c(
      "Democratic" = "#2E74C0",  # 蓝色
      "Republican" = "#CB454A"   # 红色
    )
  ) +
  labs(
    title = "Number of Legislators with Fulfilled Issues by Party and Congress",
    x = "Congress",
    y = "Number of Legislators (Fulfilled ≥ 1 Issue)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

p_person

```

```{r}
#| label: legislator fulfill promise chamber across congress with decision
#| echo: false

p_person_decision <- merged_clean %>%
  filter(!party %in% c("Independent", "I")) %>%
  group_by(congress, party, decision, legislator_id) %>%
  summarise(fulfilled_flag = any(fulfilled == 1), .groups = "drop") %>%
  group_by(congress, party, decision) %>%
  summarise(
    fulfilled_persons = sum(fulfilled_flag),
    .groups = "drop"
  ) %>%
  ggplot(aes(
    x = as.factor(congress),
    y = fulfilled_persons,
    group = interaction(party, decision),
    color = party,
    shape = decision
  )) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +
  labs(
    title = "Fulfilled Legislators by Party, Congress, and Decision Type",
    x = "Congress",
    y = "Number of Legislators"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

p_person_decision

```

```{r}
#| label: legislator fulfill promise gender across congress analysis per person
#| echo: false

# ---- 1. 统计每届国会不同性别的兑现人次 ----
gender_fulfill_person <- merged_clean %>%
  filter(!is.na(gender)) %>%  # 去掉缺失性别数据
  group_by(congress, gender, legislator_id) %>%   # 按议员统计
  summarise(
    fulfilled_flag = any(fulfilled == 1),         # 是否至少兑现过一次
    .groups = "drop"
  ) %>%
  group_by(congress, gender) %>%
  summarise(
    fulfilled_persons = sum(fulfilled_flag),      # 兑现过的人次
    total_persons = n(),                          # 该届该性别参与的总人数
    fulfill_rate = fulfilled_persons / total_persons,
    .groups = "drop"
  )

# ---- 2. 可视化：各届国会不同性别的兑现人次 ----
p_gender_person <- ggplot(gender_fulfill_person, aes(
  x = as.factor(congress), y = fulfilled_persons,
  group = gender, color = gender
)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  geom_text(aes(label = fulfilled_persons), vjust = -0.6, size = 3) +
  scale_color_manual(
    values = c(
      "M" = "#1F78B4",  # 男性蓝色
      "F" = "#E31A1C"   # 女性红色
    ),
    labels = c("M" = "Male", "F" = "Female")
  ) +
  labs(
    title = "Number of Legislators with Fulfilled Issues by Gender and Congress",
    x = "Congress",
    y = "Number of Legislators (Fulfilled ≥ 1 Issue)",
    color = "Gender"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "top"
  )

p_gender_person

```

```{r}
#| label: legislator fulfill promise chamber across congress analysis
#| echo: false

# 议院维度
chamber_fulfill <- merged_clean %>%
  group_by(chamber, issue) %>%
  summarise(
    total = n(),
    fulfilled = sum(fulfilled == 1),
    fulfill_rate = fulfilled / total,
    .groups = "drop"
  )


# ---- chamber ----
p_chamber <- ggplot(chamber_fulfill, aes(x = reorder(issue, fulfill_rate), y = fulfill_rate, fill = chamber)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_viridis_d(option = "plasma", end = 0.9) +
  labs(
    title = "Fulfillment Rate by Chamber across Issues",
    x = "Issue",
    y = "Fulfillment Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5))

p_party
p_chamber

```

## 3.5 issues by congressional districts

# 4. lgbm features importance analysis

## 4.1 overall summary

```{r}
#| label: lgbm features importance analysis 
#| echo: false
# selected variables for plot
importance_vars <- c("leverage_pl", "leverage_ne", 
                     "committee_pl", "committee_ne", 
                     "employ_industry_pl", "employ_industry_ne", 
                     "payroll_industry_pl", "payroll_industry_ne", 
                     "ethnicity_pl", "ethnicity_ne", 
                     "party_value_pl", "party_value_ne", 
                     "party_score_pl", "party_score_ne")

legis_feature_sum <- legis_all %>%
  dplyr::select(all_of(importance_vars)) %>%
  pivot_longer(cols = everything(), names_to = "feature", values_to = "importance") %>%
  mutate(abs_importance = abs(importance)) %>%
  group_by(feature) %>%
  summarise(total_importance = sum(abs_importance, na.rm = TRUE)) %>%
  arrange(desc(total_importance))




ggplot(legis_feature_sum, aes(x = total_importance, y = reorder(feature, total_importance))) +
  geom_col(fill = "gray20", color = "black", width = 0.6) +
  theme_minimal(base_family = "Helvetica") +
  labs(
    title = "legis importance of each matched features (abs)",
    x = "features(abs values)",
    y = "features"
  ) +
  theme(
    axis.text = element_text(size = 10),
    plot.title = element_text(size = 13, face = "bold")
  )

```

## 4.2 aggregate by mode and by party

```{r}
#| label: lgbm_features_importance_analysis_by_party 
#| echo: false

# 汇总计算每个模式的平均重要性
legis_mode_importance_avg <- legis_cg %>%
  dplyr::select(party, importance_intl, importance_dom, importance_prof) %>%
  pivot_longer(
    cols = c("importance_intl", "importance_dom", "importance_prof"),
    names_to = "mode", 
    values_to = "importance"
  ) %>%
  # 对每个党派和模式计算特征的平均重要性
  group_by(party, mode) %>%
  summarise(
    avg_importance = mean(importance, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(party, desc(avg_importance))

# 计算总体的结果：使用平均值
legis_mode_importance_avg_total <- legis_mode_importance_avg %>%
  group_by(mode) %>%
  summarise(
    avg_importance = mean(avg_importance, na.rm = TRUE),  # 计算总体的平均值
    .groups = "drop"
  ) %>%
  mutate(party = "Overall")  # 给总体添加一列 party = "Overall"

# 合并党派和总体的结果
legis_mode_importance_avg_combined <- bind_rows(legis_mode_importance_avg, legis_mode_importance_avg_total)

# 党派颜色映射
party_colors <- c("Democratic" = "#2E74C0", "Republican" = "#CB454A", "Overall" = "gray50")

# 可视化
# 可视化：所有党派和总体的模式在同一个图中展示
p_party <- ggplot(legis_mode_importance_avg_combined, aes(x = avg_importance, y = reorder(mode, avg_importance), fill = party)) +
  geom_col(color = "black", width = 0.6, position = position_dodge(width = 0.7)) +  # 使用 position_dodge 来分开条形
  geom_text(aes(label = round(avg_importance, 2)), 
            position = position_dodge(width = 0.7), 
            hjust = -0.2, size = 4) +  # 设置标签位置和大小
  scale_fill_manual(values = party_colors) +  # 设置党派的颜色
  scale_x_continuous(
    breaks = seq(0, max(legis_mode_importance_avg_combined$avg_importance), by = 10),  # 设定 x 轴的刻度间距
    limits = c(0, max(legis_mode_importance_avg_combined$avg_importance) + 0.05)  # 设定 x 轴的范围
  ) + 
  theme_minimal() +
  labs(
    title = "LightGBM Feature Importance of Behavior Mode (By Party)",
    x = "Average Absolute Feature Importance",
    y = "Behavior Mode",
    fill = "Party"  # 图例标题
  ) +
  theme(
    axis.text = element_text(size = 11),
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.position = "top"  # 显示图例在顶部
  )

# 显示图表
p_party


save_to_output("LGBM importance by party.png", plot = p_party, width = 12, height = 6, dpi = 300)
```

## 4.3 by congress

```{r}
#| label: lgbm_features_importance_analysis_by_congress 
#| echo: false

legis_feature_sum_congress <- legis_all %>%
  dplyr::select(congress, all_of(importance_vars)) %>%
  pivot_longer(cols = -congress, names_to = "feature", values_to = "importance") %>%
  mutate(abs_importance = abs(importance)) %>%
  group_by(congress, feature) %>%
  summarise(total_importance = sum(abs_importance, na.rm = TRUE), .groups = "drop") %>%
  arrange(congress, desc(total_importance))

# 绘图
ggplot(legis_feature_sum_congress, aes(x = total_importance, y = reorder(feature, total_importance))) +
  geom_col(fill = "gray20", color = "black", width = 0.6) +
  facet_wrap(~ congress, scales = "free_x") +
  theme_minimal(base_family = "Helvetica") +
  labs(
    title = "Importance of Each Matched Feature (by Congress)",
    x = "Total Absolute Importance",
    y = "Feature"
  ) +
  theme(
    axis.text = element_text(size = 9),
    strip.text = element_text(size = 11, face = "bold"),
    plot.title = element_text(size = 13, face = "bold")
  )
```

# 5. key characteristics analysis

```{r}
#| label: categorized_ideology 
#| echo: false

summary(legis_cg$ideology)

legis_cg1 <- legis_cg %>%
  mutate(
    ideology_q = ntile(ideology, 4), 
    ideology_q = factor(ideology_q, labels = c("Q1", "Q2", "Q3", "Q4"))
  ) %>%
  filter(! ideology_q == "NA")
```

```{r}
#| label: characteristics_mean
#| echo: false

# function
make_mean_table <- function(df, group_var) {
  df %>%
    group_by({{ group_var }}) %>%
    summarise(
      intl_mean = mean(intl_percentage, na.rm = TRUE),
      dom_mean = mean(dom_percentage, na.rm = TRUE),
      prof_mean = mean(prof_percentage, na.rm = TRUE),
      n = n(),
      .groups = "drop"
    )
}

mean_party  <- make_mean_table(legis_cg1, party)
mean_gender <- make_mean_table(legis_cg1, gender)
mean_chamber <- make_mean_table(legis_cg1, chamber)
mean_ideo <- make_mean_table(legis_cg1, ideology_q)

mean_party
mean_gender
mean_chamber
mean_ideo

```

```{r}
#| label: t-test_and_ANOVA
#| echo: false

run_tests <- function(df, group_var) {
  
  vars <- c("intl_percentage", "dom_percentage", "prof_percentage")
  
  results <- lapply(vars, function(v) {
    formula <- as.formula(paste(v, "~", group_var))
    
    tidy(aov(formula, data = df)) %>%
      filter(term == group_var) %>%  
      mutate(
        variable = v,
        stars = case_when(
          `p.value` < 0.001 ~ "***",
          `p.value` < 0.01  ~ "**",
          `p.value` < 0.05  ~ "*",
          TRUE ~ ""
        )
      )
  })
  
  bind_rows(results)
}

test_party  <- run_tests(legis_cg1, "party")
test_gender <- run_tests(legis_cg1, "gender")
test_chamber <- run_tests(legis_cg1, "chamber")
test_ideo <- run_tests(legis_cg1, "ideology_q")

test_party
test_gender
test_chamber
test_ideo


```

```{r}
#| label: visualzation
#| echo: false

plot_mode_means <- function(df, group_var, title) {
  df %>%
    pivot_longer(cols = c(intl_percentage, dom_percentage, prof_percentage),
                 names_to = "mode", values_to = "value") %>%
    group_by({{ group_var }}, mode) %>%
    summarise(
      mean = mean(value, na.rm = TRUE),
      se = sd(value, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    ) %>%
    ggplot(aes(x = mode, y = mean, fill = {{ group_var }})) +
    geom_col(position = position_dodge(width = 0.8)) +
    geom_errorbar(aes(ymin = mean - 1.96*se, ymax = mean + 1.96*se),
                  width = .2, position = position_dodge(0.8)) +
    scale_y_continuous(labels = scales::percent_format()) +
    labs(title = title, x = "Mode", y = "Mean Percentage") +
    theme_minimal(base_size = 13)
}

plot_mode_means(legis_cg1, party, "Mode Differences by Party")
plot_mode_means(legis_cg1, gender, "Mode Differences by Gender")
plot_mode_means(legis_cg1, chamber, "Mode Differences by Chamber")
plot_mode_means(legis_cg1, ideology_q, "Mode Differences by Ideology Quartile")



```

```{r}
#| label: household income and white_ratio
#| echo: false

ggplot(legis_merged, aes(x = white_ratio, y = blue_collar_share, color = party)) +
  geom_point(alpha = 0.7) +  # 绘制所有点，颜色区分党派
  geom_smooth(method = "lm", se = FALSE, aes(group = party)) +  # 添加回归线，按党派分组
  scale_color_manual(values = c("Democratic" = "#2E74C0", "Republican" = "#CB454A")) +  # 设置党派颜色
  labs(title = "Relationship Between White Ratio and Blue Collar by Party",
       x = "White Ratio",
       y = "Blue Collar") +
  theme_minimal() +
  theme(legend.title = element_blank())  # 去掉图例标题

ggplot(legis_merged %>% filter(party == "Republican"), aes(x = black_or_african_american_ratio, y = median_household_income_that_year)) +
  geom_point(alpha = 0.7, color = "#CB454A") +  # 共和党选区
  geom_smooth(method = "lm", se = FALSE, color = "black") +  # 添加回归线
  labs(title = "Relationship Between Black Ratio and Household Income in Republican Districts",
       x = "Black Ratio",
       y = "Median Household Income") +
  theme_minimal()

```

# 6. dom_percentage lm models

## 6.0 data preparation

```{r}
#| label: data cleansing
#| echo: false

# turn decision into is.dom

legis_cg <- legis_cg %>%
  mutate(is.dom = ifelse(decision == "dom", 1, 0))

# turn party into is.republican
legis_cg$party_numeric <- ifelse(legis_cg$party == "Republican", 1, 0)

# turn categorical vector into numeric 
legis_cg$gender_numeric <- ifelse(legis_cg$gender == "Male", 1, 0)
legis_cg$chamber_numeric <- ifelse(legis_cg$chamber == "senate", 1, 0)

# add district data into adver_cg/legis_cg
district_data$congress <- as.character(district_data$congress)
legis_cg$congress <- as.character(legis_cg$congress)

legis_merged <- legis_cg %>%
  left_join(
    district_data,
    by = c("congress", "state_code", "district")
  )

# set vars_to_check 
vars_to_check <- c(
  "high_edu_share",
  "foreign_born_ratio",
  "white_ratio",
  "black_or_african_american_ratio",
  "asian_ratio",
  "american_indian_and_alaska_native_ratio",
  "native_hawaiian_and_other_pacific_islander_ratio",
  "white_collar_share",
  "blue_collar_share",
  "agriculture_share",
  "median_household_income_that_year",
  "age", "seniority", "ideology", "party", "chamber", "gender"
)

# for party gruoped
vars_to_check_party <- c(
  "high_edu_share",
  "foreign_born_ratio",
  "white_ratio",
  "black_or_african_american_ratio",
  "asian_ratio",
  "american_indian_and_alaska_native_ratio",
  "native_hawaiian_and_other_pacific_islander_ratio",
  "white_collar_share",
  "blue_collar_share",
  "agriculture_share",
  "median_household_income_that_year",
  "age", "seniority", "ideology", "chamber", "gender"
)

# filter on party level
dem_legis <- legis_merged %>%
  filter(party == "Democratic")
rep_legis <- legis_merged %>%
  filter(party == "Republican")

```

```{r}
#| label: co-linerality check function
#| echo: false

check_collinearity_plot <- function(data, vars = NULL) {
  
  # ---- 1. 选择变量 ----
  if (is.null(vars)) vars <- names(data)
  df <- data[, vars]
  
  # ---- 2. 只保留数值变量，并去掉常数列 ----
  num_vars <- names(df)[sapply(df, is.numeric)]
  df_num <- df[, num_vars]
  non_constant <- sapply(df_num, function(x) sd(x, na.rm = TRUE) > 0)
  df_num <- df_num[, non_constant]
  num_vars <- colnames(df_num)
  
  if (length(num_vars) < 2) {
    warning("数值型变量少于 2 个或都是常数列，无法计算相关性")
    return(NULL)
  }
  
  # ---- 3. 计算相关系数矩阵 ----
  cor_mat <- cor(df_num, use = "pairwise.complete.obs")
  
  # ---- 4. 计算 p-value 矩阵 ----
  p_mat <- matrix(NA, nrow = length(num_vars), ncol = length(num_vars),
                  dimnames = list(num_vars, num_vars))
  
  for (i in 1:length(num_vars)) {
    for (j in 1:length(num_vars)) {
      if (i == j) {
        p_mat[i, j] <- 0
      } else {
        test <- tryCatch(cor.test(df_num[[i]], df_num[[j]], use="pairwise.complete.obs"),
                         error=function(e) NULL)
        p_mat[i, j] <- ifelse(is.null(test), NA, test$p.value)
      }
    }
  }
  
  # ---- 5. p-value → 星号 ----
  signif_mat <- ifelse(
    p_mat < 0.001, "***",
    ifelse(p_mat < 0.01, "**",
           ifelse(p_mat < 0.05, "*", ""))
  )
  
  # ---- 6. 变量名保留前两个单词，保证唯一 ----
  short_names <- sapply(num_vars, function(x) {
    parts <- unlist(strsplit(x, "_|\\s+"))
    paste(parts[1:min(2, length(parts))], collapse = "_")
  })
  short_names <- make.unique(short_names)
  names(short_names) <- num_vars
  
  # ---- 7. 转换为长表格用于 ggplot ----
  cor_df <- as.data.frame(cor_mat) %>%
    mutate(var1 = rownames(.)) %>%
    pivot_longer(-var1, names_to = "var2", values_to = "cor") %>%
    mutate(var1_short = short_names[var1],
           var2_short = short_names[var2])
  
  star_df <- as.data.frame(signif_mat) %>%
    mutate(var1 = rownames(.)) %>%
    pivot_longer(-var1, names_to = "var2", values_to = "star") %>%
    mutate(var1_short = short_names[var1],
           var2_short = short_names[var2])
  
  plot_df <- left_join(cor_df, star_df,
                       by = c("var1", "var2", "var1_short", "var2_short")) %>%
    mutate(type = case_when(
      var1 < var2 ~ "cor",
      var1 > var2 ~ "star",
      TRUE ~ "diag"
    ))
  
  # ---- 8. 绘图 ----
  p <- ggplot(plot_df, aes(x = var1_short, y = var2_short)) +
    geom_tile(aes(fill = cor), color = "white") +
    geom_text(data = subset(plot_df, type=="cor"), 
              aes(label = sprintf("%.2f", cor)), size = 3) +
    geom_text(data = subset(plot_df, type=="star"), 
              aes(label = star), size = 5, color = "black") +
    scale_fill_gradient2(low = "#2166AC", mid = "white", high = "#B2182B", 
                         midpoint = 0, limits = c(-1, 1)) +
    theme_minimal() +
    labs(title = "Correlation Heatmap with Significance Stars",
         x = "", y = "") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid = element_blank())
  
  print(p)
  
  # ---- 9. 分类 vs 数值 ANOVA ----
  cat_vars <- names(df)[sapply(df, function(x) is.factor(x) | is.character(x))]
  categorical_numeric <- NULL
  if (length(cat_vars) > 0 & length(num_vars) > 0) {
    cat_num_tests <- expand.grid(num_vars, cat_vars, stringsAsFactors = FALSE)
    colnames(cat_num_tests) <- c("numeric_var", "categorical_var")
    
    categorical_numeric <- cat_num_tests %>%
      dplyr::mutate(
        p_value = purrr::map2_dbl(numeric_var, categorical_var, function(nv, cv){
          formula <- as.formula(paste(nv, "~", cv))
          tryCatch(summary(aov(formula, data=df))[[1]][["Pr(>F)"]][1],
                   error=function(e) NA)
        })
      )
  }
  
  # ---- 10. 返回结果 ----
  list(
    numeric_numeric = cor_mat,
    p_matrix = p_mat,
    significance = signif_mat,
    categorical_numeric = categorical_numeric,
    plot_data = plot_df
  )
}

# 第二个函数： 看数值*数值的p值
check_numeric_pvalues_star <- function(data, vars = NULL) {
  if (is.null(vars)) vars <- names(data)
  df <- data[, vars]
  
  # 只保留数值型变量
  num_vars <- names(df)[sapply(df, is.numeric)]
  n <- length(num_vars)
  
  if (n < 2) stop("数值型变量少于 2 个，无法计算相关性")
  
  # 初始化结果列表
  res <- data.frame(
    var1 = character(),
    var2 = character(),
    correlation = numeric(),
    p_value = numeric(),
    significance = character(),
    stringsAsFactors = FALSE
  )
  
  # 循环计算相关性和 p 值
  for (i in 1:(n-1)) {
    for (j in (i+1):n) {
      x <- df[[num_vars[i]]]
      y <- df[[num_vars[j]]]
      # 仅使用不为 NA 的观测
      valid <- complete.cases(x, y)
      if (sum(valid) < 3) {
        cor_val <- NA
        p_val <- NA
      } else {
        test <- cor.test(x[valid], y[valid])
        cor_val <- test$estimate
        p_val <- test$p.value
      }
      # 根据 p 值加星号
      sig <- if (is.na(p_val)) "" else if (p_val < 0.001) "***" else if (p_val < 0.01) "**" else if (p_val < 0.05) "*" else ""
      
      res <- rbind(res, data.frame(
        var1 = num_vars[i],
        var2 = num_vars[j],
        correlation = cor_val,
        p_value = p_val,
        significance = sig,
        stringsAsFactors = FALSE
      ))
    }
  }
  
  return(res)
}
```

```{r}
#| label: co-linerality check 
#| echo: false

# 查看数值型变量间的相关矩阵
collinearity_result <- check_collinearity_plot(
  legis_merged,
  vars = vars_to_check
)

collinearity_result_dem <- check_collinearity_plot(
  dem_legis,
  vars = vars_to_check_party
)

collinearity_result_rep <- check_collinearity_plot(
  rep_legis,
  vars = vars_to_check_party
)

collinearity_result$numeric_numeric
collinearity_result_dem$numeric_numeric
collinearity_result_rep$numeric_numeric


# 查看分类 vs 数值 的 ANOVA 显著性
collinearity_result$categorical_numeric %>% 
  dplyr::filter(p_value < 0.05)
collinearity_result_dem$categorical_numeric %>% 
  dplyr::filter(p_value < 0.05)
collinearity_result_rep$categorical_numeric %>% 
  dplyr::filter(p_value < 0.05)

```

## 6.1 share of high education in congressional district

```{r}
#| label: district_analysis_linear_dem_edu_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ high_edu_share + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ high_edu_share +  foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ high_edu_share + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ high_edu_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)
cor(dplyr::select(dem_legis, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_edu_dom.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）
# 高等教育比例的边际效应
edu_effect1 <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect1) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 高等教育比例的边际效应（去掉income）
edu_effect2 <- ggpredict(model21a, terms = "high_edu_share [all]")
plot(edu_effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
edu_effect3 <- ggpredict(model31, terms = "high_edu_share [all]")
plot(edu_effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

edu_effect4 <- ggpredict(model31a, terms = "high_edu_share [all]")
plot(edu_effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
#| label: district_analysis_linear_rep_edu_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ high_edu_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ high_edu_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) # 去除median_income因为共线

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ high_edu_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)
cor(dplyr::select(dem_legis, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!income)" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_district_edu_dom.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）

# 高等教育比例的边际效应（去掉income）
edu_effect2 <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
edu_effect3 <- ggpredict(model31, terms = "high_edu_share [all]")
plot(edu_effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

edu_effect4 <- ggpredict(model31a, terms = "high_edu_share [all]")
plot(edu_effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)
```

## 6.2 share of white collar in congressional district

```{r}
#| label: district_analysis_linear_dem_white_collar_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ white_collar_share + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ white_collar_share +  foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ white_collar_share + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ white_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ white_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)
cor(dplyr::select(dem_legis, white_collar_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_white_collar_dom.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）
# 高等教育比例的边际效应
edu_effect1 <- ggpredict(model21, terms = "white_collar_share [all]")
plot(edu_effect1) +
  labs(
    title = "Marginal Effect (control district)",
    x = "white_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 高等教育比例的边际效应（去掉income）
edu_effect2 <- ggpredict(model21a, terms = "white_collar_share [all]")
plot(edu_effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "white_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
edu_effect3 <- ggpredict(model31, terms = "white_collar_share [all]")
plot(edu_effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "white_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

edu_effect4 <- ggpredict(model31a, terms = "white_collar_share [all]")
plot(edu_effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "white_collar_share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: district_analysis_linear_rep_white_collar_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ white_collar_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ white_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 



# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ white_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ white_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_white_collar_dom.html"),
  escape = FALSE
)
```

## 6.3 blue collar

```{r}
#| label: district_analysis_linear_dem_blue_collar_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ blue_collar_share + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ blue_collar_share +  foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ blue_collar_share + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ blue_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ blue_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_blue_collar_dom.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_linear_rep_blue_collar_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ blue_collar_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ blue_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 



# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ blue_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ blue_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_blue_collar_dom.html"),
  escape = FALSE
)
```

## 6.4 median income

```{r}
#| label: district_analysis_linear_dem_income_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ median_household_income_that_year + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ median_household_income_that_year +  foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ median_household_income_that_year + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ median_household_income_that_year + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ median_household_income_that_year +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_income_dom.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_linear_rep_income_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ median_household_income_that_year + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 



# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ median_household_income_that_year + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ median_household_income_that_year +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_income_dom.html"),
  escape = FALSE
)
```

## 6.5 white_ratio

```{r}
#| label: district_analysis_linear_dem_white_ratio_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ white_ratio + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ white_ratio + high_edu_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ white_ratio + high_edu_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_white_ratio_dom.html"),
  escape = FALSE
)


```

```{r}
#| label: district_analysis_lm_rep_white_ratio_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ white_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ white_ratio + high_edu_share  +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_white_ratio_dom.html"),
  escape = FALSE
)

```

## 6.6 asian ratio

```{r}
#| label: district_analysis_logit_dem_asian_ratio_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ asian_ratio + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ asian_ratio + median_household_income_that_year + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ asian_ratio + high_edu_share +   agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ asian_ratio + high_edu_share +  agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ asian_ratio + median_household_income_that_year +   agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_asian_ratio_dom.html"),
  escape = FALSE
)
```

```{r}
#| label: district_analysis_logit_rep_asian_ratio_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ asian_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ asian_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ asian_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ asian_ratio + high_edu_share  +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_asian_ratio_dom.html"),
  escape = FALSE
)

```

## 6.7 black and african ratio

```{r}
#| label: district_analysis_logit_dem_black_ratio_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ black_or_african_american_ratio + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ black_or_african_american_ratio + median_household_income_that_year +  foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ black_or_african_american_ratio + high_edu_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ black_or_african_american_ratio + high_edu_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ black_or_african_american_ratio + high_edu_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 2a: District controls" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_black_ratio_dom.html"),
  escape = FALSE
)
```

```{r}
#| label: district_analysis_logit_rep_black_ratio_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ black_or_african_american_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ black_or_african_american_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ black_or_african_american_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ black_or_african_american_ratio + high_edu_share  +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_black_ratio_dom.html"),
  escape = FALSE
)
```

## 6.8 foreign born

```{r}
#| label: district_analysis_logit_dem_foreign_born_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ foreign_born_ratio + factor(congress),
  data = dem_legis,
  family = binomial(link = "logit")
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage  ~  foreign_born_ratio  +  high_edu_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis,
  family = binomial(link = "logit")
)

model21a <- lm(dom_percentage ~ foreign_born_ratio  +  blue_collar_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis,
  family = binomial(link = "logit")
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ foreign_born_ratio  +  high_edu_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis,
  family = binomial(link = "logit")
)

# senirority
model31a <- lm(dom_percentage ~ foreign_born_ratio  +  blue_collar_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share +
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis,
  family = binomial(link = "logit")
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_foreign_born_dom.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_logit_rep_foreign_born_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ foreign_born_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ foreign_born_ratio + blue_collar_share +  asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ foreign_born_ratio + white_collar_share + 
    asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ foreign_born_ratio + blue_collar_share +   asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "liner_legis_rep_foreign_born_dom.html"),
  escape = FALSE
)
```

## 6.9 farmer share

```{r}
#| label: district_analysis_logit_dem_farmer_share_dom
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ agriculture_share + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ agriculture_share + foreign_born_ratio  +  high_edu_share + 
    white_ratio + black_or_african_american_ratio +  factor(congress),
  data = dem_legis
)

model21a <- lm(dom_percentage ~ agriculture_share + foreign_born_ratio  +  blue_collar_share + 
    white_ratio + black_or_african_american_ratio +  factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ agriculture_share +  foreign_born_ratio  +  high_edu_share + 
    white_ratio + black_or_african_american_ratio + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# senirority
model31a <- lm(dom_percentage ~ agriculture_share + foreign_born_ratio  +  blue_collar_share + 
    white_ratio + black_or_african_american_ratio + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_agri_dom.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_logit_rep_farmer
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(dom_percentage ~ agriculture_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(dom_percentage ~ agriculture_share +  foreign_born_ratio + blue_collar_share +  asian_ratio +
    white_ratio + black_or_african_american_ratio +  factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(dom_percentage ~ agriculture_share + foreign_born_ratio + white_collar_share + 
    asian_ratio +
    white_ratio + black_or_african_american_ratio + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(dom_percentage ~ agriculture_share + foreign_born_ratio + blue_collar_share +   asian_ratio +
    white_ratio + black_or_african_american_ratio + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_agri_dom.html"),
  escape = FALSE
)

```

## 7.4 run three model function

```{r}
#| label: run_three_model_function
#| echo: false

run_three_models <- function(
  data, 
  main_var, 
  y = "is.dom",
  indiv_controls = c("gender", "age", "seniority", "chamber"),
  district_candidates = c(
    "high_edu_share", "white_collar_share", "blue_collar_share", 
    "agriculture_share", "median_household_income_that_year",
    "white_ratio", "asian_ratio", "black_or_african_american_ratio", 
    "foreign_born_ratio"
  ),
  use_district_controls = TRUE,
  cor_cutoff = 0.6
){
  # ---- 1. ensure variables exist ----
  if(!main_var %in% names(data)) stop("main predictor not in data!")
  if(!y %in% names(data)) stop("outcome variable not in data!")
  
  # ---- 2. filter numeric district vars ----
  district_numeric <- district_candidates[
    district_candidates %in% names(data) &
      sapply(district_candidates, function(v) is.numeric(data[[v]]))
  ]
  
  # ---- 3. compute correlations only if numeric and user specified ----
  cor_ok <- c()
  
  if (use_district_controls && is.numeric(data[[main_var]])) {
    for (v in district_numeric){
      tmp <- data[, c(main_var, v)]
      tmp <- tmp[complete.cases(tmp), ]
      if (nrow(tmp) > 10){
        cval <- suppressWarnings(cor(tmp[[main_var]], tmp[[v]]))
        if (!is.na(cval) && abs(cval) < cor_cutoff){
          cor_ok <- c(cor_ok, v)
        }
      }
    }
    
    message("---- 自动筛选出的选区控制变量（|cor| < ", cor_cutoff, "） ----")
    print(cor_ok)
    
  } else if (use_district_controls && !is.numeric(data[[main_var]])) {
    message("⚠️ main predictor 不是 numeric，跳过相关性筛选，直接使用全部 district numeric 变量")
    cor_ok <- district_numeric
  } else {
    message("⚠️ use_district_controls = FALSE，不加入任何选区控制变量")
    cor_ok <- c()
  }
  
  # ---- 4. build three formulas ----
  indiv_controls <- indiv_controls[indiv_controls %in% names(data)]
  
  # Model 1
  f1 <- as.formula(paste(y, "~", main_var))
  
  # Model 2
  f2 <- as.formula(paste(
    y, "~", main_var,
    if (length(indiv_controls)>0) paste("+", paste(indiv_controls, collapse=" + ")) else ""
  ))
  
  # Model 3
  f3 <- as.formula(paste(
    y, "~", main_var,
    if (length(indiv_controls)>0) paste("+", paste(indiv_controls, collapse=" + ")) else "",
    if (length(cor_ok)>0) paste("+", paste(cor_ok, collapse=" + ")) else ""
  ))
  
  # ---- 5. run glm ----
  m1 <- glm(f1, data = data, family = binomial)
  m2 <- glm(f2, data = data, family = binomial)
  m3 <- glm(f3, data = data, family = binomial)
  
  list(
    selected_district_controls = cor_ok,
    model_main_only = m1,
    model_indiv = m2,
    model_full = m3
  )
}


result <- run_three_models(
  data = dem_legis,
  main_var = "committee_el",
  y = "is.dom",
  indiv_controls = c("gender", "seniority", "chamber"),
  use_district_controls = FALSE  # optional
)
result
```

# 7. individual character

## 7.1 raw committee_el

```{r}
#| label: individual_analysis_logit_dem_commmittee_el
#| echo: false


# 初始模型
dem_model <- lm(prof_percentage ~ committee_el + factor(congress),
                 data = dem_legis)

summary(dem_model)
tidy(dem_model, conf.int = TRUE)


# 加入个人特质作为控制变量
dem_model1 <- lm(prof_percentage ~ committee_el + gender_numeric + chamber_numeric + ideology + high_edu_share + factor(congress),
                 data = dem_legis)

summary(dem_model1)
tidy(dem_model, conf.int = TRUE)


# 加入选区变量作为控制变量
dem_model2 <- lm(prof_percentage
                 ~ committee_el + gender_numeric + chamber_numeric + ideology +
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

summary(dem_model2)
tidy(dem_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(dem_model1)
vif(dem_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-commmittee_prof_lag" = dem_model,
    "Model 2: Individual controls" = dem_model1,
    "Model 3: District controls(age)" = dem_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lm_legis_dem_committee_el.html"),
  escape = FALSE
)


```

```{r}
#| label: individual_analysis_lasso_dem_commmittee_el
#| echo: false

# 将 committee_el 转换为虚拟变量（如果它是因子变量）
committee_el_dummies <- model.matrix(~ committee_el - 1, data = legis_merged)

# 因变量：prof_percentage
y <- legis_merged$prof_percentage

# Lasso 回归（L1 正则化）
lasso_model <- cv.glmnet(committee_el_dummies, y, alpha = 1, family = "gaussian")

# Ridge 回归（L2 正则化）
ridge_model <- cv.glmnet(committee_el_dummies, y, alpha = 0, family = "gaussian")

# 查看最佳的 lambda（惩罚系数）
lasso_model$lambda.min  # Lasso 最优 lambda
ridge_model$lambda.min  # Ridge 最优 lambda

# 查看系数
coef(lasso_model, s = "lambda.min")
coef(ridge_model, s = "lambda.min")

```

```{r}
#| label: individual_analysis_logit_rep_commmittee_el
#| echo: false


# 初始模型
rep_model <- glm(is.dom ~ committee_el + factor(congress),
                 data = rep_legis,
                 family = binomial())

summary(rep_model)
tidy(rep_model, conf.int = TRUE)


# 加入个人特质作为控制变量
rep_model1 <- glm(is.dom ~ committee_el + gender_numeric + chamber_numeric + ideology + high_edu_share + factor(congress),
                 data = rep_legis,
                 family = binomial())

summary(rep_model1)
tidy(rep_model1, conf.int = TRUE)


# 加入选区变量作为控制变量
rep_model2 <- glm(
  is.dom ~ committee_el + gender_numeric + chamber_numeric + ideology +
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis,
  family = binomial(link = "logit")
)

summary(rep_model2)
tidy(rep_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(rep_model1)
vif(rep_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-commmittee_el" = rep_model,
    "Model 2: Individual controls" = rep_model1,
    "Model 3: District controls(age)" = rep_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "logit_legis_rep_committee_el.html"),
  escape = FALSE
)


```

```{r}
#| label: interaction model between party and committee_el
#| echo: false

# 删除 committee_el 缺失的行
legis_cg_clean <- legis_cg %>%
  filter(!is.na(committee_el))

# 1. 设计逻辑回归模型，因变量为 prof_percentage（专业模式占比）
# 自变量为委员会专业（committee_el）、党派（party）以及它们的交互项

model1 <- lm(
  prof_percentage ~ committee_el * party + factor(congress),
  data = legis_cg_clean 
)

model2 <- lm(
  prof_percentage ~ committee_el * party + age + seniority + gender + factor(congress),
  data = legis_cg_clean
)

# 查看模型摘要
summary(model)


modelsummary(
  list(
    "Model 1: Inteaction-commmittee_el" = model1,
    "Model 2: Control personal attributes" = model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "interaction_party_and_committee_el.html"),
  escape = FALSE
)


pred <- ggpredict(model1, terms = c("committee_el", "party"))
plot(pred)


```

```{r}
#| label: pca analysis
#| echo: false


# 1. 将 committee_el 转换为虚拟变量
committee_el_dummies <- model.matrix(~ committee_el - 1, data = legis_merged)

head(committee_el_dummies)

# 2. 对虚拟变量进行 PCA
committee_el_pca <- prcomp(committee_el_dummies, scale. = TRUE)

summary(committee_el_pca)  # 显示每个主成分的解释方差比例

# 3. 选择主成分
committee_el_pca_scores <- committee_el_pca$x[, 1:2]

head(committee_el_pca_scores)

# 4. 将主成分作为新的特征加入模型：
legis_merged <- legis_merged %>%
  bind_cols(data.frame(committee_el_pca_scores))

model_pca <- lm(
  prof_percentage ~ PC1 + PC2 + party + age + seniority + ideology + gender + factor(congress),
  data = legis_merged
)

summary(model_pca)
```

## 7.2 committee_prof

```{r}
#| label: committee_data_preparation
#| echo: false

legis_merged$congress <- as.numeric(legis_merged$congress)

legis_merged_clean <- legis_merged %>% filter(!is.na(committee_el))

committee_prof_current <- legis_merged_clean %>%
  group_by(congress, committee_el) %>%
  summarise(
    n_members = n(),
    committee_prof_current = mean(importance_prof, na.rm = TRUE),
    committee_prof_sum = sum(importance_prof, na.rm = TRUE),
    .groups = "drop"
  )

committee_prof_lag <- committee_prof_current %>%
  mutate(congress = congress + 1) %>%
  rename(committee_prof_lag = committee_prof_current)

# 确保两边类型一致
legis_merged_clean <- legis_merged_clean %>%
  mutate(
    congress = as.numeric(congress),
    committee_el = as.character(committee_el)
  )

committee_prof_current <- committee_prof_current %>%
  mutate(
    congress = as.numeric(congress),
    committee_el = as.character(committee_el)
  )

committee_prof_lag <- committee_prof_lag %>%
  mutate(
    congress = as.numeric(congress),
    committee_el = as.character(committee_el)
  )

# join
legis_merged1 <- legis_merged_clean %>%
  left_join(committee_prof_lag, by = c("congress", "committee_el"))

# 查看 n_members 是否存在
names(legis_merged1)

legis_merged1 <- legis_merged1 %>%
  mutate(
    committee_prof_loo =
      ifelse(!is.na(n_members) & n_members > 1,
             (committee_prof_sum - importance_prof) / (n_members - 1),
             NA_real_
      )
  )
```

```{r}
#| label: individual_analysis_logit_dem_commmittee_prof
#| echo: false

# 民主党
dem_legis_lag <- legis_merged1 %>%
  filter(party == "Democratic", !is.na(committee_prof_lag))

# 初始模型
dem_model <- lm(prof_percentage ~ committee_prof_lag + factor(congress),
                 data = dem_legis_lag)

summary(dem_model)
tidy(dem_model, conf.int = TRUE)


# 加入个人特质作为控制变量
dem_model1 <- lm(prof_percentage ~ committee_prof_lag + gender_numeric + chamber_numeric + ideology + high_edu_share + factor(congress),
                 data = dem_legis_lag)

summary(dem_model1)
tidy(dem_model, conf.int = TRUE)


# 加入选区变量作为控制变量
dem_model2 <- lm(prof_percentage ~ committee_prof_lag+ gender_numeric + chamber_numeric + ideology +
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis_lag)

summary(dem_model2)
tidy(dem_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(dem_model1)
vif(dem_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-commmittee_prof_lag" = dem_model,
    "Model 2: Individual controls" = dem_model1,
    "Model 3: District controls(age)" = dem_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lm_legis_dem_committee_prof_lag.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）

committee_effect <- ggpredict(dem_model, terms = "committee_prof_lag")
plot(committee_effect) +
  labs(
    title = "Marginal Effect (no control)",
    x = "Committee_prof_lag",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
committee_effect1 <- ggpredict(dem_model1, terms = "committee_prof_lag")
plot(committee_effect1) +
  labs(
    title = "Marginal Effect (with individual control)",
    x = "Committee_prof_lag",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制选区特征之后的high_education的边际效应
committee_effect2 <- ggpredict(dem_model2, terms = "committee_prof_lag")
plot(committee_effect2) +
  labs(
    title = "Marginal Effect (with district control)",
    x = "Committee_prof_lag",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
#| label: individual_analysis_logit_rep_commmittee
#| echo: false

# 共和党
rep_legis_lag <- legis_merged1 %>%
  filter(party == "Republican", !is.na(committee_prof_lag))

# 初始模型
rep_model <- lm(prof_percentage ~ committee_prof_lag + factor(congress),
                 data = rep_legis_lag)

summary(rep_model)
tidy(rep_model, conf.int = TRUE)


# 加入个人特质作为控制变量
rep_model1 <- lm(prof_percentage ~ committee_prof_lag + gender_numeric + chamber_numeric + ideology + high_edu_share + factor(congress),
                 data = rep_legis_lag)

summary(rep_model1)
tidy(rep_model, conf.int = TRUE)


# 加入选区变量作为控制变量
rep_model2 <- lm(prof_percentage ~ committee_prof_lag+ gender_numeric + chamber_numeric + ideology +
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis_lag)

summary(rep_model2)
tidy(rep_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(rep_model1)
vif(rep_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-commmittee_prof_lag" = dem_model,
    "Model 2: Individual controls" = dem_model1,
    "Model 3: District controls(age)" = dem_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lm_legis_rep_committee_prof_lag.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）

committee_effect <- ggpredict(rep_model, terms = "committee_prof_lag")
plot(committee_effect) +
  labs(
    title = "Marginal Effect (no control)",
    x = "Committee_prof_lag",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
committee_effect1 <- ggpredict(rep_model1, terms = "committee_prof_lag")
plot(committee_effect1) +
  labs(
    title = "Marginal Effect (with individual control)",
    x = "Committee_prof_lag",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制选区特征之后的high_education的边际效应
committee_effect2 <- ggpredict(rep_model2, terms = "committee_prof_lag")
plot(committee_effect2) +
  labs(
    title = "Marginal Effect (with district control)",
    x = "Committee_prof_lag",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)
```

### 7.2.1 party\*committe_el interaction

```{r}
#| label: individual_analysis_logit_interaction
#| echo: false

# 看党派与委员会专业性的交互项
full_model <- lm(
  prof_percentage ~ committee_prof_lag*party + gender + chamber + seniority + factor(congress),
  data = legis_merged1
)
summary(full_model)

```

## 7.3 ideology

```{r}
#| label: individual_analysis_logit_ideology
#| echo: false


mod_dom_interact <- lm(prof_percentage ~ ideology * party + high_edu_share + chamber + gender + factor(congress),
                        data = legis_merged)

summary(mod_dom_interact)

pred <- ggpredict(mod_dom_interact, terms = c("ideology", "party"))
plot(pred)

# 按党派分组查看 ideoloy 变量的最小值和最大值
legis_merged %>%
  group_by(party) %>%
  summarise(
    min_ideology = min(ideology, na.rm = TRUE),
    max_ideology = max(ideology, na.rm = TRUE)
  )

```

```{r}
#| label: individual_analysis_linear_dem_ideology_dom
#| echo: false

# 初始模型
dem_model <- lm(dom_percentage ~ ideology + factor(congress),
                 data = dem_legis)

summary(dem_model)
tidy(dem_model, conf.int = TRUE)


# 加入个人特质作为控制变量
dem_model1 <- lm(dom_percentage ~ ideology +  gender + chamber + age + factor(congress),
                 data = dem_legis)

summary(dem_model1)
tidy(dem_model, conf.int = TRUE)


# 加入选区变量作为控制变量
dem_model2 <- lm(dom_percentage ~ ideology +  gender + chamber + seniority + 
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

summary(dem_model2)
tidy(dem_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(dem_model1)
vif(dem_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-ideology" = dem_model,
    "Model 2: Individual controls" = dem_model1,
    "Model 3: District controls(age)" = dem_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_ideology_dom.html"),
  escape = FALSE
)


# 五、可视化：边际效应（Marginal Effects）

ideology_effect2 <- ggpredict(dem_model2, terms = "seniority [all]")
plot(ideology_effect2) +
  labs(
    title = "Marginal Effect (control district)",
    x = "Seniority",
    y = "Dom_percentage"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: individual_analysis_linear_dem_ideology_prof
#| echo: false

# 初始模型
dem_model <- lm(prof_percentage ~ ideology + factor(congress),
                 data = dem_legis)

summary(dem_model)
tidy(dem_model, conf.int = TRUE)


# 加入个人特质作为控制变量
dem_model1 <- lm(prof_percentage ~ ideology +  gender + chamber + age + factor(congress),
                 data = dem_legis)

summary(dem_model1)
tidy(dem_model, conf.int = TRUE)


# 加入选区变量作为控制变量
dem_model2 <- lm(prof_percentage ~ ideology +  gender + chamber + seniority + 
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

summary(dem_model2)
tidy(dem_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(dem_model1)
vif(dem_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-ideology" = dem_model,
    "Model 2: Individual controls" = dem_model1,
    "Model 3: District controls(age)" = dem_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_ideology_prof.html"),
  escape = FALSE
)


# 五、可视化：边际效应（Marginal Effects）
ideology_effect2 <- ggpredict(dem_model2, terms = "seniority [all]")
plot(ideology_effect2) +
  labs(
    title = "Marginal Effect (control district)",
    x = "Seniority",
    y = "Prof_percentage"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: individual_analysis_linear_rep_ideology_dom
#| echo: false

# 初始模型
rep_model <- lm(dom_percentage ~ ideology + factor(congress),
                 data = rep_legis)

summary(rep_model)
tidy(rep_model, conf.int = TRUE)


# 加入个人特质作为控制变量
rep_model1 <- lm(dom_percentage ~ ideology +  gender + chamber + age + factor(congress),
                 data = rep_legis)

summary(rep_model1)
tidy(rep_model1, conf.int = TRUE)


# 加入选区变量作为控制变量
rep_model2 <- lm(dom_percentage ~ ideology +  gender + chamber + seniority +
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
)

summary(rep_model2)
tidy(rep_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(rep_model1)
vif(rep_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-ideology" = rep_model,
    "Model 2: Individual controls" = rep_model1,
    "Model 3: District controls(age)" = rep_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_ideology_dom.html"),
  escape = FALSE
)


# 五、可视化：边际效应（Marginal Effects）
# 高等教育比例的边际效应
ideology_effect <- ggpredict(rep_model, terms = "ideology [all]")
plot(ideology_effect) +
  labs(
    title = "Marginal Effect (no control)",
    x = "Ideology",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 高等教育比例的边际效应（去掉income）
ideology_effect1 <- ggpredict(rep_model1, terms = "ideology [all]")
plot(ideology_effect1) +
  labs(
    title = "Marginal Effect (control individual)",
    x = "Ideology",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
ideology_effect2 <- ggpredict(rep_model2, terms = "ideology [all]")
plot(ideology_effect2) +
  labs(
    title = "Marginal Effect (control district)",
    x = "Ideology",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)


```

```{r}
#| label: individual_analysis_linear_rep_ideology_prof
#| echo: false

# 初始模型
rep_model <- lm(prof_percentage ~ ideology + factor(congress),
                 data = rep_legis)

summary(rep_model)
tidy(rep_model, conf.int = TRUE)


# 加入个人特质作为控制变量
rep_model1 <- lm(prof_percentage ~ ideology +  gender + chamber + age + factor(congress),
                 data = rep_legis)

summary(rep_model1)
tidy(rep_model1, conf.int = TRUE)


# 加入选区变量作为控制变量
rep_model2 <- lm(prof_percentage ~ ideology +  gender + chamber + seniority +
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
)

summary(rep_model2)
tidy(rep_model2, conf.int = TRUE)

# 四、模型诊断与比较
# 1. 检查多重共线性
vif(rep_model1)
vif(rep_model2)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-ideology" = rep_model,
    "Model 2: Individual controls" = rep_model1,
    "Model 3: District controls(age)" = rep_model2
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_ideology_prof.html"),
  escape = FALSE
)


# 五、可视化：边际效应（Marginal Effects）
# 高等教育比例的边际效应
ideology_effect <- ggpredict(rep_model, terms = "ideology [all]")
plot(ideology_effect) +
  labs(
    title = "Marginal Effect (no control)",
    x = "Ideology",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 高等教育比例的边际效应（去掉income）
ideology_effect1 <- ggpredict(rep_model1, terms = "ideology [all]")
plot(ideology_effect1) +
  labs(
    title = "Marginal Effect (control individual)",
    x = "Ideology",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
ideology_effect2 <- ggpredict(rep_model2, terms = "ideology [all]")
plot(ideology_effect2) +
  labs(
    title = "Marginal Effect (control district)",
    x = "Ideology",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)


```

```{r}
#| label: individual_analysis_linear_seniority_and_party
#| echo: false

# 初始模型
model1 <- lm(dom_percentage ~ party * seniority + factor(congress),
                 data = legis_merged)


# 加入个人特质作为控制变量
model2 <- lm(dom_percentage ~  party * seniority + gender  + chamber + factor(congress),
                 data = legis_merged)


# 加入选区变量作为控制变量
model3 <- lm(dom_percentage ~ party * seniority + gender  + chamber +
    high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = legis_merged
)


# 模型比较表
modelsummary(
  list(
    "Model 1: Party&Seniority interaction" = model1,
    "Model 2: Individual controls" = model2,
    "Model 3: District controls" = model3
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_party_seniority_interaction.html"),
  escape = FALSE
)

```

# 8. prof_percentage lm model

## 8.1 high_edu

```{r}
#| label: district_analysis_legis_dem_edu_prof
#| echo: false

# --- 一、核心模型（最简版本） ---
model11 <- lm(
  prof_percentage ~ high_edu_share + factor(congress),
  data = dem_legis
)

# --- 二、扩展控制模型（控制选区结构异质性） ---
model21 <- lm(
  prof_percentage ~ high_edu_share + foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ high_edu_share + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# --- 三、稳健模型（控制议员层级变量） ---
# age
model31 <- lm(
  prof_percentage ~ high_edu_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ high_edu_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# --- 四、模型诊断与比较 ---
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "lm_legis_dem_district_edu.html"),
  escape = FALSE
)

# --- 五、可视化：边际效应（Marginal Effects） ---
library(ggeffects)

# 高等教育比例的边际效应
edu_effect1 <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect1) +
  labs(
    title = "Marginal Effect (control district)",
    x = "High Education Share",
    y = "Predicted Professional Mode (%)"
  ) +
  theme_minimal(base_size = 14)

edu_effect2 <- ggpredict(model21a, terms = "high_edu_share [all]")
plot(edu_effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Professional Mode (%)"
  ) +
  theme_minimal(base_size = 14)

edu_effect3 <- ggpredict(model31, terms = "high_edu_share [all]")
plot(edu_effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "High Education Share",
    y = "Predicted Professional Mode (%)"
  ) +
  theme_minimal(base_size = 14)

edu_effect4 <- ggpredict(model31a, terms = "high_edu_share [all]")
plot(edu_effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "High Education Share",
    y = "Predicted Professional Mode (%)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
#| label: district_analysis_linear_rep_edu_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ high_edu_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ high_edu_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) # 去除median_income因为共线

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ high_edu_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ high_edu_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)
cor(dplyr::select(dem_legis, high_edu_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls(!income)" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_district_edu_prof.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）

# 高等教育比例的边际效应（去掉income）
edu_effect2 <- ggpredict(model21, terms = "high_edu_share [all]")
plot(edu_effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

# 控制个人特征之后的high_education的边际效应
edu_effect3 <- ggpredict(model31, terms = "high_edu_share [all]")
plot(edu_effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

edu_effect4 <- ggpredict(model31a, terms = "high_edu_share [all]")
plot(edu_effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "High Education Share",
    y = "Predicted Probability (is.dom)"
  ) +
  theme_minimal(base_size = 14)

```

## 8.2 white collar

```{r}
#| label: district_analysis_linear_dem_white_collar_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ white_collar_share + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ white_collar_share +  foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ white_collar_share + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ white_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ white_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)
cor(dplyr::select(dem_legis, white_collar_share, median_household_income_that_year, white_collar_share), use = "complete.obs")

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-white_collar" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_white_collar_prof.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）
library(ggeffects)

effect1 <- ggpredict(model21, terms = "white_collar_share [all]")
plot(effect1) +
  labs(
    title = "Marginal Effect (control district)",
    x = "White Collar Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect2 <- ggpredict(model21a, terms = "white_collar_share [all]")
plot(effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "White Collar Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect3 <- ggpredict(model31, terms = "white_collar_share [all]")
plot(effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "White Collar Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect4 <- ggpredict(model31a, terms = "white_collar_share [all]")
plot(effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "White Collar Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
#| label: district_analysis_linear_rep_white_collar_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ white_collar_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ white_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 



# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ white_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ white_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_white_collar_prof.html"),
  escape = FALSE
)
```

## 8.3 blue collar

```{r}
#| label: district_analysis_linear_dem_blue_collar_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ blue_collar_share + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ blue_collar_share +  foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ blue_collar_share + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ blue_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ blue_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-blue_collar" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_blue_collar_prof.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_linear_rep_blue_collar_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ blue_collar_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ blue_collar_share + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 



# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ blue_collar_share + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ blue_collar_share +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_blue_collar_dom_prof.html"),
  escape = FALSE
)


```

## 8.4 median_house_income

```{r}
#| label: district_analysis_linear_dem_income_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ median_household_income_that_year + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ median_household_income_that_year +  foreign_born_ratio + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ median_household_income_that_year + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ median_household_income_that_year + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ median_household_income_that_year +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-income" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_income_prof.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_linear_rep_income_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ median_household_income_that_year + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ median_household_income_that_year + foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 



# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ median_household_income_that_year + 
    foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ median_household_income_that_year +  foreign_born_ratio + asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_income_prof.html"),
  escape = FALSE
)
```

## 8.5 white ratio

```{r}
#| label: district_analysis_linear_dem_white_ratio_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ white_ratio + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ white_ratio + high_edu_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ white_ratio + high_edu_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-white_ratio" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_white_ratio.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）
library(ggeffects)

effect1 <- ggpredict(model21, terms = "white_ratio [all]")
plot(effect1) +
  labs(
    title = "Marginal Effect (control district)",
    x = "White Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect2 <- ggpredict(model21a, terms = "white_ratio [all]")
plot(effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "White Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect3 <- ggpredict(model31, terms = "white_ratio [all]")
plot(effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "White Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect4 <- ggpredict(model31a, terms = "white_ratio [all]")
plot(effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "White Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: district_analysis_lm_rep_white_ratio_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ white_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ white_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ white_ratio + high_edu_share  +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_white_ratio_prof.html"),
  escape = FALSE
)

```

## 8.6 asian ratio

```{r}
#| label: district_analysis_linear_dem_asian_ratio_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ asian_ratio + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ asian_ratio + median_household_income_that_year + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ asian_ratio + high_edu_share + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ asian_ratio + high_edu_share + agriculture_share + 
    ideology + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ asian_ratio + median_household_income_that_year + agriculture_share + 
    ideology + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-asian_ratio" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_asian_ratio_prof.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_logit_rep_asian_ratio
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ asian_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ asian_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ asian_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ asian_ratio + high_edu_share  +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_asian_ratio_prof.html"),
  escape = FALSE
)


```

## 8.7 black ratio

```{r}
#| label: district_analysis_linear_dem_black_ratio_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ black_or_african_american_ratio + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ black_or_african_american_ratio + median_household_income_that_year +  
    foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ black_or_african_american_ratio + high_edu_share +  
    foreign_born_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ black_or_african_american_ratio + high_edu_share +  
    foreign_born_ratio + agriculture_share + ideology + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ black_or_african_american_ratio + high_edu_share +  
    foreign_born_ratio + agriculture_share + ideology + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-black_ratio" = model11,
    "Model 2: District controls" = model21,
    "Model 2a: District controls" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_black_ratio_prof.html"),
  escape = FALSE
)

```

```{r}
#| label: district_analysis_logit_rep_black_ratio_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ black_or_african_american_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ black_or_african_american_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ black_or_african_american_ratio + blue_collar_share +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ black_or_african_american_ratio + high_edu_share  +  foreign_born_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_black_ratio_prof.html"),
  escape = FALSE
)

```

## 8.8 foreign born ratio

```{r}
#| label: district_analysis_linear_dem_foreign_born
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ foreign_born_ratio + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ foreign_born_ratio + high_edu_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ foreign_born_ratio + blue_collar_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ foreign_born_ratio + high_edu_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ foreign_born_ratio + blue_collar_share + 
    white_ratio + black_or_african_american_ratio + agriculture_share +
    ideology + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-foreign_born" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_foreign_born_prof.html"),
  escape = FALSE
)

# 五、可视化：边际效应（Marginal Effects）
library(ggeffects)

effect1 <- ggpredict(model21, terms = "foreign_born_ratio [all]")
plot(effect1) +
  labs(
    title = "Marginal Effect (control district)",
    x = "Foreign Born Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect2 <- ggpredict(model21a, terms = "foreign_born_ratio [all]")
plot(effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "Foreign Born Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect3 <- ggpredict(model31, terms = "foreign_born_ratio [all]")
plot(effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "Foreign Born Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect4 <- ggpredict(model31a, terms = "foreign_born_ratio [all]")
plot(effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "Foreign Born Ratio",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: district_analysis_logit_rep_foreign_born
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ foreign_born_ratio + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ foreign_born_ratio + blue_collar_share +  asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ foreign_born_ratio + white_collar_share + 
    asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ foreign_born_ratio + blue_collar_share +   asian_ratio +
    white_ratio + black_or_african_american_ratio + agriculture_share + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "liner_legis_rep_foreign_born_prof.html"),
  escape = FALSE
)

```

## 8.9 farmer ratio

```{r}
#| label: district_analysis_linear_dem_farmer_share
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(
  prof_percentage ~ agriculture_share + factor(congress),
  data = dem_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(
  prof_percentage ~ agriculture_share + foreign_born_ratio + high_edu_share + 
    white_ratio + black_or_african_american_ratio + factor(congress),
  data = dem_legis
)

model21a <- lm(
  prof_percentage ~ agriculture_share + foreign_born_ratio + blue_collar_share + 
    white_ratio + black_or_african_american_ratio + factor(congress),
  data = dem_legis
)

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(
  prof_percentage ~ agriculture_share + foreign_born_ratio + high_edu_share + 
    white_ratio + black_or_african_american_ratio + 
    ideology + gender + chamber + age + factor(congress),
  data = dem_legis
)

# seniority
model31a <- lm(
  prof_percentage ~ agriculture_share + foreign_born_ratio + blue_collar_share + 
    white_ratio + black_or_african_american_ratio + 
    ideology + gender + chamber + seniority + factor(congress),
  data = dem_legis
)

# 四、模型诊断与比较
# 1. 检查多重共线性
library(car)
vif(model21)
vif(model21a)
vif(model31)
vif(model31a)

# 2. 模型比较表
library(modelsummary)
modelsummary(
  list(
    "Model 1: Simple-agriculture" = model11,
    "Model 2: District controls(!asian_ratio)" = model21,
    "Model 2a: District controls(!foreign_born)" = model21a,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_dem_district_agri_prof.html"),
  escape = FALSE
)

# 五、可视化：边际效应
library(ggeffects)

effect1 <- ggpredict(model21, terms = "agriculture_share [all]")
plot(effect1) +
  labs(
    title = "Marginal Effect (control district)",
    x = "Agriculture Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect2 <- ggpredict(model21a, terms = "agriculture_share [all]")
plot(effect2) +
  labs(
    title = "Marginal Effect (control district, !income)",
    x = "Agriculture Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect3 <- ggpredict(model31, terms = "agriculture_share [all]")
plot(effect3) +
  labs(
    title = "Marginal Effect (control individual, !seniority)",
    x = "Agriculture Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

effect4 <- ggpredict(model31a, terms = "agriculture_share [all]")
plot(effect4) +
  labs(
    title = "Marginal Effect (control individual, !age)",
    x = "Agriculture Share",
    y = "Predicted Professionalization (%)"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
#| label: district_analysis_lm_rep_farmer_prof
#| echo: false

# 一、核心模型（最简版本）
model11 <- lm(prof_percentage ~ agriculture_share + factor(congress),
  data = rep_legis
)

# 二、扩展控制模型（控制选区结构异质性）
model21 <- lm(prof_percentage ~ agriculture_share +  foreign_born_ratio + blue_collar_share +  asian_ratio +
    white_ratio + black_or_african_american_ratio +  factor(congress),
  data = rep_legis
) 

# 三、稳健模型（控制议员层级变量）
# age
model31 <- lm(prof_percentage ~ agriculture_share + foreign_born_ratio + white_collar_share + 
    asian_ratio +
    white_ratio + black_or_african_american_ratio + 
    ideology  + gender + chamber + age  + factor(congress),
  data = rep_legis
)

# senirority
model31a <- lm(prof_percentage ~ agriculture_share + foreign_born_ratio + blue_collar_share +   asian_ratio +
    white_ratio + black_or_african_american_ratio + 
    ideology  + gender + chamber + seniority + factor(congress),
  data = rep_legis
)


# 四、模型诊断与比较
# 1. 检查多重共线性
vif(model21)
vif(model31)
vif(model31a)

# 2. 模型比较表
modelsummary(
  list(
    "Model 1: Simple-education" = model11,
    "Model 2: District controls" = model21,
    "Model 3: + Individual controls(age)" = model31,
    "Model 3a: + Individual controls(seniority)" = model31a
  ),
  fmt = 3,
  stars = TRUE,
  output = file.path(output_dir, "linear_legis_rep_agri_prof.html"),
  escape = FALSE
)
```

# 9. issue
